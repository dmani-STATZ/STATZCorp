{% extends "base_template.html" %}
{% load static %}

{% block extra_head %}{% endblock %}

{% block body %}
<div class="container mx-auto px-4 reports-admin">
  <div class="flex items-center justify-between mt-4 mb-4">
    <h1 class="text-2xl font-semibold text-white">Reports Admin Workspace</h1>
    <a href="{% url 'reports:my_requests' %}" class="btn">Back to My Reports</a>
  </div>
  <div class="split-layout">
    <!-- Left: Pending list -->
    <div class="panel">
      <h2>Requests</h2>
      <div class="panel-body">
        {% if pending %}
          {% for r in pending %}
            <div class="req-item">
              <a href="?id={{ r.id }}">{{ r.title }}</a>
              <div class="muted">{{ r.user }} · {{ r.get_status_display }} · {{ r.created_at|date:'Y-m-d H:i' }}</div>
            </div>
          {% endfor %}
        {% else %}
          <p class="muted">No pending requests.</p>
        {% endif %}
      </div>
    </div>

    <!-- Middle: Selected + SQL form -->
    <div class="panel">
      <h2>SQL Report</h2>
      <div class="panel-body">
        {% if selected %}
          <div class="mb-2">
            <div class="text-lg">{{ selected.title }}</div>
            <div class="muted">Category: {{ selected.get_category_display }} · From: {{ selected.user }}</div>
            <p class="mt-2">{{ selected.description }}</p>
          </div>
          <form id="previewForm" method="post" action="{% url 'reports:admin_preview_sql' selected.id %}">
            {% csrf_token %}
            {{ sql_form.sql_query.label_tag }}
            {{ sql_form.sql_query }}
            <input type="hidden" name="context_notes" id="preview_context_notes" value="">
            <div class="mt-2">
              <button class="btn" type="submit">Preview</button>
              <a class="btn danger" href="{% url 'reports:admin_delete_request' selected.id %}" onclick="return confirm('Delete this request?');">Delete</a>
            </div>
          </form>

          <form id="saveForm" method="post" action="{% url 'reports:admin_save_sql' selected.id %}" class="mt-3">
            {% csrf_token %}
            <input type="hidden" name="sql_query" id="save_sql_query" value="">
            {{ sql_form.context_notes.label_tag }}
            {{ sql_form.context_notes }}
            <div class="mt-2">
              <button class="btn btn-save" type="submit">Save SQL (mark Completed)</button>
            </div>
          </form>

          {% if preview_columns %}
            <div class="mt-4">
              <h3 class="text-white mb-2">Preview Results (first rows)</h3>
              <div style="max-height: 300px; overflow:auto;">
                <table class="preview">
                  <thead>
                    <tr>
                      {% for c in preview_columns %}<th>{{ c }}</th>{% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in preview_rows %}
                      <tr>
                        {% for v in row %}<td>{{ v }}</td>{% endfor %}
                      </tr>
                    {% empty %}
                    <tr><td class="muted" colspan="99">No rows</td></tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          {% endif %}
        {% else %}
          <p class="muted">Select a request on the left to begin.</p>
        {% endif %}
      </div>
    </div>

    <!-- Right: AI prompts / streaming -->
    <div class="panel">
      <h2>AI Prompts</h2>
      <div class="panel-body">
        <div class="mb-3 p-3 bg-gray-900 rounded">
          <div id="globalModelStatus" class="text-sm {% if not global_ai_model_info.has_stored_model %}text-yellow-400{% elif global_ai_model_info.needs_update %}text-orange-400{% else %}text-gray-300{% endif %}">
            {% if not global_ai_model_info.has_stored_model %}
              No shared AI model configured. Fallback: {{ global_ai_model_info.fallback_model }}.
            {% elif global_ai_model_info.needs_update %}
              Shared model {{ global_ai_model_info.stored_model }} is flagged for replacement.
            {% else %}
              Shared model: {{ global_ai_model_info.stored_model }}{% if global_ai_model_info.updated_by %} (updated by {{ global_ai_model_info.updated_by }}{% if global_ai_model_info.updated_at_display %} on {{ global_ai_model_info.updated_at_display }}{% endif %}){% endif %}.
            {% endif %}
          </div>
          {% if request.user.is_superuser %}
          <div class="mt-2 flex flex-wrap gap-2 items-center">
            <input id="admin-global-model-input" type="text" class="flex-1 md:flex-none rounded border border-gray-600 bg-gray-800 text-gray-100 px-2 py-1" value="{{ global_ai_model_info.stored_model|default:'' }}" placeholder="mistralai/mistral-small:free">
            <label class="flex items-center gap-1 text-sm text-gray-200">
              <input type="checkbox" id="admin-global-model-flag" {% if global_ai_model_info.needs_update %}checked{% endif %}>
              Needs update
            </label>
            <button id="admin-global-model-save" class="btn small btn btn-save" type="button">Save Shared Model</button>
          </div>
          {% endif %}
        </div>
        <div class="mt-2">
          <div class="mb-1">Query type</div>
          {% with ai_cat=selected.category|default:"contract" %}
          <label class="mr-2"><input type="radio" name="aiCategory" value="contract" {% if ai_cat == "contract" %}checked{% endif %}> Contract</label>
          <label class="mr-2"><input type="radio" name="aiCategory" value="supplier" {% if ai_cat == "supplier" %}checked{% endif %}> Supplier</label>
          <label class="mr-2"><input type="radio" name="aiCategory" value="nsn" {% if ai_cat == "nsn" %}checked{% endif %}> NSN</label>
          <label class="mr-2"><input type="radio" name="aiCategory" value="other" {% if ai_cat == "other" %}checked{% endif %}> Other</label>
          {% endwith %}
          <div class="mt-2">
            <label><input id="aiFullSchema" type="checkbox"> Use full DB schema</label>
          </div>
        </div>
        <div class="mt-3">
          <div class="flex items-center justify-between mb-1">
            <label class="block">User prompt</label>
            <button
              id="aiFillFromRequest"
              class="btn"
              type="button"
              {% if not selected %}disabled{% endif %}
              {% if selected %}
                data-title="{{ selected.title|escape }}"
                data-description="{{ selected.description|escape }}"
                data-category="{{ selected.category }}"
              {% endif %}
            >
              Use selected request
            </button>
          </div>
          <textarea id="aiPrompt" rows="6" placeholder="Describe the report to generate SQL...">{% if selected %}{{ selected.title }}{% if selected.description %} - {{ selected.description }}{% endif %}{% endif %}</textarea>
        </div>
        <div class="mt-3">
          <button id="aiStart" class="btn primary" type="button">Start AI</button>
          <button id="aiStop" class="btn" type="button" disabled>Stop</button>
          <button id="aiCopy" class="btn" type="button" disabled>Copy SQL to editor</button>
          <span id="aiStatus" class="muted ml-2"></span>
        </div>
        <div class="mt-3">
          <label class="block mb-1">AI Stream</label>
          <textarea id="aiStream" rows="8" readonly placeholder="Streaming..."></textarea>
        </div>
        <div class="mt-3">
          <label class="block mb-1">Extracted SQL</label>
          <textarea id="aiSql" rows="6" placeholder="Parsed SQL will appear here if detected."></textarea>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function(){
    let es = null;
    const startBtn = document.getElementById('aiStart');
    const stopBtn = document.getElementById('aiStop');
    const copySqlBtn = document.getElementById('aiCopy');
    const copyRequestBtn = document.getElementById('aiFillFromRequest');
    const statusEl = document.getElementById('aiStatus');
    const globalModelStatusEl = document.getElementById('globalModelStatus');
    const globalModelInput = document.getElementById('admin-global-model-input');
    const globalModelFlag = document.getElementById('admin-global-model-flag');
    const globalModelSaveBtn = document.getElementById('admin-global-model-save');
    let globalModelInfo = JSON.parse('{{ global_ai_model_info_json|escapejs }}');

    function getCSRF(){
      const name = 'csrftoken';
      const cookies = document.cookie ? document.cookie.split(';') : [];
      for(const c of cookies){
        const cookie = c.trim();
        if(cookie.startsWith(name + '=')){
          return decodeURIComponent(cookie.substring(name.length + 1));
        }
      }
      return '';
    }

    function renderGlobalModelStatus(info){
      if(!globalModelStatusEl){ return; }
      let text = '';
      let className = 'text-sm text-gray-300';
      if(!info || !info.has_stored_model){
        text = `No shared AI model configured. Fallback: ${info?.fallback_model || 'mistralai/mistral-small:free'}.`;
        className = 'text-sm text-yellow-400';
      } else if(info.needs_update){
        text = `Shared model ${info.stored_model} is flagged for replacement.`;
        className = 'text-sm text-orange-400';
      } else {
        text = `Shared model: ${info.stored_model || info.effective_model}`;
        if(info.updated_by){
          text += ` (updated by ${info.updated_by}`;
          if(info.updated_at_display){ text += ` on ${info.updated_at_display}`; }
          text += ')';
        }
      }
      globalModelStatusEl.textContent = text;
      globalModelStatusEl.className = className;
      if(globalModelFlag){ globalModelFlag.checked = !!info?.needs_update; }
      if(globalModelInput && info?.has_stored_model){
        globalModelInput.value = info.stored_model;
      }
    }

    renderGlobalModelStatus(globalModelInfo);

    globalModelSaveBtn?.addEventListener('click', function(){
      const payload = {
        model: (globalModelInput?.value || '').trim(),
        needs_update: globalModelFlag?.checked ?? false,
      };
      fetch('{% url "suppliers:global_ai_model_config" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRF(),
        },
        body: JSON.stringify(payload),
      })
        .then(async (resp) => {
          const data = await resp.json().catch(() => ({}));
          if (!resp.ok || !data.ok) {
            const msg = data.error || data.message || 'Failed to save shared model.';
            throw new Error(msg);
          }
          return data;
        })
        .then((data) => {
          globalModelInfo = data.info;
          renderGlobalModelStatus(globalModelInfo);
          alert(data.message || 'Shared model saved.');
        })
        .catch((err) => alert(err.message || 'Unable to save shared model.'));
    });
    function category(){
      const el = document.querySelector('input[name="aiCategory"]:checked');
      return el ? el.value : 'other';
    }
    function extractSQL(text){
      const fence = text.match(/```(?:sql)?\s*([\s\S]*?)```/i);
      if (fence) return fence[1].trim();
      const sel = text.match(/(select[\s\S]+?)(?:;|$)/i);
      return sel ? sel[1].trim() : '';
    }
    function setRunning(running){
      if(running){
        startBtn.setAttribute('disabled','disabled');
        stopBtn.removeAttribute('disabled');
        statusEl.textContent = 'Running...';
      } else {
        startBtn.removeAttribute('disabled');
        stopBtn.setAttribute('disabled','disabled');
        statusEl.textContent = '';
      }
    }
    function start(){
      const prompt = document.getElementById('aiPrompt').value.trim();
      const streamEl = document.getElementById('aiStream');
      const sqlEl = document.getElementById('aiSql');
      streamEl.value = '';
      sqlEl.value = '';
      if(!prompt){ alert('Enter a prompt'); return; }
      setRunning(true);
      const url = new URL('{% url 'reports:admin_ai_stream' %}', window.location.origin);
      url.searchParams.set('prompt', prompt);
      url.searchParams.set('category', category());
      if(document.getElementById('aiFullSchema').checked){ url.searchParams.set('full','1'); }
      es = new EventSource(url);
      es.onmessage = (e) => {
        try { var data = JSON.parse(e.data); } catch{ return; }
        if(data.type === 'token'){
          streamEl.value += data.text;
          streamEl.scrollTop = streamEl.scrollHeight;
          const maybe = extractSQL(streamEl.value);
          if(maybe){ sqlEl.value = maybe; copySqlBtn.removeAttribute('disabled'); }
        } else if(data.type === 'status'){ /* status */ }
        else if(data.type === 'done'){ es && es.close(); es=null; setRunning(false); }
        else if(data.type === 'error' || data.error){
          const msg = data.message || data.error || 'Unknown error';
          streamEl.value += "\n[Error] " + msg;
          stop();
        }
      };
      es.onerror = () => { es && es.close(); es=null; setRunning(false); };
    }
    function stop(){ if(es){ es.close(); es=null; } setRunning(false); }
    function showToast(msg){
      if (window.notify) {
        window.notify('info', msg);
      }
    }
    function copy(){
      const sql = document.getElementById('aiSql').value.trim();
      const editor = document.getElementById('id_sql_query');
      if(editor){ editor.value = sql || document.getElementById('aiStream').value; showToast('SQL copied to editor'); }
    }
    function selectedRequestMeta(){
      if(!copyRequestBtn){ return null; }
      return {
        title: copyRequestBtn.getAttribute('data-title') || '',
        description: copyRequestBtn.getAttribute('data-description') || '',
        category: copyRequestBtn.getAttribute('data-category') || '',
      };
    }
    function applyRequestToAI(showToastMessage){
      const meta = selectedRequestMeta();
      if(!meta){ return; }
      const parts = [];
      if(meta.title){ parts.push(meta.title); }
      if(meta.description){ parts.push(meta.description); }
      const prompt = parts.join(' - ').trim();
      const promptEl = document.getElementById('aiPrompt');
      if(prompt && promptEl){ promptEl.value = prompt; }
      const radio = meta.category ? document.querySelector(`input[name="aiCategory"][value="${meta.category}"]`) : null;
      if(radio){ radio.checked = true; }
      if(showToastMessage){ showToast('Request copied to AI prompt'); }
    }
    // Copy context notes into hidden field when previewing to preserve text
    const previewForm = document.getElementById('previewForm');
    if(previewForm){
      previewForm.addEventListener('submit', function(){
        const src = document.getElementById('id_context_notes');
        const dest = document.getElementById('preview_context_notes');
        if(src && dest){ dest.value = src.value; }
      });
    }

    startBtn.addEventListener('click', start);
    stopBtn.addEventListener('click', stop);
    copySqlBtn.addEventListener('click', copy);
    if(copyRequestBtn){
      copyRequestBtn.addEventListener('click', function(){ applyRequestToAI(true); });
      // Prefill AI panel when a request is selected so the admin can start immediately.
      if(selectedRequestMeta().title || selectedRequestMeta().description){ applyRequestToAI(false); }
    }

    // Ensure SQL from the editor is included when saving
    const saveForm = document.getElementById('saveForm');
    if(saveForm){
      saveForm.addEventListener('submit', function(){
        const editor = document.getElementById('id_sql_query');
        const hidden = document.getElementById('save_sql_query');
        if(editor && hidden){ hidden.value = editor.value; }
      });
    }
  })();
</script>
{% endblock %}
