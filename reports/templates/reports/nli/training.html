{% extends "base_template.html" %}
{% load static %}

{% block title %}NLI Training Interface{% endblock %}

{% block extra_css %}
<style>
    .query-card {
        transition: all 0.3s ease;
    }
    .query-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    .status-badge {
        @apply px-2 py-1 rounded-full text-xs font-semibold;
    }
    .status-success {
        @apply bg-green-100 text-green-800;
    }
    .status-error {
        @apply bg-red-100 text-red-800;
    }
    .status-pending {
        @apply bg-yellow-100 text-yellow-800;
    }
    .sql-editor {
        font-family: 'Consolas', 'Monaco', monospace;
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 1rem;
        border-radius: 4px;
        min-height: 200px;
    }
    
    .verified-badge {
        @apply bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-semibold;
    }
    
    .copy-button {
        @apply absolute top-2 right-2 bg-gray-700 text-white px-2 py-1 rounded text-sm;
    }
    
    .sql-container {
        @apply relative;
    }
</style>
{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold">NLI Training Interface</h1>
        <div class="flex space-x-4">
            <button id="showStats" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                Show Statistics
            </button>
            <button id="refreshQueries" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                Refresh Queries
            </button>
            <button id="deleteAllQueries" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                Delete All Queries
            </button>
        </div>
    </div>

    <!-- Confirmation Modal for Delete All -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Delete All Queries</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Are you sure you want to delete all query logs? This action cannot be undone.
                    </p>
                </div>
                <div class="flex justify-center space-x-4 mt-4">
                    <button id="confirmDelete" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Yes, Delete All
                    </button>
                    <button class="close-modal px-4 py-2 border rounded text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="statsModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Learning Statistics</h2>
                <button class="close-modal text-gray-600 hover:text-gray-800">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div id="statsContent" class="space-y-4">
                <!-- Statistics will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Query List -->
    <div id="queryList" class="space-y-6">
        <!-- Query cards will be inserted here -->
    </div>

    <!-- Query Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Edit Query</h2>
                <button class="close-modal text-gray-600 hover:text-gray-800">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <form id="queryEditForm" class="space-y-4">
                <input type="hidden" id="editQueryId" name="query_id">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700">Original Query</label>
                    <p id="originalQuery" class="mt-1 p-2 bg-gray-50 rounded"></p>
                </div>

                <div>
                    <label for="correctedQuery" class="block text-sm font-medium text-gray-700">Corrected Query</label>
                    <input type="text" id="correctedQuery" name="corrected_query" 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <div>
                    <label for="fieldMappings" class="block text-sm font-medium text-gray-700">Field Mappings</label>
                    <textarea id="fieldMappings" name="field_mappings" rows="4"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            placeholder='{"natural_term": "database_field"}'></textarea>
                </div>

                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Training Notes</label>
                    <textarea id="notes" name="notes" rows="3"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" class="close-modal px-4 py-2 border rounded text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- SQL Verification Modal -->
    <div id="sqlModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
        <div class="relative top-20 mx-auto p-5 border w-3/4 shadow-lg rounded-md bg-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">SQL Verification</h2>
                <button class="close-modal text-gray-600 hover:text-gray-800">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Original Query</label>
                    <p id="originalQuery" class="mt-1 p-2 bg-gray-50 rounded"></p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Generated SQL</label>
                    <div class="sql-container">
                        <pre id="generatedSQL" class="sql-editor"></pre>
                        <button class="copy-button" onclick="copySQL('generatedSQL')">Copy</button>
                    </div>
                </div>

                <div>
                    <label for="verifiedSQL" class="block text-sm font-medium text-gray-700">Verified SQL from SSMS</label>
                    <div class="sql-container">
                        <textarea id="verifiedSQL" name="verified_sql" rows="6"
                                class="sql-editor w-full"
                                placeholder="Paste the correct SQL query from SSMS here..."></textarea>
                    </div>
                </div>

                <div>
                    <label for="ormTranslation" class="block text-sm font-medium text-gray-700">Django ORM Translation</label>
                    <textarea id="ormTranslation" name="orm_translation" rows="4"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                            placeholder="The system will attempt to translate the SQL to Django ORM..."></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" class="close-modal px-4 py-2 border rounded text-gray-700 hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="button" id="verifySQLButton" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        Verify SQL
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


{% block extra_js %}
<script>
// Define utility functions first
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 p-4 rounded-lg text-white ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function loadQueries() {
    fetch('/reports/nli/training/queries/', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && Array.isArray(data.queries)) {
            document.getElementById('queryList').innerHTML = data.queries.map(query => createQueryCard(query)).join('');
            // Add event listeners to new cards
            attachCardListeners();
        } else {
            throw new Error('Invalid response format');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('queryList').innerHTML = '<div class="p-4 bg-red-100 text-red-700 rounded">Error loading queries: ' + error.message + '</div>';
    });
}

function createQueryCard(query) {
    return `
        <div class="query-card bg-white p-6 rounded-lg shadow-md" data-query-id="${query.id}">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-lg font-semibold">${query.raw_query}</h3>
                    <p class="text-sm text-gray-500">${new Date(query.timestamp).toLocaleString()}</p>
                </div>
                <span class="status-badge ${getStatusClass(query.status)}">
                    ${query.status}
                </span>
            </div>
            <div class="space-y-2">
                <p class="text-sm"><strong>Parsed Fields:</strong> ${JSON.stringify(query.parsed_fields)}</p>
                <p class="text-sm"><strong>Success:</strong> ${query.was_successful ? 'Yes' : 'No'}</p>
                ${query.error_message ? `<p class="text-sm text-red-600"><strong>Error:</strong> ${query.error_message}</p>` : ''}
            </div>
            <div class="mt-4 flex justify-end space-x-3">
                <button class="edit-query px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    Edit
                </button>
                <button class="mark-correct px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600" 
                        ${query.was_successful ? 'disabled' : ''}>
                    Mark Correct
                </button>
                <button class="verify-sql px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                        data-query-id="${query.id}">
                    Verify SQL
                </button>
            </div>
            ${query.sql_verified ? '<span class="verified-badge">SQL Verified</span>' : ''}
        </div>
    `;
}

function getStatusClass(status) {
    switch (status.toLowerCase()) {
        case 'success': return 'status-success';
        case 'error': return 'status-error';
        default: return 'status-pending';
    }
}

function attachCardListeners() {
    // Add event listeners to edit buttons
    document.querySelectorAll('.edit-query').forEach(button => {
        button.addEventListener('click', function() {
            const queryId = this.closest('.query-card').dataset.queryId;
            showEditModal(queryId);
        });
    });

    // Add event listeners to mark correct buttons
    document.querySelectorAll('.mark-correct').forEach(button => {
        button.addEventListener('click', function() {
            const queryId = this.closest('.query-card').dataset.queryId;
            markQueryCorrect(queryId);
        });
    });

    // Add event listeners to verify SQL buttons
    document.querySelectorAll('.verify-sql').forEach(button => {
        button.addEventListener('click', function() {
            const queryId = this.closest('.query-card').dataset.queryId;
            showSQLModal(queryId);
        });
    });
}

// Define modal-related functions
function showSQLModal(queryId) {
    fetch(`/reports/nli/training/query/${queryId}/`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('editQueryId').value = queryId; // Store the query ID
        document.getElementById('originalQuery').textContent = data.raw_query;
        document.getElementById('generatedSQL').textContent = data.generated_sql || 'No SQL generated';
        document.getElementById('verifiedSQL').value = data.verified_sql || '';
        document.getElementById('ormTranslation').value = data.orm_translation || '';
        document.getElementById('sqlModal').classList.remove('hidden');
    })
    .catch(error => {
        console.error('Error loading SQL details:', error);
        showNotification('Error loading SQL details: ' + error.message, 'error');
    });
}

function verifySQL() {
    const queryId = document.getElementById('editQueryId').value;
    const verifiedSQL = document.getElementById('verifiedSQL').value;
    
    if (!queryId) {
        showNotification('Error: Query ID not found', 'error');
        return;
    }

    if (!verifiedSQL.trim()) {
        showNotification('Please enter the verified SQL query', 'error');
        return;
    }

    fetch(`/reports/nli/training/query/${queryId}/verify-sql/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            verified_sql: verifiedSQL
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || `HTTP error! status: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            document.getElementById('sqlModal').classList.add('hidden');
            loadQueries();  // Refresh the query list
            showNotification(data.message || 'SQL verification saved successfully!', 'success');
            
            // Update ORM translation if provided
            if (data.orm_translation) {
                document.getElementById('ormTranslation').value = data.orm_translation;
            }
        } else {
            throw new Error(data.error || 'Failed to verify SQL');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification(error.message || 'Error saving SQL verification', 'error');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const queryList = document.getElementById('queryList');
    const statsModal = document.getElementById('statsModal');
    const editModal = document.getElementById('editModal');
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const queryEditForm = document.getElementById('queryEditForm');
    const sqlModal = document.getElementById('sqlModal');

    // Load queries on page load
    loadQueries();

    // Refresh button
    document.getElementById('refreshQueries').addEventListener('click', loadQueries);

    // Stats button
    document.getElementById('showStats').addEventListener('click', showStats);

    // Delete All Queries functionality
    document.getElementById('deleteAllQueries').addEventListener('click', function() {
        deleteConfirmModal.classList.remove('hidden');
    });

    document.getElementById('confirmDelete').addEventListener('click', async function() {
        try {
            const response = await fetch('/reports/nli/training/delete-all/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            });

            if (response.ok) {
                // Refresh the query list
                loadQueries();
                // Hide the confirmation modal
                deleteConfirmModal.classList.add('hidden');
                // Show success message
                showNotification('All queries have been deleted successfully', 'success');
            } else {
                throw new Error('Failed to delete queries');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Failed to delete queries: ' + error.message, 'error');
        }
    });

    // Close modals when clicking cancel buttons
    document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', function() {
            statsModal.classList.add('hidden');
            editModal.classList.add('hidden');
            deleteConfirmModal.classList.add('hidden');
            sqlModal.classList.add('hidden');
        });
    });

    // Handle form submission
    queryEditForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitQueryEdit(new FormData(this));
    });

    // Add event listener for verify SQL button
    document.getElementById('verifySQLButton').addEventListener('click', verifySQL);

    function showStats() {
        fetch('/reports/nli/training/stats/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('statsContent').innerHTML = createStatsHTML(data);
            statsModal.classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading statistics');
        });
    }

    function createStatsHTML(stats) {
        return `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">Success Rate</h3>
                    <p class="text-2xl">${stats.success_rate}%</p>
                </div>
                <div class="p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">Total Queries</h3>
                    <p class="text-2xl">${stats.total_queries}</p>
                </div>
                <div class="p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">Common Errors</h3>
                    <ul class="list-disc list-inside">
                        ${stats.common_errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                </div>
                <div class="p-4 bg-gray-50 rounded">
                    <h3 class="font-semibold mb-2">Field Mappings Learned</h3>
                    <p class="text-sm">${JSON.stringify(stats.field_mappings, null, 2)}</p>
                </div>
            </div>
        `;
    }

    function showEditModal(queryId) {
        fetch(`/reports/nli/training/query/${queryId}/`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('editQueryId').value = queryId;
            document.getElementById('originalQuery').textContent = data.raw_query;
            document.getElementById('correctedQuery').value = data.corrected_query || '';
            document.getElementById('fieldMappings').value = JSON.stringify(data.field_mappings || {}, null, 2);
            document.getElementById('notes').value = data.notes || '';
            editModal.classList.remove('hidden');
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading query details');
        });
    }

    function submitQueryEdit(formData) {
        const queryId = formData.get('query_id');
        fetch(`/reports/nli/training/query/${queryId}/update/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                editModal.classList.add('hidden');
                loadQueries();  // Refresh the query list
                alert('Query updated successfully');
            } else {
                alert('Error updating query: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating query');
        });
    }

    function markQueryCorrect(queryId) {
        fetch(`/reports/nli/training/query/${queryId}/mark-correct/`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadQueries();  // Refresh the query list
                alert('Query marked as correct');
            } else {
                alert('Error marking query as correct: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error marking query as correct');
        });
    }

    function copySQL(elementId) {
        const sqlText = document.getElementById(elementId).textContent;
        navigator.clipboard.writeText(sqlText);
        // Show a brief "Copied!" message
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        setTimeout(() => button.textContent = originalText, 2000);
    }
});
</script>
{% endblock %} 
{% endblock %}