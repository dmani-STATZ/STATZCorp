{% extends "base_template.html" %}
{% load static %}

{% block title %}Natural Language Query Interface{% endblock %}

{% block extra_css %}
<style>
    .query-suggestions {
        display: none;
        position: absolute;
        width: 100%;
        max-height: 200px;
        overflow-y: auto;
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        z-index: 10;
    }

    .query-suggestion {
        padding: 0.5rem 1rem;
        cursor: pointer;
    }

    .query-suggestion:hover {
        background-color: #f7fafc;
    }

    .results-table th {
        position: sticky;
        top: 0;
        background-color: #f8fafc;
        z-index: 1;
    }
</style>
{% endblock %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-4">Natural Language Query Interface</h1>
        <p class="text-gray-600 mb-4">
            Ask questions about your contracts data in plain English. For example:
        </p>
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <ul class="list-disc list-inside space-y-2 text-gray-700">
                <li>"Show all contracts"</li>
                <li>"Show contracts where contract_value is greater than 10000"</li>
                <li>"Count contracts by status"</li>
                <li>"Show contracts where due_date is less than 2024-04-30"</li>
                <li>"Show contracts where contract_value is greater than 50000 and status is open"</li>
                <li>"Show contracts where buyer is DLA Land"</li>
            </ul>
        </div>
        <!-- <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <h2 class="text-lg font-semibold mb-2">Available Fields:</h2>
            <p class="text-sm text-gray-600 mb-2">You can query using any of these fields:</p>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 text-sm">
                <div class="p-2 bg-white rounded shadow-sm">contract_number</div>
                <div class="p-2 bg-white rounded shadow-sm">contract_value</div>
                <div class="p-2 bg-white rounded shadow-sm">contract_type</div>
                <div class="p-2 bg-white rounded shadow-sm">status</div>
                <div class="p-2 bg-white rounded shadow-sm">buyer</div>
                <div class="p-2 bg-white rounded shadow-sm">due_date</div>
                <div class="p-2 bg-white rounded shadow-sm">award_date</div>
                <div class="p-2 bg-white rounded shadow-sm">po_number</div>
            </div>
        </div> -->
    </div>

    <div class="mb-8">
        <form id="queryForm" class="space-y-4">
            <div class="relative">
                <label for="query" class="block text-sm font-medium text-gray-700 mb-2">
                    Enter your query:
                </label>
                <input type="text" id="query" name="query"
                    class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                    placeholder="Type your question here...">
                <div id="suggestions" class="query-suggestions"></div>
            </div>
            <div class="flex space-x-4">
                <button type="submit"
                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Run Query
                </button>
                <button type="button" id="exportExcel" 
                    class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 hidden">
                    Export to Excel
                </button>
            </div>
        </form>
    </div>

    <div id="query-results" class="mt-4">
        <h2 class="text-xl font-bold mb-2">Query Results</h2>
        
        <div id="results" class="overflow-x-auto">
            <!-- Results Summary -->
            <p id="resultsSummary" class="text-sm text-gray-600 mb-2"></p>
            
            <!-- Results Table -->
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr id="resultsHeader"></tr>
                </thead>
                <tbody id="resultsBody" class="bg-white divide-y divide-gray-200">
                    <!-- Results rows will be inserted here -->
                </tbody>
            </table>
            
            <!-- Pagination -->
            <div class="flex items-center justify-between mt-4">
                <!-- Mobile pagination -->
                <div class="flex flex-1 justify-between sm:hidden">
                    <button id="prevPageMobile" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Previous
                    </button>
                    <button id="nextPageMobile" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Next
                    </button>
                </div>
                
                <!-- Desktop pagination -->
                <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                    <div>
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                            <button id="prevPage" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Previous</span>
                                <!-- Heroicon name: solid/chevron-left -->
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            
                            <div id="pageNumbers" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                                <!-- Page numbers will be inserted here -->
                            </div>
                            
                            <button id="nextPage" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                <span class="sr-only">Next</span>
                                <!-- Heroicon name: solid/chevron-right -->
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Feedback Section -->
        <div class="feedback-section mt-4">
            <button id="feedback-btn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                Report Incorrect Results
            </button>
            
            <div id="feedback-form" class="hidden mt-4 p-4 border rounded">
                <h3 class="text-lg font-semibold mb-2">Submit Feedback</h3>
                <textarea id="feedback-text" class="w-full p-2 border rounded" rows="3" 
                          placeholder="Please explain what is incorrect about these results..."></textarea>
                <input type="hidden" id="query-id" value="">
                <button id="submit-feedback" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Submit Feedback
                </button>
            </div>
        </div>
    </div>

    <div id="error" class="hidden mt-4 bg-red-50 border-l-4 border-red-400 p-4">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p id="errorMessage" class="text-sm text-red-700"></p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const queryForm = document.getElementById('queryForm');
        const queryInput = document.getElementById('query');
        const suggestions = document.getElementById('suggestions');
        const results = document.getElementById('results');
        const resultsHeader = document.getElementById('resultsHeader');
        const resultsBody = document.getElementById('resultsBody');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('errorMessage');
        const resultsSummary = document.getElementById('resultsSummary');
        const pageNumbers = document.getElementById('pageNumbers');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const prevPageMobile = document.getElementById('prevPageMobile');
        const nextPageMobile = document.getElementById('nextPageMobile');

        let currentPage = 1;
        let totalPages = 1;
        let currentQuery = '';

        // Updated suggestions based on actual contract fields
        const suggestions_list = [
            "Show all contracts",
            "Show contracts where contract_value is greater than 10000",
            "Count contracts by status",
            "Show contracts where due_date is less than 2024-04-30",
            "Show contracts where contract_value is greater than $50000 and status is open",
            "Show contracts where buyer is DLA Land"
        ];

        function showSuggestions(input) {
            const matchingSuggestions = suggestions_list.filter(s => 
                s.toLowerCase().includes(input.toLowerCase())
            );

            if (matchingSuggestions.length > 0 && input.length > 0) {
                suggestions.innerHTML = matchingSuggestions
                    .map(s => `<div class="query-suggestion">${s}</div>`)
                    .join('');
                suggestions.style.display = 'block';
            } else {
                suggestions.style.display = 'none';
            }
        }

        queryInput.addEventListener('input', (e) => {
            showSuggestions(e.target.value);
        });

        suggestions.addEventListener('click', (e) => {
            if (e.target.classList.contains('query-suggestion')) {
                queryInput.value = e.target.textContent;
                suggestions.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (!suggestions.contains(e.target) && e.target !== queryInput) {
                suggestions.style.display = 'none';
            }
        });

        function displayResults(data) {
            if (!data.success) {
                error.classList.remove('hidden');
                errorMessage.textContent = data.error;
                results.classList.add('hidden');
                document.getElementById('exportExcel').classList.add('hidden');
                return;
            }

            error.classList.add('hidden');
            results.classList.remove('hidden');

            // Show export button if we have results
            const exportButton = document.getElementById('exportExcel');
            if (data.results && data.results.length > 0) {
                exportButton.classList.remove('hidden');
            } else {
                exportButton.classList.add('hidden');
            }

            // Update pagination info
            currentPage = data.current_page;
            totalPages = data.total_pages;
            updatePagination();

            // Clear previous results
            resultsHeader.innerHTML = '';
            resultsBody.innerHTML = '';

            if (data.results.length === 0) {
                resultsBody.innerHTML = `
                    <tr>
                        <td colspan="100%" class="px-6 py-4 text-center text-gray-500">
                            No results found
                        </td>
                    </tr>
                `;
                return;
            }

            // Create table headers
            const headers = Object.keys(data.results[0]);
            resultsHeader.innerHTML = headers
                .map(header => `
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ${header}
                    </th>
                `)
                .join('');

            // Create table rows
            resultsBody.innerHTML = data.results
                .map(row => `
                    <tr>
                        ${headers.map(header => `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                ${row[header] !== null ? row[header] : ''}
                            </td>
                        `).join('')}
                    </tr>
                `)
                .join('');

            // Update results summary
            const start = (currentPage - 1) * 10 + 1;
            const end = Math.min(currentPage * 10, data.total_count);
            resultsSummary.textContent = `Showing ${start} to ${end} of ${data.total_count} results`;
        }

        function updatePagination() {
            prevPage.disabled = currentPage === 1;
            nextPage.disabled = currentPage === totalPages;
            prevPageMobile.disabled = currentPage === 1;
            nextPageMobile.disabled = currentPage === totalPages;

            pageNumbers.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                if (
                    i === 1 || 
                    i === totalPages || 
                    (i >= currentPage - 2 && i <= currentPage + 2)
                ) {
                    const button = document.createElement('button');
                    button.className = `relative inline-flex items-center px-4 py-2 border text-sm font-medium
                        ${i === currentPage 
                            ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' 
                            : 'bg-white border-gray-300 text-gray-700 hover:bg-gray-50'}`;
                    button.textContent = i;
                    button.onclick = () => fetchPage(i);
                    pageNumbers.appendChild(button);
                } else if (
                    (i === currentPage - 3 && currentPage > 4) ||
                    (i === currentPage + 3 && currentPage < totalPages - 3)
                ) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700';
                    ellipsis.textContent = '...';
                    pageNumbers.appendChild(ellipsis);
                }
            }
        }

        function fetchPage(page) {
            const formData = new FormData();
            formData.append('query', currentQuery);
            formData.append('page', page);

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.json())
            .then(data => displayResults(data))
            .catch(error => {
                console.error('Error:', error);
                displayError('An error occurred while fetching results.');
            });
        }

        prevPage.onclick = () => {
            if (currentPage > 1) {
                fetchPage(currentPage - 1);
            }
        };

        nextPage.onclick = () => {
            if (currentPage < totalPages) {
                fetchPage(currentPage + 1);
            }
        };

        prevPageMobile.onclick = prevPage.onclick;
        nextPageMobile.onclick = nextPage.onclick;

        queryForm.onsubmit = (e) => {
            e.preventDefault();
            currentQuery = queryInput.value;
            fetchPage(1);
        };

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function displayError(message) {
            error.classList.remove('hidden');
            errorMessage.textContent = message;
            results.classList.add('hidden');
        }

        document.getElementById('feedback-btn').addEventListener('click', function() {
            document.getElementById('feedback-form').classList.toggle('hidden');
        });

        document.getElementById('submit-feedback').addEventListener('click', function() {
            const feedback = document.getElementById('feedback-text').value;
            const queryId = document.getElementById('query-id').value;
            
            if (!feedback) {
                alert('Please provide feedback before submitting.');
                return;
            }
            
            // Send feedback to server
            fetch('/reports/nli/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    feedback: feedback,
                    query_id: queryId
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Server error occurred');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Thank you for your feedback! The system will learn from this.');
                    document.getElementById('feedback-form').classList.add('hidden');
                    document.getElementById('feedback-text').value = '';
                } else {
                    throw new Error(data.error || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting feedback: ' + error.message);
            });
        });

        // Update query ID when results are loaded
        function updateQueryId(queryId) {
            document.getElementById('query-id').value = queryId;
        }

        // Add export functionality
        document.getElementById('exportExcel').addEventListener('click', function() {
            const formData = new FormData();
            formData.append('query', currentQuery);
            formData.append('export', 'excel');

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'query_results.xlsx';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error exporting to Excel. Please try again.');
            });
        });
    });
</script>
{% endblock %} 