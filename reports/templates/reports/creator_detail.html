{% extends "reports/base.html" %}
{% load static %}

{% block reports_title %}Process Report Request{% endblock %}

{% block reports_subtitle %}
<p class="text-gray-600 mt-2">{{ object.generated_name }}</p>
{% endblock %}

{% block reports_content %}
<div class="space-y-8">
    <!-- Request Details -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Request Details</h2>
        <dl class="grid grid-cols-1 gap-x-4 gap-y-6 sm:grid-cols-2">
            <div>
                <dt class="text-sm font-medium text-gray-500">Requested By</dt>
                <dd class="mt-1 text-sm text-gray-900">
                    {{ object.user.get_full_name|default:object.user.username }}<br>
                    <span class="text-gray-500">{{ object.user.email }}</span>
                </dd>
            </div>
            <div>
                <dt class="text-sm font-medium text-gray-500">Request Date</dt>
                <dd class="mt-1 text-sm text-gray-900">{{ object.created_at|date:"M d, Y H:i" }}</dd>
            </div>
            <div class="sm:col-span-2">
                <dt class="text-sm font-medium text-gray-500">Request Description</dt>
                <dd class="mt-1 text-sm text-gray-900 whitespace-pre-wrap">{{ object.request_text }}</dd>
            </div>
        </dl>
    </div>

    <!-- Status Update Form -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Update Status</h2>
        <form method="post" class="space-y-4">
            {% csrf_token %}
            <div>
                <label for="id_status" class="block text-sm font-medium text-gray-700">Status</label>
                <select name="status" id="id_status" 
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    {% for value, label in object.STATUS_CHOICES %}
                    <option value="{{ value }}" {% if object.status == value %}selected{% endif %}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_assigned_to" class="block text-sm font-medium text-gray-700">Assigned To</label>
                <select name="assigned_to" id="id_assigned_to"
                        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                    <option value="">Not Assigned</option>
                    {% for user in user_list %}
                    <option value="{{ user.id }}" {% if object.assigned_to_id == user.id %}selected{% endif %}>
                        {{ user.get_full_name|default:user.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    Update Status
                </button>
            </div>
        </form>
    </div>

    <!-- SQL Query Form -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Report SQL</h2>
        <form method="post" class="space-y-4">
            {% csrf_token %}
            <div>
                <label for="sql_query" class="block text-sm font-medium text-gray-700">SQL Query</label>
                <textarea name="sql_query" id="sql_query" rows="10"
                    class="mt-1 block w-full shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm border border-gray-300 rounded-md font-mono"
                    placeholder="Enter the SQL query that will generate this report...">{{ report_form.sql_query }}</textarea>
            </div>
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700">Report Description</label>
                <textarea name="description" id="description" rows="3"
                    class="mt-1 block w-full shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm border border-gray-300 rounded-md"
                    placeholder="Provide a description of what this report shows...">{{ report_form.description }}</textarea>
            </div>
            <div class="flex justify-end">
                <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                    {% if report_form.sql_query %}Update Report{% else %}Create Report{% endif %}
                </button>
            </div>
        </form>
    </div>

    {% if object.completed_report %}
    <!-- Change Requests -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Change Requests</h2>
        {% with changes=object.completed_report.change_requests.all %}
        {% if changes %}
        <div class="space-y-4">
            {% for change in changes %}
            <div class="border-l-4 {% if change.status == 'pending' %}border-yellow-400{% elif change.status == 'completed' %}border-green-400{% else %}border-gray-200{% endif %} pl-4">
                <div class="text-sm text-gray-900">{{ change.change_text }}</div>
                <div class="mt-1 text-xs text-gray-500">
                    Requested by {{ change.user.get_full_name|default:change.user.username }}
                    on {{ change.created_at|date:"M d, Y" }}
                </div>
                <div class="mt-1">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                        {% if change.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% elif change.status == 'completed' %}bg-green-100 text-green-800
                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ change.get_status_display }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-600">No change requests yet.</p>
        {% endif %}
        {% endwith %}
    </div>
    {% endif %}
</div>
{% endblock %} 