{% extends "base_template.html" %}
{% load static %}
{% load report_filters %}

{% block body %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">{{ report.name }}</h1>
        <div class="flex space-x-4">
            <a href="{% url 'reporting:export_report' report.id %}" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded inline-flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Export to Excel
            </a>
            <a href="{% url 'reporting:edit_report' report.id %}" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded inline-flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit Report
            </a>
            <a href="{% url 'reporting:report_list' %}" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded inline-flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12"></path>
                </svg>
                Back to Reports
            </a>
        </div>
    </div>

    <!-- Aggregation Results -->
    {% if aggregation_results %}
    <div class="mb-4 border rounded-lg p-4 bg-gray-50">
        <h2 class="text-lg font-semibold mb-2">Totals and Aggregations</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            {% for field, result in aggregation_results.items %}
            <div class="p-3 bg-white rounded shadow">
                <div class="text-sm text-gray-600">{{ result.label }}</div>
                <div class="text-lg font-semibold">
                    {% if result.value|stringformat:"s"|slice:":1" == "-" %}
                        {{ result.value|stringformat:"s"|slice:"1:" }}
                    {% else %}
                        {{ result.value }}
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if group_fields %}
    <!-- Grouped Data Display -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border rounded-lg">
            <thead>
                <tr class="bg-gray-100">
                    {% for field in group_fields %}
                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">
                        {{ field|get_field_label:field_labels }}
                    </th>
                    {% endfor %}
                    {% for field_path, config in aggregation_info.items %}
                    <th class="px-4 py-2 text-right text-sm font-semibold text-gray-600">
                        {{ config.label|default:field_path }}
                    </th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr class="border-t hover:bg-gray-50">
                    {% for field in group_fields %}
                    <td class="px-4 py-2">{{ row|get_item:field }}</td>
                    {% endfor %}
                    {% for field_path, config in aggregation_info.items %}
                    <td class="px-4 py-2 text-right">
                        {% with agg_value=row|get_item:field_path|add:"_"|add:config.type %}
                        {% if config.type == "count" %}
                            {{ agg_value|default:"0" }}
                        {% else %}
                            {{ agg_value|floatformat:2 }}
                        {% endif %}
                        {% endwith %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            <tfoot class="bg-gray-100 font-semibold">
                <tr>
                    {% for field in group_fields %}
                    {% if forloop.first %}
                    <td class="px-4 py-2">Grand Total</td>
                    {% else %}
                    <td></td>
                    {% endif %}
                    {% endfor %}
                    {% for field_path, config in aggregation_info.items %}
                    <td class="px-4 py-2 text-right">
                        {% with total=results|calculate_total:field_path %}
                        {% if config.type == "count" %}
                            {{ total|default:"0" }}
                        {% else %}
                            {{ total|floatformat:2 }}
                        {% endif %}
                        {% endwith %}
                    </td>
                    {% endfor %}
                </tr>
            </tfoot>
        </table>
    </div>
    {% else %}
    <!-- Regular Data Display -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white border rounded-lg">
            <thead>
                <tr class="bg-gray-100">
                    {% for field_label in field_labels %}
                    <th class="px-4 py-2 text-left text-sm font-semibold text-gray-600">{{ field_label.label }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr class="border-t hover:bg-gray-50">
                    {% for field_label in field_labels %}
                    <td class="px-4 py-2">{{ row|get_item:field_label.name }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <!-- Pagination -->
    {% if is_paginated %}
    <div class="mt-4 flex justify-between items-center">
        <div class="text-sm text-gray-600">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ paginator.count }} entries
        </div>
        <div class="space-x-2">
            {% if page_obj.has_previous %}
            <a href="?page=1" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">&laquo; First</a>
            <a href="?page={{ page_obj.previous_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Previous</a>
            {% endif %}
            
            <span class="px-3 py-1">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">Last &raquo;</a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %} 