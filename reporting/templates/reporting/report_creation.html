{% extends "base_template.html" %}
{% load static %}

{% block body %}
<style>
    /* Field dropdown styling */
    select option {
        padding: 4px 8px;
    }
    
    select optgroup {
        font-weight: 600;
        color: #4B5563;
        background-color: #F3F4F6;
    }
    
    select option.text-blue-600 {
        color: #2563EB;
        font-style: italic;
    }
    
    /* Improve readability of field dropdowns */
    select[multiple] {
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }
    
    /* Add spacing between optgroups */
    select optgroup + optgroup {
        margin-top: 8px;
    }
</style>

<div class="container mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-8">{% if is_edit %}Edit Report{% else %}Create New Report{% endif %}</h1>
    
    <!-- Messages Area -->
    <div id="messages" class="hidden mb-4">
        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4"></div>
    </div>
    
    <form id="reportForm" method="post" class="space-y-8">
        {% csrf_token %}
        
        <!-- Report Name -->
        <div class="mb-4">
            <label for="{{ form.report_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Report Name</label>
            {{ form.report_name }}
        </div>
        
        <!-- Hidden Fields -->
        {{ form.selected_tables }}
        {{ form.selected_fields }}
        {{ form.filters }}
        {{ form.sort_by }}
        {{ form.sort_direction }}

        <!-- CRITICAL: Ensure aggregations and group_by fields are properly defined -->
        <input type="hidden" id="id_aggregations" name="aggregations" value="{{ report.aggregations|default:'{}' }}">
        <input type="hidden" id="id_group_by" name="group_by" value="{{ report.group_by|default:'{}' }}">

        <!-- Initialize data for JavaScript -->
        <script>
            console.log('Initializing report data');
            window.initialData = {
                selectedTables: "{{ report.selected_tables|default:'[]'|safe }}",
                selectedFields: "{{ report.selected_fields|default:'{}'|safe }}",
                filters: "{{ report.filters|default:'[]'|safe }}",
                sortBy: "{{ report.sort_by|default:'{}'|safe }}",
                sortDirection: '{{ report.sort_direction|default:"asc" }}',
                aggregations: "{{ report.aggregations|default:'{}'|safe }}",
                groupBy: "{{ report.group_by|default:'{}'|safe }}"
            };
            console.log('Initial data:', window.initialData);
        </script>

        <!-- Table Selection -->
        <div class="grid grid-cols-3 gap-4 mb-8">
            <!-- Available Tables -->
            <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-2">Available Tables</h3>
                <select id="availableTables" multiple class="w-full h-64 border rounded p-2">
                    {% for table in available_tables %}
                        <option value="{{ table.name }}">{{ table.verbose_name }}</option>
                    {% endfor %}
                </select>
                <p class="text-sm text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
            </div>
            
            <!-- Move Buttons -->
            <div class="flex flex-col items-center justify-center space-y-4">
                <button type="button" id="addTable" class="w-20 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                    →
                </button>
                <button type="button" id="removeTable" class="w-20 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    ←
                </button>
            </div>
            
            <!-- Selected Tables -->
            <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-2">Selected Tables</h3>
                <select id="selectedTables" multiple class="w-full h-64 border rounded p-2"></select>
                <p class="text-sm text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
            </div>
        </div>

        <!-- Field Selection -->
        <div class="grid grid-cols-3 gap-4 mb-8">
            <!-- Available Fields -->
            <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-2">Available Fields</h3>
                <div class="mb-2">
                    <input type="text" id="fieldSearch" class="form-input w-full" placeholder="Search fields..." />
                </div>
                <div class="relative">
                    <div id="fieldsLoading" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    </div>
                <select id="availableFields" multiple class="w-full h-64 border rounded p-2"></select>
                </div>
                <p class="text-sm text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
            </div>
            
            <!-- Move Buttons -->
            <div class="flex flex-col items-center justify-center space-y-4">
                <button type="button" id="addField" class="w-20 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    →
                </button>
                <button type="button" id="removeField" class="w-20 bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 disabled:opacity-50 disabled:cursor-not-allowed">
                    ←
                </button>
            </div>
            
            <!-- Selected Fields -->
            <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-2">Selected Fields</h3>
                <select id="selectedFields" multiple class="w-full h-64 border rounded p-2"></select>
                <p class="text-sm text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
            </div>
        </div>

        <!-- Filter Builder Section -->
        <div class="mb-8 border rounded-lg p-4 bg-gray-50">
            <h2 class="text-lg font-semibold mb-4">Filters</h2>
            <div class="grid grid-cols-4 gap-4 items-end">
                <!-- Filter Field -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Field</label>
                    <select id="filterField" class="form-select w-full"></select>
                </div>
                <!-- Operator -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Operator</label>
                    <select id="filterOperator" class="form-select w-full">
                        <!-- Text Operators -->
                        <optgroup label="Text">
                            <option value="equals">Equals</option>
                            <option value="not_equals">Does Not Equal</option>
                            <option value="contains">Contains</option>
                            <option value="not_contains">Does Not Contain</option>
                            <option value="starts_with">Starts With</option>
                            <option value="ends_with">Ends With</option>
                        </optgroup>
                        <!-- Numeric Operators -->
                        <optgroup label="Numeric">
                            <option value="equals">Equals</option>
                            <option value="not_equals">Does Not Equal</option>
                            <option value="gt">Greater Than</option>
                            <option value="gte">Greater Than or Equal</option>
                            <option value="lt">Less Than</option>
                            <option value="lte">Less Than or Equal</option>
                        </optgroup>
                        <!-- Date Operators -->
                        <optgroup label="Date">
                            <option value="equals">Equals</option>
                            <option value="not_equals">Does Not Equal</option>
                            <option value="gt">After</option>
                            <option value="gte">On or After</option>
                            <option value="lt">Before</option>
                            <option value="lte">On or Before</option>
                        </optgroup>
                        <!-- List Operators -->
                        <optgroup label="Lists">
                            <option value="in">In List</option>
                            <option value="not_in">Not In List</option>
                        </optgroup>
                        <!-- Null Operators -->
                        <optgroup label="Null">
                            <option value="is_null">Is Empty</option>
                            <option value="is_not_null">Is Not Empty</option>
                        </optgroup>
                    </select>
                </div>
                <!-- Value Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                    <input type="text" id="filterValue" class="form-input w-full" autocomplete="off">
                    <input type="date" id="filterDateValue" class="form-input w-full hidden" autocomplete="off">
                    <input type="datetime-local" id="filterDateTimeValue" class="form-input w-full hidden" autocomplete="off">
                    <input type="number" id="filterNumberValue" class="form-input w-full hidden" step="any" autocomplete="off">
                    <select id="filterValueDropdown" class="form-select w-full mt-1 hidden"></select>
                    <div class="text-xs text-gray-500 mt-1" id="filterValueHint"></div>
                </div>
                <!-- Add/Update Button -->
                <div>
                    <button type="button" id="addFilterBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full">Add Filter</button>
                </div>
            </div>
            <!-- Current Filters List -->
            <div class="mt-6">
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Filters</label>
                <select id="currentFilters" size="4" class="w-full border rounded p-2"></select>
                <div class="flex space-x-2 mt-2">
                    <button type="button" id="editFilterBtn" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
                    <button type="button" id="removeFilterBtn" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">Remove</button>
                </div>
            </div>
        </div>

        <!-- Aggregation Section -->
        <div class="mb-8 border rounded-lg p-4 bg-gray-50">
            <h2 class="text-lg font-semibold mb-4">Aggregations</h2>
            <div class="grid grid-cols-4 gap-4 items-end">
                <!-- Field Selection -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Field</label>
                    <select id="aggregationField" class="form-select w-full">
                        <option value="">Select a field...</option>
                    </select>
                </div>
                <!-- Aggregation Type -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <select id="aggregationType" class="form-select w-full">
                        <optgroup label="Numeric">
                            <option value="sum">Sum</option>
                            <option value="avg">Average</option>
                            <option value="min">Minimum</option>
                            <option value="max">Maximum</option>
                        </optgroup>
                        <optgroup label="General">
                            <option value="count">Count</option>
                        </optgroup>
                    </select>
                </div>
                <!-- Custom Label -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Label (Optional)</label>
                    <input type="text" id="aggregationLabel" class="form-input w-full" placeholder="Custom label for total">
                </div>
                <!-- Add Button -->
                <div>
                    <button type="button" id="addAggregationBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Add Aggregation
                    </button>
                </div>
            </div>
            
            <!-- Current Aggregations -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Aggregations</label>
                <select id="currentAggregations" class="form-select w-full mb-2" size="4">
                </select>
                <div class="flex space-x-2">
                    <button type="button" id="editAggregationBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                        Edit Selected
                    </button>
                    <button type="button" id="removeAggregationBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Remove Selected
                    </button>
                </div>
            </div>
            
            <!-- Group By Section -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Group By Fields</label>
                <div class="text-xs text-gray-500 mb-2">
                    You can group by:
                    <ul class="list-disc list-inside">
                        <li>Text fields (e.g., names, codes)</li>
                        <li>Date fields</li>
                        <li>Choice fields (e.g., status)</li>
                        <li>Foreign key fields (e.g., related records)</li>
                        <li>Boolean fields (true/false)</li>
                        <li>Numeric fields</li>
                    </ul>
                </div>
                <select id="groupByField" class="form-select w-full mb-2">
                    <option value="">Select a field...</option>
                </select>
                <div class="flex space-x-2">
                    <button type="button" id="addGroupByBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Add Group By
                    </button>
                </div>
            </div>
            
            <!-- Current Group By -->
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Current Group By Fields</label>
                <select id="currentGroupBy" class="form-select w-full mb-2" size="4">
                </select>
                <div class="flex space-x-2">
                    <button type="button" id="removeGroupByBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        Remove Selected
                    </button>
                </div>
            </div>
        </div>

        <!-- Sort Configuration Section -->
        <div class="mb-8 border rounded-lg p-4 bg-gray-50">
            <h2 class="text-lg font-semibold mb-4">Sort Configuration</h2>
            <div class="grid grid-cols-3 gap-4 items-end">
                <!-- Sort Field -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                    <select id="sortField" class="form-select w-full">
                        <option value="">Select a field...</option>
                    </select>
                </div>
                <!-- Sort Direction -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Direction</label>
                    <select id="sortDirection" class="form-select w-full">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>
                <!-- Apply Sort Button -->
                <div>
                    <button type="button" id="applySortBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 w-full">
                        Apply Sort
                    </button>
                </div>
            </div>
            <!-- Current Sort Display -->
            <div class="mt-4" id="currentSortDisplay">
                <p class="text-sm text-gray-500">No sorting applied</p>
            </div>
        </div>

        <!-- Hidden Sort Fields -->
        <input type="hidden" name="sort_by" id="sort_by" value="{}">
        <input type="hidden" name="sort_direction" id="sort_direction" value="asc">

        <!-- Debug Area -->
        <div class="mt-4 p-4 bg-gray-100 rounded">
            <h3 class="text-sm font-medium text-gray-700 mb-1">Debug Information</h3>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-gray-600">Group By JSON:</label>
                    <textarea id="groupByDebug" class="w-full h-24 text-xs font-mono bg-gray-50 p-2 border rounded" readonly></textarea>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600">Selected Fields JSON:</label>
                    <textarea id="selectedFieldsDebug" class="w-full h-24 text-xs font-mono bg-gray-50 p-2 border rounded" readonly></textarea>
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-4">
            <a href="{% url 'reporting:report_list' %}" 
               class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Cancel
            </a>
            <button type="submit" class="bg-green-500 text-white px-6 py-2 rounded hover:bg-green-600">
                {% if is_edit %}Save Changes{% else %}Create Report{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{% static 'reporting/js/report_creation.js' %}"></script>
{% endblock %}
