{% extends "contracts/contract_base.html" %}
{% load static %}

{% block title %}Contract Queue{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Contract Queue</h1>
        <div class="space-x-4">
            <a href="{% url 'processing:download_csv_template' %}" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                Download Template
            </a>
            <a href="{% url 'processing:download_test_data' %}" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                Download Test Data
            </a>
            <button onclick="document.getElementById('csv-upload').click()" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded">
                Upload CSV
            </button>
            <input type="file" id="csv-upload" class="hidden" accept=".csv" onchange="handleFileUpload(this)">
        </div>
    </div>

    <!-- Drag and Drop Zone -->
    <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-6 text-center transition-colors duration-200 ease-in-out">
        <div class="flex flex-col items-center justify-center">
            <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <p class="text-lg text-gray-600 mb-2">Drag and drop your CSV file here</p>
            <p class="text-sm text-gray-500">or</p>
            <button onclick="document.getElementById('csv-upload').click()" class="mt-2 text-indigo-600 hover:text-indigo-500">
                Browse files
            </button>
        </div>
    </div>

    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contract Number</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Buyer</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Award Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contract Value</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for contract in queued_contracts %}
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap">{{ contract.contract_number }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ contract.buyer }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ contract.award_date|date:"Y-m-d" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">{{ contract.due_date|date:"Y-m-d" }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${{ contract.contract_value|floatformat:2 }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if contract.is_being_processed %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                Being Processed by {{ contract.processed_by.username }}
                                {% if contract.processing_started %}
                                    <br>Since {{ contract.processing_started|date:"Y-m-d H:i" }}
                                {% endif %}
                            </span>
                        {% else %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                Ready for Processing
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        {% if not contract.is_being_processed %}
                            <button onclick="startProcessing({{ contract.id }})" class="text-indigo-600 hover:text-indigo-900 mr-3">
                                Start Processing
                            </button>
                        {% elif contract.processed_by == user %}
                            <button onclick="resumeProcessing({{ contract.id }})" class="text-green-600 hover:text-green-900">
                                Resume Processing
                            </button>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="px-6 py-4 text-center text-gray-500">
                        No contracts in queue
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="processingModal" class="hidden fixed z-10 inset-0 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 transition-opacity" aria-hidden="true">
            <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
        </div>
        <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                            Processing Contract
                        </h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="modal-message">
                                Please wait while we process your request...
                            </p>
                            <div id="modal-error" class="mt-2 hidden">
                                <p class="text-sm text-red-600"></p>
                            </div>
                            <div id="modal-progress" class="mt-4">
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                <button type="button" id="modal-close" class="hidden w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm" onclick="hideModal()">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}

<script>
function showModal(message, showProgress = true) {
    document.getElementById('modal-message').textContent = message;
    document.getElementById('modal-error').classList.add('hidden');
    document.getElementById('modal-close').classList.add('hidden');
    document.getElementById('modal-progress').style.display = showProgress ? 'block' : 'none';
    document.getElementById('processingModal').classList.remove('hidden');
}

function showError(message) {
    const errorDiv = document.getElementById('modal-error');
    errorDiv.querySelector('p').textContent = message;
    errorDiv.classList.remove('hidden');
    document.getElementById('modal-close').classList.remove('hidden');
    document.getElementById('modal-progress').style.display = 'none';
}

function hideModal() {
    document.getElementById('processingModal').classList.add('hidden');
    // Reset progress bar
    document.querySelector('#modal-progress .bg-blue-600').style.width = '0%';
}

function updateProgress(percent) {
    document.querySelector('#modal-progress .bg-blue-600').style.width = `${percent}%`;
}

function startProcessing(queueId) {
    showModal('Starting contract processing...');
    updateProgress(25);
    
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    const fetchOptions = {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin'
    };

    fetch(`{% url 'processing:start_processing' queue_id=0 %}`.replace('0', queueId), fetchOptions)
    .then(response => {
        updateProgress(50);
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Network response was not ok');
            });
        }
        return response.json();
    })
    .then(data => {
        updateProgress(75);
        if (data.success) {
            updateProgress(100);
            // Add a small delay to show the completion
            setTimeout(() => {
                window.location.href = `{% url 'processing:process_contract_detail' pk=0 %}`.replace('0', data.process_contract_id);
            }, 500);
        } else {
            throw new Error(data.error || 'An error occurred while processing the contract.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError(error.message || 'An error occurred while processing the contract.');
    });
}

function resumeProcessing(contractId) {
    showModal('Retrieving contract information...', false);
    
    const getFetchOptions = {
        'method': 'GET',
        'headers': {
            'X-CSRFToken': getCookie('csrftoken')
        },
        'credentials': 'same-origin'
    };
    fetch(`{% url 'processing:get_process_contract' queue_id=0 %}`.replace('0', contractId), getFetchOptions)
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Network response was not ok');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            window.location.href = `{% url 'processing:process_contract_edit' pk=0 %}`.replace('0', data.process_contract_id);
        } else {
            throw new Error(data.error || 'Could not find processing contract');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError(error.message || 'An error occurred while resuming processing');
    });
}

function handleFileUpload(input) {
    if (input.files.length === 0) return;
    
    const formData = new FormData();
    formData.append('csv_file', input.files[0]);
    
    // Show loading state
    const loadingToast = showToast('Uploading and processing file...', 'info');
    
    fetch("{% url 'processing:upload_csv' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Hide loading toast
        loadingToast.remove();
        
        if (data.success) {
            showToast('File uploaded and processed successfully!', 'success');
            location.reload();
        } else {
            let errorMessage = data.error;
            let errorDetails = '';
            
            // Handle specific error types
            switch (data.error_type) {
                case 'missing_columns':
                    errorMessage = 'Missing required columns in CSV file:';
                    errorDetails = data.missing_columns.join(', ');
                    break;
                    
                case 'missing_value':
                    errorMessage = `Missing required value in row ${data.row}`;
                    errorDetails = `Column: "${data.column}"`;
                    break;
                    
                case 'invalid_decimal':
                    errorMessage = `Invalid number format in row ${data.row}`;
                    errorDetails = `Column: "${data.column}", Value: "${data.value}"
                        Please ensure the number is properly formatted (e.g., 1234.56)`;
                    break;
                    
                case 'invalid_date':
                    errorMessage = `Invalid date format in row ${data.row}`;
                    errorDetails = `Column: "${data.column}", Value: "${data.value}"
                        Please use YYYY-MM-DD format (e.g., 2024-03-14)`;
                    break;
                    
                case 'encoding_error':
                    errorMessage = 'File encoding error';
                    errorDetails = 'Please save your CSV file with UTF-8 encoding';
                    break;
                    
                case 'csv_format_error':
                    errorMessage = 'CSV file is malformed';
                    errorDetails = 'Please ensure your CSV file is properly formatted and not corrupted';
                    break;
            }
            
            showErrorModal(errorMessage, errorDetails);
        }
    })
    .catch(error => {
        // Hide loading toast
        loadingToast.remove();
        
        console.error('Error:', error);
        showErrorModal('Upload Error', 'An unexpected error occurred while uploading the file. Please try again.');
    });
    
    // Clear the file input
    input.value = '';
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    if (files.length > 0) {
        const file = files[0];
        if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
            const formData = new FormData();
            formData.append('csv_file', file);
            
            // Show loading state
            const loadingToast = showToast('Uploading and processing file...', 'info');
            
            fetch("{% url 'processing:upload_csv' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading toast
                loadingToast.remove();
                
                if (data.success) {
                    showToast('File uploaded and processed successfully!', 'success');
                    location.reload();
                } else {
                    let errorMessage = data.error;
                    let errorDetails = '';
                    
                    // Handle specific error types (same as above)
                    switch (data.error_type) {
                        case 'missing_columns':
                            errorMessage = 'Missing required columns in CSV file:';
                            errorDetails = data.missing_columns.join(', ');
                            break;
                            
                        case 'missing_value':
                            errorMessage = `Missing required value in row ${data.row}`;
                            errorDetails = `Column: "${data.column}"`;
                            break;
                            
                        case 'invalid_decimal':
                            errorMessage = `Invalid number format in row ${data.row}`;
                            errorDetails = `Column: "${data.column}", Value: "${data.value}"
                                Please ensure the number is properly formatted (e.g., 1234.56)`;
                            break;
                            
                        case 'invalid_date':
                            errorMessage = `Invalid date format in row ${data.row}`;
                            errorDetails = `Column: "${data.column}", Value: "${data.value}"
                                Please use YYYY-MM-DD format (e.g., 2024-03-14)`;
                            break;
                            
                        case 'encoding_error':
                            errorMessage = 'File encoding error';
                            errorDetails = 'Please save your CSV file with UTF-8 encoding';
                            break;
                            
                        case 'csv_format_error':
                            errorMessage = 'CSV file is malformed';
                            errorDetails = 'Please ensure your CSV file is properly formatted and not corrupted';
                            break;
                    }
                    
                    showErrorModal(errorMessage, errorDetails);
                }
            })
            .catch(error => {
                // Hide loading toast
                loadingToast.remove();
                
                console.error('Error:', error);
                showErrorModal('Upload Error', 'An unexpected error occurred while uploading the file. Please try again.');
            });
        } else {
            showToast('Please upload a CSV file', 'error');
        }
    }
}

// Toast notification system
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded shadow-lg ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        toast.remove();
    }, 5000);
    
    return toast;
}

// Error modal system
function showErrorModal(title, details) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center';
    modal.innerHTML = `
        <div class="relative bg-white rounded-lg shadow-xl max-w-lg w-full mx-4">
            <div class="p-6">
                <div class="flex items-start justify-between">
                    <h3 class="text-lg font-medium text-red-600">${title}</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-500">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-gray-500 whitespace-pre-line">${details}</p>
                </div>
                <div class="mt-6 flex justify-end">
                    <button onclick="this.closest('.fixed').remove()" 
                            class="bg-red-100 text-red-600 px-4 py-2 rounded hover:bg-red-200">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Add drag and drop functionality
const dropZone = document.getElementById('drop-zone');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

// Highlight drop zone when item is dragged over it
['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

// Handle dropped files
dropZone.addEventListener('drop', handleDrop, false);

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight(e) {
    dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
}

function unhighlight(e) {
    dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
}
</script>
{% endblock %} 