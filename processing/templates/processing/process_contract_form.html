{% extends "contracts/contract_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Edit Processing Contract{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">
                Edit Processing Contract: {{ process_contract.contract_number }}
            </h1>
            <p class="text-sm text-gray-600 mt-1">Started processing on {{ process_contract.created_at|date:"M d, Y H:i" }}</p>
        </div>
    </div>

    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Contract Details Card -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Contract Details</h2>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Number</label>
                            <input type="text" name="contract_number" value="{{ process_contract.contract_number }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Award Date</label>
                            <input type="date" name="award_date" value="{{ process_contract.award_date|date:'Y-m-d' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">IDIQ Contract</label>
                            <div class="flex gap-2 items-center">
                                <input type="text" 
                                       value="{{ process_contract.idiq_contract.contract_number|default:'' }}" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                       readonly>
                                <button type="button" 
                                        data-action="open-idiq"
                                        data-idiq="{{ process_contract.idiq_contract.contract_number|default:'' }}"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    Match
                                </button>
                                {% if process_contract.idiq_contract %}
                                <button type="button" 
                                        onclick="removeIdiq()"
                                        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    Remove
                                </button>
                                <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <svg class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" name="due_date" value="{{ process_contract.due_date|date:'Y-m-d' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Solicitation Type</label>
                            <input type="text" name="solicitation_type" value="{{ process_contract.solicitation_type }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>

                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PO Number</label>
                            <input type="text" name="po_number" value="{{ process_contract.po_number }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sales Class ({{ process_contract.sales_class_text }})</label>
                            <select name="sales_class" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-------</option>
                                {% for sales_class in sales_classes %}
                                    <option value="{{ sales_class.sales_team }}" {% if process_contract.sales_class == sales_class.sales_team %}selected{% endif %}>{{ sales_class.sales_team }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tab Number</label>
                            <input type="text" name="tab_number" value="{{ process_contract.tab_num }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NIST</label>
                            <select name="nist" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Yes" {% if process_contract.nist == "Yes" %}selected{% endif %}>Yes</option>
                                <option value="No" {% if process_contract.nist == "No" %}selected{% endif %}>No</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Buyer</label>
                            <div class="flex gap-2 items-center">
                                <input type="text" value="{{ process_contract.buyer_text|default:'' }}" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                       readonly>
                                <button type="button" 
                                        data-action="open-buyer"
                                        data-buyer="{{ process_contract.buyer_text|default:'' }}"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    Match
                                </button>
                                {% if process_contract.buyer %}
                                <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Files URL</label>
                            <input type="text" name="files_url" value="{{ process_contract.files_url }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Type ({{ process_contract.contract_type_text }})</label>
                            <select name="contract_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-------</option>
                                {% for type in contract_types %}
                                    <option value="{{ type.description }}" {% if process_contract.contract_type == type.description %}selected{% endif %}>{{ type.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Value</label>
                            <input type="number" step="0.01" name="contract_value" value="{{ process_contract.contract_value }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Card -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Processing Status</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Status</label>
                            <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                {% for status in statuses %}
                                    <option value="{{ status.0 }}" {% if process_contract.status == status.0 %}selected{% endif %}>{{ status.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Created By</label>
                            <input type="text" value="{{ process_contract.created_by }}" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Modified</label>
                            <input type="text" value="{{ process_contract.modified_at }}" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Split Information Card -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Splits Information</h2>
                        <button type="button" 
                                onclick="addNewSplit()"
                                class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Add New Split
                        </button>
                    </div>
                    
                    <!-- Dynamic Splits Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="splitsTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Split Value</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Split Paid</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for split in process_contract.splits.all %}
                                <tr class="split-row" data-id="{{ split.id }}">
                                    <td class="px-4 py-3">
                                        <input type="text" 
                                               name="splits-{{ split.id }}-company" 
                                               value="{{ split.company_name }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" 
                                               step="0.01" 
                                               name="splits-{{ split.id }}-value" 
                                               value="{{ split.split_value }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" 
                                               step="0.01" 
                                               name="splits-{{ split.id }}-paid" 
                                               value="{{ split.split_paid }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button type="button" 
                                                onclick="removeSplit(this)" 
                                                class="text-red-600 hover:text-red-900">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Total Split Value Display -->
                    <div class="mt-4 text-right">
                        <p class="text-sm text-gray-600">Total Split Value: <span id="totalSplitValue">0.00</span></p>
                        <p class="text-sm text-gray-600">Contract Value: {{ process_contract.contract_value|default:"0.00" }}</p>
                    </div>
                </div>
            </div>

            <!-- CLIN Items Card -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">CLIN Items</h2>
                    {{ clin_formset.management_form }}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CLIN</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NSN</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Price</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for clin_form in clin_formset %}
                                <tr class="hover:bg-gray-50">
                                    <!-- Actions Column -->
                                    <td class="px-4 py-3 text-sm font-medium">
                                        <div class="flex items-center space-x-2">
                                            <button type="button" 
                                                    data-action="toggle-clin"
                                                    data-index="{{ forloop.counter0 }}"
                                                    class="text-blue-600 hover:text-blue-900 flex items-center">
                                                <span class="clin-expand-icon-{{ forloop.counter0 }} flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                    </svg>
                                                    <span class="ml-1 text-sm clin-text-{{ forloop.counter0 }}">Expand</span>
                                                </span>
                                            </button>
                                        </div>
                                    </td>
                                    <!-- Basic Info Columns -->
                                    <td class="px-4 py-3">
                                        <span class="text-sm font-medium text-gray-900">{{ clin_form.item_number.value|default:'' }}</span>
                                        {{ clin_form.id }}
                                        {{ clin_form.item_number.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-sm text-gray-900">{{ clin_form.item_type.value|default:'---' }}</span>
                                        {{ clin_form.item_type.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm">
                                            <div class="font-medium text-gray-900">{{ clin_form.instance.nsn_text|default:'Not Set' }}</div>
                                            <div class="text-gray-500 text-xs">{{ clin_form.instance.nsn_description_text|default:'' }}</div>
                                        </div>
                                        {{ clin_form.nsn.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-sm text-gray-900">{{ clin_form.instance.supplier_text|default:'Not Set' }}</span>
                                        {{ clin_form.supplier.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="text-sm font-medium text-gray-900 qty-display" data-clin-id="{{ clin_form.instance.id }}" id="qty_display_{{ clin_form.instance.id }}">{{ clin_form.order_qty.value|floatformat:'1'|default:'0.0' }}</span>
                                        {{ clin_form.order_qty.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="text-sm font-medium text-gray-900">${{ clin_form.unit_price.value|floatformat:'2'|default:'0.00' }}</span>
                                        {{ clin_form.unit_price.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="text-sm font-medium text-gray-900">${{ clin_form.item_value.value|floatformat:'2'|default:'0.00' }}</span>
                                        {{ clin_form.item_value.as_hidden }}
                                    </td>
                                </tr>
                                <!-- Detailed Edit Row (Initially Hidden) -->
                                <tr class="clin-details-{{ forloop.counter0 }} hidden">
                                    <td colspan="8" class="px-4 py-4 bg-gray-50">
                                        <!-- ITEM LINE -->
                                        <div class="grid grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="item_number_{{ clin_form.instance.id }}">Item Number</label>
                                                <input type="text" 
                                                       id="item_number_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.item_number.html_name }}" 
                                                       value="{{ clin_form.item_number.value|default:'' }}" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="item_type_{{ clin_form.instance.id }}">Item Type</label>
                                                <select id="item_type_{{ clin_form.instance.id }}"
                                                        name="{{ clin_form.item_type.html_name }}" 
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        data-clin-id="{{ clin_form.instance.id }}">
                                                    <option value="">-------</option>
                                                    {% for choice in clin_form.item_type.field.choices %}
                                                        <option value="{{ choice.0 }}" {% if clin_form.item_type.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="status_{{ clin_form.instance.id }}">Status</label>
                                                <select id="status_{{ clin_form.instance.id }}"
                                                        name="{{ clin_form.status.html_name }}"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        data-clin-id="{{ clin_form.instance.id }}">
                                                    {% for choice in clin_form.status.field.choices %}
                                                        <option value="{{ choice.0 }}" {% if clin_form.status.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- NSN and Due date Line -->
                                        <div class="grid grid-cols-2 gap-4 mb-4">
                                            <!-- NSN Selection Box -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="nsn_{{ clin_form.instance.id }}">NSN*</label>
                                                <div class="flex gap-2 items-center">
                                                    <input type="text" 
                                                           id="nsn_{{ clin_form.instance.id }}"
                                                           value="{{ clin_form.instance.nsn_text|default:'' }}" 
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                                           readonly
                                                           data-clin-id="{{ clin_form.instance.id }}">
                                                    <button type="button" 
                                                            data-action="open-nsn"
                                                            data-id="{{ clin_form.instance.id }}"
                                                            data-nsn="{{ clin_form.instance.nsn_text|default:'' }}"
                                                            data-description="{{ clin_form.instance.nsn_description_text|default:'' }}"
                                                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                        Match
                                                    </button>
                                                    {% if clin_form.instance.nsn %}
                                                    <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                    {% else %}
                                                    <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                    {% endif %}
                                                </div>
                                                {% if clin_form.instance.nsn_description_text %}
                                                <p id="nsn_description_{{ clin_form.instance.id }}" class="mt-1 text-sm text-gray-500">{{ clin_form.instance.nsn_description_text }}</p>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="status_{{ clin_form.instance.id }}">Due Date</label>
                                                <input type="date" 
                                                       id="due_date_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.due_date.html_name }}" 
                                                       value="{{ clin_form.due_date.value|date:'Y-m-d' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">

                                             </div>
                                        </div>
                                        <!--  CLIN Section     -->
                                        <div class="grid grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="order_qty_{{ clin_form.instance.id }}">Quantity</label>
                                                <input type="number" 
                                                       id="order_qty_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.order_qty.html_name }}" 
                                                       value="{{ clin_form.order_qty.value|floatformat:'1'|default:'0.0' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="unit_price_{{ clin_form.instance.id }}">Unit Price</label>
                                                <input type="number" 
                                                       id="unit_price_{{ clin_form.instance.id }}"
                                                       step="0.01" 
                                                       name="{{ clin_form.unit_price.html_name }}" 
                                                       value="{{ clin_form.unit_price.value|floatformat:'2'|default:'0.00' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="item_value_{{ clin_form.instance.id }}">Total Value</label>
                                                <div class="flex gap-2">
                                                    <input type="number" 
                                                           id="item_value_{{ clin_form.instance.id }}"
                                                           step="0.01" 
                                                           name="{{ clin_form.item_value.html_name }}" 
                                                           value="{{ clin_form.item_value.value|floatformat:'2'|default:'0.00' }}"
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                           readonly
                                                           data-clin-id="{{ clin_form.instance.id }}">
                                                    <button type="button" 
                                                            onclick="recalculateTotal(this)"
                                                            data-clin-id="{{ clin_form.instance.id }}"
                                                            class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                                                        ReCalc
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Supplier Selection Box -->
                                        <div class="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="supplier_{{ clin_form.instance.id }}">Supplier*</label>
                                                <div class="flex gap-2 items-center">
                                                    <input type="text" 
                                                           id="supplier_{{ clin_form.instance.id }}"
                                                           value="{{ clin_form.instance.supplier_text|default:'' }}" 
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                                           readonly
                                                           data-clin-id="{{ clin_form.instance.id }}">
                                                    <button type="button" 
                                                            data-action="open-supplier"
                                                            data-id="{{ clin_form.instance.id }}"
                                                            data-supplier="{{ clin_form.instance.supplier_text|default:'' }}"
                                                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                        Match
                                                    </button>
                                                    {% if clin_form.instance.supplier %}
                                                    <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                    {% else %}
                                                    <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="supplier_due_date_{{ clin_form.instance.id }}">Supplier Due Date</label>
                                                <input type="date" 
                                                       id="supplier_due_date_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.supplier_due_date.html_name }}" 
                                                       value="{{ clin_form.supplier_due_date.value|date:'Y-m-d' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="order_qty_{{ clin_form.instance.id }}_supplier">Quantity</label>
                                                <input type="number" 
                                                       id="order_qty_{{ clin_form.instance.id }}_supplier"
                                                       name="{{ clin_form.order_qty.html_name }}" 
                                                       value="{{ clin_form.order_qty.value|floatformat:'1'|default:'0.0' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}"
                                                       readonly>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="price_per_unit_{{ clin_form.instance.id }}">Supplier Price</label>
                                                <input type="number" 
                                                       id="price_per_unit_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.price_per_unit.html_name }}" 
                                                       value="{{ clin_form.price_per_unit.value|default:'0' }}"
                                                       step="any"
                                                       min="0"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}"
                                                       onchange="handlePriceChange(this)">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="quote_value_{{ clin_form.instance.id }}">Supplier Total</label>
                                                <div class="flex gap-2">
                                                    <input type="number" 
                                                           id="quote_value_{{ clin_form.instance.id }}"
                                                           step="0.01" 
                                                           name="{{ clin_form.quote_value.html_name }}" 
                                                           value="{{ clin_form.quote_value.value|floatformat:'2'|default:'0.00' }}"
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                           readonly
                                                           data-clin-id="{{ clin_form.instance.id }}">
                                                    <button type="button" 
                                                            onclick="recalculateTotal(this)"
                                                            data-clin-id="{{ clin_form.instance.id }}"
                                                            class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                                                        ReCalc
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-4 flex justify-end">
                                            <label class="inline-flex items-center text-sm text-red-600">
                                                {{ clin_form.DELETE }}
                                                <span class="ml-2">Delete this CLIN</span>
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4 mt-6">
            <a href="{% url 'processing:queue' %}" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">Cancel</a>
            <button type="submit" class="px-6 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">Save</button>
        </div>
    </form>
</div>

<!-- Cancel Processing Confirmation Modal -->
<div id="cancelModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Cancel Processing</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Are you sure you want to cancel processing this contract?</p>
                <p class="text-sm text-red-500 mt-2">This action cannot be undone and all progress will be lost.</p>
            </div>
            <div class="mt-4 flex justify-center space-x-4">
                <button onclick="closeModal()" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                    No, Keep Processing
                </button>
                <button onclick="cancelProcessing()" 
                        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    Yes, Cancel Processing
                </button>
            </div>
        </div>
    </div>
</div>

<!-- NSN Selection Modal -->
<div id="nsn_modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="relative top-20 mx-auto p-5 border max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center border-b pb-3">
            <h3 class="text-lg font-semibold text-gray-900">Select NSN</h3>
            <button type="button" onclick="closeNsnModal()" class="text-gray-400 hover:text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="mt-4">
            <!-- Original NSN Info -->
            <div class="mb-4 p-3 bg-gray-50 rounded">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Original NSN Information:</h4>
                <p id="original_nsn_display" class="text-gray-900"></p>
                <button type="button" 
                        onclick="showAddNsnForm()"
                        class="mt-2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                    Add as New NSN
                </button>
            </div>

            <!-- Add NSN Form (Initially Hidden) -->
            <div id="add_nsn_form" class="mb-4 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Add New NSN</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">NSN Code</label>
                        <input type="text" id="new_nsn_code" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                        <textarea id="new_nsn_description" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <button type="button" 
                            onclick="createNewNsn()"
                            class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        Create NSN
                    </button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="mb-4">
                <label for="nsn_search" class="block text-sm font-medium text-gray-700 mb-1">Search NSN</label>
                <div class="flex space-x-2">
                    <input type="text" id="nsn_search" class="form-control flex-1" placeholder="Enter NSN code or description">
                    <button type="button" onclick="searchNsn()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Search
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">Enter at least 3 characters to search</p>
            </div>

            <!-- Results Section -->
            <div id="nsn_search_results" class="mt-4 max-h-[300px] overflow-y-auto">
                <!-- Results will be populated here -->
                <div class="text-center text-gray-500 py-4">Search for NSN by code or description</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-4 flex justify-end border-t pt-3">
            <button type="button" onclick="closeNsnModal()" 
                    style="background-color: #D1D5DB; color: #ff0000; padding: 0.5rem 1rem; border-radius: 0.25rem; display: inline-block; transition: background-color 0.3s;">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Supplier Selection Modal -->
<div id="supplier_modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="relative top-20 mx-auto p-5 border max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center border-b pb-3">
            <h3 class="text-lg font-semibold text-gray-900">Select Supplier</h3>
            <button type="button" onclick="closeSupplierModal()" class="text-gray-400 hover:text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="mt-4">
            <!-- Original Supplier Info -->
            <div class="mb-4 p-3 bg-gray-50 rounded">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Original Supplier Information:</h4>
                <p id="original_supplier_display" class="text-gray-900"></p>
                <button type="button" 
                        onclick="showAddSupplierForm()"
                        class="mt-2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                    Add as New Supplier
                </button>
            </div>

            <!-- Add Supplier Form (Initially Hidden) -->
            <div id="add_supplier_form" class="mb-4 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Add New Supplier</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Supplier Name</label>
                        <input type="text" id="new_supplier_name" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">CAGE Code*</label>
                        <input type="text" id="new_supplier_cage_code" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="button" 
                            onclick="createNewSupplier()"
                            class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        Create Supplier
                    </button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="mb-4">
                <label for="supplier_search" class="block text-sm font-medium text-gray-700 mb-1">Search Supplier</label>
                <div class="flex space-x-2">
                    <input type="text" id="supplier_search" class="form-control flex-1" placeholder="Enter supplier name or CAGE code">
                    <button type="button" onclick="searchSupplier()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Search
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">Enter at least 3 characters to search</p>
            </div>

            <!-- Results Section -->
            <div id="supplier_search_results" class="mt-4 max-h-[300px] overflow-y-auto">
                <!-- Results will be populated here -->
                <div class="text-center text-gray-500 py-4">Search for supplier by name or CAGE code</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-4 flex justify-end border-t pt-3">
            <button type="button" onclick="closeSupplierModal()" 
                    style="background-color: #D1D5DB; color: #ff0000; padding: 0.5rem 1rem; border-radius: 0.25rem; display: inline-block; transition: background-color 0.3s;">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Buyer Selection Modal -->
<div id="buyer_modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="relative top-20 mx-auto p-5 border max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center border-b pb-3">
            <h3 class="text-lg font-semibold text-gray-900">Select Buyer</h3>
            <button type="button" onclick="closeBuyerModal()" class="text-gray-400 hover:text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="mt-4">
            <!-- Original Buyer Info -->
            <div class="mb-4 p-3 bg-gray-50 rounded">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Original Buyer Information:</h4>
                <p id="original_buyer_display" class="text-gray-900"></p>
                <button type="button" 
                        onclick="showAddBuyerForm()"
                        class="mt-2 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                    Add as New Buyer
                </button>
            </div>

            <!-- Add Buyer Form (Initially Hidden) -->
            <div id="add_buyer_form" class="mb-4 hidden">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Add New Buyer</h4>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Buyer Name</label>
                        <input type="text" id="new_buyer_name" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <button type="button" 
                            onclick="createNewBuyer()"
                            class="w-full px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        Create Buyer
                    </button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="mb-4">
                <label for="buyer_search" class="block text-sm font-medium text-gray-700 mb-1">Search Buyer</label>
                <div class="flex space-x-2">
                    <input type="text" id="buyer_search" class="form-control flex-1" placeholder="Enter buyer name">
                    <button type="button" onclick="searchBuyer()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Search
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">Enter at least 3 characters to search</p>
            </div>

            <!-- Results Section -->
            <div id="buyer_search_results" class="mt-4 max-h-[300px] overflow-y-auto">
                <!-- Results will be populated here -->
                <div class="text-center text-gray-500 py-4">Search for buyer by name</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-4 flex justify-end border-t pt-3">
            <button type="button" onclick="closeBuyerModal()" 
                    style="background-color: #D1D5DB; color: #ff0000; padding: 0.5rem 1rem; border-radius: 0.25rem; display: inline-block; transition: background-color 0.3s;">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- IDIQ Contract Selection Modal -->
<div id="idiq_modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="relative top-20 mx-auto p-5 border max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center border-b pb-3">
            <h3 class="text-lg font-semibold text-gray-900">Select IDIQ Contract</h3>
            <button type="button" onclick="closeIdiqModal()" class="text-gray-400 hover:text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div class="mt-4">
            <!-- Original IDIQ Info -->
            <div class="mb-4 p-3 bg-gray-50 rounded">
                <h4 class="text-sm font-medium text-gray-700 mb-2">Original IDIQ Contract Information:</h4>
                <p id="original_idiq_display" class="text-gray-900"></p>
            </div>

            <!-- Search Section -->
            <div class="mb-4">
                <label for="idiq_search" class="block text-sm font-medium text-gray-700 mb-1">Search IDIQ Contract</label>
                <div class="flex space-x-2">
                    <input type="text" id="idiq_search" class="form-control flex-1" placeholder="Enter contract number...">
                    <button type="button" onclick="searchIdiq()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Search
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">Enter at least 3 characters to search</p>
            </div>

            <!-- Results Section -->
            <div id="idiq_search_results" class="mt-4 max-h-[300px] overflow-y-auto">
                <!-- Results will be populated here -->
                <div class="text-center text-gray-500 py-4">Search for IDIQ contract by number</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-4 flex justify-end border-t pt-3">
            <button type="button" onclick="closeIdiqModal()" 
                    style="background-color: #D1D5DB; color: #ff0000; padding: 0.5rem 1rem; border-radius: 0.25rem; display: inline-block; transition: background-color 0.3s;">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- JavaScript for form functionality -->
<script>
    // Global variables for modal functionality
    const processContractId = "{{ process_contract.id }}";
    let currentNsnClinId = null,
        currentSupplierClinId = null,
        nsnCurrentPage = 1,
        supplierCurrentPage = 1;

    // Calculate total price when quantity or unit price changes
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('tr');
        forms.forEach(form => {
            const qtyInput = form.querySelector('[name$="-order_qty"]');
            const priceInput = form.querySelector('[name$="-unit_price"]');
            const totalInput = form.querySelector('[name$="-item_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const calculateTotal = () => {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    totalInput.value = (qty * price).toFixed(2);
                };
                
                qtyInput.addEventListener('input', calculateTotal);
                priceInput.addEventListener('input', calculateTotal);
            }
        });
    });

    // Match buyer function
    function matchBuyer(buyerText) {
        fetch(`/processing/match-buyer/${processContractId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `buyer_text=${encodeURIComponent(buyerText)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Failed to match buyer');
            }
        });
    }

    function openNsnModal(clinId, nsnText, nsnDescription) {
        currentNsnClinId = clinId;
        const modal = document.getElementById('nsn_modal');
        const searchInput = document.getElementById('nsn_search');
        const originalDisplay = document.getElementById('original_nsn_display');
        
        originalDisplay.textContent = `NSN: ${nsnText || 'Not specified'}`;
        if (nsnDescription) {
            originalDisplay.textContent += `\nDescription: ${nsnDescription}`;
        }
        
        searchInput.value = nsnText || '';
        modal.classList.remove('hidden');
        searchInput.focus();
        
        if (nsnText) {
            searchNsn();
        }
    }

    function closeNsnModal() {
        document.getElementById('nsn_modal').classList.add('hidden');
        currentNsnClinId = null;
    }

    function searchNsn() {
        const searchTerm = document.getElementById('nsn_search').value.trim();
        if (searchTerm.length < 3) {
            document.getElementById('nsn_search_results').innerHTML = 
                '<div class="text-center text-gray-500 py-4">Enter at least 3 characters to search</div>';
            return;
        }
        
        document.getElementById('nsn_search_results').innerHTML = 
            '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading...</p></div>';
        
        fetch(`/contracts/api/options/nsn/?search=${encodeURIComponent(searchTerm)}&page=1&page_size=10`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const resultsDiv = document.getElementById('nsn_search_results');
                    resultsDiv.innerHTML = '';
                    
                    if (data.options && data.options.length > 0) {
                        let resultsHtml = '';
                        data.options.forEach(option => {
                            resultsHtml += `
                                <div class="nsn-result-item hover:bg-gray-50 p-2 cursor-pointer" 
                                     onclick="selectNsn('${option.value}', '${option.label}')">
                                    <div class="font-medium">${option.label}</div>
                                </div>
                            `;
                        });
                        resultsDiv.innerHTML = resultsHtml;
                    } else {
                        resultsDiv.innerHTML = '<div class="text-center text-gray-500 py-4">No matches found</div>';
                    }
                } else {
                    document.getElementById('nsn_search_results').innerHTML = 
                        '<div class="text-center text-red-500 py-4">Error searching for NSN</div>';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                document.getElementById('nsn_search_results').innerHTML = 
                    '<div class="text-center text-red-500 py-4">Error connecting to the server</div>';
            });
    }

    function openSupplierModal(clinId, supplierText) {
        currentSupplierClinId = clinId;
        const modal = document.getElementById('supplier_modal');
        const searchInput = document.getElementById('supplier_search');
        const originalDisplay = document.getElementById('original_supplier_display');
        
        originalDisplay.textContent = `Supplier: ${supplierText || 'Not specified'}`;
        searchInput.value = supplierText || '';
        modal.classList.remove('hidden');
        searchInput.focus();
        
        if (supplierText) {
            searchSupplier();
        }
    }

    function closeSupplierModal() {
        document.getElementById('supplier_modal').classList.add('hidden');
        currentSupplierClinId = null;
    }

    function searchSupplier() {
        const searchTerm = document.getElementById('supplier_search').value.trim();
        if (searchTerm.length < 3) {
            document.getElementById('supplier_search_results').innerHTML = 
                '<div class="text-center text-gray-500 py-4">Enter at least 3 characters to search</div>';
            return;
        }
        
        document.getElementById('supplier_search_results').innerHTML = 
            '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading...</p></div>';
        
        fetch(`/contracts/api/options/supplier/?search=${encodeURIComponent(searchTerm)}&page=1&page_size=10`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const resultsDiv = document.getElementById('supplier_search_results');
                    resultsDiv.innerHTML = '';
                    
                    if (data.options && data.options.length > 0) {
                        let resultsHtml = '';
                        data.options.forEach(option => {
                            resultsHtml += `
                                <div class="nsn-result-item hover:bg-gray-50 p-2 cursor-pointer" 
                                     onclick="selectSupplier('${option.value}', '${option.label}')">
                                    <div class="font-medium">${option.label}</div>
                                </div>
                            `;
                        });
                        resultsDiv.innerHTML = resultsHtml;
                    } else {
                        resultsDiv.innerHTML = '<div class="text-center text-gray-500 py-4">No matches found</div>';
                    }
                } else {
                    document.getElementById('supplier_search_results').innerHTML = 
                        '<div class="text-center text-red-500 py-4">Error searching for supplier</div>';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                document.getElementById('supplier_search_results').innerHTML = 
                    '<div class="text-center text-red-500 py-4">Error connecting to the server</div>';
            });
    }

    // Add these helper functions for selecting NSN and Supplier
    function selectNsn(id, text) {
        console.log('Selecting NSN:', { id, text });
        console.log('Current CLIN ID:', currentNsnClinId);
        
        // Update the CLIN's NSN
        fetch(`/processing/match-nsn/${currentNsnClinId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Error response:', text);
                    throw new Error('Network response was not ok');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success response:', data);
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error selecting NSN');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error selecting NSN: ' + error.message);
        });
    }

    function selectSupplier(id, text) {
        // Update the CLIN's supplier
        fetch(`/processing/match-supplier/${currentSupplierClinId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ supplier_id: id })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error selecting supplier');
            }
        });
    }

    function prevNsnPage() {
        nsnCurrentPage--;
        searchNsn();
    }

    function nextNsnPage() {
        nsnCurrentPage++;
        searchNsn();
    }

    function prevSupplierPage() {
        supplierCurrentPage--;
        searchSupplier();
    }

    function nextSupplierPage() {
        supplierCurrentPage++;
        searchSupplier();
    }

    function confirmCancel() {
        document.getElementById('cancelModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('cancelModal').classList.add('hidden');
    }

    function cancelProcessing() {
        window.location.href = '{% url "processing:queue" %}';
    }

    // Add this function for CLIN expand/collapse
    function toggleClinDetails(index) {
        const detailsRow = document.querySelector(`.clin-details-${index}`);
        const expandIcon = document.querySelector(`.clin-expand-icon-${index}`);
        const textSpan = document.querySelector(`.clin-text-${index}`);
        
        if (detailsRow.classList.contains('hidden')) {
            detailsRow.classList.remove('hidden');
            expandIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <span class="ml-1 text-sm clin-text-${index}">Hide</span>
            `;
        } else {
            detailsRow.classList.add('hidden');
            expandIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <span class="ml-1 text-sm clin-text-${index}">Expand</span>
            `;
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Handle CLIN toggle
        document.querySelectorAll('[data-action="toggle-clin"]').forEach(button => {
            button.addEventListener('click', function() {
                const index = this.dataset.index;
                toggleClinDetails(index);
            });
        });

        // Handle NSN modal
        document.querySelectorAll('[data-action="open-nsn"]').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const nsn = this.dataset.nsn;
                const description = this.dataset.description;
                openNsnModal(id, nsn, description);
            });
        });

        // Handle Supplier modal
        document.querySelectorAll('[data-action="open-supplier"]').forEach(button => {
            button.addEventListener('click', function() {
                const id = this.dataset.id;
                const supplier = this.dataset.supplier;
                openSupplierModal(id, supplier);
            });
        });

        // Add event listeners for NSN search
        const searchInput = document.getElementById('nsn_search');
        const searchButton = document.querySelector('button[onclick="searchNsn()"]');
        
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchNsn();
                }
            });
        }
        
        if (searchButton) {
            searchButton.addEventListener('click', searchNsn);
        }

        // Add event listeners for supplier search
        const supplierSearchInput = document.getElementById('supplier_search');
        const supplierSearchButton = document.querySelector('button[onclick="searchSupplier()"]');
        
        if (supplierSearchInput) {
            supplierSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchSupplier();
                }
            });
        }
        
        if (supplierSearchButton) {
            supplierSearchButton.addEventListener('click', searchSupplier);
        }
    });

    function addNewSplit() {
        const table = document.querySelector('#splitsTable tbody');
        const newRow = document.createElement('tr');
        const timestamp = new Date().getTime(); // Use timestamp as temporary ID
        
        newRow.className = 'split-row';
        newRow.innerHTML = `
            <td class="px-4 py-3">
                <input type="text" 
                       name="splits-new-${timestamp}-company" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="px-4 py-3">
                <input type="number" 
                       step="0.01" 
                       name="splits-new-${timestamp}-value" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="px-4 py-3">
                <input type="number" 
                       step="0.01" 
                       name="splits-new-${timestamp}-paid" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="px-4 py-3 text-center">
                <button type="button" 
                        onclick="removeSplit(this)" 
                        class="text-red-600 hover:text-red-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </td>
        `;
        
        table.appendChild(newRow);
        updateTotalSplitValue();
    }

    function removeSplit(button) {
        const row = button.closest('tr');
        row.remove();
        updateTotalSplitValue();
    }

    function updateTotalSplitValue() {
        const splitValues = document.querySelectorAll('input[name$="-value"]');
        let total = 0;
        
        splitValues.forEach(input => {
            total += parseFloat(input.value || 0);
        });
        
        document.getElementById('totalSplitValue').textContent = total.toFixed(2);
    }

    // Add event listeners for split value changes
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.endsWith('-value')) {
            updateTotalSplitValue();
        }
    });

    // Initial calculation
    document.addEventListener('DOMContentLoaded', function() {
        updateTotalSplitValue();
    });

    function openBuyerModal(buyerText) {
        const modal = document.getElementById('buyer_modal');
        const searchInput = document.getElementById('buyer_search');
        const originalDisplay = document.getElementById('original_buyer_display');
        
        originalDisplay.textContent = `Buyer: ${buyerText || 'Not specified'}`;
        searchInput.value = buyerText || '';
        modal.classList.remove('hidden');
        searchInput.focus();
        
        if (buyerText) {
            searchBuyer();
        }
    }

    function closeBuyerModal() {
        document.getElementById('buyer_modal').classList.add('hidden');
    }

    function searchBuyer() {
        const searchTerm = document.getElementById('buyer_search').value.trim();
        if (searchTerm.length < 3) {
            document.getElementById('buyer_search_results').innerHTML = 
                '<div class="text-center text-gray-500 py-4">Enter at least 3 characters to search</div>';
            return;
        }
        
        document.getElementById('buyer_search_results').innerHTML = 
            '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading...</p></div>';
        
        fetch(`/contracts/api/options/buyer/?search=${encodeURIComponent(searchTerm)}&page=1&page_size=10`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const resultsDiv = document.getElementById('buyer_search_results');
                    resultsDiv.innerHTML = '';
                    
                    if (data.options && data.options.length > 0) {
                        let resultsHtml = '';
                        data.options.forEach(option => {
                            resultsHtml += `
                                <div class="buyer-result-item hover:bg-gray-50 p-2 cursor-pointer" 
                                     onclick="selectBuyer('${option.value}', '${option.label}')">
                                    <div class="font-medium">${option.label}</div>
                                </div>
                            `;
                        });
                        resultsDiv.innerHTML = resultsHtml;
                    } else {
                        resultsDiv.innerHTML = '<div class="text-center text-gray-500 py-4">No matches found</div>';
                    }
                } else {
                    document.getElementById('buyer_search_results').innerHTML = 
                        '<div class="text-center text-red-500 py-4">Error searching for buyer</div>';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                document.getElementById('buyer_search_results').innerHTML = 
                    '<div class="text-center text-red-500 py-4">Error connecting to the server</div>';
            });
    }

    function selectBuyer(id, text) {
        console.log('Selecting buyer:', { id, text });
        
        // Update the contract's buyer
        fetch(`/processing/match-buyer/${processContractId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ id: id })
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Error response:', text);
                    throw new Error('Network response was not ok');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success response:', data);
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error selecting buyer');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error selecting buyer: ' + error.message);
        });
    }

    // Add event listeners for buyer search
    document.addEventListener('DOMContentLoaded', function() {
        // Handle Buyer modal
        document.querySelectorAll('[data-action="open-buyer"]').forEach(button => {
            button.addEventListener('click', function() {
                const buyer = this.dataset.buyer;
                openBuyerModal(buyer);
            });
        });

        // Add event listeners for buyer search
        const buyerSearchInput = document.getElementById('buyer_search');
        const buyerSearchButton = document.querySelector('button[onclick="searchBuyer()"]');
        
        if (buyerSearchInput) {
            buyerSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchBuyer();
                }
            });
        }
        
        if (buyerSearchButton) {
            buyerSearchButton.addEventListener('click', searchBuyer);
        }
    });

    function recalculateTotal(button) {
        const row = button.closest('.grid');
        const qtyInput = row.querySelector('input[name$="-order_qty"]');
        
        // Check if this is a supplier section by looking for price_per_unit input
        const isSupplierSection = row.querySelector('input[id$="_supplier"]') !== null;
        
        if (isSupplierSection) {
            // Handle supplier total calculation
            const supplierPriceInput = row.querySelector('input[name$="-price_per_unit"]');
            const supplierTotalInput = row.querySelector('input[name$="-quote_value"]');
            
            if (qtyInput && supplierPriceInput && supplierTotalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(supplierPriceInput.value) || 0;
                // Use the full value for calculation
                supplierTotalInput.value = (qty * price).toFixed(2);
            }
        } else {
            // Handle CLIN total calculation
            const priceInput = row.querySelector('input[name$="-unit_price"]');
            const totalInput = row.querySelector('input[name$="-item_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                totalInput.value = (qty * price).toFixed(2);
            }
        }
    }

    // Add function to format number inputs to 2 decimal places
    function formatNumberInput(input) {
        if (input && input.value) {
            const value = parseFloat(input.value) || 0;
            input.value = value.toFixed(2);
        }
    }

    // Add this function to synchronize quantity fields
    function syncQuantityFields(clinId, value) {
        // Update the main display in table header
        const mainDisplay = document.getElementById(`qty_display_${clinId}`);
        if (mainDisplay) {
            mainDisplay.textContent = value || '0';
        }

        // Update all quantity inputs
        document.querySelectorAll(`input[id^="order_qty_"][data-clin-id="${clinId}"]`).forEach(input => {
            if (!input.readOnly) {
                input.value = value || '0';
            }
        });

        // Update supplier quantity display (readonly)
        const supplierQty = document.getElementById(`order_qty_${clinId}_supplier`);
        if (supplierQty) {
            supplierQty.value = value || '0';
        }

        // Recalculate totals for both CLIN and supplier sections
        const clinSection = document.querySelector(`#order_qty_${clinId}`).closest('.grid');
        const supplierSection = document.querySelector(`#order_qty_${clinId}_supplier`).closest('.grid');
        
        // Calculate CLIN total
        if (clinSection) {
            const calcButton = clinSection.querySelector('button[onclick^="recalculateTotal"]');
            if (calcButton) recalculateTotal(calcButton);
        }
        
        // Calculate supplier total
        if (supplierSection) {
            const calcButton = supplierSection.querySelector('button[onclick^="recalculateTotal"]');
            if (calcButton) recalculateTotal(calcButton);
        }
    }

    // Add input event listeners for quantity fields and supplier price fields
    document.addEventListener('DOMContentLoaded', function() {
        // Format all numeric inputs on page load
        document.querySelectorAll('input[type="number"]').forEach(input => {
            if (input.name.endsWith('-unit_price') || 
                input.name.endsWith('-item_value') || 
                input.name.endsWith('-price_per_unit') || 
                input.name.endsWith('-quote_value')) {
                // Only format on initial load if the input has a value
                if (input.value) {
                    formatNumberInput(input);
                }
            }
        });

        // Add event listeners for quantity field changes
        document.querySelectorAll('input[id^="order_qty_"]').forEach(input => {
            if (!input.readOnly) {  // Only add listeners to editable fields
                input.addEventListener('change', function() {
                    const clinId = this.dataset.clinId;
                    syncQuantityFields(clinId, this.value);
                });
            }
        });

        // Add event listeners for price field changes
        document.querySelectorAll('input[name$="-unit_price"], input[name$="-price_per_unit"]').forEach(input => {
            // Only format on blur (when leaving the field)
            input.addEventListener('blur', function() {
                formatNumberInput(this);
                const calcButton = this.closest('.grid').querySelector('button[onclick^="recalculateTotal"]');
                if (calcButton) recalculateTotal(calcButton);
            });

            // Allow free typing while in the field
            input.addEventListener('input', function() {
                // Don't format during input
                const calcButton = this.closest('.grid').querySelector('button[onclick^="recalculateTotal"]');
                if (calcButton) recalculateTotal(calcButton);
            });
        });
    });

    function openIdiqModal(idiqText) {
        const modal = document.getElementById('idiq_modal');
        const searchInput = document.getElementById('idiq_search');
        const originalDisplay = document.getElementById('original_idiq_display');
        
        originalDisplay.textContent = `IDIQ Contract: ${idiqText || 'Not specified'}`;
        searchInput.value = idiqText || '';
        modal.classList.remove('hidden');
        searchInput.focus();
        
        if (idiqText) {
            searchIdiq();
        }
    }

    function closeIdiqModal() {
        document.getElementById('idiq_modal').classList.add('hidden');
    }

    function searchIdiq() {
        const searchTerm = document.getElementById('idiq_search').value.trim();
        if (searchTerm.length < 3) {
            document.getElementById('idiq_search_results').innerHTML = 
                '<div class="text-center text-gray-500 py-4">Enter at least 3 characters to search</div>';
            return;
        }
        
        document.getElementById('idiq_search_results').innerHTML = 
            '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading...</p></div>';
        
        fetch(`/contracts/api/options/idiq/?search=${encodeURIComponent(searchTerm)}&page=1&page_size=10`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const resultsDiv = document.getElementById('idiq_search_results');
                    resultsDiv.innerHTML = '';
                    
                    if (data.options && data.options.length > 0) {
                        let resultsHtml = '';
                        data.options.forEach(option => {
                            resultsHtml += `
                                <div class="idiq-result-item hover:bg-gray-50 p-2 cursor-pointer" 
                                     onclick="selectIdiq('${option.value}', '${option.label}')">
                                    <div class="font-medium">${option.label}</div>
                                    <div class="text-sm text-gray-500">TAB: ${option.tab_num || 'N/A'}</div>
                                </div>
                            `;
                        });
                        resultsDiv.innerHTML = resultsHtml;
                    } else {
                        resultsDiv.innerHTML = '<div class="text-center text-gray-500 py-4">No matches found</div>';
                    }
                } else {
                    document.getElementById('idiq_search_results').innerHTML = 
                        '<div class="text-center text-red-500 py-4">Error searching for IDIQ contracts</div>';
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                document.getElementById('idiq_search_results').innerHTML = 
                    '<div class="text-center text-red-500 py-4">Error connecting to the server</div>';
            });
    }

    function selectIdiq(id, text) {
        console.log('Selecting IDIQ:', { id, text });
        
        // Update the contract's IDIQ
        fetch(`/processing/match-idiq/${processContractId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ 
                idiq_id: id,  // Changed from 'id' to 'idiq_id' to match expected format
                contract_number: text  // Adding contract number for reference
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to select IDIQ contract');
                }).catch(() => {
                    throw new Error('Network response was not ok');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success response:', data);
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error selecting IDIQ contract');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(error.message || 'Error selecting IDIQ contract');
        });
    }

    // Add event listeners for IDIQ contract search
    document.addEventListener('DOMContentLoaded', function() {
        // Handle IDIQ modal
        document.querySelectorAll('[data-action="open-idiq"]').forEach(button => {
            button.addEventListener('click', function() {
                const idiq = this.dataset.idiq;
                openIdiqModal(idiq);
            });
        });

        // Add event listeners for IDIQ search
        const idiqSearchInput = document.getElementById('idiq_search');
        const idiqSearchButton = document.querySelector('button[onclick="searchIdiq()"]');
        
        if (idiqSearchInput) {
            idiqSearchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchIdiq();
                }
            });
        }
        
        if (idiqSearchButton) {
            idiqSearchButton.addEventListener('click', searchIdiq);
        }
    });

    // Add this function to the JavaScript section
    function removeIdiq() {
        console.log('Removing IDIQ contract');
        
        // Send request to remove IDIQ contract
        fetch(`/processing/match-idiq/${processContractId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ id: null })  // Sending null to remove the IDIQ
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                return response.text().then(text => {
                    console.error('Error response:', text);
                    throw new Error('Network response was not ok');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success response:', data);
            if (data.success) {
                location.reload();
            } else {
                alert(data.error || 'Error removing IDIQ contract');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error removing IDIQ contract: ' + error.message);
        });
    }

    // Add these new functions for price handling
    function handlePriceChange(input) {
        // Only format when the user is done typing (on change)
        if (input.value) {
            const value = parseFloat(input.value) || 0;
            // Store the full value but display formatted
            input.setAttribute('data-full-value', value);
            input.value = value.toFixed(2);
        }
    }

    // Update the recalculateTotal function
    function recalculateTotal(button) {
        const row = button.closest('.grid');
        const qtyInput = row.querySelector('input[name$="-order_qty"]');
        
        // Check if this is a supplier section by looking for price_per_unit input
        const isSupplierSection = row.querySelector('input[id$="_supplier"]') !== null;
        
        if (isSupplierSection) {
            // Handle supplier total calculation
            const supplierPriceInput = row.querySelector('input[name$="-price_per_unit"]');
            const supplierTotalInput = row.querySelector('input[name$="-quote_value"]');
            
            if (qtyInput && supplierPriceInput && supplierTotalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(supplierPriceInput.value) || 0;
                // Use the full value for calculation
                supplierTotalInput.value = (qty * price).toFixed(2);
            }
        } else {
            // Handle CLIN total calculation
            const priceInput = row.querySelector('input[name$="-unit_price"]');
            const totalInput = row.querySelector('input[name$="-item_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                totalInput.value = (qty * price).toFixed(2);
            }
        }
    }

    // Update the event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Remove the automatic formatting on input
        document.querySelectorAll('input[type="number"]').forEach(input => {
            // Remove any existing input event listeners
            input.removeEventListener('input', formatNumberInput);
            
            // Only format on blur or change
            if (input.name.endsWith('-unit_price') || 
                input.name.endsWith('-price_per_unit') || 
                input.name.endsWith('-quote_value')) {
                
                // Clear existing listeners
                input.removeEventListener('blur', formatNumberInput);
                
                // Add new change handler
                input.addEventListener('change', function() {
                    handlePriceChange(this);
                });
            }
        });
    });

    // Add these new functions for handling the add forms
    function showAddBuyerForm() {
        const form = document.getElementById('add_buyer_form');
        const input = document.getElementById('new_buyer_name');
        const originalText = document.getElementById('original_buyer_display').textContent.replace('Buyer: ', '');
        
        form.classList.remove('hidden');
        input.value = originalText;
    }

    function showAddNsnForm() {
        const form = document.getElementById('add_nsn_form');
        const codeInput = document.getElementById('new_nsn_code');
        const descInput = document.getElementById('new_nsn_description');
        const originalText = document.getElementById('original_nsn_display').textContent;
        
        // Parse NSN and description from original text
        const nsnMatch = originalText.match(/NSN: (.*?)(?:\nDescription: |$)/);
        const descMatch = originalText.match(/Description: (.*?)$/);
        
        form.classList.remove('hidden');
        if (nsnMatch) codeInput.value = nsnMatch[1].trim();
        if (descMatch) descInput.value = descMatch[1].trim();
    }

    function showAddSupplierForm() {
        const form = document.getElementById('add_supplier_form');
        const nameInput = document.getElementById('new_supplier_name');
        const originalText = document.getElementById('original_supplier_display').textContent.replace('Supplier: ', '');
        
        form.classList.remove('hidden');
        nameInput.value = originalText;
    }

    function createNewBuyer() {
        const buyerName = document.getElementById('new_buyer_name').value.trim();
        
        if (!buyerName) {
            alert('Buyer name is required');
            return;
        }
        
        fetch('/contracts/api/buyers/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                buyer_text: buyerName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectBuyer(data.id, buyerName);
            } else {
                alert(data.error || 'Failed to create buyer');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating buyer');
        });
    }

    function createNewNsn() {
        const nsnCode = document.getElementById('new_nsn_code').value.trim();
        const nsnDescription = document.getElementById('new_nsn_description').value.trim();
        
        if (!nsnCode) {
            alert('NSN code is required');
            return;
        }
        
        fetch('/contracts/api/nsn/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                nsn: nsnCode,
                description: nsnDescription
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectNsn(data.id, nsnCode);
            } else {
                alert(data.error || 'Failed to create NSN');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating NSN');
        });
    }

    function createNewSupplier() {
        const supplierName = document.getElementById('new_supplier_name').value.trim();
        const cageCode = document.getElementById('new_supplier_cage_code').value.trim();
        
        if (!supplierName || !cageCode) {
            alert('Supplier name and CAGE code are required');
            return;
        }
        
        fetch('/contracts/api/suppliers/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                supplier_name: supplierName,
                cage_code: cageCode
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectSupplier(data.id, supplierName);
            } else {
                alert(data.error || 'Failed to create supplier');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating supplier');
        });
    }
</script>
{% endblock %}