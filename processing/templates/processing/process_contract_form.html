{% extends "contracts/contract_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Edit Processing Contract{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">
                Edit Processing Contract: {{ process_contract.contract_number }}
            </h1>
            <p class="text-sm text-gray-600 mt-1">Started processing on {{ process_contract.created_at|date:"M d, Y H:i" }}</p>
        </div>
    </div>

    <form method="post" class="space-y-6">
        {% csrf_token %}
        
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Contract Details Card -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Contract Details</h2>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Number</label>
                            <input type="text" name="contract_number" value="{{ process_contract.contract_number }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">IDIQ Contract</label>
                            <div class="flex gap-2 items-center">
                                <input type="text" 
                                       value="{{ process_contract.idiq_contract.contract_number|default:'' }}" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                       readonly>
                                <button type="button" 
                                        data-action="open-idiq"
                                        data-idiq="{{ process_contract.idiq_contract.contract_number|default:'' }}"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    Match
                                </button>
                                {% if process_contract.idiq_contract %}
                                <button type="button" 
                                        onclick="removeIdiq()"
                                        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    Remove
                                </button>
                                <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <svg class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PO Number</label>
                            <input type="text" name="po_number" value="{{ process_contract.po_number }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tab Number</label>
                            <input type="text" name="tab_number" value="{{ process_contract.tab_num }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Buyer</label>
                            <div class="flex gap-2 items-center">
                                <input type="text" value="{{ process_contract.buyer_text|default:'' }}" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                       readonly>
                                <button type="button" 
                                        data-action="open-buyer"
                                        data-buyer="{{ process_contract.buyer_text|default:'' }}"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    Match
                                </button>
                                {% if process_contract.buyer %}
                                <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Type ({{ process_contract.contract_type_text }})</label>
                            <select name="contract_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-------</option>
                                {% for type in contract_types %}
                                    <option value="{{ type.description }}" {% if process_contract.contract_type == type.description %}selected{% endif %}>{{ type.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Award Date</label>
                            <input type="date" name="award_date" value="{{ process_contract.award_date|date:'Y-m-d' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" name="due_date" value="{{ process_contract.due_date|date:'Y-m-d' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Solicitation Type</label>
                            <input type="text" name="solicitation_type" value="{{ process_contract.solicitation_type }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sales Class ({{ process_contract.sales_class_text }})</label>
                            <select name="sales_class" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-------</option>
                                {% for sales_class in sales_classes %}
                                    <option value="{{ sales_class.sales_team }}" {% if process_contract.sales_class == sales_class.sales_team %}selected{% endif %}>{{ sales_class.sales_team }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Value</label>
                            <input type="number" step="0.01" name="contract_value" value="{{ process_contract.contract_value }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Gross</label>
                            <input type="number" step="0.01" name="plan_gross" value="{{ process_contract.plan_gross }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Planned Split</label>
                            <input type="text" name="planned_split" value="{{ process_contract.planned_split }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Files URL</label>
                            <input type="text" name="files_url" value="{{ process_contract.files_url }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NIST</label>
                            <select name="nist" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Yes" {% if process_contract.nist == "Yes" %}selected{% endif %}>Yes</option>
                                <option value="No" {% if process_contract.nist == "No" %}selected{% endif %}>No</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Card -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Processing Status</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Status</label>
                            <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                {% for status in statuses %}
                                    <option value="{{ status.0 }}" {% if process_contract.status == status.0 %}selected{% endif %}>{{ status.1 }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Created By</label>
                            <input type="text" value="{{ process_contract.created_by }}" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Modified</label>
                            <input type="text" value="{{ process_contract.modified_at }}" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" readonly>
                        </div>
                    </div>
                </div>

                <!-- Contract Calculations Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Contract Calculations</h2>
                    <div class="space-y-4">
                        <button type="button" 
                                class="w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Update Value and Plan Gross
                        </button>
                    </div>
                </div>
            </div>

            <!-- Split Information Card -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Splits Information</h2>
                        <button type="button" 
                                onclick="addNewSplit()"
                                class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Add New Split
                        </button>
                    </div>
                    
                    <!-- Dynamic Splits Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="splitsTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Split Value</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Split Paid</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for split in process_contract.splits.all %}
                                <tr class="split-row" data-id="{{ split.id }}">
                                    <td class="px-4 py-3">
                                        <input type="text" 
                                               name="splits-{{ split.id }}-company" 
                                               value="{{ split.company_name }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" 
                                               step="0.01" 
                                               name="splits-{{ split.id }}-value" 
                                               value="{{ split.split_value }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </td>
                                    <td class="px-4 py-3">
                                        <input type="number" 
                                               step="0.01" 
                                               name="splits-{{ split.id }}-paid" 
                                               value="{{ split.split_paid }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </td>
                                    <td class="px-4 py-3 text-center">
                                        <button type="button" 
                                                onclick="removeSplit(this)" 
                                                class="text-red-600 hover:text-red-900">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Total Split Value Display -->
                    <div class="mt-4 text-right">
                        <p class="text-sm text-gray-600">Total Split Value: <span id="totalSplitValue">0.00</span></p>
                        <p class="text-sm text-gray-600">Contract Value: {{ process_contract.contract_value|default:"0.00" }}</p>
                    </div>
                </div>
            </div>

            <!-- CLIN Items Card -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">CLIN Items</h2>
                    {{ clin_formset.management_form }}
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CLIN</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NSN</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Price</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for clin_form in clin_formset %}
                                <tr class="hover:bg-gray-50">
                                    <!-- Actions Column -->
                                    <td class="px-4 py-3 text-sm font-medium">
                                        <div class="flex items-center space-x-2">
                                            <button type="button" 
                                                    data-action="toggle-clin"
                                                    data-index="{{ forloop.counter0 }}"
                                                    class="text-blue-600 hover:text-blue-900 flex items-center">
                                                <span class="clin-expand-icon-{{ forloop.counter0 }} flex items-center">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                                    </svg>
                                                    <span class="ml-1 text-sm clin-text-{{ forloop.counter0 }}">Expand</span>
                                                </span>
                                            </button>
                                        </div>
                                    </td>
                                    <!-- Basic Info Columns -->
                                    <td class="px-4 py-3">
                                        <span class="text-sm font-medium text-gray-900">{{ clin_form.item_number.value|default:'' }}</span>
                                        {{ clin_form.id }}
                                        {{ clin_form.item_number.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-sm text-gray-900">{{ clin_form.item_type.value|default:'---' }}</span>
                                        {{ clin_form.item_type.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <div class="text-sm">
                                            <div class="font-medium text-gray-900">{{ clin_form.instance.nsn_text|default:'Not Set' }}</div>
                                            <div class="text-gray-500 text-xs">{{ clin_form.instance.nsn_description_text|default:'' }}</div>
                                        </div>
                                        {{ clin_form.nsn.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3">
                                        <span class="text-sm text-gray-900">{{ clin_form.instance.supplier_text|default:'Not Set' }}</span>
                                        {{ clin_form.supplier.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="text-sm font-medium text-gray-900 qty-display" data-clin-id="{{ clin_form.instance.id }}" id="qty_display_{{ clin_form.instance.id }}">{{ clin_form.order_qty.value|floatformat:'1'|default:'0.0' }}</span>
                                        {{ clin_form.order_qty.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="text-sm font-medium text-gray-900">${{ clin_form.unit_price.value|floatformat:'2'|default:'0.00' }}</span>
                                        {{ clin_form.unit_price.as_hidden }}
                                    </td>
                                    <td class="px-4 py-3 text-right">
                                        <span class="text-sm font-medium text-gray-900">${{ clin_form.item_value.value|floatformat:'2'|default:'0.00' }}</span>
                                        {{ clin_form.item_value.as_hidden }}
                                    </td>
                                </tr>
                                <!-- Detailed Edit Row (Initially Hidden) -->
                                <tr class="clin-details-{{ forloop.counter0 }} hidden">
                                    <td colspan="8" class="px-4 py-4 bg-gray-50">
                                        <!-- ITEM LINE -->
                                        <div class="grid grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="item_number_{{ clin_form.instance.id }}">Item Number</label>
                                                <input type="text" 
                                                       id="item_number_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.item_number.html_name }}" 
                                                       value="{{ clin_form.item_number.value|default:'' }}" 
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="item_type_{{ clin_form.instance.id }}">Item Type</label>
                                                <select id="item_type_{{ clin_form.instance.id }}"
                                                        name="{{ clin_form.item_type.html_name }}" 
                                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                        data-clin-id="{{ clin_form.instance.id }}">
                                                    <option value="">-------</option>
                                                    {% for choice in clin_form.item_type.field.choices %}
                                                        <option value="{{ choice.0 }}" {% if clin_form.item_type.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div>

                                            </div>
                                        </div>

                                        <!-- NSN and Due date Line -->
                                        <div class="grid grid-cols-2 gap-4 mb-4">
                                            <!-- NSN Selection Box -->
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="nsn_{{ clin_form.instance.id }}">NSN*</label>
                                                <div class="flex gap-2 items-center">
                                                    <input type="text" 
                                                           id="nsn_{{ clin_form.instance.id }}"
                                                           value="{{ clin_form.instance.nsn_text|default:'' }}" 
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                                           readonly
                                                           data-clin-id="{{ clin_form.instance.id }}">
                                                    <button type="button" 
                                                            data-action="open-nsn"
                                                            data-id="{{ clin_form.instance.id }}"
                                                            data-nsn="{{ clin_form.instance.nsn_text|default:'' }}"
                                                            data-description="{{ clin_form.instance.nsn_description_text|default:'' }}"
                                                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                        Match
                                                    </button>
                                                    {% if clin_form.instance.nsn %}
                                                    <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                    {% else %}
                                                    <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                    {% endif %}
                                                </div>
                                                {% if clin_form.instance.nsn_description_text %}
                                                <p id="nsn_description_{{ clin_form.instance.id }}" class="mt-1 text-sm text-gray-500">{{ clin_form.instance.nsn_description_text }}</p>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="status_{{ clin_form.instance.id }}">Due Date</label>
                                                <input type="date" 
                                                       id="due_date_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.due_date.html_name }}" 
                                                       value="{{ clin_form.due_date.value|date:'Y-m-d' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">

                                             </div>
                                        </div>
                                        <!--  CLIN Section     -->
                                        <div class="grid grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="order_qty_{{ clin_form.instance.id }}">Quantity</label>
                                                <input type="number" 
                                                       id="order_qty_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.order_qty.html_name }}" 
                                                       value="{{ clin_form.order_qty.value|floatformat:'1'|default:'0.0' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="unit_price_{{ clin_form.instance.id }}">Unit Price</label>
                                                <input type="number" 
                                                       id="unit_price_{{ clin_form.instance.id }}"
                                                       step="0.01" 
                                                       name="{{ clin_form.unit_price.html_name }}" 
                                                       value="{{ clin_form.unit_price.value|floatformat:'2'|default:'0.00' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="item_value_{{ clin_form.instance.id }}">Total Value</label>
                                                <div class="flex gap-2">
                                                    <input type="number" 
                                                           id="item_value_{{ clin_form.instance.id }}"
                                                           step="0.01" 
                                                           name="{{ clin_form.item_value.html_name }}" 
                                                           value="{{ clin_form.item_value.value|floatformat:'2'|default:'0.00' }}"
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                           readonly
                                                           data-clin-id="{{ clin_form.instance.id }}">
                                                    <button type="button" 
                                                            onclick="recalculateTotal(this)"
                                                            data-clin-id="{{ clin_form.instance.id }}"
                                                            class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                                                        ReCalc
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Supplier Selection Box -->
                                        <div class="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="supplier_{{ clin_form.instance.id }}">Supplier*</label>
                                                <div class="flex gap-2 items-center">
                                                    <input type="text" 
                                                           id="supplier_{{ clin_form.instance.id }}"
                                                           value="{{ clin_form.instance.supplier_text|default:'' }}" 
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                                           readonly
                                                           data-clin-id="{{ clin_form.instance.id }}">
                                                    <button type="button" 
                                                            data-action="open-supplier"
                                                            data-id="{{ clin_form.instance.id }}"
                                                            data-supplier="{{ clin_form.instance.supplier_text|default:'' }}"
                                                            class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                        Match
                                                    </button>
                                                    {% if clin_form.instance.supplier %}
                                                    <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                    {% else %}
                                                    <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="supplier_due_date_{{ clin_form.instance.id }}">Supplier Due Date</label>
                                                <input type="date" 
                                                       id="supplier_due_date_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.supplier_due_date.html_name }}" 
                                                       value="{{ clin_form.supplier_due_date.value|date:'Y-m-d' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}">
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-3 gap-4 mb-4">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="order_qty_{{ clin_form.instance.id }}_supplier">Quantity</label>
                                                <input type="number" 
                                                       id="order_qty_{{ clin_form.instance.id }}_supplier"
                                                       name="{{ clin_form.order_qty.html_name }}" 
                                                       value="{{ clin_form.order_qty.value|floatformat:'1'|default:'0.0' }}"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}"
                                                       readonly>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="price_per_unit_{{ clin_form.instance.id }}">Supplier Price</label>
                                                <input type="number" 
                                                       id="price_per_unit_{{ clin_form.instance.id }}"
                                                       name="{{ clin_form.price_per_unit.html_name }}" 
                                                       value="{{ clin_form.price_per_unit.value|default:'0' }}"
                                                       step="any"
                                                       min="0"
                                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                       data-clin-id="{{ clin_form.instance.id }}"
                                                       onchange="handlePriceChange(this)">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1" for="quote_value_{{ clin_form.instance.id }}">Supplier Total</label>
                                                <div class="flex gap-2">
                                                    <input type="number" 
                                                           id="quote_value_{{ clin_form.instance.id }}"
                                                           step="0.01" 
                                                           name="{{ clin_form.quote_value.html_name }}" 
                                                           value="{{ clin_form.quote_value.value|floatformat:'2'|default:'0.00' }}"
                                                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                           readonly
                                                           data-clin-id="{{ clin_form.instance.id }}">
                                                    <button type="button" 
                                                            onclick="recalculateTotal(this)"
                                                            data-clin-id="{{ clin_form.instance.id }}"
                                                            class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                                                        ReCalc
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-4 flex justify-end">
                                            <label class="inline-flex items-center text-sm text-red-600">
                                                {{ clin_form.DELETE }}
                                                <span class="ml-2">Delete this CLIN</span>
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4 mt-6">
            <a href="{% url 'processing:queue' %}" class="px-6 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">Cancel</a>
            <button type="submit" class="px-6 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">Save</button>
        </div>
    </form>
</div>

<!-- Cancel Processing Confirmation Modal -->
<div id="cancelModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Cancel Processing</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Are you sure you want to cancel processing this contract?</p>
                <p class="text-sm text-red-500 mt-2">This action cannot be undone and all progress will be lost.</p>
            </div>
            <div class="mt-4 flex justify-center space-x-4">
                <button onclick="closeModal()" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                    No, Keep Processing
                </button>
                <button onclick="cancelProcessing()" 
                        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    Yes, Cancel Processing
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include all modals -->
{% include "processing/modals/idiq_modal.html" %}
{% include "processing/modals/buyer_modal.html" %}
{% include "processing/modals/nsn_modal.html" %}
{% include "processing/modals/supplier_modal.html" %}

<!-- Include all modal scripts -->
<script src="{% static 'processing/js/idiq_modal.js' %}"></script>
<script src="{% static 'processing/js/buyer_modal.js' %}"></script>
<script src="{% static 'processing/js/nsn_modal.js' %}"></script>
<script src="{% static 'processing/js/supplier_modal.js' %}"></script>

<!-- JavaScript for form functionality -->
<script>
    // Global variables for modal functionality
    const processContractId = "{{ process_contract.id }}";

    // Calculate total price when quantity or unit price changes
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('tr');
        forms.forEach(form => {
            const qtyInput = form.querySelector('[name$="-order_qty"]');
            const priceInput = form.querySelector('[name$="-unit_price"]');
            const totalInput = form.querySelector('[name$="-item_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const calculateTotal = () => {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    totalInput.value = (qty * price).toFixed(2);
                };
                
                qtyInput.addEventListener('input', calculateTotal);
                priceInput.addEventListener('input', calculateTotal);
            }
        });
    });

    function confirmCancel() {
        document.getElementById('cancelModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('cancelModal').classList.add('hidden');
    }

    function cancelProcessing() {
        window.location.href = '{% url "processing:queue" %}';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners for CLIN expand/collapse
        document.querySelectorAll('[data-action="toggle-clin"]').forEach(button => {
            button.addEventListener('click', function() {
                const index = this.dataset.index;
                toggleClinDetails(index);
            });
        });
    });

    // Add this function for CLIN expand/collapse
    function toggleClinDetails(index) {
        const detailsRow = document.querySelector(`.clin-details-${index}`);
        const expandIcon = document.querySelector(`.clin-expand-icon-${index}`);
        
        if (detailsRow.classList.contains('hidden')) {
            detailsRow.classList.remove('hidden');
            expandIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <span class="ml-1 text-sm clin-text-${index}">Hide</span>
            `;
        } else {
            detailsRow.classList.add('hidden');
            expandIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <span class="ml-1 text-sm clin-text-${index}">Expand</span>
            `;
        }
    }

    function addNewSplit() {
        const table = document.querySelector('#splitsTable tbody');
        const newRow = document.createElement('tr');
        const timestamp = new Date().getTime(); // Use timestamp as temporary ID
        
        newRow.className = 'split-row';
        newRow.innerHTML = `
            <td class="px-4 py-3">
                <input type="text" 
                       name="splits-new-${timestamp}-company" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="px-4 py-3">
                <input type="number" 
                       step="0.01" 
                       name="splits-new-${timestamp}-value" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="px-4 py-3">
                <input type="number" 
                       step="0.01" 
                       name="splits-new-${timestamp}-paid" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </td>
            <td class="px-4 py-3 text-center">
                <button type="button" 
                        onclick="removeSplit(this)" 
                        class="text-red-600 hover:text-red-900">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </td>
        `;
        
        table.appendChild(newRow);
        updateTotalSplitValue();
    }

    function removeSplit(button) {
        const row = button.closest('tr');
        row.remove();
        updateTotalSplitValue();
    }

    function updateTotalSplitValue() {
        const splitValues = document.querySelectorAll('input[name$="-value"]');
        let total = 0;
        
        splitValues.forEach(input => {
            total += parseFloat(input.value || 0);
        });
        
        document.getElementById('totalSplitValue').textContent = total.toFixed(2);
    }

    // Add event listeners for split value changes
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.endsWith('-value')) {
            updateTotalSplitValue();
        }
    });

    // Initial calculation
    document.addEventListener('DOMContentLoaded', function() {
        updateTotalSplitValue();
    });

    function recalculateTotal(button) {
        const row = button.closest('.grid');
        const qtyInput = row.querySelector('input[name$="-order_qty"]');
        
        // Check if this is a supplier section by looking for price_per_unit input
        const isSupplierSection = row.querySelector('input[id$="_supplier"]') !== null;
        
        if (isSupplierSection) {
            // Handle supplier total calculation
            const supplierPriceInput = row.querySelector('input[name$="-price_per_unit"]');
            const supplierTotalInput = row.querySelector('input[name$="-quote_value"]');
            
            if (qtyInput && supplierPriceInput && supplierTotalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(supplierPriceInput.value) || 0;
                // Use the full value for calculation
                supplierTotalInput.value = (qty * price).toFixed(2);
            }
        } else {
            // Handle CLIN total calculation
            const priceInput = row.querySelector('input[name$="-unit_price"]');
            const totalInput = row.querySelector('input[name$="-item_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                totalInput.value = (qty * price).toFixed(2);
            }
        }
    }

    // Add function to format number inputs to 2 decimal places
    function formatNumberInput(input) {
        if (input && input.value) {
            const value = parseFloat(input.value) || 0;
            input.value = value.toFixed(2);
        }
    }

    // Add this function to synchronize quantity fields
    function syncQuantityFields(clinId, value) {
        // Update the main display in table header
        const mainDisplay = document.getElementById(`qty_display_${clinId}`);
        if (mainDisplay) {
            mainDisplay.textContent = value || '0';
        }

        // Update all quantity inputs
        document.querySelectorAll(`input[id^="order_qty_"][data-clin-id="${clinId}"]`).forEach(input => {
            if (!input.readOnly) {
                input.value = value || '0';
            }
        });

        // Update supplier quantity display (readonly)
        const supplierQty = document.getElementById(`order_qty_${clinId}_supplier`);
        if (supplierQty) {
            supplierQty.value = value || '0';
        }

        // Recalculate totals for both CLIN and supplier sections
        const clinSection = document.querySelector(`#order_qty_${clinId}`).closest('.grid');
        const supplierSection = document.querySelector(`#order_qty_${clinId}_supplier`).closest('.grid');
        
        // Calculate CLIN total
        if (clinSection) {
            const calcButton = clinSection.querySelector('button[onclick^="recalculateTotal"]');
            if (calcButton) recalculateTotal(calcButton);
        }
        
        // Calculate supplier total
        if (supplierSection) {
            const calcButton = supplierSection.querySelector('button[onclick^="recalculateTotal"]');
            if (calcButton) recalculateTotal(calcButton);
        }
    }

    // Add input event listeners for quantity fields and supplier price fields
    document.addEventListener('DOMContentLoaded', function() {
        // Format all numeric inputs on page load
        document.querySelectorAll('input[type="number"]').forEach(input => {
            if (input.name.endsWith('-unit_price') || 
                input.name.endsWith('-item_value') || 
                input.name.endsWith('-price_per_unit') || 
                input.name.endsWith('-quote_value')) {
                // Only format on initial load if the input has a value
                if (input.value) {
                    formatNumberInput(input);
                }
            }
        });

        // Add event listeners for quantity field changes
        document.querySelectorAll('input[id^="order_qty_"]').forEach(input => {
            if (!input.readOnly) {  // Only add listeners to editable fields
                input.addEventListener('change', function() {
                    const clinId = this.dataset.clinId;
                    syncQuantityFields(clinId, this.value);
                });
            }
        });

        // Add event listeners for price field changes
        document.querySelectorAll('input[name$="-unit_price"], input[name$="-price_per_unit"]').forEach(input => {
            // Only format on blur (when leaving the field)
            input.addEventListener('blur', function() {
                formatNumberInput(this);
                const calcButton = this.closest('.grid').querySelector('button[onclick^="recalculateTotal"]');
                if (calcButton) recalculateTotal(calcButton);
            });

            // Allow free typing while in the field
            input.addEventListener('input', function() {
                // Don't format during input
                const calcButton = this.closest('.grid').querySelector('button[onclick^="recalculateTotal"]');
                if (calcButton) recalculateTotal(calcButton);
            });
        });
    });
    // Add these new functions for price handling
    function handlePriceChange(input) {
        // Only format when the user is done typing (on change)
        if (input.value) {
            const value = parseFloat(input.value) || 0;
            // Store the full value but display formatted
            input.setAttribute('data-full-value', value);
            input.value = value.toFixed(2);
        }
    }

    // Update the recalculateTotal function
    function recalculateTotal(button) {
        const row = button.closest('.grid');
        const qtyInput = row.querySelector('input[name$="-order_qty"]');
        
        // Check if this is a supplier section by looking for price_per_unit input
        const isSupplierSection = row.querySelector('input[id$="_supplier"]') !== null;
        
        if (isSupplierSection) {
            // Handle supplier total calculation
            const supplierPriceInput = row.querySelector('input[name$="-price_per_unit"]');
            const supplierTotalInput = row.querySelector('input[name$="-quote_value"]');
            
            if (qtyInput && supplierPriceInput && supplierTotalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(supplierPriceInput.value) || 0;
                // Use the full value for calculation
                supplierTotalInput.value = (qty * price).toFixed(2);
            }
        } else {
            // Handle CLIN total calculation
            const priceInput = row.querySelector('input[name$="-unit_price"]');
            const totalInput = row.querySelector('input[name$="-item_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                totalInput.value = (qty * price).toFixed(2);
            }
        }
    }

    // Update the event listeners
    document.addEventListener('DOMContentLoaded', function() {
        // Remove the automatic formatting on input
        document.querySelectorAll('input[type="number"]').forEach(input => {
            // Remove any existing input event listeners
            input.removeEventListener('input', formatNumberInput);
            
            // Only format on blur or change
            if (input.name.endsWith('-unit_price') || 
                input.name.endsWith('-price_per_unit') || 
                input.name.endsWith('-quote_value')) {
                
                // Clear existing listeners
                input.removeEventListener('blur', formatNumberInput);
                
                // Add new change handler
                input.addEventListener('change', function() {
                    handlePriceChange(this);
                });
            }
        });
    });

</script>
{% endblock %}