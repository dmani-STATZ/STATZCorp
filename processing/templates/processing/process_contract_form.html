{% extends "contracts/contract_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Edit Processing Contract{% endblock %}

{% block content %}
<!-- Add this right after the opening body tag or as the first element in your template -->
<div id="custom-messages-container" class="fixed top-0 left-0 right-0 flex justify-center items-start pt-20 z-[2000] pointer-events-none">
    <div id="custom-messages" class="pointer-events-auto"></div>
</div>

<!-- System Messages Section - Fixed Position -->
<div id="system-messages" class="fixed top-20 left-0 right-0 z-50 px-4">
    {% if messages %}
    <div class="messages max-w-4xl mx-auto">
        {% for message in messages %}
        <div class="bg-{{ message.tags }}-100 border border-{{ message.tags }}-400 text-{{ message.tags }}-700 px-4 py-3 rounded relative mb-2 shadow-lg" role="alert">
            <span class="block sm:inline">{{ message }}</span>
            <button type="button" class="absolute top-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
                <svg class="h-6 w-6 text-{{ message.tags }}-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <title>Close</title>
                    <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
                </svg>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Main Content Container -->
<div class="container mx-auto px-4 py-6">
    <!-- Header Section -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">
                Edit Processing Contract: {{ process_contract.contract_number }}
            </h1>
            <p class="text-sm text-gray-600 mt-1">Started processing on {{ process_contract.created_at|date:"M d, Y H:i" }}</p>
        </div>
    </div>

    <form id="process-contract-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="status" value="{{ process_contract.status|default:'in_progress' }}">
        
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Contract Details Card -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h2 class="text-xl font-semibold mb-4">Contract Details</h2>
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Number</label>
                            <input type="text" name="contract_number" value="{{ process_contract.contract_number }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">IDIQ Contract</label>
                            <div class="flex gap-2 items-center">
                                <input type="text" 
                                       value="{{ process_contract.idiq_contract.contract_number|default:'' }}" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                       readonly>
                                <button type="button" 
                                        data-action="open-idiq"
                                        data-idiq="{{ process_contract.idiq_contract.contract_number|default:'' }}"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    Match
                                </button>
                                {% if process_contract.idiq_contract %}
                                <button type="button" 
                                        onclick="removeIdiq()"
                                        class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500">
                                    Remove
                                </button>
                                <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <svg class="h-6 w-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">PO Number</label>
                            <input type="text" name="po_number" value="{{ process_contract.po_number }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tab Number</label>
                            <input type="text" name="tab_number" value="{{ process_contract.tab_num }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Buyer</label>
                            <div class="flex gap-2 items-center">
                                <input type="text" value="{{ process_contract.buyer_text|default:'' }}" 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                       readonly>
                                <button type="button" 
                                        data-action="open-buyer"
                                        data-buyer="{{ process_contract.buyer_text|default:'' }}"
                                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    Match
                                </button>
                                {% if process_contract.buyer %}
                                <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                {% else %}
                                <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                                {% endif %}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Type ({{ process_contract.contract_type_text }})</label>
                            <select name="contract_type" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-------</option>
                                {% for type in contract_types %}
                                    <option value="{{ type.id }}" {% if process_contract.contract_type_id == type.id %}selected{% endif %}>{{ type.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Award Date</label>
                            <input type="date" name="award_date" value="{{ process_contract.award_date|date:'Y-m-d' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" name="due_date" value="{{ process_contract.due_date|date:'Y-m-d' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Solicitation Type</label>
                            <input type="text" name="solicitation_type" value="{{ process_contract.solicitation_type }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sales Class ({{ process_contract.sales_class_text }})</label>
                            <select name="sales_class" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-------</option>
                                {% for sales_class in sales_classes %}
                                    <option value="{{ sales_class.id }}" {% if process_contract.sales_class_id == sales_class.id %}selected{% endif %}>{{ sales_class.sales_team }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contract Value</label>
                            <input type="number" step="0.01" name="contract_value" value="{{ process_contract.contract_value }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Plan Gross</label>
                            <input type="number" step="0.01" name="plan_gross" value="{{ process_contract.plan_gross }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Planned Split</label>
                            <input type="text" name="planned_split" value="{{ process_contract.planned_split }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Files URL</label>
                            <input type="text" name="files_url" value="{{ process_contract.files_url }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NIST</label>
                            <select name="nist" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    data-previous-value="{{ process_contract.nist|yesno:'Yes,No' }}">
                                <option value="Yes" {% if process_contract.nist %}selected{% endif %}>Yes</option>
                                <option value="No" {% if not process_contract.nist %}selected{% endif %}>No</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Card -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Processing Status</h2>
                        <a href="{% url 'processing:queue' %}" 
                           class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">
                            Return to Queue
                        </a>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Current Status</label>
                            <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="statusChange(this.value)">
                            {% for choice in form.fields.status.choices %}
                                <option value="{{ choice.0 }}" 
                                    {% if process_contract.status == choice.0 %}selected{% endif %}
                                    class="{% if choice.0 == 'draft' %}text-gray-700
                                           {% elif choice.0 == 'in_progress' %}text-blue-700
                                           {% elif choice.0 == 'ready_for_review' %}text-green-700
                                           {% elif choice.0 == 'completed' %}text-purple-700
                                           {% elif choice.0 == 'cancelled' %}text-red-700{% endif %}">
                                    {{ choice.1 }}
                                </option>
                            {% endfor %}
                            </select>
                            <div class="mt-2 flex items-center space-x-2 text-xs">
                                <span class="inline-block w-3 h-3 bg-gray-200 rounded-full"></span>
                                <span class="text-gray-600">Draft</span>
                                <span class="inline-block w-3 h-3 bg-blue-200 rounded-full"></span>
                                <span class="text-gray-600">In Progress</span>
                                <span class="inline-block w-3 h-3 bg-green-200 rounded-full"></span>
                                <span class="text-gray-600">Ready for Review</span>
                                <span class="inline-block w-3 h-3 bg-purple-200 rounded-full"></span>
                                <span class="text-gray-600">Completed</span>
                                <span class="inline-block w-3 h-3 bg-red-200 rounded-full"></span>
                                <span class="text-gray-600">Cancelled</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Created By</label>
                            <input type="text" value="{{ process_contract.created_by }}" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Modified</label>
                            <input type="text" value="{{ process_contract.modified_at }}" class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" readonly>
                        </div>
                    </div>
                </div>

                <!-- Contract Calculations Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Contract Calculations</h2>
                    <div class="space-y-4">
                        <button type="button" 
                                onclick="updateContractCalculations()"
                                class="w-full px-4 py-2 bg-gray-100 text-green-500 border border-green-500 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-200">
                            Update Value and Plan Gross
                        </button>
                    </div>
                    <div class="space-y-4 pt-3">
                        <button type="button" 
                                onclick="confirmCancel()"
                                class="w-full px-6 py-2 bg-gray-700 text-red-400 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500">
                            Cancel and Return to Queue
                        </button>
                    </div>
                    <div class="space-y-4 pt-3">
                        <button type="button" 
                            onclick="finalizeContract()"
                            class="w-full px-6 py-2 bg-green-400 text-black rounded-md hover:bg-green-300 focus:outline-none focus:ring-2 focus:ring-green-300">
                            Submit Contract and Create Email
                        </button>
                    </div>
                </div>
            </div>

            <!-- Split Information Card -->
            <div class="lg:col-span-3">
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Splits Information</h2>
                        <button type="button" 
                                onclick="addNewSplit()"
                                class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                            Add New Split
                        </button>
                    </div>
                    
                    <!-- Dynamic Splits Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" id="splitsTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Split Value</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Split Paid</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for split in process_contract.splits.all %}
                                <tr class="split-row" data-id="{{ split.id }}">
                                    <td class="px-4 py-3">
                                        <input type="text" 
                                               name="splits-{{ split.id }}-company" 
                                               value="{{ split.company_name }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="hidden" name="splits-{{ split.id }}-id" value="{{ split.id }}">
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" 
                                       step="0.01" 
                                       name="splits-{{ split.id }}-value" 
                                       value="{{ split.split_value }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" 
                                       step="0.01" 
                                       name="splits-{{ split.id }}-paid" 
                                       value="{{ split.split_paid }}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center space-x-2">
                                    <button type="button" 
                                            onclick="saveSplit(this)" 
                                            class="text-green-600 hover:text-green-900"
                                            title="Save Split">
                                        <svg fill="#000000" width="20px" height="20px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1">
                                            <path d="M20.71,9.29l-6-6a1,1,0,0,0-.32-.21A1.09,1.09,0,0,0,14,3H6A3,3,0,0,0,3,6V18a3,3,0,0,0,3,3H18a3,3,0,0,0,3-3V10A1,1,0,0,0,20.71,9.29ZM9,5h4V7H9Zm6,14H9V16a1,1,0,0,1,1-1h4a1,1,0,0,1,1,1Zm4-1a1,1,0,0,1-1,1H17V16a3,3,0,0,0-3-3H10a3,3,0,0,0-3,3v3H6a1,1,0,0,1-1-1V6A1,1,0,0,1,6,5H7V8A1,1,0,0,0,8,9h6a1,1,0,0,0,1-1V6.41l4,4Z"/>
                                        </svg>
                                    </button>
                                    <button type="button" 
                                            onclick="removeSplit(this)" 
                                            class="text-red-600 hover:text-red-900"
                                            title="Delete Split">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Total Split Value Display -->
            <div class="mt-4 text-right">
                <p class="text-sm text-gray-600">Total Split Value: <span id="totalSplitValue">0.00</span></p>
                <p class="text-sm text-gray-600">Contract Value: {{ process_contract.contract_value|default:"0.00" }}</p>
            </div>
        </div>
    </div>

    <!-- CLIN Items Card -->
    <div class="lg:col-span-3">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800">CLIN Items</h2>
                <button type="button" 
                        onclick="addNewClin()"
                        class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                    Add New CLIN
                </button>
            </div>
            {{ clin_formset.management_form }}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CLIN</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Type</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NSN</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier</th>
                            <!-- <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Price</th> -->
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for clin_form in clin_formset %}
                        <tr class="hover:bg-gray-50">
                            <!-- Actions Column -->
                            <td class="px-4 py-3 text-sm font-medium">
                                <div class="flex items-center space-x-2">
                                    <button type="button" 
                                            data-action="toggle-clin"
                                            data-index="{{ forloop.counter0 }}"
                                            class="text-blue-600 hover:text-blue-900 flex items-center">
                                        <span class="clin-expand-icon-{{ forloop.counter0 }} flex items-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                            </svg>
                                            <span class="ml-1 text-sm clin-text-{{ forloop.counter0 }}">Expand</span>
                                        </span>
                                    </button>
                                </div>
                            </td>
                            <!-- Basic Info Columns -->
                            <td class="px-4 py-3">
                                <span class="text-sm font-medium text-gray-900">{{ clin_form.item_number.value|default:'' }}</span>
                                {{ clin_form.id }}
                                {{ clin_form.item_number.as_hidden }}
                            </td>
                            <td class="px-4 py-3">
                                <span class="text-sm text-gray-900">{{ clin_form.item_type.value|default:'---' }}</span>
                                {{ clin_form.item_type.as_hidden }}
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm">
                                    <div class="font-medium text-gray-900">{{ clin_form.instance.nsn_text|default:'Not Set' }}</div>
                                    <div class="text-gray-500 text-xs">{{ clin_form.instance.nsn_description_text|default:'' }}</div>
                                </div>
                                {{ clin_form.nsn.as_hidden }}
                            </td>
                            <td class="px-4 py-3">
                                <span class="text-sm text-gray-900">{{ clin_form.instance.supplier_text|default:'Not Set' }}</span>
                                {{ clin_form.supplier.as_hidden }}
                            </td>
                            <!-- <td class="px-4 py-3 text-right">
                                <span class="text-sm font-medium text-gray-900" data-field="order_qty">{{ clin_form.order_qty.value|floatformat:'1'|default:'0.0' }}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-sm font-medium text-gray-900" data-field="unit_price">${{ clin_form.unit_price.value|floatformat:'2'|default:'0.00' }}</span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-sm font-medium text-gray-900" data-field="item_value">${{ clin_form.item_value.value|floatformat:'2'|default:'0.00' }}</span>
                            </td> -->
                        </tr>
                        <!-- Detailed Edit Row (Initially Hidden) -->
                        <tr class="clin-details-{{ forloop.counter0 }} hidden">
                            <td colspan="8" class="px-4 py-4 bg-gray-50">
                                <!-- ITEM LINE -->
                                <div class="grid grid-cols-4 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="item_number_{{ clin_form.instance.id }}">Item Number</label>
                                        <input type="text" 
                                               id="item_number_{{ clin_form.instance.id }}"
                                               name="item_number" 
                                               value="{{ clin_form.item_number.value|default:'' }}" 
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               data-clin-id="{{ clin_form.instance.id }}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="item_type_{{ clin_form.instance.id }}">Item Type</label>
                                        <select id="item_type_{{ clin_form.instance.id }}"
                                                name="item_type" 
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                data-clin-id="{{ clin_form.instance.id }}">
                                            <option value="">-------</option>
                                            {% for choice in clin_form.item_type.field.choices %}
                                                <option value="{{ choice.0 }}" {% if clin_form.item_type.value == choice.0 %}selected{% endif %}>{{ choice.1 }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="clin_po_num_{{ clin_form.instance.id }}">CLIN PO Number</label>
                                        <input type="text" 
                                        id="clin_po_num_{{ clin_form.instance.id }}"
                                        name="clin_po_num" 
                                        value="{{ clin_form.clin_po_num.value }}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        data-clin-id="{{ clin_form.instance.id }}">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="tab_num_{{ clin_form.instance.id }}">Tab Number</label>
                                        <input type="text" 
                                        id="tab_num_{{ clin_form.instance.id }}"
                                        name="tab_num" 
                                        value="{{ clin_form.tab_num.value }}" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        data-clin-id="{{ clin_form.instance.id }}">
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 gap-4 mb-4">
                                    <hr />
                                </div>
                                <!-- NSN and Due date Line -->
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <!-- NSN Selection Box -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="nsn_{{ clin_form.instance.id }}">NSN*</label>
                                        <div class="flex gap-2 items-center">
                                            <input type="text" 
                                                   id="nsn_{{ clin_form.instance.id }}"
                                                   value="{{ clin_form.instance.nsn_text|default:'' }}" 
                                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                                   readonly
                                                   data-clin-id="{{ clin_form.instance.id }}">
                                            <button type="button" 
                                                    data-action="open-nsn"
                                                    data-id="{{ clin_form.instance.id }}"
                                                    data-nsn="{{ clin_form.instance.nsn_text|default:'' }}"
                                                    data-description="{{ clin_form.instance.nsn_description_text|default:'' }}"
                                                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                Match
                                            </button>
                                            {% if clin_form.instance.nsn %}
                                            <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            {% else %}
                                            <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                            {% endif %}
                                        </div>
                                        {% if clin_form.instance.nsn_description_text %}
                                        <p id="nsn_description_{{ clin_form.instance.id }}" class="mt-1 text-sm text-gray-500">{{ clin_form.instance.nsn_description_text }}</p>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="status_{{ clin_form.instance.id }}">Due Date</label>
                                        <input type="date" 
                                               id="due_date_{{ clin_form.instance.id }}"
                                               name="due_date" 
                                               value="{{ clin_form.due_date.value|date:'Y-m-d' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               data-clin-id="{{ clin_form.instance.id }}">
                                     </div>
                                </div>
                                <!--  CLIN Section     -->
                                <div class="grid grid-cols-9 gap-4 mb-4">
                                    <div class="col-span-2">
                                        <label class="col-span-3 block text-sm font-medium text-gray-700 mb-1" for="order_qty_{{ clin_form.instance.id }}">Quantity</label>
                                        <input type="number" 
                                               id="order_qty_{{ clin_form.instance.id }}"
                                               name="order_qty" 
                                               value="{{ clin_form.order_qty.value|floatformat:'1'|default:'0.0' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               data-clin-id="{{ clin_form.instance.id }}">
                                    </div>
                                    <div class="col-span-1">
                                        <label class="col-span-3 block text-sm font-medium text-gray-700 mb-1" for="uom_{{ clin_form.instance.id }}">UOM</label>
                                        <input type="text" 
                                               id="uom_{{ clin_form.instance.id }}"
                                               name="uom" 
                                               value="{{ clin_form.uom.value }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               data-clin-id="{{ clin_form.instance.id }}">
                                    </div>
                                    <div class="col-span-3">
                                        <label class="col-span-3 block text-sm font-medium text-gray-700 mb-1" for="unit_price_{{ clin_form.instance.id }}">Unit Price</label>
                                        <input type="number" 
                                               id="unit_price_{{ clin_form.instance.id }}"
                                               name="unit_price" 
                                               value="{{ clin_form.unit_price.value|floatformat:'2'|default:'0.00' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               data-clin-id="{{ clin_form.instance.id }}">
                                    </div>
                                    <div class="col-span-3">
                                        <label class="col-span-3 block text-sm font-medium text-gray-700 mb-1" for="item_value_{{ clin_form.instance.id }}">Total Value</label>
                                        <div class="flex gap-2">
                                            <input type="number" 
                                                   id="item_value_{{ clin_form.instance.id }}"
                                                   name="item_value" 
                                                   value="{{ clin_form.item_value.value|floatformat:'2'|default:'0.00' }}"
                                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                   readonly
                                                   data-clin-id="{{ clin_form.instance.id }}">
                                            <button type="button" 
                                                    onclick="recalculateTotal(this)"
                                                    data-clin-id="{{ clin_form.instance.id }}"
                                                    class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                                                ReCalc
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 gap-4 mb-4">
                                    <hr />
                                </div>
                                <!-- Supplier Selection Box -->
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="supplier_{{ clin_form.instance.id }}">Supplier*</label>
                                        <div class="flex gap-2 items-center">
                                            <input type="text" 
                                                   id="supplier_{{ clin_form.instance.id }}"
                                                   value="{{ clin_form.instance.supplier_text|default:'' }}" 
                                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md bg-gray-50" 
                                                   readonly
                                                   data-clin-id="{{ clin_form.instance.id }}">
                                            <button type="button" 
                                                    data-action="open-supplier"
                                                    data-id="{{ clin_form.instance.id }}"
                                                    data-supplier="{{ clin_form.instance.supplier_text|default:'' }}"
                                                    class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                                Match
                                            </button>
                                            {% if clin_form.instance.supplier %}
                                            <svg class="h-6 w-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                            {% else %}
                                            <svg class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="supplier_due_date_{{ clin_form.instance.id }}">Supplier Due Date</label>
                                        <input type="date" 
                                               id="supplier_due_date_{{ clin_form.instance.id }}"
                                               name="supplier_due_date" 
                                               value="{{ clin_form.supplier_due_date.value|date:'Y-m-d' }}"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               data-clin-id="{{ clin_form.instance.id }}">
                                    </div>
                                </div>

                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-1" for="special_payment_terms_{{ clin_form.instance.id }}">Special Payment Terms ({{ clin_form.special_payment_terms_text.value }})</label>
                                            <select id="special_payment_terms_{{ clin_form.instance.id }}"
                                                    name="special_payment_terms" 
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                    data-clin-id="{{ clin_form.instance.id }}">
                                                <option value="">-------</option>
                                                {% for terms in special_payment_terms %}
                                                    <option value="{{ terms.0 }}" {% if clin_form.special_payment_terms.value == terms.0 %}selected{% endif %}>{{ terms.terms }}</option>
                                                {% endfor %}
                                            </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="price_per_unit_{{ clin_form.instance.id }}">Supplier Price</label>
                                        <input type="number" 
                                               id="price_per_unit_{{ clin_form.instance.id }}"
                                               name="price_per_unit" 
                                               value="{{ clin_form.price_per_unit.value|default:'0' }}"
                                               step="any"
                                               min="0"
                                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                               data-clin-id="{{ clin_form.instance.id }}"
                                               onchange="handlePriceChange(this)">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="quote_value_{{ clin_form.instance.id }}">Supplier Total</label>
                                        <div class="flex gap-2">
                                            <input type="number" 
                                                   id="quote_value_{{ clin_form.instance.id }}"
                                                   step="0.01" 
                                                   name="quote_value" 
                                                   value="{{ clin_form.quote_value.value|floatformat:'2'|default:'0.00' }}"
                                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                                   readonly
                                                   data-clin-id="{{ clin_form.instance.id }}">
                                            <button type="button" 
                                                    onclick="recalculateTotal(this)"
                                                    data-clin-id="{{ clin_form.instance.id }}"
                                                    class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                                                ReCalc
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-8 gap-4 mb-4">
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="ia_{{ clin_form.instance.id }}">IA</label>
                                        <select id="ia_{{ clin_form.instance.id }}"
                                                name="ia" 
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                data-clin-id="{{ clin_form.instance.id }}">
                                                <option value="">-------</option>
                                                <option value="O" {% if clin_form.instance.ia == 'O' %}selected{% endif %}>Origin</option>
                                                <option value="D" {% if clin_form.instance.ia == 'D' %}selected{% endif %}>Destination</option>
                                        </select>
                                    </div>
                                    <div class="col-span-2">
                                        <label class="block text-sm font-medium text-gray-700 mb-1" for="fob_{{ clin_form.instance.id }}">FOB</label>
                                        <select id="fob_{{ clin_form.instance.id }}"
                                                name="fob" 
                                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                data-clin-id="{{ clin_form.instance.id }}">
                                                <option value="">-------</option>
                                                <option value="O" {% if clin_form.instance.fob == 'O' %}selected{% endif %}>Origin</option>
                                                <option value="D" {% if clin_form.instance.fob == 'D' %}selected{% endif %}>Destination</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-4 flex justify-end">
                                    <button type="button" 
                                            onclick="showDeleteModal(this)" 
                                            data-clin-id="{{ clin_form.instance.id }}"
                                            class="bg-red-500 text-white hover:bg-red-600 px-4 py-2 rounded flex items-center gap-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Delete CLIN
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

</form>
</div>

<!-- Cancel Processing Confirmation Modal -->
<div id="cancelModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Cancel Processing</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Are you sure you want to cancel processing this contract?</p>
                <p class="text-sm text-red-500 mt-2">This action cannot be undone and all progress will be lost.</p>
            </div>
            <div class="mt-4 flex justify-center space-x-4">
                <button onclick="closeModal()" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">
                    No, Keep Processing
                </button>
                <button onclick="cancelProcessing()" 
                        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">
                    Yes, Cancel Processing
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add the delete confirmation modal -->
<div id="deleteClinModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-[2000]">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">Delete CLIN</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Are you sure you want to delete this CLIN? This action cannot be undone.</p>
            </div>
            <div class="mt-4 flex justify-center space-x-4">
                <button id="cancelDeleteClin" 
                        class="bg-gray-200 text-gray-800 active:bg-gray-300 font-bold px-6 py-3 rounded shadow hover:shadow-lg outline-none focus:outline-none mr-1 mb-1">
                    Cancel
                </button>
                <button id="confirmDeleteClin" 
                        class="bg-red-500 text-white active:bg-red-600 font-bold px-6 py-3 rounded shadow hover:shadow-lg outline-none focus:outline-none mr-1 mb-1">
                    Delete CLIN
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Include all modals -->
{% include "processing/modals/idiq_modal.html" %}
{% include "processing/modals/buyer_modal.html" %}
{% include "processing/modals/nsn_modal.html" %}
{% include "processing/modals/supplier_modal.html" %}

<!-- Include all modal scripts -->
<script src="{% static 'processing/js/idiq_modal.js' %}"></script>
<script src="{% static 'processing/js/buyer_modal.js' %}"></script>
<script src="{% static 'processing/js/nsn_modal.js' %}"></script>
<script src="{% static 'processing/js/supplier_modal.js' %}"></script>

<!-- JavaScript for form functionality -->
<script>
    // Function to update Contract Value and Plan Gross
    async function updateContractCalculations() {
        let totalItemValue = 0;
        let totalQuoteValue = 0;

        // Get all CLIN item values from expanded sections only
        document.querySelectorAll('[class^="clin-details-"] input[id^="item_value_"]').forEach(input => {
            totalItemValue += parseFloat(input.value || 0);
        });
        console.log('Total Item Value:', totalItemValue);

        // Get all quote values from expanded sections only
        document.querySelectorAll('[class^="clin-details-"] input[id^="quote_value_"]').forEach(input => {
            totalQuoteValue += parseFloat(input.value || 0);
        });
        console.log('Total Quote Value:', totalQuoteValue);

        // Update Contract Value field (total of item values)
        const contractValueInput = document.querySelector('input[name="contract_value"]');
        if (contractValueInput) {
            contractValueInput.value = totalItemValue.toFixed(2);
            // Save contract value to database
            saveField(contractValueInput);
        }

        // Update Plan Gross field (item values minus quote values)
        const planGrossInput = document.querySelector('input[name="plan_gross"]');
        if (planGrossInput) {
            const planGrossValue = totalItemValue - totalQuoteValue;
            planGrossInput.value = planGrossValue.toFixed(2);
            // Save plan gross to database
            saveField(planGrossInput);

            // Calculate total of existing splits
            let totalSplitValue = 0;
            document.querySelectorAll('input[name$="-value"]').forEach(input => {
                if (!input.name.includes('new-calculation-difference')) {
                    totalSplitValue += parseFloat(input.value || 0);
                }
            });

            // Find difference between Plan Gross and total splits
            const splitDifference = planGrossValue - totalSplitValue;

            // Remove any existing calculation difference split
            document.querySelectorAll('.split-row').forEach(row => {
                if (row.querySelector('input[name*="new-calculation-difference"]')) {
                    row.remove();
                }
            });

            // If there's a difference, add a new split
            if (Math.abs(splitDifference) > 0.01) { // Using 0.01 to account for floating point precision
                const processContractId = parseInt("{{ process_contract.id }}");
                
                // First save the split to the database
                try {
                    const splitData = {
                        process_contract_id: processContractId,
                        company_name: "Calculation Difference",
                        split_value: splitDifference
                    };

                    const response = await fetch('/processing/contract/split/create/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify(splitData)
                    });

                    // Log the raw response for debugging
                    console.log('Response status:', response.status);
                    const responseText = await response.text();
                    console.log('Response text:', responseText);

                    // Try to parse the response as JSON
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        console.error('Failed to parse JSON response:', e);
                        throw new Error('Invalid server response format');
                    }

                    if (data.success && data.split_id) {
                        // Now add the row to the UI with the saved ID
                        const table = document.querySelector('#splitsTable tbody');
                        const newRow = document.createElement('tr');
                        newRow.className = 'split-row';
                        newRow.innerHTML = `
                            <td class="px-4 py-3">
                                <input type="text" 
                                       name="splits-${data.split_id}-company" 
                                       value="Calculation Difference" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <input type="hidden" name="splits-${data.split_id}-id" value="${data.split_id}">
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" 
                                       step="0.01" 
                                       name="splits-${data.split_id}-value" 
                                       value="${splitDifference.toFixed(2)}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </td>
                            <td class="px-4 py-3">
                                <input type="number" 
                                       step="0.01" 
                                       name="splits-${data.split_id}-paid" 
                                       value="0.00" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </td>
                            <td class="px-4 py-3 text-center">
                                <div class="flex justify-center space-x-2">
                                    <button type="button" 
                                            onclick="saveSplit(this)" 
                                            class="text-green-600 hover:text-green-900"
                                            title="Save Split">
                                        <svg fill="#000000" width="20px" height="20px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1">
                                            <path d="M20.71,9.29l-6-6a1,1,0,0,0-.32-.21A1.09,1.09,0,0,0,14,3H6A3,3,0,0,0,3,6V18a3,3,0,0,0,3,3H18a3,3,0,0,0,3-3V10A1,1,0,0,0,20.71,9.29ZM9,5h4V7H9Zm6,14H9V16a1,1,0,0,1,1-1h4a1,1,0,0,1,1,1Zm4-1a1,1,0,0,1-1,1H17V16a3,3,0,0,0-3-3H10a3,3,0,0,0-3,3v3H6a1,1,0,0,1-1-1V6A1,1,0,0,1,6,5H7V8A1,1,0,0,0,8,9h6a1,1,0,0,0,1-1V6.41l4,4Z"/>
                                        </svg>
                                    </button>
                                    <button type="button" 
                                            onclick="removeSplit(this)" 
                                            class="text-red-600 hover:text-red-900"
                                            title="Delete Split">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        `;
                        table.appendChild(newRow);
                        showMessage('Calculation difference split created and saved', 'success');
                    } else {
                        throw new Error(data.error || 'Failed to save calculation difference split');
                    }
                } catch (error) {
                    console.error('Error saving calculation difference split:', error);
                    showMessage('Error saving calculation difference split: ' + error.message, 'error');
                }
            }

            // Update the total split value display
            updateTotalSplitValue();
        }

        // Show success message
        showMessage('Contract calculations updated and saved', 'success');
    }

    // Global variables for modal functionality
    const processContractId = "{{ process_contract.id }}";

    // Calculate total price when quantity or unit price changes
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('tr');
        forms.forEach(form => {
            const qtyInput = form.querySelector('[name$="-order_qty"]');
            const priceInput = form.querySelector('[name$="-unit_price"]');
            const totalInput = form.querySelector('[name$="-item_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const calculateTotal = () => {
                    const qty = parseFloat(qtyInput.value) || 0;
                    const price = parseFloat(priceInput.value) || 0;
                    totalInput.value = (qty * price).toFixed(2);
                };
                
                qtyInput.addEventListener('input', calculateTotal);
                priceInput.addEventListener('input', calculateTotal);
            }
        });
    });

    function confirmCancel() {
        document.getElementById('cancelModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('cancelModal').classList.add('hidden');
    }

    async function cancelProcessing() {
        try {
            // Make API call to handle lock removal and status change
            const response = await fetch(`{% url 'processing:cancel_process_contract' process_contract_id=0 %}`.replace('0', processContractId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to cancel processing');
            }

            // If successful, redirect to queue
            window.location.href = "{% url 'processing:queue' %}";
        } catch (error) {
            console.error('Error canceling processing:', error);
            alert(error.message || 'Failed to cancel processing. Please try again.');
        }
    }

    function markReadyForReview() {
        const processContractId = document.getElementById('process_contract_id').value;
        const url = `/processing/process-contract/${processContractId}/mark-ready/`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = '/processing/queue/';
            } else {
                showErrorMessage(data.error || 'An error occurred while marking the contract as ready for review.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorMessage('An error occurred while marking the contract as ready for review.');
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Add event listeners for CLIN expand/collapse
        document.querySelectorAll('[data-action="toggle-clin"]').forEach(button => {
            button.addEventListener('click', function() {
                const index = this.dataset.index;
                toggleClinDetails(index);
            });
        });
    });

    // Add this function for CLIN expand/collapse
    function toggleClinDetails(index) {
        const detailsRow = document.querySelector(`.clin-details-${index}`);
        const expandIcon = document.querySelector(`.clin-expand-icon-${index}`);
        
        if (detailsRow.classList.contains('hidden')) {
            detailsRow.classList.remove('hidden');
            expandIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <span class="ml-1 text-sm clin-text-${index}">Hide</span>
            `;
        } else {
            detailsRow.classList.add('hidden');
            expandIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
                <span class="ml-1 text-sm clin-text-${index}">Expand</span>
            `;
        }
    }

    function addNewSplit() {
        const table = document.querySelector('#splitsTable tbody');
        const newRow = document.createElement('tr');
        const timestamp = new Date().getTime(); // Use timestamp as temporary ID
        
        newRow.className = 'split-row unsaved-split';
        newRow.innerHTML = `
            <td class="px-4 py-3 relative">
                <div class="flex items-center gap-2">
                    <input type="text" 
                           name="splits-new-${timestamp}-company" 
                           class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-yellow-50">
                    <span class="bg-yellow-200 text-yellow-800 text-xs font-medium px-2 py-1 rounded whitespace-nowrap">
                        Unsaved
                    </span>
                </div>
                <input type="hidden" name="splits-new-${timestamp}-id" value="">
            </td>
            <td class="px-4 py-3">
                <input type="number" 
                       step="0.01" 
                       name="splits-new-${timestamp}-value" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-yellow-50">
            </td>
            <td class="px-4 py-3">
                <input type="number" 
                       step="0.01" 
                       name="splits-new-${timestamp}-paid" 
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-yellow-50">
            </td>
            <td class="px-4 py-3 text-center">
                <div class="flex justify-center space-x-2">
                    <button type="button" 
                            onclick="saveSplit(this)" 
                            class="text-green-600 hover:text-green-900 animate-pulse"
                            title="Save Split">
                        <svg fill="#000000" width="20px" height="20px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1">
                            <path d="M20.71,9.29l-6-6a1,1,0,0,0-.32-.21A1.09,1.09,0,0,0,14,3H6A3,3,0,0,0,3,6V18a3,3,0,0,0,3,3H18a3,3,0,0,0,3-3V10A1,1,0,0,0,20.71,9.29ZM9,5h4V7H9Zm6,14H9V16a1,1,0,0,1,1-1h4a1,1,0,0,1,1,1Zm4-1a1,1,0,0,1-1,1H17V16a3,3,0,0,0-3-3H10a3,3,0,0,0-3,3v3H6a1,1,0,0,1-1-1V6A1,1,0,0,1,6,5H7V8A1,1,0,0,0,8,9h6a1,1,0,0,0,1-1V6.41l4,4Z"/>
                        </svg>
                    </button>
                    <button type="button" 
                            onclick="removeSplit(this)" 
                            class="text-red-600 hover:text-red-900"
                            title="Delete Split">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </td>
        `;
        
        table.appendChild(newRow);
        updateTotalSplitValue();
    }

    async function saveSplit(button) {
        const row = button.closest('tr');
        const processContractId = parseInt("{{ process_contract.id }}");
        const splitId = row.querySelector('input[name$="-id"]').value;
        const companyInput = row.querySelector('input[name$="-company"]');
        const valueInput = row.querySelector('input[name$="-value"]');
        const paidInput = row.querySelector('input[name$="-paid"]');

        // Format the data according to the model fields
        const splitData = {
            company_name: companyInput.value.trim(),
            split_value: parseFloat(valueInput.value) || 0.00,
            split_paid: parseFloat(paidInput.value) || 0.00
        };

        try {
            const url = splitId ? 
                `/processing/contract/split/${splitId}/update/` :
                `/processing/contract/split/create/`;
            
            // If creating new split, include process_contract_id
            if (!splitId) {
                splitData.process_contract_id = processContractId;
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify(splitData)
            });

            const data = await response.json();

            if (data.success) {
                showMessage('Split saved successfully', 'success');
                if (!splitId && data.split_id) {
                    // Update the row with the new split ID
                    const idInput = row.querySelector('input[name$="-id"]');
                    idInput.value = data.split_id;
                    // Update the input names to use the new ID
                    companyInput.name = `splits-${data.split_id}-company`;
                    valueInput.name = `splits-${data.split_id}-value`;
                    paidInput.name = `splits-${data.split_id}-paid`;
                    
                    // Remove unsaved styling
                    row.classList.remove('unsaved-split');
                    const inputs = row.querySelectorAll('.bg-yellow-50');
                    inputs.forEach(input => input.classList.remove('bg-yellow-50'));
                    row.querySelector('.bg-yellow-200')?.closest('.flex')?.querySelector('span')?.remove();
                    button.classList.remove('animate-pulse');
                }
                // Update total split value display
                updateTotalSplitValue();
            } else {
                throw new Error(data.error || 'Failed to save split');
            }
        } catch (error) {
            console.error('Save split error:', error);
            showMessage('Error saving split: ' + error.message, 'error');
        }
    }

    async function removeSplit(button) {
        const row = button.closest('tr');
        const splitId = row.querySelector('input[name$="-id"]').value;

        if (!splitId) {
            // If it's a new unsaved split, just remove from UI
            row.remove();
            updateTotalSplitValue();
            return;
        }

        try {
            const response = await fetch(`/processing/contract/split/${splitId}/delete/`, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            // Log the raw response for debugging
            console.log('Response status:', response.status);
            const responseText = await response.text();
            console.log('Response text:', responseText);

            // Try to parse the response as JSON
            let data;
            try {
                data = JSON.parse(responseText);
            } catch (e) {
                console.error('Failed to parse JSON response:', e);
                throw new Error('Invalid server response format');
            }

            if (data.success) {
                row.remove();
                updateTotalSplitValue();
                showMessage('Split deleted successfully', 'success');
            } else {
                throw new Error(data.error || 'Failed to delete split');
            }
        } catch (error) {
            console.error('Delete split error:', error);
            showMessage('Error deleting split: ' + error.message, 'error');
        }
    }

    function updateTotalSplitValue() {
        const splitValues = document.querySelectorAll('input[name$="-value"]');
        let total = 0;
        
        splitValues.forEach(input => {
            total += parseFloat(input.value || 0);
        });
        
        document.getElementById('totalSplitValue').textContent = total.toFixed(2);
    }

    // Add event listeners for split value changes
    document.addEventListener('input', function(e) {
        if (e.target.name && e.target.name.endsWith('-value')) {
            updateTotalSplitValue();
        }
    });

    // Initial calculation
    document.addEventListener('DOMContentLoaded', function() {
        updateTotalSplitValue();
    });

    function recalculateTotal(button) {
        const clinId = button.dataset.clinId;
        const row = button.closest('.grid');
        
        // Check if this is a supplier calculation or CLIN calculation
        const isSupplierCalc = row.querySelector('input[name="price_per_unit"]') !== null;
        
        if (isSupplierCalc) {
            // Supplier calculation
            const qtyInput = document.querySelector(`#order_qty_${clinId}`); // Get the main quantity input
            const priceInput = row.querySelector('input[name="price_per_unit"]');
            const totalInput = row.querySelector('input[name="quote_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = qty * price;
                totalInput.value = total.toFixed(2);
                
                // Save the recalculated values
                saveClinField(priceInput, clinId);
                saveClinField(totalInput, clinId);
            }
        } else {
            // CLIN calculation
            const qtyInput = row.querySelector('input[name="order_qty"]');
            const priceInput = row.querySelector('input[name="unit_price"]');
            const totalInput = row.querySelector('input[name="item_value"]');
            
            if (qtyInput && priceInput && totalInput) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = qty * price;
                totalInput.value = total.toFixed(2);
                
                // Save the recalculated values
                saveClinField(qtyInput, clinId);
                saveClinField(priceInput, clinId);
                saveClinField(totalInput, clinId);
            }
        }
        
        // Update contract calculations after any value changes
        // updateContractCalculations();
    }

    // Add function to format number inputs to 2 decimal places
    function formatNumberInput(input) {
        if (input && input.value) {
            const value = parseFloat(input.value) || 0;
            input.value = value.toFixed(2);
        }
    }

    // Add these new functions for price handling
    function handlePriceChange(input) {
        // Only format when the user is done typing (on change)
        if (input.value) {
            const value = parseFloat(input.value) || 0;
            // Store the full value but display formatted
            input.setAttribute('data-full-value', value);
            input.value = value.toFixed(2);
        }
    }

    // Add these new functions for auto-saving and CLIN deletion
    let saveTimeout;

    function autoSave(element) {
        clearTimeout(saveTimeout);
        const form = document.querySelector('form');
        const formData = new FormData(form);
        
        // Debug logs for form data
        console.log('Element that triggered save:', element.name, element.value);
        console.log('Form data entries:');
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        
        // Ensure status is included
        if (!formData.get('status')) {
            formData.set('status', '{{ process_contract.status }}');
        }

        // Show saving indicator
        showMessage('Saving changes...', 'info');
        
        saveTimeout = setTimeout(() => {
            fetch(`{% url 'processing:save_and_return' process_contract_id=process_contract.id %}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json().then(data => {
                    if (!response.ok) {
                        console.error('Server response:', data);
                        throw new Error(data.error || `Server error: ${response.status}`);
                    }
                    return data;
                });
            })
            .then(data => {
                if (data.success) {
                    showMessage('Changes saved successfully', 'success');
                } else {
                    const errorMsg = data.errors ? Object.entries(data.errors).map(([field, errors]) => 
                        `${field}: ${errors.join(', ')}`).join('\n') : data.error;
                    throw new Error(errorMsg || 'Unknown error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showMessage('Error saving changes: ' + error.message, 'error');
            });
        }, 1000); // Wait 1 second after last change before saving
    }

    // Update the deleteClin function
    let clinToDelete = null;
    let clinRowToDelete = null;
    let detailsRowToDelete = null;

    function showDeleteModal(button) {
        clinToDelete = button.dataset.clinId;
        clinRowToDelete = button.closest('tr').previousElementSibling;
        detailsRowToDelete = button.closest('tr');

        // If this is a new unsaved CLIN (no ID), just remove it from the UI
        if (!clinToDelete || clinToDelete === 'None') {
            clinRowToDelete.remove();
            detailsRowToDelete.remove();
            updateContractCalculations();
            return;
        }

        document.getElementById('deleteClinModal').classList.remove('hidden');
    }

    // Update the delete confirmation handler
    document.getElementById('confirmDeleteClin').addEventListener('click', async function() {
        if (!clinToDelete || clinToDelete === 'None') {
            // This shouldn't happen as we handle it in showDeleteModal, but just in case
            clinRowToDelete.remove();
            detailsRowToDelete.remove();
            document.getElementById('deleteClinModal').classList.add('hidden');
            updateContractCalculations();
            return;
        }

        try {
            const response = await fetch(`{% url 'processing:api_delete_processing_clin' id=process_contract.id clin_id=0 %}`.replace('0', clinToDelete), {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (data.success) {
                showMessage('CLIN deleted successfully', 'success');
                clinRowToDelete.remove();
                detailsRowToDelete.remove();
                document.getElementById('deleteClinModal').classList.add('hidden');
                clinToDelete = null;
                clinRowToDelete = null;
                detailsRowToDelete = null;
                updateContractCalculations();
            } else {
                throw new Error(data.error || 'Failed to delete CLIN');
            }
        } catch (error) {
            showMessage('Error deleting CLIN: ' + error.message, 'error');
            document.getElementById('deleteClinModal').classList.remove('hidden');
        }
    });

    // Add function to prevent empty CLIN creation
    function preventEmptyCliCreation() {
        const formset = document.querySelector('tbody');
        const rows = formset.querySelectorAll('tr');
        
        // If there's only one CLIN and it's empty, don't allow deletion
        if (rows.length <= 2) { // 2 because each CLIN has two rows (main + details)
            const deleteButtons = formset.querySelectorAll('button[onclick^="showDeleteModal"]');
            deleteButtons.forEach(button => {
                if (!button.dataset.clinId || button.dataset.clinId === 'None') {
                    button.style.display = 'none';
                }
            });
        }
    }

    // Call this function on page load
    document.addEventListener('DOMContentLoaded', function() {
        preventEmptyCliCreation();
    });

    // Update the showMessage function to handle message grouping and deduplication
    function showMessage(message, type = 'info') {
        const container = document.getElementById('custom-messages');
        
        // Remove any existing messages with the same text to prevent duplicates
        const existingMessages = container.querySelectorAll('.message-text');
        for (const existing of existingMessages) {
            if (existing.textContent === message) {
                return; // Skip showing duplicate message
            }
        }
        
        // Limit the number of visible messages
        const maxMessages = 3;
        const currentMessages = container.children;
        while (currentMessages.length >= maxMessages) {
            container.removeChild(currentMessages[0]);
        }
        
        const messageDiv = document.createElement('div');
        
        // Set message styles based on type
        const baseClasses = 'px-4 py-3 rounded relative mb-2 shadow-lg transition-all duration-500';
        const typeClasses = {
            'success': 'bg-green-100 border border-green-400 text-green-700',
            'error': 'bg-red-100 border border-red-400 text-red-700',
            'info': 'bg-blue-100 border border-blue-400 text-blue-700',
            'warning': 'bg-yellow-100 border border-yellow-400 text-yellow-700'
        };
        
        messageDiv.className = `${baseClasses} ${typeClasses[type] || typeClasses.info}`;
        messageDiv.innerHTML = `
            <span class="block sm:inline message-text">${message}</span>
            <button type="button" class="absolute top-0 right-0 px-4 py-3" onclick="this.parentElement.remove()">
                <svg class="h-4 w-4" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                    <title>Close</title>
                    <path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/>
                </svg>
            </button>
        `;
        
        container.appendChild(messageDiv);
        
        // Remove message after delay (longer for errors)
        const delay = type === 'error' ? 8000 : 3000;
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(-100%)';
            setTimeout(() => messageDiv.remove(), 500);
        }, delay);
    }

    // Update saveField to be more selective about showing messages
    function saveField(element) {
        const fieldName = element.name;
        const fieldValue = element.value;
        const processContractId = "{{ process_contract.id }}";
        
        // Don't show saving message for every field change
        if (!['contract_value', 'plan_gross'].includes(fieldName)) {
            console.log('Saving field:', fieldName, fieldValue); // Keep logging for debugging
        } else {
            showMessage(`Saving ${fieldName}...`, 'info');
        }
        
        const formData = new FormData();
        formData.append('field_name', fieldName);
        formData.append('field_value', fieldValue);
        
        return fetch(`/processing/api/update-field/${processContractId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('Save response:', data);
            if (data.status === 'success') {
                // Only show success messages for important fields
                if (['contract_value', 'plan_gross'].includes(fieldName)) {
                    showMessage(`${fieldName} saved successfully`, 'success');
                }
                
                // Update any related fields
                if (data.related_updates) {
                    Object.entries(data.related_updates).forEach(([relatedField, value]) => {
                        const relatedElement = document.querySelector(`[name="${relatedField}"]`);
                        if (relatedElement) {
                            relatedElement.value = value;
                        }
                    });
                }
                return data; // Return the data for chaining
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showMessage('Error saving: ' + error.message, 'error');
            // Revert the field to its previous value if needed
            if (element.dataset.previousValue) {
                element.value = element.dataset.previousValue;
            }
            throw error; // Re-throw to maintain Promise rejection
        });
    }

    // Update saveClinField to be more selective about showing messages
    function saveClinField(element, clinId) {
        const fieldName = element.name;
        const fieldValue = element.value;
        const processContractId = "{{ process_contract.id }}";
        
        // Don't show saving message for routine field changes
        if (['item_value', 'quote_value'].includes(fieldName)) {
            showMessage(`Saving CLIN ${clinId} ${fieldName}...`, 'info');
        }
        
        const formData = new FormData();
        formData.append('field_name', fieldName);
        formData.append('field_value', fieldValue);
        
        fetch(`/processing/api/update-clin-field/${processContractId}/clin/${clinId}/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Only show success messages for important fields
                if (['item_value', 'quote_value'].includes(fieldName)) {
                    showMessage(`CLIN ${clinId} ${fieldName} saved successfully`, 'success');
                }
                
                // Update any related fields
                if (data.related_updates) {
                    Object.entries(data.related_updates).forEach(([relatedField, value]) => {
                        const clinSection = element.closest('tr').nextElementSibling;
                        if (clinSection) {
                            const relatedInput = clinSection.querySelector(`[name$="${relatedField}"]`);
                            if (relatedInput) {
                                relatedInput.value = value;
                                
                                // Also update the display value in the main table row if it exists
                                const mainRow = clinSection.previousElementSibling;
                                const displaySpan = mainRow.querySelector(`[data-field="${relatedField}"]`);
                                if (displaySpan) {
                                    displaySpan.textContent = value;
                                }
                            }
                        }
                    });
                }
            } else {
                throw new Error(data.message);
            }
        })
        .catch(error => {
            console.error('Save CLIN error:', error);
            showMessage('Error saving: ' + error.message, 'error');
            // Revert the field to its previous value if needed
            if (element.dataset.previousValue) {
                element.value = element.dataset.previousValue;
            }
        });
    }

    // Update setupFieldSaving to handle both regular and CLIN fields
    function setupFieldSaving() {
        // Special handling for NIST select
        const nistSelect = document.querySelector('select[name="nist"]');
        if (nistSelect) {
            nistSelect.addEventListener('change', function() {
                console.log('NIST changed:', this.value); // Debug log
                saveField(this);
            });
        }

        // Add specific handling for CLIN text fields
        const clinTextFields = ['uom', 'clin_po_num', 'tab_num'];
        clinTextFields.forEach(fieldName => {
            document.querySelectorAll(`[name="${fieldName}"]`).forEach(element => {
                const clinId = element.dataset.clinId;
                if (clinId) {
                    // Store the initial value
                    element.dataset.previousValue = element.value;
                    
                    // Add input event listener with debounce
                    let debounceTimer;
                    element.addEventListener('input', function() {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            if (this.value !== this.dataset.previousValue) {
                                console.log(`${fieldName} changed:`, this.value); // Debug log
                                saveClinField(this, clinId);
                                this.dataset.previousValue = this.value;
                            }
                        }, 1000);
                    });

                    // Add blur event listener
                    element.addEventListener('blur', function() {
                        if (this.value !== this.dataset.previousValue) {
                            console.log(`${fieldName} blur:`, this.value); // Debug log
                            clearTimeout(debounceTimer);
                            saveClinField(this, clinId);
                            this.dataset.previousValue = this.value;
                        }
                    });
                }
            });
        });

        document.querySelectorAll('input, select, textarea').forEach(element => {
            // Skip elements that are part of hidden form management
            if (element.name.includes('TOTAL_FORMS') || 
                element.name.includes('INITIAL_FORMS') || 
                element.name.includes('MIN_NUM_FORMS') || 
                element.name.includes('MAX_NUM_FORMS')) {
                return;
            }
            
            // Skip NIST select and CLIN text fields as they're handled separately
            if (element.name === 'nist' || clinTextFields.includes(element.name)) {
                return;
            }
            
            // Store the initial value
            element.dataset.previousValue = element.value;
            
            // Check if this is a CLIN field
            const clinId = element.dataset.clinId;
            const saveFunction = clinId ? 
                () => saveClinField(element, clinId) : 
                () => saveField(element);
            
            // For select elements and checkboxes
            if (element.tagName === 'SELECT' || element.type === 'checkbox') {
                element.addEventListener('change', function() {
                    console.log('Select/checkbox changed:', this.name); // Debug log
                    saveFunction();
                });
            }
            // For text/number inputs
            else if (element.type === 'text' || element.type === 'number' || element.type === 'date') {
                let debounceTimer;
                element.addEventListener('input', function() {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        if (this.value !== this.dataset.previousValue) {
                            console.log('Input changed:', this.name); // Debug log
                            saveFunction();
                            this.dataset.previousValue = this.value;
                        }
                    }, 1000); // Wait 1 second after last input before saving
                });
                
                // Also save on blur (when input loses focus)
                element.addEventListener('blur', function() {
                    if (this.value !== this.dataset.previousValue) {
                        console.log('Input blur:', this.name); // Debug log
                        clearTimeout(debounceTimer);
                        saveFunction();
                        this.dataset.previousValue = this.value;
                    }
                });
            }
        });
    }

    // Make sure setupFieldSaving is called when the document loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Setting up field saving...'); // Debug log
        setupFieldSaving();
        
        // Initialize the custom messages container if it doesn't exist
        if (!document.getElementById('custom-messages-container')) {
            const container = document.createElement('div');
            container.id = 'custom-messages-container';
            container.className = 'fixed top-0 left-0 right-0 flex justify-center items-start pt-20 z-[2000] pointer-events-none';
            const messages = document.createElement('div');
            messages.id = 'custom-messages';
            messages.className = 'pointer-events-auto';
            container.appendChild(messages);
            document.body.insertBefore(container, document.body.firstChild);
        }
    });

    // Add this CSS to your existing styles section or create a new one
    const styles = document.createElement('style');
    styles.textContent = `
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .unsaved-split {
            position: relative;
            background-color: rgb(254, 252, 232, 0.2);
        }
    `;
    document.head.appendChild(styles);

    async function addNewClin() {
        try {
            const processContractId = "{{ process_contract.id }}";
            const response = await fetch(`/processing/api/contract/${processContractId}/clin/create/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({})  // Empty object for default values
            });

            const data = await response.json();

            if (data.success) {
                // Reload the page to show the new CLIN
                window.location.reload();
                showMessage('New CLIN added successfully', 'success');
            } else {
                throw new Error(data.error || 'Failed to add CLIN');
            }
        } catch (error) {
            console.error('Error adding CLIN:', error);
            showMessage('Error adding CLIN: ' + error.message, 'error');
        }
    }

    // Confirmation dialog for cancelling the contract
    function statusChange(status) {
        const currentStatus = "{{ process_contract.status }}";
        const validTransitions = {
            'draft': ['in_progress', 'cancelled'],
            'in_progress': ['ready_for_review', 'cancelled'],
            'ready_for_review': ['completed', 'in_progress', 'cancelled'],
            'completed': ['cancelled'],
            'cancelled': []
        };

        // Check if the transition is valid
        if (!validTransitions[currentStatus]?.includes(status)) {
            showMessage(`Invalid status transition from ${currentStatus} to ${status}`, 'error');
            // Reset the select to current status
            document.querySelector('select[name="status"]').value = currentStatus;
            return;
        }

        // Handle specific status transitions
        switch(status) {
            case 'cancelled':
                confirmCancel();
                break;
            case 'completed':
                // Validate all required fields before allowing completion
                if (!validateForCompletion()) {
                    showMessage('Please complete all required fields before marking as completed', 'error');
                    document.querySelector('select[name="status"]').value = currentStatus;
                    return;
                }
                break;
            case 'ready_for_review':
                // Check if all CLINs are properly matched
                if (!validateClins()) {
                    showMessage('Please ensure all CLINs have matched NSNs and suppliers before marking ready for review', 'error');
                    document.querySelector('select[name="status"]').value = currentStatus;
                    return;
                }
                // Save the status first
                saveField(document.querySelector('select[name="status"]')).then(() => {
                    showMessage('Contract marked as ready for review. Redirecting to queue...', 'success');
                    // Wait a moment for the message to be visible
                    setTimeout(() => {
                        window.location.href = "{% url 'processing:queue' %}";
                    }, 1500);
                });
                return; // Return early since we're handling the save and redirect
                break;
        }

        // If we get here, save the new status (for non-ready_for_review cases)
        saveField(document.querySelector('select[name="status"]'));
    }

    function validateForCompletion() {
        // Check required fields
        const requiredFields = [
            'contract_number',
            'buyer',
            'contract_type',
            'award_date',
            'due_date',
            'contract_value'
        ];

        for (const field of requiredFields) {
            const element = document.querySelector(`[name="${field}"]`);
            if (!element || !element.value) {
                return false;
            }
        }

        // Check if there's at least one CLIN
        const clins = document.querySelectorAll('.clin-details-0');
        if (!clins.length) {
            return false;
        }

        return true;
    }

    function validateClins() {
        let isValid = true;
        // Check each CLIN for NSN and supplier matches
        document.querySelectorAll('[data-action="toggle-clin"]').forEach(clin => {
            const clinRow = clin.closest('tr');
            const nsnStatus = clinRow.querySelector('svg.text-red-500');
            const supplierStatus = clinRow.nextElementSibling.querySelector('svg.text-red-500');
            
            if (nsnStatus || supplierStatus) {
                isValid = false;
            }
        });
        return isValid;
    }

    // Add this JavaScript function at the end of the script section
    async function finalizeContract() {
        try {
            // Show processing indicator
            showMessage('Finalizing contract...', 'info');
            
            // Call finalize endpoint directly
            const response = await fetch(`/processing/contract/${processContractId}/finalize-and-email/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (data.success) {
                showMessage('Contract finalized successfully', 'success');
                
                // Open email client with pre-populated email
                window.location.href = data.mailto_url;
                
                // Redirect to queue after a short delay
                setTimeout(() => {
                    window.location.href = "{% url 'processing:queue' %}";
                }, 2000);
            } else if (data.validation_errors) {
                // Handle validation errors from the finalize endpoint
                let errorMsg = 'Contract validation failed:';
                
                // Process contract-level validation errors
                const validationErrors = data.validation_errors;
                for (const [field, error] of Object.entries(validationErrors)) {
                    if (field !== 'clins') {
                        errorMsg += `\n- ${error}`;
                    }
                }
                
                // Process CLIN validation errors
                if (validationErrors.clins) {
                    if (typeof validationErrors.clins === 'string') {
                        errorMsg += `\n- ${validationErrors.clins}`;
                    } else {
                        errorMsg += '\n- CLIN errors:';
                        validationErrors.clins.forEach(clinError => {
                            const clinNum = clinError.clin_number;
                            errorMsg += `\n  - CLIN ${clinNum}:`;
                            for (const [field, error] of Object.entries(clinError)) {
                                if (field !== 'clin_number') {
                                    errorMsg += `\n    - ${error}`;
                                }
                            }
                        });
                    }
                }
                
                throw new Error(errorMsg);
            } else {
                throw new Error(data.error || 'Failed to finalize contract');
            }
        } catch (error) {
            console.error('Error finalizing contract:', error);
            showMessage('Error finalizing contract: ' + error.message, 'error');
        }
    }

    // Add this near the beginning of your script section
    let autoSaveTimer;
    
    // Function to automatically save form data periodically
    function setupAutoSave() {
        clearTimeout(autoSaveTimer);
        
        autoSaveTimer = setTimeout(async function() {
            try {
                const form = document.querySelector('form');
                const formData = new FormData(form);
                
                // Add silent parameter to indicate this is an autosave
                formData.append('auto_save', 'true');
                
                // Get CSRF token
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                
                // Perform the save quietly in the background
                const response = await fetch('/processing/save-contract-data/{{ process_contract.id }}/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });
                
                // Only show message if there's an error
                if (!response.ok) {
                    console.warn('Auto-save failed:', await response.text());
                } else {
                    console.log('Auto-save completed successfully');
                }
                
            } catch (error) {
                console.warn('Auto-save error:', error);
            }
            
            // Set up the next auto-save
            setupAutoSave();
        }, 30000); // Auto-save every 30 seconds
    }
    
    // Start the auto-save when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        setupAutoSave();
        
        // Reset the auto-save timer when user interacts with the form
        const form = document.querySelector('form');
        form.addEventListener('input', function() {
            clearTimeout(autoSaveTimer);
            setupAutoSave();
        });
    });
</script>
{% endblock %}