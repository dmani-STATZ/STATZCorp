{% extends 'training/training_base.html' %}
{% load static %}
{% load training_filters %}

{% block body %}
<style>
    table {
        background-color: transparent;
    }
    thead {
        background-color: transparent;
        position: sticky;
        top: 0;
        z-index: 20;
    }
    tbody {
        background-color: transparent;
    }
    th {
        background-color: transparent;
        height: 300px;
        position: relative;
        padding: 0;
    }

    /* New styles for rotated headers */
    .rotated-header {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: rotate(-45deg) ;
        transform-origin: left;
        width: 400px; /* Increased width for text */
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        padding: 8px;
    }

    td {
        background-color: transparent;
        border: 1px solid #000;
        text-align: center;
        width: 100px; /* Reduced from 200px since we don't need as much width */
        height: 50px;
    }

    tr {
        background-color: transparent;
    }

    /* Sticky first column */
    tbody td:first-child, thead th:first-child {
        position: sticky;
        left: 0;
        z-index: 10;
        background: #fff;
    }

    /* Zebra rows for readability */
    tbody tr:nth-child(odd) td { background-color: #fafafa; }
    tbody tr:nth-child(even) td { background-color: #ffffff; }
    tbody tr td.bg-green-200 { background-color: #bbf7d0 !important; }
    tbody tr td.bg-red-200 { background-color: #fecaca !important; }
    tbody tr td.bg-gray-100 { background-color: #f3f4f6 !important; }

    .legend span { display: inline-block; width: 12px; height: 12px; border-radius: 2px; margin-right: 6px; }
    .legend .done { background: #22c55e; }
    .legend .todo { background: #ef4444; }
    .legend .na { background: #e5e7eb; }
</style>


    <div>
        <h1 class="text-2xl font-bold mb-2">Arctic Wolf Training Audit</h1>
        <div class="flex items-center justify-between mb-3 text-sm">
            <div class="legend">
                <span class="done"></span> Completed
                <span class="ml-4 todo"></span> Not Completed
                <span class="ml-4 na"></span> Not Required
            </div>
            <div class="flex items-center gap-3">
                <a href="{% url 'training:dashboard' %}"
                   class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded">
                    Back to Dashboard
                </a>
                <label class="inline-flex items-center gap-1"><input type="checkbox" id="toggle-incomplete-only"> Show only incomplete courses</label>
                <label class="inline-flex items-center gap-1"><input type="checkbox" id="toggle-users-incomplete-only"> Show only users with incomplete</label>
                <a href="{% url 'training:arctic_wolf_audit_export' %}"
                   class="bg-gray-900 hover:bg-black text-white font-semibold py-1 px-3 rounded">
                    Export PDF
                </a>
                <button id="copy-audit" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-2 rounded">Copy Table</button>
            </div>
        </div>
        <div style="overflow: auto;">
            <table>
                <thead>
                    <tr>
                        <th style="vertical-align: bottom; width: 150px;">Employee</th>
                        {% for course in courses %}
                        <th data-course-id="{{ course.id }}" class="{% if course.id in overdue_course_ids %} ring-2 ring-yellow-400 {% endif %}">
                            <div class="rotated-header">{{ course.name }}</div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for user_data in audit_data %}
                    <tr>
                        <td class="font-medium bg-white">{{ user_data.user.first_name }}&nbsp;{{ user_data.user.last_name }}</td>
                        {% for course in courses %}
                            {% with course_status=user_data.courses|get_item:course.id %}
                                <td data-course-id="{{ course.id }}"
                                    data-status="{% if course_status.not_required %}na{% elif course_status.completed_date %}complete{% else %}incomplete{% endif %}"
                                    class="{% if course_status.not_required %} bg-gray-100 text-gray-500 {% elif course_status.completed_date %} bg-green-200 {% else %} bg-red-200 {% endif %}">
                                    {% if course_status.not_required %}
                                        <span class="text-xs block">N/A</span>
                                    {% elif course_status.completed_date %}
                                        <span class="text-xs block">{{ course_status.completed_date|date:"n/j/Y" }}</span>
                                    {% endif %}
                                </td>
                            {% endwith %}
                        {% endfor %}
                    </tr>
                    {% empty %}
                        <tr><td colspan="{% with total_cols=courses|length|add:1 %}{{ total_cols }}{% endwith %}" class="px-4 py-2 text-center">No Arctic Wolf training data available.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <script>
        (function(){
            const colCounts = JSON.parse('{{ column_completed_counts|safe|escapejs }}'.replaceAll("'", '"'));
            const eligibleCounts = JSON.parse('{{ eligible_counts_by_course|safe|escapejs }}'.replaceAll("'", '"'));
            const table = document.querySelector('table');
            const toggleCourses = document.getElementById('toggle-incomplete-only');
            const toggleUsers = document.getElementById('toggle-users-incomplete-only');
            const copyBtn = document.getElementById('copy-audit');

            function updateVisibility(){
                const showIncompleteColsOnly = toggleCourses.checked;
                const showUsersIncompleteOnly = toggleUsers.checked;

                // Columns
                const ths = table.querySelectorAll('thead th[data-course-id]');
                ths.forEach(th => {
                    const id = th.getAttribute('data-course-id');
                    const full = (colCounts[id] || 0) >= (eligibleCounts[id] || 0);
                    const show = !showIncompleteColsOnly || !full;
                    th.style.display = show ? '' : 'none';
                });
                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    let userHasIncomplete = false;
                    row.querySelectorAll('td[data-course-id]').forEach(td => {
                        const id = td.getAttribute('data-course-id');
                        const full = (colCounts[id] || 0) >= (eligibleCounts[id] || 0);
                        const showCol = !showIncompleteColsOnly || !full;
                        td.style.display = showCol ? '' : 'none';
                        if (showCol && td.dataset.status === 'incomplete') userHasIncomplete = true;
                    });
                    row.style.display = (!showUsersIncompleteOnly || userHasIncomplete) ? '' : 'none';
                });
            }
            toggleCourses?.addEventListener('change', updateVisibility);
            toggleUsers?.addEventListener('change', updateVisibility);
            updateVisibility();

            copyBtn?.addEventListener('click', () => {
                const range = document.createRange();
                range.selectNode(table);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
                document.execCommand('copy');
                sel.removeAllRanges();
                alert('Audit table copied');
            });
        })();
    </script>
{% endblock %}
