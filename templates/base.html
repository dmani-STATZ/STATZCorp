{% extends "base_template.html" %}

{% block extra_head %}
<script>
    // Set session storage flag on login
    function setSessionFlag() {
        sessionStorage.setItem('isLoggedIn', 'true');
    }

    // Clear session storage flag on logout
    function clearSessionFlag() {
        sessionStorage.removeItem('isLoggedIn');
    }

    // Check session storage flag on page load
    window.onload = function() {
        if (!sessionStorage.getItem('isLoggedIn')) {
            // Redirect to logout URL if not logged in
            window.location.href = "{% url 'users:logout' %}";
        }
    }

    // Set session flag when the user logs in
    document.addEventListener('DOMContentLoaded', function() {
        setSessionFlag();
    });

    // Clear session flag when the user logs out
    document.addEventListener('beforeunload', function() {
        clearSessionFlag();
    });
</script>

{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50">
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <div class="flex">
            <!-- Main Content Area -->
            <div class="flex-1">
                {% if messages %}
                    {% for message in messages %}
                        <div class="mb-4 p-4 rounded-md {% if message.tags == 'success' %}bg-green-100 text-green-700{% elif message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
                {% block content %}{% endblock content %}
            </div>
        </div>
    </main>
</div>
{% endblock body %}

{% block extra_scripts %}
<script>
    let idleTime = 0;
    const maxIdleTime = 30 * 60 * 1000; // 10 minutes in milliseconds

    function resetIdleTimer() {
        idleTime = 0;
    }

    function checkIdleTime() {
        idleTime += 1000; // Increment idle time by 1 second
        if (idleTime >= maxIdleTime) {
            logoutUser(); // Call the logout function
        }
    }

    function logoutUser() {
        fetch("{% url 'logout' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}', // Include CSRF token
                'Content-Type': 'application/x-www-form-urlencoded',
            },
        }).then(response => {
            if (response.ok) {
                window.location.href = "{% url 'users:login' %}"; // Redirect to login page
            }
        }).catch(error => console.error('Error logging out:', error));
    }

    // Reset the idle timer on any of these events
    window.onload = resetIdleTimer;
    window.onmousemove = resetIdleTimer;
    window.onmousedown = resetIdleTimer; // Catch touchpad/mouse events
    window.ontouchstart = resetIdleTimer;
    window.onclick = resetIdleTimer;     // Catch touch events
    window.onkeypress = resetIdleTimer;  // Catch keyboard events

    // Check idle time every second
    setInterval(checkIdleTime, 1000);
</script>
{% endblock %}