{% extends "contracts/contract_base.html" %}
{% load static %}

{% block contract_content %}
<div class="max-w-6xl mx-auto px-4 py-8">
    <div class="mb-6 row-between">
        <div>
            <h1 class="text-3xl font-semibold text-gray-900">Edit Supplier</h1>
            <p class="mt-2 text-gray-600">
                Update supplier details, website, contact info, and compliance flags.
            </p>
        </div>
        <a href="{% url 'suppliers:supplier_detail' pk=object.pk %}"
           class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
            Cancel
        </a>
    </div>

    <form method="post" class="card card-padded shadow space-y-6">
        {% csrf_token %}

        {% if new_address_message %}
            <div class="rounded-md bg-green-50 border border-green-200 p-4 text-sm text-green-700 row gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.707a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                {{ new_address_message }}
            </div>
        {% endif %}

        {% if form.non_field_errors %}
            <div class="rounded-md bg-red-50 border border-red-200 p-4 text-sm text-red-700">
                {{ form.non_field_errors|join:", " }}
            </div>
        {% endif %}

        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Supplier Details</h2>
            <div class="grid md:grid-cols-2 gap-6">
                {% include "contracts/includes/simple_field.html" with field=form.name %}
                {% include "contracts/includes/simple_field.html" with field=form.cage_code %}
                {% include "contracts/includes/simple_field.html" with field=form.supplier_type %}
                {% include "contracts/includes/simple_field.html" with field=form.contact %}
                {% include "contracts/includes/simple_field.html" with field=form.prime %}
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Contact & Web</h2>
            <div class="grid md:grid-cols-2 gap-6">
                {% include "contracts/includes/simple_field.html" with field=form.business_phone %}
                {% include "contracts/includes/simple_field.html" with field=form.business_fax %}
                {% include "contracts/includes/simple_field.html" with field=form.business_email %}
                {% include "contracts/includes/simple_field.html" with field=form.primary_phone %}
                {% include "contracts/includes/simple_field.html" with field=form.primary_email %}
                <div id="website">
                    {% include "contracts/includes/simple_field.html" with field=form.website_url %}
                </div>
                {% include "contracts/includes/simple_field.html" with field=form.logo_url %}
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Addresses</h2>
            <div class="grid md:grid-cols-3 gap-4">
                {% include "suppliers/includes/address_picker.html" with field=form.physical_address label="Physical Address" %}
                {% include "suppliers/includes/address_picker.html" with field=form.shipping_address label="Shipping Address" %}
                {% include "suppliers/includes/address_picker.html" with field=form.billing_address label="Billing Address" %}
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Status & Flags</h2>
            <div class="space-y-8">
                <div>
                    <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-3">Risk Flags</h3>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% include "suppliers/includes/toggle_switch.html" with field=form.probation label="Probation" description="Tracks whether the supplier is currently on probation." %}
                        {% include "suppliers/includes/toggle_switch.html" with field=form.conditional label="Conditional" description="Marks suppliers operating under conditional approval." %}
                        {% include "suppliers/includes/toggle_switch.html" with field=form.archived label="Archived" description="Archives suppliers to hide them from active workflows." %}
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-gray-600 uppercase tracking-wide mb-3">Certifications & Type</h3>
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% include "suppliers/includes/toggle_switch.html" with field=form.ppi label="PPI Certified" description="Indicates whether PPI certification is current." %}
                        {% include "suppliers/includes/toggle_switch.html" with field=form.iso label="ISO Certified" description="Indicates whether ISO certification is current." %}
                        {% include "suppliers/includes/toggle_switch.html" with field=form.is_packhouse label="Packhouse" description="Supplier operates as an approved packhouse." %}
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Additional Options</h2>
            <div class="grid md:grid-cols-3 gap-4">
                {% include "contracts/includes/simple_field.html" with field=form.special_terms %}
                {% include "contracts/includes/simple_field.html" with field=form.packhouse %}
                {% include "contracts/includes/simple_field.html" with field=form.allows_gsi %}
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Additional Notes</h2>
            {% include "contracts/includes/simple_field.html" with field=form.notes %}
        </section>

        <div class="pt-4 flex justify-end space-x-3">
            <a href="{% url 'suppliers:supplier_detail' pk=object.pk %}"
               class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                Cancel
            </a>
            <button type="submit"
                    class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Save Changes
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'suppliers/js/supplier_edit.js' %}?v=20251204-001"></script>

<!--
CHANGE TRACKING & VISUAL INDICATORS - TESTING GUIDE
====================================================

This form now includes comprehensive change tracking with visual indicators.

FEATURES IMPLEMENTED:
1. Visual Change Indicators
   - Amber/yellow pulse bar on the left side of changed fields
   - Amber border on changed input fields
   - Ring highlight on changed toggle controls
   - Badge counter on the "Save Changes" button showing number of pending changes

2. Field Wiring Verification
   - All text inputs, selects, and textareas are tracked
   - Toggle controls (checkboxes) are properly wired and tracked
   - Address select dropdowns are tracked
   - All changes trigger proper events

3. Console Debugging
   - Open browser console (F12) to see detailed logs
   - Shows initial field values on page load
   - Logs every field change with before/after values
   - Shows which fields are being submitted

TESTING CHECKLIST:
□ Text Fields (name, cage_code, phones, emails, URLs)
  - Change a value -> should see amber bar & border
  - Revert to original -> indicator should disappear

□ Select Fields (supplier_type, contact, special_terms, prime, packhouse)
  - Change selection -> should see amber bar
  - Revert to original -> indicator should disappear

□ Address Selects (physical, shipping, billing)
  - Change address -> should see amber bar
  - Should properly save the new address

□ Toggle Controls in Warning Flags section
  - Probation: Click On/Off -> should see ring highlight
  - Conditional: Click On/Off -> should see ring highlight  
  - Archived: Click On/Off -> should see ring highlight
  - Values should save properly

□ Toggle Controls in Certifications section
  - PPI: Click Yes/No -> should see ring highlight
  - ISO: Click Yes/No -> should see ring highlight
  - Is Packhouse: Click Yes/No -> should see ring highlight
  - Values should save properly

□ Additional Options
  - allows_gsi: Should track and save
  - packhouse: Should track and save

□ Textarea (notes)
  - Type changes -> should see amber bar & border
  - Should save properly

□ Save Button Badge
  - Should show number of changed fields
  - Should hide when no changes

TROUBLESHOOTING:
If a field doesn't save:
1. Check browser console for errors
2. Verify the field name matches the form definition
3. Check that the field is in the SupplierForm fields list
4. Ensure the toggle control has the correct data-checkbox-id

To disable debug logging:
Change DEBUG = true to DEBUG = false in supplier_edit.js
-->
{% endblock %}
