{% extends "contracts/contract_base.html" %}
{% load static %}

{% block title %}Suppliers{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
    .mock-container {
        display: grid;
        grid-template-columns: 1fr 3fr;
        gap: 32px;
        min-height: 75vh;
        padding: 0;
    }
    .mock-pane {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
        padding: 18px;
        position: relative;
    }
    .heading-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 24px;
    }
    .supplier-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 8px 12px;
        background: #f8fafc;
    }
    .tabs {
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        gap: 16px;
        font-weight: 600;
        color: #6b7280;
    }
    .tab-btn.active {
        color: #6c1e27;
        border-bottom: 2px solid #6c1e27;
    }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .toggle-btn {
        border: 2px solid #d1fae5;
        background: #ecfdf3;
        padding: 6px 14px;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 700;
        color: #065f46;
        box-shadow: 0 1px 2px rgba(16, 185, 129, 0.18);
        transition: all 0.15s ease;
    }
    .toggle-btn:hover:not(:disabled) {
        background: #d1fae5;
        color: #047857;
        box-shadow: 0 3px 8px rgba(16, 185, 129, 0.2);
    }
    .toggle-btn.active {
        background: #fef2f2;
        border-color: #fca5a5;
        color: #b91c1c;
        box-shadow: 0 4px 10px rgba(248, 113, 113, 0.3);
    }
    .toggle-btn[data-flag="archived"] {
        background: #eff6ff;
        border-color: #bfdbfe;
        color: #1d4ed8;
        box-shadow: 0 1px 2px rgba(96, 165, 250, 0.18);
    }
    .toggle-btn[data-flag="archived"].active {
        background: #0f172a;
        color: #f8fafc;
        border-color: #94a3b8;
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.35);
    }
    .toggle-btn:disabled {
        border-color: #cbd5e1;
        color: #94a3b8;
        background: #f8fafc;
        box-shadow: none;
        cursor: not-allowed;
    }
    .flag-meta {
        font-size: 0.75rem;
        color: #475569;
        line-height: 1.2;
    }

    /* Loading States - Spinner */
    .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: currentColor;
        animation: spin 0.8s ease-in-out infinite;
    }
    .spinner-dark {
        border: 2px solid rgba(100, 116, 139, 0.2);
        border-top-color: #475569;
    }
    .spinner-lg {
        width: 24px;
        height: 24px;
        border-width: 3px;
    }
    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* Search Loading */
    .search-wrapper {
        position: relative;
    }
    .search-spinner {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .search-wrapper.loading .search-spinner {
        opacity: 1;
    }

    /* Detail Panel Loading Overlay */
    .detail-loading-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(2px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        border-radius: 12px;
    }
    .detail-loading-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    /* Skeleton Loading Animation */
    .skeleton {
        background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 4px;
    }
    @keyframes shimmer {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
    .skeleton-text {
        height: 14px;
        margin-bottom: 8px;
    }
    .skeleton-text-sm {
        height: 10px;
        margin-bottom: 6px;
    }
    .skeleton-box {
        height: 80px;
    }

    /* Button Loading States */
    .btn-loading {
        position: relative;
        color: transparent !important;
        pointer-events: none;
    }
    .btn-loading::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 50%;
        width: 16px;
        height: 16px;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 0.8s ease-in-out infinite;
    }
    .btn-loading-dark::after {
        border: 2px solid rgba(100, 116, 139, 0.2);
        border-top-color: #475569;
    }

    /* Select loading state */
    select.loading {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' stroke='%23e2e8f0' stroke-width='3'%3E%3C/circle%3E%3Cpath fill='%236366f1' d='M12 2a10 10 0 0 1 10 10h-3a7 7 0 0 0-7-7V2z'%3E%3CanimateTransform attributeName='transform' type='rotate' from='0 12 12' to='360 12 12' dur='1s' repeatCount='indefinite'/%3E%3C/path%3E%3C/svg%3E");
        background-position: right 8px center;
        background-repeat: no-repeat;
        background-size: 16px;
        padding-right: 32px;
        opacity: 0.7;
        pointer-events: none;
    }

    /* Inline saving indicator */
    .save-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #10b981;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .save-indicator.visible {
        opacity: 1;
    }
    .save-indicator.saving {
        color: #6366f1;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-100">
    <div class="heading-row w-[95vw] mx-auto px-4">
        <div>
            <p class="text-xs uppercase tracking-widest text-slate-500 font-semibold mb-1">Supplier Management</p>
            <h1 class="text-3xl font-bold text-slate-900">Suppliers</h1>
        </div>
        <a href="{% url 'suppliers:supplier_create' %}"
           class="inline-flex items-center px-4 py-2 rounded-lg text-white text-sm font-semibold bg-indigo-600 hover:bg-indigo-700 shadow">
            <svg xmlns="http://www.w3.org/2000/svg" class="-ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12m6-6H6" />
            </svg>
            Add Supplier
        </a>
    </div>

    <div class="w-[95vw] mx-auto mock-container">
        <!-- Left 25% -->
        <div class="mock-pane">
            <p class="text-sm font-semibold text-slate-700 mb-3">Supplier Search</p>
            <div class="space-y-3">
                <div class="search-wrapper" id="search-wrapper">
                    <input type="text" id="supplier-search" name="q" value="{{ request.GET.q }}"
                           class="w-full rounded-md border border-slate-300 px-3 py-2 pr-8 text-sm"
                           placeholder="Search by name or CAGE...">
                    <div class="search-spinner">
                        <div class="spinner spinner-dark" style="width: 14px; height: 14px;"></div>
                    </div>
                </div>
            </div>
            <div id="supplier-list" class="mt-4 space-y-2 text-sm text-slate-700 max-h-[70vh] overflow-auto">
                {% for supplier in suppliers %}
                <a href="#"
                   data-id="{{ supplier.id }}"
                   class="supplier-card supplier-item flex items-center justify-between hover:border-indigo-200 py-1 {% if selected_supplier and selected_supplier.id == supplier.id %}border-indigo-300 bg-indigo-50{% endif %}">
                    <div class="leading-tight">
                        <div class="text-sm font-semibold text-slate-900">{{ supplier.name }}{% if supplier.cage_code %} ({{ supplier.cage_code }}){% endif %}</div>
                    </div>
                </a>
                {% empty %}
                <div class="text-slate-500 text-sm px-2 py-3">No suppliers found.</div>
                {% endfor %}
            </div>
        </div>

        <!-- Right 75% -->
        <div class="mock-pane space-y-3" id="detail-pane">
            <!-- Loading Overlay -->
            <div id="detail-loading-overlay" class="detail-loading-overlay">
                <div class="flex flex-col items-center gap-3">
                    <div class="spinner spinner-dark spinner-lg"></div>
                    <span class="text-sm text-slate-600 font-medium">Loading supplier...</span>
                </div>
            </div>
            <p class="text-sm font-semibold text-slate-700">Supplier Info</p>
            <div class="tabs">
                <button class="tab-btn active" data-tab="info">Info</button>
                <button class="tab-btn" data-tab="contracts">Contracts</button>
                <button class="tab-btn" data-tab="personnel">Personnel</button>
                <button class="tab-btn" data-tab="qms">QMS</button>
                <button class="tab-btn" data-tab="files">Files</button>
                <button class="tab-btn" data-tab="statistics">Statistics</button>
                <button class="tab-btn" data-tab="vsm">VSM</button>
            </div>
            <div class="tab-panel active" data-panel="info">
                <div class="space-y-3 text-sm text-slate-800">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="supplier-card relative">
                            <div class="flex items-start justify-between gap-2">
                                <div>
                                    <div class="text-xs uppercase text-slate-500 mb-1">Name</div>
                                    <div id="detail-name" class="font-semibold text-slate-900">{% if has_selected_supplier %}{{ detail_payload.name|default:"N/A" }}{% else %}Select a supplier{% endif %}</div>
                                </div>
                                <button type="button" id="edit-name-btn" class="text-slate-500 hover:text-indigo-600 transition" title="Edit name, CAGE, and DODAAC">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                            </div>
                            <div class="mt-2 grid grid-cols-2 gap-2">
                                <div>
                                    <div class="text-xs uppercase text-slate-500">CAGE</div>
                                    <div id="detail-cage" class="text-slate-900 font-medium">{% if has_selected_supplier %}{{ detail_payload.cage_code|default:"N/A" }}{% else %}Select a supplier{% endif %}</div>
                                </div>
                                <div>
                                    <div class="text-xs uppercase text-slate-500">DODAAC</div>
                                    <div id="detail-dodaac" class="text-slate-900 font-medium">{% if has_selected_supplier %}{{ detail_payload.dodaac|default:"N/A" }}{% else %}Select a supplier{% endif %}</div>
                                </div>
                            </div>
                        </div>
                        <div class="supplier-card">
                            <div class="text-xs uppercase text-slate-500 mb-2">Type</div>
                            <select id="detail-type-select" class="w-full rounded-md border border-slate-300 px-2 py-2 text-sm bg-white mb-3">
                                <option value="">Select type</option>
                                {% for stype in supplier_types %}
                                <option value="{{ stype.id }}" {% if detail_payload.supplier_type_id == stype.id %}selected{% endif %}>{{ stype.description }}</option>
                                {% endfor %}
                            </select>
                            <div class="text-xs uppercase text-slate-500 mb-2">Packhouse</div>
                            <select id="detail-packhouse-select" class="w-full rounded-md border border-slate-300 px-2 py-2 text-sm bg-white">
                                <option value="">Select packhouse</option>
                                {% for p in packhouse_options %}
                                <option value="{{ p.id }}" {% if detail_payload.packhouse_id == p.id %}selected{% endif %}>{{ p.name }} ({{ p.cage_code }})</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="supplier-card">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs uppercase text-slate-500">Addresses</div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <div class="flex items-center gap-2 text-xs uppercase text-slate-500 mb-1">
                                    Physical
                                    <button type="button" class="edit-address-btn text-slate-500 hover:text-indigo-600" data-field="physical" title="Edit physical address">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                    </button>
                                </div>
                                    <div id="detail-addr-physical" class="leading-tight">{% if has_selected_supplier %}{{ detail_payload.physical_address|linebreaks|default:"None" }}{% else %}Select a supplier{% endif %}</div>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 text-xs uppercase text-slate-500 mb-1">
                                        Shipping
                                        <button type="button" class="edit-address-btn text-slate-500 hover:text-indigo-600" data-field="shipping" title="Edit shipping address">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                    </button>
                                </div>
                                    <div id="detail-addr-shipping" class="leading-tight">{% if has_selected_supplier %}{{ detail_payload.shipping_address|linebreaks|default:"None" }}{% else %}Select a supplier{% endif %}</div>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 text-xs uppercase text-slate-500 mb-1">
                                        Billing
                                        <button type="button" class="edit-address-btn text-slate-500 hover:text-indigo-600" data-field="billing" title="Edit billing address">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                    </button>
                                </div>
                                    <div id="detail-addr-billing" class="leading-tight">{% if has_selected_supplier %}{{ detail_payload.billing_address|linebreaks|default:"None" }}{% else %}Select a supplier{% endif %}</div>
                                </div>
                            </div>
                        </div>

                    <div class="supplier-card">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-xs uppercase text-slate-500">Contacts</div>
                            <button type="button" id="add-contact-btn" class="text-indigo-600 text-sm font-semibold hover:underline">Add contact</button>
                        </div>
                        <div id="contacts-list" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3 text-sm">
                            {% if detail_contacts and has_selected_supplier %}
                                {% for contact in detail_contacts %}
                                    <div class="border border-slate-200 rounded-md px-3 py-2 bg-slate-50 contact-row h-full flex flex-col justify-between" data-contact-id="{{ contact.id|default:'' }}">
                                        <div>
                                            <div class="font-semibold text-slate-900 flex items-center gap-2">
                                                {{ contact.name }}
                                                {% if contact.title %}<span class="text-xs text-slate-500">({{ contact.title }})</span>{% endif %}
                                            </div>
                                            <div class="text-slate-700 text-sm">
                                                {% if contact.email %}
                                                    <a href="mailto:{{ contact.email }}" class="text-indigo-600 hover:underline">{{ contact.email }}</a>
                                                {% endif %}
                                            </div>
                                            <div class="text-slate-700 text-sm">
                                                {% if contact.phone %}
                                                    <a href="tel:{{ contact.phone }}" class="text-indigo-600 hover:underline">{{ contact.phone }}</a>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-2 justify-end mt-2">
                                            <button type="button" class="edit-contact-btn text-slate-500 hover:text-indigo-600" title="Edit contact" data-contact-id="{{ contact.id|default:'' }}" data-contact-name="{{ contact.name|default:'' }}" data-contact-email="{{ contact.email|default:'' }}" data-contact-phone="{{ contact.phone|default:'' }}" data-contact-title="{{ contact.title|default:'' }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                            </button>
                                            <button type="button" class="delete-contact-btn text-red-500 hover:text-red-700" title="Delete contact" data-contact-id="{{ contact.id|default:'' }}">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                            </button>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-slate-500 text-sm">{% if has_selected_supplier %}No contacts yet{% else %}Select a supplier{% endif %}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="supplier-card space-y-3">
                        <div class="text-xs uppercase text-slate-500">Compliance & Status</div>
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div class="space-y-2">
                                <label class="block text-xs uppercase text-slate-500">Prime</label>
                                <select id="prime-select" class="w-full rounded-md border border-slate-300 px-2 py-2 text-sm bg-white">
                                    <option value="">None</option>
                                    <option value="1">STATZ</option>
                                    <option value="2">PPI</option>
                                </select>
                                <label class="block text-xs uppercase text-slate-500">GSI</label>
                                <select id="gsi-select" class="w-full rounded-md border border-slate-300 px-2 py-2 text-sm bg-white">
                                    <option value="UNK">Unknown</option>
                                    <option value="YES">Yes</option>
                                    <option value="NO">No</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-xs uppercase text-slate-500">PPI</label>
                                <select id="ppi-select" class="w-full rounded-md border border-slate-300 px-2 py-2 text-sm bg-white">
                                    <option value="">Unknown</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                                <label class="block text-xs uppercase text-slate-500">Special Terms</label>
                                <select id="special-terms-select" class="w-full rounded-md border border-slate-300 px-2 py-2 text-sm bg-white">
                                    <option value="">None</option>
                                    {% for st in special_terms_options %}
                                    <option value="{{ st.id }}">{{ st.terms }}</option>
                                    {% endfor %}
                                </select>
                                <div class="text-xs text-slate-600">Terms Set On: <span id="detail-special-on">{{ detail_payload.special_terms_on|default:"" }}</span></div>
                            </div>
                            <div class="space-y-2">
                                <label class="block text-xs uppercase text-slate-500">ISO</label>
                                <select id="iso-select" class="w-full rounded-md border border-slate-300 px-2 py-2 text-sm bg-white">
                                    <option value="">Unknown</option>
                                    <option value="true">Yes</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-sm pt-2 border-t border-slate-200">
                            <div class="flex items-center gap-2">
                                <button type="button" class="toggle-btn {% if detail_payload.probation %}active{% endif %}" data-flag="probation">Probation</button>
                                <div class="flag-meta">
                                    <div>On: <span id="detail-prob-on">{{ detail_payload.probation_on|default:"" }}</span></div>
                                    <div>By: <span id="detail-prob-by">{{ detail_payload.probation_by|default:"" }}</span></div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" class="toggle-btn {% if detail_payload.conditional %}active{% endif %}" data-flag="conditional">Conditional</button>
                                <div class="flag-meta">
                                    <div>On: <span id="detail-cond-on">{{ detail_payload.conditional_on|default:"" }}</span></div>
                                    <div>By: <span id="detail-cond-by">{{ detail_payload.conditional_by|default:"" }}</span></div>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button type="button" class="toggle-btn {% if detail_payload.archived %}active{% endif %}" data-flag="archived">Archived</button>
                                <div class="flag-meta">
                                    <div>On: <span id="detail-arch-on">{{ detail_payload.archived_on|default:"" }}</span></div>
                                    <div>By: <span id="detail-arch-by">{{ detail_payload.archived_by|default:"" }}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                        <div class="supplier-card">
                            <div class="flex items-center justify-between mb-1">
                                <div class="text-xs uppercase text-slate-500">Files URL</div>
                                <button type="button" id="edit-files-btn" class="text-indigo-600 text-sm font-semibold hover:underline">Edit</button>
                            </div>
                            <div class="text-sm">
                                <a id="detail-files-url"
                                   href="{{ detail_payload.files_url|default:'' }}"
                                   target="_blank" rel="noopener"
                                   class="{% if detail_payload.files_url %}text-indigo-600 hover:text-indigo-800{% else %}text-slate-500 pointer-events-none cursor-not-allowed{% endif %}">
                                    {% if detail_payload.files_url %}SharePoint Link{% else %}None provided{% endif %}
                                </a>
                            </div>
                        </div>
                        <div class="supplier-card">
                            <div class="flex items-center justify-between mb-1">
                                <div class="text-xs uppercase text-slate-500">Notes</div>
                                <button type="button" id="edit-notes-btn" class="text-indigo-600 text-sm font-semibold hover:underline">Edit</button>
                            </div>
                            <div id="detail-notes">{% if has_selected_supplier %}{{ detail_payload.notes|linebreaks|default:"No notes yet" }}{% else %}Select a supplier{% endif %}</div>
                        </div>
                </div>
            </div>
            <div class="tab-panel" data-panel="contracts">
                <div class="supplier-card">
                    <div class="text-xs uppercase text-slate-500 mb-2">Contracts</div>
                    <div id="detail-contracts">
                        {% if detail_contracts %}
                            <div class="space-y-2">
                                {% for contract in detail_contracts %}
                                <div class="flex justify-between text-sm">
                                    <div>
                                        <div class="font-semibold">{{ contract.number|default:"No Number" }}</div>
                                        <div class="text-xs text-slate-500">Award: {{ contract.award_date|default:"N/A" }}</div>
                                    </div>
                                    <div class="text-xs text-slate-600">{{ contract.status|default:"Status" }}</div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-sm text-slate-600">No contracts.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="tab-panel" data-panel="personnel">
                <div class="supplier-card">
                    <div class="text-xs uppercase text-slate-500 mb-2">Personnel</div>
                    <div id="detail-contacts" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        {% if detail_contacts %}
                            {% for contact in detail_contacts %}
                            <div class="border border-slate-200 rounded-md px-3 py-2 bg-slate-50 space-y-1">
                                <div class="font-semibold text-slate-900">
                                    {% if contact.id %}
                                        <a href="{% url 'contracts:contact_detail' contact.id %}" class="text-blue-600 hover:text-blue-800">{{ contact.name }}</a>
                                    {% else %}
                                        {{ contact.name }}
                                    {% endif %}
                                    {% if contact.title %}<span class="text-xs text-slate-500">({{ contact.title }})</span>{% endif %}
                                </div>
                                <div class="text-sm text-slate-700">
                                    {% if contact.email %}<a href="mailto:{{ contact.email }}" class="text-indigo-600 hover:underline">{{ contact.email }}</a>{% else %}<span class="text-slate-500">No email</span>{% endif %}
                                </div>
                                <div class="text-sm text-slate-700">
                                    {% if contact.phone %}<a href="tel:{{ contact.phone }}" class="text-indigo-600 hover:underline">{{ contact.phone }}</a>{% else %}<span class="text-slate-500">No phone</span>{% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-sm text-slate-600">No personnel listed.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="tab-panel" data-panel="qms">
                <div class="space-y-3">
                    <div class="supplier-card space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="text-xs uppercase text-slate-500">Certifications</div>
                            <button type="button" id="open-cert-modal" class="text-indigo-600 text-sm font-semibold hover:underline"
                                onclick="const m=document.getElementById('cert-modal'); if(m){m.classList.remove('hidden'); m.classList.add('flex');}">
                                Add
                            </button>
                        </div>
                        <div id="detail-certs" class="space-y-2 text-sm">
                            {% if detail_certifications %}
                                {% for cert in detail_certifications %}
                                <div class="flex items-center justify-between border border-slate-200 rounded-md px-3 py-2 bg-slate-50" data-cert-id="{{ cert.id|default:'' }}">
                                    <div>
                                        <div class="font-semibold text-slate-900">{{ cert.type }}</div>
                                        <div class="text-xs text-slate-600">
                                            {% if cert.date %}Date: {{ cert.date }}{% endif %}
                                            {% if cert.expires %} {% if cert.date %}|{% endif %} Exp: {{ cert.expires }}{% endif %}
                                            {% if cert.compliance_status %} {% if cert.date or cert.expires %}|{% endif %} Compliance: {{ cert.compliance_status }}{% endif %}
                                            {% if cert.document_url %} {% if cert.date or cert.expires or cert.compliance_status %}|{% endif %} <a href="{{ cert.document_url }}" target="_blank" class="text-indigo-600 hover:text-indigo-800">View file</a>{% endif %}
                                        </div>
                                    </div>
                                    <button type="button" class="delete-cert-btn text-red-500 hover:text-red-700" title="Delete" data-id="{{ cert.id|default:'' }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-sm text-slate-600">No certifications.</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="supplier-card space-y-3">
                        <div class="flex items-center justify-between">
                            <div class="text-xs uppercase text-slate-500">Classifications</div>
                            <button type="button" id="open-class-modal" class="text-indigo-600 text-sm font-semibold hover:underline"
                                onclick="const m=document.getElementById('class-modal'); if(m){m.classList.remove('hidden'); m.classList.add('flex');}">
                                Add
                            </button>
                        </div>
                        <div id="detail-classifications" class="space-y-2 text-sm">
                            {% if detail_classifications %}
                                {% for c in detail_classifications %}
                                <div class="flex items-center justify-between border border-slate-200 rounded-md px-3 py-2 bg-slate-50" data-class-id="{{ c.id|default:'' }}">
                                    <div>
                                        <div class="font-semibold text-slate-900">{{ c.type }}</div>
                                        <div class="text-xs text-slate-600">
                                            {% if c.date %}Date: {{ c.date }}{% endif %}
                                            {% if c.expires %} {% if c.date %}|{% endif %} Exp: {{ c.expires }}{% endif %}
                                            {% if c.document_url %} {% if c.date or c.expires %}|{% endif %}<a href="{{ c.document_url }}" target="_blank" class="text-indigo-600 hover:text-indigo-800">View file</a>{% endif %}
                                        </div>
                                    </div>
                                    <button type="button" class="delete-class-btn text-red-500 hover:text-red-700" title="Delete" data-id="{{ c.id|default:'' }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-sm text-slate-600">No classifications.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-panel" data-panel="files">
                <div class="supplier-card">
                    <div class="text-xs uppercase text-slate-500 mb-2">Files</div>
                    <div class="text-sm text-slate-600">Files content placeholder</div>
                </div>
            </div>
            <div class="tab-panel" data-panel="statistics">
                <div class="supplier-card">
                    <div class="text-xs uppercase text-slate-500 mb-2">Statistics</div>
                    <div id="detail-stats">
                        {% if detail_stats %}
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>Total Contracts: {{ detail_stats.total_contracts }}</div>
                            <div>Active Contracts: {{ detail_stats.active_contracts }}</div>
                            <div>Total Value: {{ detail_stats.total_value }}</div>
                            <div>Yearly Value: {{ detail_stats.yearly_value }}</div>
                        </div>
                        {% else %}
                        <div class="text-sm text-slate-600">No stats.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="tab-panel" data-panel="vsm">
                <div class="supplier-card">
                    <div class="text-xs uppercase text-slate-500 mb-2">VSM</div>
                    <div class="text-sm text-slate-600">VSM content placeholder</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% if detail_payload %}{{ detail_payload|json_script:"detail-data" }}{% endif %}
{% if initial_suppliers %}{{ initial_suppliers|json_script:"initial-suppliers" }}{% endif %}

<!-- Quick edit modal for name, CAGE, and DODAAC -->
<div id="name-edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-slate-900">Edit Supplier</h3>
                <p class="text-sm text-slate-500">Update name, CAGE, and DODAAC</p>
            </div>
            <button type="button" id="name-modal-close" class="text-slate-500 hover:text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="space-y-3">
            <div>
                <label for="name-input" class="block text-xs uppercase text-slate-500 mb-1">Supplier Name</label>
                <input id="name-input" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="Enter supplier name">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="cage-input" class="block text-xs uppercase text-slate-500 mb-1">CAGE</label>
                    <input id="cage-input" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="CAGE">
                </div>
                <div>
                    <label for="dodaac-input" class="block text-xs uppercase text-slate-500 mb-1">DODAAC</label>
                    <input id="dodaac-input" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="DODAAC">
                </div>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button type="button" id="name-modal-cancel" class="px-4 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50">Cancel</button>
            <button type="button" id="name-modal-save" class="px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 inline-flex items-center gap-2 min-w-[80px] justify-center">
                <span class="btn-text">Save</span>
                <span class="btn-spinner hidden"><div class="spinner" style="width: 14px; height: 14px;"></div></span>
            </button>
        </div>
    </div>
</div>

<!-- Address modal -->
<div id="address-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-slate-900">Edit Address</h3>
                <p class="text-sm text-slate-500">Select or create an address for this supplier</p>
            </div>
            <button type="button" id="address-modal-close" class="text-slate-500 hover:text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-xs uppercase text-slate-500 mb-1" for="address-select">Use existing address</label>
                <select id="address-select" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm">
                    <option value="">-- Select address --</option>
                </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="address-line1">Address Line 1</label>
                    <input id="address-line1" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="123 Main St">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="address-line2">Address Line 2</label>
                    <input id="address-line2" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="Suite 100">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="address-city">City</label>
                    <input id="address-city" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="City">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="address-state">State</label>
                    <input id="address-state" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="State">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="address-zip">Zip</label>
                    <input id="address-zip" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="Zip">
                </div>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button type="button" id="address-modal-cancel" class="px-4 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50">Cancel</button>
            <button type="button" id="address-modal-save" class="px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 inline-flex items-center gap-2 min-w-[80px] justify-center">
                <span class="btn-text">Save</span>
                <span class="btn-spinner hidden"><div class="spinner" style="width: 14px; height: 14px;"></div></span>
            </button>
        </div>
    </div>
</div>

<!-- Contact modal -->
<div id="contact-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-slate-900">Add / Edit Contact</h3>
                <p class="text-sm text-slate-500">Create or update a contact for this supplier</p>
            </div>
            <button type="button" id="contact-modal-close" class="text-slate-500 hover:text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <input type="hidden" id="contact-id">
        <div class="space-y-3">
            <div>
                <label class="block text-xs uppercase text-slate-500 mb-1" for="contact-name">Name</label>
                <input id="contact-name" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="Full name">
            </div>
            <div>
                <label class="block text-xs uppercase text-slate-500 mb-1" for="contact-title">Title</label>
                <input id="contact-title" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="Title">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="contact-email">Email</label>
                    <input id="contact-email" type="email" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="email@example.com">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="contact-phone">Phone</label>
                    <input id="contact-phone" type="text" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="(555) 123-4567">
                </div>
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button type="button" id="contact-modal-cancel" class="px-4 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50">Cancel</button>
            <button type="button" id="contact-modal-save" class="px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 inline-flex items-center gap-2 min-w-[80px] justify-center">
                <span class="btn-text">Save</span>
                <span class="btn-spinner hidden"><div class="spinner" style="width: 14px; height: 14px;"></div></span>
            </button>
        </div>
    </div>
</div>

<!-- Certification modal -->
<div id="cert-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-slate-900">Add Certification</h3>
                <p class="text-sm text-slate-500">Create a new supplier certification</p>
            </div>
            <button type="button" id="cert-modal-close" class="text-slate-500 hover:text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-xs uppercase text-slate-500 mb-1" for="cert-type-input">Type</label>
                <select id="cert-type-input" class="w-full rounded-md border border-slate-300 px-2 py-2 bg-white text-sm">
                    <option value="">Select type</option>
                    {% for ct in certification_types %}
                    <option value="{{ ct.id }}">{{ ct.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="cert-date-input">Date</label>
                    <input id="cert-date-input" type="date" max="{{ today|date:'Y-m-d' }}" class="w-full rounded-md border border-slate-300 px-2 py-2 bg-white text-sm">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="cert-exp-input">Expiration</label>
                    <input id="cert-exp-input" type="date" class="w-full rounded-md border border-slate-300 px-2 py-2 bg-white text-sm">
                </div>
            </div>
            <div>
                <label class="block text-xs uppercase text-slate-500 mb-1" for="cert-compliance-input">Compliance Status</label>
                <input id="cert-compliance-input" list="compliance-status-options" type="text" class="w-full rounded-md border border-slate-300 px-2 py-2 bg-white text-sm" placeholder="Enter or select status">
                <datalist id="compliance-status-options">
                    {% for status in compliance_statuses %}
                    <option value="{{ status }}"></option>
                    {% endfor %}
                </datalist>
            </div>
            <div>
                <label class="block text-xs uppercase text-slate-500 mb-1" for="cert-file-input">Attach File (optional)</label>
                <input id="cert-file-input" type="file" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm bg-white">
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button type="button" id="cert-modal-cancel" class="px-4 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50">Cancel</button>
            <button type="button" id="cert-modal-save" class="px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 inline-flex items-center gap-2 min-w-[80px] justify-center">
                <span class="btn-text">Save</span>
                <span class="btn-spinner hidden"><div class="spinner" style="width: 14px; height: 14px;"></div></span>
            </button>
        </div>
    </div>
</div>

<!-- Classification modal -->
<div id="class-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-slate-900">Add Classification</h3>
                <p class="text-sm text-slate-500">Create a new supplier classification</p>
            </div>
            <button type="button" id="class-modal-close" class="text-slate-500 hover:text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="space-y-3">
            <div>
                <label class="block text-xs uppercase text-slate-500 mb-1" for="class-type-input">Type</label>
                <select id="class-type-input" class="w-full rounded-md border border-slate-300 px-2 py-2 bg-white text-sm">
                    <option value="">Select type</option>
                    {% for ct in classification_types %}
                    <option value="{{ ct.id }}">{{ ct.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="class-date-input">Date</label>
                    <input id="class-date-input" type="date" max="{{ today|date:'Y-m-d' }}" class="w-full rounded-md border border-slate-300 px-2 py-2 bg-white text-sm">
                </div>
                <div>
                    <label class="block text-xs uppercase text-slate-500 mb-1" for="class-exp-input">Expiration</label>
                    <input id="class-exp-input" type="date" class="w-full rounded-md border border-slate-300 px-2 py-2 bg-white text-sm">
                </div>
            </div>
            <div>
                <label class="block text-xs uppercase text-slate-500 mb-1" for="class-file-input">Attach File (optional)</label>
                <input id="class-file-input" type="file" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm bg-white">
            </div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button type="button" id="class-modal-cancel" class="px-4 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50">Cancel</button>
            <button type="button" id="class-modal-save" class="px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 inline-flex items-center gap-2 min-w-[80px] justify-center">
                <span class="btn-text">Save</span>
                <span class="btn-spinner hidden"><div class="spinner" style="width: 14px; height: 14px;"></div></span>
            </button>
        </div>
    </div>
</div>
<!-- Notes modal -->
<div id="notes-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-slate-900">Edit Notes</h3>
                <p class="text-sm text-slate-500">Update supplier notes</p>
            </div>
            <button type="button" id="notes-modal-close" class="text-slate-500 hover:text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div>
            <label for="notes-input" class="block text-xs uppercase text-slate-500 mb-1">Notes</label>
            <textarea id="notes-input" rows="8" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="Enter notes"></textarea>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button type="button" id="notes-modal-cancel" class="px-4 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50">Cancel</button>
            <button type="button" id="notes-modal-save" class="px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 inline-flex items-center gap-2 min-w-[80px] justify-center">
                <span class="btn-text">Save</span>
                <span class="btn-spinner hidden"><div class="spinner" style="width: 14px; height: 14px;"></div></span>
            </button>
        </div>
    </div>
</div>

<!-- Files modal -->
<div id="files-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50 px-4">
    <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6">
        <div class="flex items-start justify-between mb-4">
            <div>
                <h3 class="text-lg font-semibold text-slate-900">Edit Files URL</h3>
                <p class="text-sm text-slate-500">Link to supplier files (e.g., SharePoint)</p>
            </div>
            <button type="button" id="files-modal-close" class="text-slate-500 hover:text-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div>
            <label for="files-input" class="block text-xs uppercase text-slate-500 mb-1">Files URL</label>
            <input id="files-input" type="url" class="w-full rounded-md border border-slate-300 px-3 py-2 text-sm" placeholder="https://...">
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button type="button" id="files-modal-cancel" class="px-4 py-2 rounded-md border border-slate-300 text-slate-700 text-sm hover:bg-slate-50">Cancel</button>
            <button type="button" id="files-modal-save" class="px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700 inline-flex items-center gap-2 min-w-[80px] justify-center">
                <span class="btn-text">Save</span>
                <span class="btn-spinner hidden"><div class="spinner" style="width: 14px; height: 14px;"></div></span>
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    try {
    // ============================================
    // LOADING STATES & TOAST NOTIFICATION SYSTEM
    // ============================================
    
    function showToast(message, type = 'success', duration = 3000) {
        if (window.notify) {
            window.notify(type, message, duration);
        }
    }
    
    // Button loading state helpers
    function setButtonLoading(btn, loading) {
        if (!btn) return;
        const textEl = btn.querySelector('.btn-text');
        const spinnerEl = btn.querySelector('.btn-spinner');
        if (textEl && spinnerEl) {
            if (loading) {
                textEl.classList.add('hidden');
                spinnerEl.classList.remove('hidden');
                btn.disabled = true;
            } else {
                textEl.classList.remove('hidden');
                spinnerEl.classList.add('hidden');
                btn.disabled = false;
            }
        } else {
            btn.disabled = loading;
        }
    }
    
    // Search loading state
    const searchWrapper = document.getElementById('search-wrapper');
    function setSearchLoading(loading) {
        if (searchWrapper) {
            searchWrapper.classList.toggle('loading', loading);
        }
    }
    
    // Detail panel loading overlay
    const detailOverlay = document.getElementById('detail-loading-overlay');
    function setDetailLoading(loading) {
        if (detailOverlay) {
            detailOverlay.classList.toggle('active', loading);
        }
    }
    
    // Select loading state
    function setSelectLoading(select, loading) {
        if (!select) return;
        select.classList.toggle('loading', loading);
        select.disabled = loading;
    }
    
    // Tab switching (persist tab in URL so deep links keep state)
    const tabButtons = document.querySelectorAll('[data-tab]');
    const tabPanels = document.querySelectorAll('[data-panel]');
    let currentTab = new URL(window.location).searchParams.get('tab') || 'info';
    tabButtons.forEach(btn => btn.addEventListener('click', () => {
        tabButtons.forEach(b => b.classList.remove('active'));
        tabPanels.forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        const panel = document.querySelector(`[data-panel="${btn.dataset.tab}"]`);
        if (panel) panel.classList.add('active');
        currentTab = btn.dataset.tab || 'info';
        const url = new URL(window.location);
        url.searchParams.set('tab', btn.dataset.tab);
        window.history.replaceState({}, '', url);
    }));
    const initialTab = new URL(window.location).searchParams.get('tab');
    const initialButton = initialTab ? document.querySelector(`[data-tab="${initialTab}"]`) : tabButtons[0];
    if (initialButton) initialButton.click();

    // Autocomplete + list render
    const searchInput = document.getElementById('supplier-search');
    const listEl = document.getElementById('supplier-list');
    const archived = '{{ request.GET.archived|default:"active" }}';
    const detailDataScript = document.getElementById('detail-data');
    let currentDetail = detailDataScript ? JSON.parse(detailDataScript.textContent || '{}') : null;
    let currentSupplierId = currentDetail ? currentDetail.id : null;
    const urlSupplierId = new URL(window.location).searchParams.get('supplier_id');
    const initialSuppliersScript = document.getElementById('initial-suppliers');
    let initialSuppliers = [];
    if (initialSuppliersScript) {
        try {
            initialSuppliers = JSON.parse(initialSuppliersScript.textContent || '[]');
        } catch (e) {
            initialSuppliers = [];
        }
    }

    // Compliance select elements (declared early so setDetail can use them)
    const primeSelect = document.getElementById('prime-select');
    const ppiSelect = document.getElementById('ppi-select');
    const isoSelect = document.getElementById('iso-select');
    const gsiSelect = document.getElementById('gsi-select');
    const specialTermsSelect = document.getElementById('special-terms-select');

    // Build left-hand list and navigate with a full page load (so URL updates)
    function renderList(items) {
        listEl.innerHTML = '';
        if (!items || !items.length) {
            const empty = document.createElement('div');
            empty.className = 'text-slate-500 text-sm px-2 py-3';
            empty.textContent = 'No suppliers found.';
            listEl.appendChild(empty);
            return;
        }
        items.forEach(item => {
            const a = document.createElement('a');
            a.href = "#";
            a.dataset.id = item.id;
            a.className = 'supplier-card flex items-center justify-between hover:border-indigo-200';
            a.innerHTML = `
                <div>
                    <div class="text-sm font-semibold text-slate-900">${item.name}</div>
                    <div class="text-xs text-slate-500 flex items-center gap-2">
                        ${item.cage_code ? `<span class="font-mono">CAGE: ${item.cage_code}</span>` : ''}
                    </div>
                </div>
                <span class="badge badge-neutral">View</span>
            `;
            a.addEventListener('click', function(ev) {
                ev.preventDefault();
                fetchDetail(item.id, true);
            });
            listEl.appendChild(a);
        });
    }

    function doSearch(term) {
        setSearchLoading(true);
        const params = new URLSearchParams({ q: term || '', archived });
        fetch(`{% url 'suppliers:supplier_autocomplete' %}?${params.toString()}`)
            .then(resp => resp.json())
            .then(data => {
                renderList(data.results || []);
                const url = new URL(window.location);
                if (term) url.searchParams.set('q', term); else url.searchParams.delete('q');
                url.searchParams.delete('supplier_id');
                url.searchParams.set('tab', currentTab || 'info');
                window.history.replaceState({}, '', url);
            })
            .catch(() => {
                showToast('Search failed. Please try again.', 'error');
            })
            .finally(() => {
                setSearchLoading(false);
            });
    }

    let debounceTimer;
    searchInput.addEventListener('input', () => {
        const term = searchInput.value.trim();
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => doSearch(term), 200);
    });

    // Allow manual reset of search/list
    const resetBtn = document.createElement('button');
    resetBtn.type = 'button';
    resetBtn.textContent = 'Reset';
    resetBtn.className = 'mt-2 text-xs text-indigo-600 hover:underline';
    resetBtn.addEventListener('click', () => {
        searchInput.value = '';
        renderList(initialSuppliers);
        const url = new URL(window.location);
        url.searchParams.delete('q');
        url.searchParams.delete('supplier_id');
        window.history.replaceState({}, '', url);
    });
    if (searchInput && searchInput.parentElement) {
        searchInput.parentElement.appendChild(resetBtn);
    }

    // Render the main detail pane from a supplier payload
    function setDetail(data) {
        if (!data || !data.id) return;
        currentDetail = data;
        const setText = (id, value) => {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        };
        setText('detail-name', data.name || 'N/A');
        const statuses = document.getElementById('detail-statuses');
        if (statuses) {
            statuses.innerHTML = '';
            if (data.probation) statuses.innerHTML += '<span class="badge badge-red">Probation</span>';
            if (data.conditional) statuses.innerHTML += '<span class="badge badge-yellow">Conditional</span>';
            if (data.archived) statuses.innerHTML += '<span class="badge badge-muted">Archived</span>';
        }
        setText('detail-cage', data.cage_code || 'N/A');
        const typeSelect = document.getElementById('detail-type-select');
        if (typeSelect) typeSelect.value = data.supplier_type_id || '';
        const packhouseSelect = document.getElementById('detail-packhouse-select');
        if (packhouseSelect) packhouseSelect.value = data.packhouse_id || '';
        const dodaacEl = document.getElementById('detail-dodaac');
        if (dodaacEl) dodaacEl.textContent = data.dodaac || 'N/A';
        setText('detail-phone', data.business_phone || 'No phone');
        setText('detail-email', data.business_email || 'No email');
        setText('detail-fax', data.business_fax || 'No fax');
        setText('detail-address', data.address || 'No address on file');
        setText('detail-notes', data.notes || 'No notes yet');
        const notes2 = document.getElementById('detail-notes-2');
        if (notes2) notes2.textContent = data.notes || 'No notes yet';
        const addrPhys = document.getElementById('detail-addr-physical');
        if (addrPhys) addrPhys.textContent = data.physical_address || 'No address';
        const addrShip = document.getElementById('detail-addr-shipping');
        if (addrShip) addrShip.textContent = data.shipping_address || 'No address';
        const addrBill = document.getElementById('detail-addr-billing');
        if (addrBill) addrBill.textContent = data.billing_address || 'No address';
        currentDetail.physical_address_id = data.physical_address_id;
        currentDetail.shipping_address_id = data.shipping_address_id;
        currentDetail.billing_address_id = data.billing_address_id;
        currentDetail.physical_address_display = data.physical_address_display;
        currentDetail.shipping_address_display = data.shipping_address_display;
        currentDetail.billing_address_display = data.billing_address_display;
        setText('detail-gsi', data.allows_gsi || 'Unknown');
        setText('detail-ppi', data.ppi === true ? 'Yes' : data.ppi === false ? 'No' : 'Unknown');
        setText('detail-iso', data.iso === true ? 'Yes' : data.iso === false ? 'No' : 'Unknown');
        setText('detail-prime', data.prime || '');
        setText('detail-special', data.special_terms || '');
        setText('detail-special-on', data.special_terms_on || '');
        const filesEl = document.getElementById('detail-files-url');
        if (filesEl) {
            if (data.files_url) {
                filesEl.textContent = 'SharePoint Link';
                filesEl.setAttribute('href', data.files_url);
                filesEl.classList.remove('text-slate-500', 'pointer-events-none', 'cursor-not-allowed');
                filesEl.classList.add('text-indigo-600');
            } else {
                filesEl.textContent = 'None provided';
                filesEl.setAttribute('href', '#');
                filesEl.classList.add('text-slate-500', 'pointer-events-none', 'cursor-not-allowed');
                filesEl.classList.remove('text-indigo-600');
            }
        }
        if (primeSelect) primeSelect.value = data.prime != null ? String(data.prime) : '';
        if (ppiSelect) ppiSelect.value = data.ppi === true ? 'true' : data.ppi === false ? 'false' : '';
        if (isoSelect) isoSelect.value = data.iso === true ? 'true' : data.iso === false ? 'false' : '';
        if (gsiSelect) gsiSelect.value = data.allows_gsi_value || 'UNK';
        if (specialTermsSelect) specialTermsSelect.value = data.special_terms_id || '';
        setText('detail-prob-on', data.probation_on || '');
        setText('detail-prob-by', data.probation_by || '');
        setText('detail-cond-on', data.conditional_on || '');
        setText('detail-cond-by', data.conditional_by || '');
        setText('detail-arch-on', data.archived_on || '');
        setText('detail-arch-by', data.archived_by || '');
        setText('detail-contact-name', data.contact_name || '');
        setText('detail-contact-email', data.contact_email || '');
        setText('detail-contact-phone', data.contact_phone || '');

        const contractsEl = document.getElementById('detail-contracts');
        if (contractsEl) {
            if (data.contracts && data.contracts.length) {
                contractsEl.innerHTML = data.contracts.map(c => `
                    <div class="flex justify-between text-sm">
                        <div>
                            <div class="font-semibold">${c.number || 'No Number'}</div>
                            <div class="text-xs text-slate-500">Award: ${c.award_date || 'N/A'}</div>
                        </div>
                        <div class="text-xs text-slate-600">${c.status || ''}</div>
                    </div>
                `).join('');
            } else {
                contractsEl.innerHTML = '<div class="text-sm text-slate-600">No contracts.</div>';
            }
        }

        renderContacts(data.contacts || []);

        const contactsPanel = document.getElementById('detail-contacts');
        if (contactsPanel) {
            if (data.contacts && data.contacts.length) {
                contactsPanel.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3';
                contactsPanel.innerHTML = data.contacts.map(ct => `
                    <div class="border border-slate-200 rounded-md px-3 py-2 bg-slate-50 space-y-1">
                        <div class="font-semibold text-slate-900">
                            ${ct.id ? `<a href="${`{% url 'contracts:contact_detail' 0 %}`.replace('/0/', `/${ct.id}/`)}" class="text-blue-600 hover:text-blue-800">${ct.name || ''}</a>` : (ct.name || '')}
                            ${ct.title ? `<span class="text-xs text-slate-500">(${ct.title})</span>` : ''}
                        </div>
                        <div class="text-sm text-slate-700">
                            ${ct.email ? `<a href="mailto:${ct.email}" class="text-indigo-600 hover:underline">${ct.email}</a>` : '<span class="text-slate-500">No email</span>'}
                        </div>
                        <div class="text-sm text-slate-700">
                            ${ct.phone ? `<a href="tel:${ct.phone}" class="text-indigo-600 hover:underline">${ct.phone}</a>` : '<span class="text-slate-500">No phone</span>'}
                        </div>
                    </div>
                `).join('');
            } else {
                contactsPanel.className = '';
                contactsPanel.innerHTML = '<div class="text-sm text-slate-600">No personnel listed.</div>';
            }
        }

        renderCerts(data.certifications || []);
        renderClasses(data.classifications || []);

        const certsEl = document.getElementById('detail-certs');
        if (certsEl) {
            if (data.certifications && data.certifications.length) {
                certsEl.innerHTML = '<ul class="space-y-1 text-sm">' + data.certifications.map(cert => `
                    <li>${cert.type || ''}${cert.expires ? ` (exp ${cert.expires})` : ''}</li>
                `).join('') + '</ul>';
            } else {
                certsEl.innerHTML = '<div class="text-sm text-slate-600">No certifications.</div>';
            }
        }

        const statsEl = document.getElementById('detail-stats');
        if (statsEl) {
            if (data.stats) {
                statsEl.innerHTML = `
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div>Total Contracts: ${data.stats.total_contracts || 0}</div>
                        <div>Active Contracts: ${data.stats.active_contracts || 0}</div>
                        <div>Total Value: ${data.stats.total_value || 0}</div>
                        <div>Yearly Value: ${data.stats.yearly_value || 0}</div>
                    </div>
                `;
            } else {
                statsEl.innerHTML = '<div class="text-sm text-slate-600">No stats.</div>';
            }
        }
    }

    function resetDetailUI() {
        const textTargets = [
            'detail-name', 'detail-cage', 'detail-dodaac', 'detail-phone', 'detail-email', 'detail-fax',
            'detail-address', 'detail-notes', 'detail-notes-2', 'detail-addr-physical', 'detail-addr-shipping', 'detail-addr-billing',
            'detail-gsi', 'detail-ppi', 'detail-iso', 'detail-prime', 'detail-special', 'detail-special-on',
            'detail-prob-on', 'detail-prob-by', 'detail-cond-on', 'detail-cond-by', 'detail-arch-on', 'detail-arch-by',
            'detail-contact-name', 'detail-contact-email', 'detail-contact-phone'
        ];
        textTargets.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '';
        });
        const listTargets = [
            'detail-contracts', 'detail-contacts', 'detail-certs', 'detail-classifications', 'detail-stats', 'contacts-list'
        ];
        listTargets.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.innerHTML = '';
        });
    }

    // Fetch detail payload via AJAX (used on initial load when only supplier_id is in URL)
    function fetchDetail(id, updateUrl = false) {
        setDetailLoading(true);
        resetDetailUI();
        const params = new URLSearchParams({ supplier_id: id, ajax: '1' });
        fetch(`${window.location.pathname}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(async resp => {
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(`HTTP ${resp.status}: ${text.slice(0, 300)}`);
                }
                return resp.json();
            })
            .then(data => {
                setDetail(data);
                currentSupplierId = data.id;
                // highlight selection
                document.querySelectorAll('.supplier-item').forEach(el => {
                    el.classList.toggle('border-indigo-300', el.dataset.id == id);
                    el.classList.toggle('bg-indigo-50', el.dataset.id == id);
                });
                if (updateUrl) {
                    const url = new URL(window.location);
                    url.searchParams.set('supplier_id', id);
                    url.searchParams.set('tab', currentTab || 'info');
                    window.history.replaceState({}, '', url);
                }
            })
            .catch((err) => {
                const message = err && err.message ? err.message : 'Failed to load supplier details.';
                showToast(message, 'error');
                console.error('Supplier detail error', err);
            })
            .finally(() => {
                setDetailLoading(false);
            });
    }

    // Attach click handlers to existing list
    document.querySelectorAll('.supplier-item').forEach(el => {
        el.addEventListener('click', function(ev) {
            ev.preventDefault();
            fetchDetail(this.dataset.id, true);
        });
    });

    // Initialize detail from server payload
    if (currentDetail && currentDetail.id) {
        setDetail(currentDetail);
        currentSupplierId = currentDetail.id || currentSupplierId;
    } else if (urlSupplierId) {
        fetchDetail(urlSupplierId, true);
    }

    // Render contact cards and wire edit/delete actions
    function renderContacts(contacts) {
        currentDetail.contacts = contacts;
        const list = document.getElementById('contacts-list');
        if (!list) return;
        if (!contacts.length) {
            list.className = 'text-slate-500 text-sm';
            list.innerHTML = 'No contacts yet';
            return;
        }
        list.className = 'grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-3 text-sm';
        list.innerHTML = contacts.map(ct => `
            <div class="border border-slate-200 rounded-md px-3 py-2 bg-slate-50 contact-row h-full flex flex-col justify-between" data-contact-id="${ct.id || ''}">
                <div>
                    <div class="font-semibold text-slate-900 flex items-center gap-2">
                        ${ct.name || ''}
                        ${ct.title ? `<span class="text-xs text-slate-500">(${ct.title})</span>` : ''}
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${ct.email ? `<a href="mailto:${ct.email}" class="text-indigo-600 hover:underline">${ct.email}</a>` : ''}
                    </div>
                    <div class="text-slate-700 text-sm">
                        ${ct.phone ? `<a href="tel:${ct.phone}" class="text-indigo-600 hover:underline">${ct.phone}</a>` : ''}
                    </div>
                </div>
                <div class="flex items-center gap-2 justify-end mt-2">
                    <button type="button" class="edit-contact-btn text-slate-500 hover:text-indigo-600" title="Edit contact" data-contact-id="${ct.id || ''}" data-contact-name="${ct.name || ''}" data-contact-email="${ct.email || ''}" data-contact-phone="${ct.phone || ''}" data-contact-title="${ct.title || ''}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                    </button>
                    <button type="button" class="delete-contact-btn text-red-500 hover:text-red-700" title="Delete contact" data-contact-id="${ct.id || ''}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
            </div>
        `).join('');

        list.querySelectorAll('.edit-contact-btn').forEach(btn => {
            btn.addEventListener('click', () => openContactModal({
                id: btn.dataset.contactId,
                name: btn.dataset.contactName,
                email: btn.dataset.contactEmail,
                phone: btn.dataset.contactPhone,
                title: btn.dataset.contactTitle
            }));
        });
        list.querySelectorAll('.delete-contact-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const contactId = btn.dataset.contactId;
                if (!contactId || !currentSupplierId) return;
                
                // Add loading state to the row
                const row = btn.closest('.contact-row');
                if (row) row.style.opacity = '0.5';
                btn.disabled = true;
                
                const deleteUrl = `{% url 'contracts:supplier_delete_contact' pk=0 contact_id=0 %}`.replace('/0/contact/0/', `/${currentSupplierId}/contact/${contactId}/`);
                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(resp => resp.json())
                .then(data => {
                    currentSupplierId = data.id;
                    setDetail(data);
                    showToast('Contact deleted.', 'success');
                })
                .catch(() => {
                    showToast('Failed to delete contact.', 'error');
                    if (row) row.style.opacity = '1';
                    btn.disabled = false;
                });
            });
        });
    }

    function renderCerts(certs) {
        const wrap = document.getElementById('detail-certs');
        if (!wrap) return;
        if (!certs.length) {
            wrap.innerHTML = '<div class="text-sm text-slate-600">No certifications.</div>';
            return;
        }
        wrap.innerHTML = certs.map(cert => `
            <div class="flex items-center justify-between border border-slate-200 rounded-md px-3 py-2 bg-slate-50" data-cert-id="${cert.id || ''}">
                <div>
                    <div class="font-semibold text-slate-900">${cert.type || ''}</div>
                    <div class="text-xs text-slate-600">
                        ${cert.date ? `Date: ${cert.date}` : ''}${cert.expires ? `${cert.date ? ' | ' : ''}Exp: ${cert.expires}` : ''}${cert.compliance_status ? `${(cert.date || cert.expires) ? ' | ' : ''}Compliance: ${cert.compliance_status}` : ''}${cert.document_url ? `${(cert.date || cert.expires || cert.compliance_status) ? ' | ' : ''}<a href=\"${cert.document_url}\" target=\"_blank\" class=\"text-indigo-600 hover:text-indigo-800\">View file</a>` : ''}
                    </div>
                </div>
                <button type="button" class="delete-cert-btn text-red-500 hover:text-red-700" title="Delete" data-id="${cert.id || ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        `).join('');
        wrap.querySelectorAll('.delete-cert-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const cid = btn.dataset.id;
                if (!cid || !currentSupplierId) return;
                
                // Add loading state to the row
                const row = btn.closest('[data-cert-id]');
                if (row) row.style.opacity = '0.5';
                btn.disabled = true;
                
                fetch(`{% url 'contracts:supplier_delete_certification' supplier_id=0 pk=0 %}`.replace('/0/', `/${currentSupplierId}/`).replace('/0/', `/${cid}/`), {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(resp => resp.json())
                .then(() => {
                    refreshDetail();
                    showToast('Certification deleted.', 'success');
                })
                .catch(() => {
                    showToast('Failed to delete certification.', 'error');
                    if (row) row.style.opacity = '1';
                    btn.disabled = false;
                });
            });
        });
    }

    function renderClasses(classes) {
        const wrap = document.getElementById('detail-classifications');
        if (!wrap) return;
        if (!classes.length) {
            wrap.innerHTML = '<div class="text-sm text-slate-600">No classifications.</div>';
            return;
        }
        wrap.innerHTML = classes.map(c => `
            <div class="flex items-center justify-between border border-slate-200 rounded-md px-3 py-2 bg-slate-50" data-class-id="${c.id || ''}">
                <div>
                    <div class="font-semibold text-slate-900">${c.type || ''}</div>
                    <div class="text-xs text-slate-600">
                        ${c.date ? `Date: ${c.date}` : ''}${c.expires ? `${c.date ? ' | ' : ''}Exp: ${c.expires}` : ''}${c.document_url ? `${(c.date || c.expires) ? ' | ' : ''}<a href=\"${c.document_url}\" target=\"_blank\" class=\"text-indigo-600 hover:text-indigo-800\">View file</a>` : ''}
                    </div>
                </div>
                <button type="button" class="delete-class-btn text-red-500 hover:text-red-700" title="Delete" data-id="${c.id || ''}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        `).join('');
        wrap.querySelectorAll('.delete-class-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const cid = btn.dataset.id;
                if (!cid || !currentSupplierId) return;
                
                // Add loading state to the row
                const row = btn.closest('[data-class-id]');
                if (row) row.style.opacity = '0.5';
                btn.disabled = true;
                
                fetch(`{% url 'contracts:supplier_delete_classification' supplier_id=0 pk=0 %}`.replace('/0/', `/${currentSupplierId}/`).replace('/0/', `/${cid}/`), {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(resp => resp.json())
                .then(() => {
                    refreshDetail();
                    showToast('Classification deleted.', 'success');
                })
                .catch(() => {
                    showToast('Failed to delete classification.', 'error');
                    if (row) row.style.opacity = '1';
                    btn.disabled = false;
                });
            });
        });
    }

    function refreshDetail(showOverlay = false) {
        if (!currentSupplierId) return;
        if (showOverlay) setDetailLoading(true);
        const params = new URLSearchParams({ supplier_id: currentSupplierId, ajax: '1' });
        fetch(`${window.location.pathname}?${params.toString()}`, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(resp => resp.json())
            .then(data => {
                setDetail(data);
            })
            .catch(() => {
                showToast('Failed to refresh data.', 'error');
            })
            .finally(() => {
                if (showOverlay) setDetailLoading(false);
            });
    }

    // Toggle buttons
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    // Name/CAGE/DODAAC quick edit modal
    const nameModal = document.getElementById('name-edit-modal');
    const editNameBtn = document.getElementById('edit-name-btn');
    const nameInput = document.getElementById('name-input');
    const cageInput = document.getElementById('cage-input');
    const dodaacInput = document.getElementById('dodaac-input');
    const nameSaveBtn = document.getElementById('name-modal-save');
    const nameCancelBtn = document.getElementById('name-modal-cancel');
    const nameCloseBtn = document.getElementById('name-modal-close');
    const addressModal = document.getElementById('address-modal');
    const addressSelect = document.getElementById('address-select');
    const addressLine1 = document.getElementById('address-line1');
    const addressLine2 = document.getElementById('address-line2');
    const addressCity = document.getElementById('address-city');
    const addressState = document.getElementById('address-state');
    const addressZip = document.getElementById('address-zip');
    const addressSaveBtn = document.getElementById('address-modal-save');
    const addressCancelBtn = document.getElementById('address-modal-cancel');
    const addressCloseBtn = document.getElementById('address-modal-close');
    const contactModal = document.getElementById('contact-modal');
    const contactIdInput = document.getElementById('contact-id');
    const contactNameInput = document.getElementById('contact-name');
    const contactEmailInput = document.getElementById('contact-email');
    const contactPhoneInput = document.getElementById('contact-phone');
    const contactTitleInput = document.getElementById('contact-title');
    const contactSaveBtn = document.getElementById('contact-modal-save');
    const contactCancelBtn = document.getElementById('contact-modal-cancel');
    const contactCloseBtn = document.getElementById('contact-modal-close');
    const addContactBtn = document.getElementById('add-contact-btn');
    const notesModal = document.getElementById('notes-modal');
    const notesInput = document.getElementById('notes-input');
    const notesSaveBtn = document.getElementById('notes-modal-save');
    const notesCancelBtn = document.getElementById('notes-modal-cancel');
    const notesCloseBtn = document.getElementById('notes-modal-close');
    const editNotesBtn = document.getElementById('edit-notes-btn');
    const editNotesBtn2 = document.getElementById('edit-notes-btn-2');
    const filesModal = document.getElementById('files-modal');
    const filesInput = document.getElementById('files-input');
    const filesSaveBtn = document.getElementById('files-modal-save');
    const filesCancelBtn = document.getElementById('files-modal-cancel');
    const filesCloseBtn = document.getElementById('files-modal-close');
    const editFilesBtn = document.getElementById('edit-files-btn');
    const certModal = document.getElementById('cert-modal');
    const certTypeInput = document.getElementById('cert-type-input');
    const certDateInput = document.getElementById('cert-date-input');
    const certExpInput = document.getElementById('cert-exp-input');
    const certFileInput = document.getElementById('cert-file-input');
    const certComplianceInput = document.getElementById('cert-compliance-input');
    const certSaveBtn = document.getElementById('cert-modal-save');
    const certCancelBtn = document.getElementById('cert-modal-cancel');
    const certCloseBtn = document.getElementById('cert-modal-close');
    const openCertBtn = document.getElementById('open-cert-modal');
    const classModal = document.getElementById('class-modal');
    const classTypeInput = document.getElementById('class-type-input');
    const classDateInput = document.getElementById('class-date-input');
    const classExpInput = document.getElementById('class-exp-input');
    const classFileInput = document.getElementById('class-file-input');
    const classSaveBtn = document.getElementById('class-modal-save');
    const classCancelBtn = document.getElementById('class-modal-cancel');
    const classCloseBtn = document.getElementById('class-modal-close');
    const openClassBtn = document.getElementById('open-class-modal');
    const supplierTypeSelect = document.getElementById('detail-type-select');
    const packhouseSelectEl = document.getElementById('detail-packhouse-select');
    let activeAddressField = null;
    let addressesCache = [];

    function populateNameModal() {
        if (!currentDetail) return;
        if (nameInput) nameInput.value = currentDetail.name || '';
        if (cageInput) cageInput.value = currentDetail.cage_code || '';
        if (dodaacInput) dodaacInput.value = currentDetail.dodaac || '';
    }

    function openNameModal() {
        if (!currentSupplierId || !nameModal) return;
        populateNameModal();
        nameModal.classList.remove('hidden');
        nameModal.classList.add('flex');
    }

    function closeNameModal() {
        if (!nameModal) return;
        nameModal.classList.add('hidden');
        nameModal.classList.remove('flex');
        if (nameSaveBtn) nameSaveBtn.disabled = false;
    }

    [nameCancelBtn, nameCloseBtn].forEach(btn => {
        if (btn) btn.addEventListener('click', closeNameModal);
    });
    if (editNameBtn) editNameBtn.addEventListener('click', openNameModal);

    if (nameSaveBtn) {
        nameSaveBtn.addEventListener('click', function() {
            if (!currentSupplierId) return;
            setButtonLoading(nameSaveBtn, true);
            fetch(`{% url 'contracts:supplier_quick_update' pk=0 %}`.replace('0', currentSupplierId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new URLSearchParams({
                    name: nameInput ? nameInput.value : '',
                    cage_code: cageInput ? cageInput.value : '',
                    dodaac: dodaacInput ? dodaacInput.value : ''
                })
            })
            .then(resp => {
                if (!resp.ok) throw new Error('Save failed');
                return resp.json();
            })
            .then(data => {
                currentSupplierId = data.id;
                setDetail(data);
                const listTitle = document.querySelector(`.supplier-item[data-id="${currentSupplierId}"] .text-sm.font-semibold`);
                if (listTitle) {
                    listTitle.textContent = data.cage_code ? `${data.name || 'N/A'} (${data.cage_code})` : (data.name || 'N/A');
                }
                closeNameModal();
                showToast('Supplier updated successfully!', 'success');
            })
            .catch(() => {
                showToast('Failed to save changes. Please try again.', 'error');
            })
            .finally(() => {
                setButtonLoading(nameSaveBtn, false);
            });
        });
    }

    function populateAddressSelect(addresses) {
        if (!addressSelect) return;
        addressSelect.innerHTML = '<option value="">-- Select address --</option>';
        addresses.forEach(addr => {
            const opt = document.createElement('option');
            opt.value = addr.id;
            opt.textContent = addr.display || '';
            addressSelect.appendChild(opt);
        });
    }

    function fetchAddresses(query) {
        const params = new URLSearchParams();
        if (query) params.append('q', query);
        fetch(`{% url 'contracts:addresses_lookup' %}?${params.toString()}`)
            .then(resp => resp.json())
            .then(data => {
                addressesCache = data.results || [];
                populateAddressSelect(addressesCache);
            })
            .catch(() => {});
    }

    function populateAddressFields(field) {
        if (!currentDetail) return;
        const addrObj = currentDetail[`${field}_address_obj`];
        if (addressSelect) addressSelect.value = addrObj && addrObj.id ? addrObj.id : '';
        if (addressLine1) addressLine1.value = addrObj?.line1 || '';
        if (addressLine2) addressLine2.value = addrObj?.line2 || '';
        if (addressCity) addressCity.value = addrObj?.city || '';
        if (addressState) addressState.value = addrObj?.state || '';
        if (addressZip) addressZip.value = addrObj?.zip || '';
    }

    function openAddressModal(field) {
        if (!addressModal || !field || !currentSupplierId) return;
        activeAddressField = field;
        fetchAddresses();
        populateAddressFields(field);
        addressModal.classList.remove('hidden');
        addressModal.classList.add('flex');
    }

    function closeAddressModal() {
        if (!addressModal) return;
        addressModal.classList.add('hidden');
        addressModal.classList.remove('flex');
        if (addressSaveBtn) addressSaveBtn.disabled = false;
        activeAddressField = null;
    }

    [addressCancelBtn, addressCloseBtn].forEach(btn => {
        if (btn) btn.addEventListener('click', closeAddressModal);
    });

    document.querySelectorAll('.edit-address-btn').forEach(btn => {
        btn.addEventListener('click', () => openAddressModal(btn.dataset.field));
    });

    if (addressSaveBtn) {
        addressSaveBtn.addEventListener('click', function() {
            if (!currentSupplierId || !activeAddressField) return;
            setButtonLoading(addressSaveBtn, true);
            fetch(`{% url 'contracts:supplier_update_address' pk=0 %}`.replace('0', currentSupplierId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new URLSearchParams({
                    field: activeAddressField,
                    address_id: addressSelect ? addressSelect.value : '',
                    line1: addressLine1 ? addressLine1.value : '',
                    line2: addressLine2 ? addressLine2.value : '',
                    city: addressCity ? addressCity.value : '',
                    state: addressState ? addressState.value : '',
                    zip: addressZip ? addressZip.value : '',
                })
            })
            .then(resp => resp.json())
            .then(data => {
                currentSupplierId = data.id;
                setDetail(data);
                closeAddressModal();
                showToast('Address updated successfully!', 'success');
            })
            .catch(() => {
                showToast('Failed to save address. Please try again.', 'error');
            })
            .finally(() => {
                setButtonLoading(addressSaveBtn, false);
            });
        });
    }

    function openContactModal(contact = {}) {
        if (!contactModal || !currentSupplierId) return;
        if (contactIdInput) contactIdInput.value = contact.id || '';
        if (contactNameInput) contactNameInput.value = contact.name || '';
        if (contactEmailInput) contactEmailInput.value = contact.email || '';
        if (contactPhoneInput) contactPhoneInput.value = contact.phone || '';
        if (contactTitleInput) contactTitleInput.value = contact.title || '';
        contactModal.classList.remove('hidden');
        contactModal.classList.add('flex');
    }

    function closeContactModal() {
        if (!contactModal) return;
        contactModal.classList.add('hidden');
        contactModal.classList.remove('flex');
        if (contactSaveBtn) contactSaveBtn.disabled = false;
    }

    [contactCancelBtn, contactCloseBtn].forEach(btn => {
        if (btn) btn.addEventListener('click', closeContactModal);
    });

    if (addContactBtn) addContactBtn.addEventListener('click', () => openContactModal({}));

    if (contactSaveBtn) {
        contactSaveBtn.addEventListener('click', function() {
            if (!currentSupplierId) return;
            setButtonLoading(contactSaveBtn, true);
            fetch(`{% url 'contracts:supplier_save_contact' pk=0 %}`.replace('0', currentSupplierId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new URLSearchParams({
                    contact_id: contactIdInput ? contactIdInput.value : '',
                    name: contactNameInput ? contactNameInput.value : '',
                    email: contactEmailInput ? contactEmailInput.value : '',
                    phone: contactPhoneInput ? contactPhoneInput.value : '',
                    title: contactTitleInput ? contactTitleInput.value : '',
                })
            })
            .then(resp => resp.json())
            .then(data => {
                currentSupplierId = data.id;
                setDetail(data);
                closeContactModal();
                if (contactPhoneInput) contactPhoneInput.value = formatPhone(contactPhoneInput.value);
                showToast('Contact saved successfully!', 'success');
            })
            .catch(() => {
                showToast('Failed to save contact. Please try again.', 'error');
            })
            .finally(() => {
                setButtonLoading(contactSaveBtn, false);
            });
        });
    }

    function updateSelects(payload, triggerSelect = null) {
        if (!currentSupplierId) return;
        if (triggerSelect) setSelectLoading(triggerSelect, true);
        fetch(`{% url 'contracts:supplier_update_selects' pk=0 %}`.replace('0', currentSupplierId), {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams(payload)
        })
        .then(resp => resp.json())
        .then(data => {
            currentSupplierId = data.id;
            setDetail(data);
            showToast('Updated successfully!', 'success');
        })
        .catch(() => {
            showToast('Failed to update. Please try again.', 'error');
        })
        .finally(() => {
            if (triggerSelect) setSelectLoading(triggerSelect, false);
        });
    }

    if (supplierTypeSelect) {
        supplierTypeSelect.addEventListener('change', () => {
            updateSelects({ supplier_type_id: supplierTypeSelect.value || '' }, supplierTypeSelect);
        });
    }

    if (packhouseSelectEl) {
        packhouseSelectEl.addEventListener('change', () => {
            updateSelects({ packhouse_id: packhouseSelectEl.value || '' }, packhouseSelectEl);
        });
    }

    function updateCompliance(payload, triggerSelect = null) {
        if (!currentSupplierId) return;
        if (triggerSelect) setSelectLoading(triggerSelect, true);
        fetch(`{% url 'contracts:supplier_update_compliance' pk=0 %}`.replace('0', currentSupplierId), {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams(payload)
        })
        .then(resp => resp.json())
        .then(data => {
            currentSupplierId = data.id;
            setDetail(data);
            showToast('Compliance updated!', 'success');
        })
        .catch(() => {
            showToast('Failed to update compliance.', 'error');
        })
        .finally(() => {
            if (triggerSelect) setSelectLoading(triggerSelect, false);
        });
    }

    if (primeSelect) {
        primeSelect.addEventListener('change', () => {
            updateCompliance({ prime: primeSelect.value || '' }, primeSelect);
        });
    }
    if (ppiSelect) {
        ppiSelect.addEventListener('change', () => {
            updateCompliance({ ppi: ppiSelect.value || '' }, ppiSelect);
        });
    }
    if (isoSelect) {
        isoSelect.addEventListener('change', () => {
            updateCompliance({ iso: isoSelect.value || '' }, isoSelect);
        });
    }
    if (gsiSelect) {
        gsiSelect.addEventListener('change', () => {
            updateCompliance({ allows_gsi: gsiSelect.value || 'UNK' }, gsiSelect);
        });
    }
    if (specialTermsSelect) {
        specialTermsSelect.addEventListener('change', () => {
            updateCompliance({ special_terms_id: specialTermsSelect.value || '' }, specialTermsSelect);
        });
    }

    // QMS modals
    function openCertModal() {
        if (!certModal) return;
        if (certTypeInput) certTypeInput.value = '';
        if (certDateInput) certDateInput.value = '';
        if (certExpInput) certExpInput.value = '';
        if (certComplianceInput) certComplianceInput.value = '';
        if (certFileInput) certFileInput.value = '';
        certModal.classList.remove('hidden');
        certModal.classList.add('flex');
    }
    function closeCertModal() {
        if (!certModal) return;
        certModal.classList.add('hidden');
        certModal.classList.remove('flex');
        if (certSaveBtn) certSaveBtn.disabled = false;
    }
    [certCancelBtn, certCloseBtn].forEach(btn => {
        if (btn) btn.addEventListener('click', closeCertModal);
    });
    if (openCertBtn) openCertBtn.addEventListener('click', openCertModal);
    if (certSaveBtn) {
        certSaveBtn.addEventListener('click', function() {
            if (!currentSupplierId || !certTypeInput || !certTypeInput.value) return;
            setButtonLoading(certSaveBtn, true);
            const formData = new FormData();
            formData.append('certification_type', certTypeInput.value);
            formData.append('certification_date', certDateInput ? certDateInput.value : '');
            formData.append('certification_expiration', certExpInput ? certExpInput.value : '');
            formData.append('compliance_status', certComplianceInput ? certComplianceInput.value : '');
            if (certFileInput && certFileInput.files && certFileInput.files[0]) {
                formData.append('file', certFileInput.files[0]);
            }
            fetch(`{% url 'contracts:supplier_add_certification' supplier_id=0 %}`.replace('0', currentSupplierId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(resp => resp.json())
            .then(() => {
                closeCertModal();
                refreshDetail();
                showToast('Certification added successfully!', 'success');
            })
            .catch(() => {
                showToast('Failed to add certification.', 'error');
            })
            .finally(() => {
                setButtonLoading(certSaveBtn, false);
            });
        });
    }

    function openClassModal() {
        if (!classModal) return;
        if (classTypeInput) classTypeInput.value = '';
        if (classDateInput) classDateInput.value = '';
        if (classExpInput) classExpInput.value = '';
        if (classFileInput) classFileInput.value = '';
        classModal.classList.remove('hidden');
        classModal.classList.add('flex');
    }
    function closeClassModal() {
        if (!classModal) return;
        classModal.classList.add('hidden');
        classModal.classList.remove('flex');
        if (classSaveBtn) classSaveBtn.disabled = false;
    }
    [classCancelBtn, classCloseBtn].forEach(btn => {
        if (btn) btn.addEventListener('click', closeClassModal);
    });
    if (openClassBtn) openClassBtn.addEventListener('click', openClassModal);
    if (classSaveBtn) {
        classSaveBtn.addEventListener('click', function() {
            if (!currentSupplierId || !classTypeInput || !classTypeInput.value) return;
            setButtonLoading(classSaveBtn, true);
            const formData = new FormData();
            formData.append('classification_type', classTypeInput.value);
            formData.append('classification_date', classDateInput ? classDateInput.value : '');
            formData.append('expiration_date', classExpInput ? classExpInput.value : '');
            if (classFileInput && classFileInput.files && classFileInput.files[0]) {
                formData.append('file', classFileInput.files[0]);
            }
            fetch(`{% url 'contracts:supplier_add_classification' supplier_id=0 %}`.replace('0', currentSupplierId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(resp => resp.json())
            .then(() => {
                closeClassModal();
                refreshDetail();
                showToast('Classification added successfully!', 'success');
            })
            .catch(() => {
                showToast('Failed to add classification.', 'error');
            })
            .finally(() => {
                setButtonLoading(classSaveBtn, false);
            });
        });
    }

    function openNotesModal() {
        if (!notesModal || !notesInput) return;
        notesInput.value = (currentDetail && currentDetail.notes) || '';
        notesModal.classList.remove('hidden');
        notesModal.classList.add('flex');
    }

    function closeNotesModal() {
        if (!notesModal) return;
        notesModal.classList.add('hidden');
        notesModal.classList.remove('flex');
        if (notesSaveBtn) notesSaveBtn.disabled = false;
    }

    [notesCancelBtn, notesCloseBtn].forEach(btn => {
        if (btn) btn.addEventListener('click', closeNotesModal);
    });
    [editNotesBtn, editNotesBtn2].forEach(btn => {
        if (btn) btn.addEventListener('click', openNotesModal);
    });

    if (notesSaveBtn) {
        notesSaveBtn.addEventListener('click', function() {
            if (!currentSupplierId) return;
            setButtonLoading(notesSaveBtn, true);
            fetch(`{% url 'contracts:supplier_update_notes' pk=0 %}`.replace('0', currentSupplierId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new URLSearchParams({
                    notes: notesInput ? notesInput.value : ''
                })
            })
            .then(resp => resp.json())
            .then(data => {
                currentSupplierId = data.id;
                setDetail(data);
                closeNotesModal();
                showToast('Notes saved successfully!', 'success');
            })
            .catch(() => {
                showToast('Failed to save notes.', 'error');
            })
            .finally(() => {
                setButtonLoading(notesSaveBtn, false);
            });
        });
    }

    function openFilesModal() {
        if (!filesModal || !filesInput) return;
        filesInput.value = (currentDetail && currentDetail.files_url) || '';
        filesModal.classList.remove('hidden');
        filesModal.classList.add('flex');
    }

    function closeFilesModal() {
        if (!filesModal) return;
        filesModal.classList.add('hidden');
        filesModal.classList.remove('flex');
        if (filesSaveBtn) filesSaveBtn.disabled = false;
    }

    [filesCancelBtn, filesCloseBtn].forEach(btn => {
        if (btn) btn.addEventListener('click', closeFilesModal);
    });
    if (editFilesBtn) editFilesBtn.addEventListener('click', openFilesModal);

    if (filesSaveBtn) {
        filesSaveBtn.addEventListener('click', function() {
            if (!currentSupplierId) return;
            setButtonLoading(filesSaveBtn, true);
            fetch(`{% url 'contracts:supplier_update_files' pk=0 %}`.replace('0', currentSupplierId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new URLSearchParams({
                    files_url: filesInput ? filesInput.value : ''
                })
            })
            .then(resp => resp.json())
            .then(data => {
                currentSupplierId = data.id;
                setDetail(data);
                closeFilesModal();
                showToast('Files URL saved successfully!', 'success');
            })
            .catch(() => {
                showToast('Failed to save files URL.', 'error');
            })
            .finally(() => {
                setButtonLoading(filesSaveBtn, false);
            });
        });
    }

    // Simple phone mask for contact phone input
    function formatPhone(value) {
        const digits = (value || '').replace(/\D/g, '').slice(0, 10);
        const parts = [];
        if (digits.length > 0) parts.push('(' + digits.slice(0, Math.min(3, digits.length)));
        if (digits.length >= 4) parts[0] += ') ';
        if (digits.length > 3) parts.push(digits.slice(3, Math.min(6, digits.length)));
        if (digits.length >= 7) parts.push('-' + digits.slice(6, Math.min(10, digits.length)));
        return parts.join('');
    }
    if (contactPhoneInput) {
        contactPhoneInput.addEventListener('input', () => {
            const caretPos = contactPhoneInput.selectionStart;
            const formatted = formatPhone(contactPhoneInput.value);
            contactPhoneInput.value = formatted;
            contactPhoneInput.setSelectionRange(caretPos, caretPos);
        });
    }

    document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.disabled || this.dataset.disabled === 'true') return;
            const field = this.dataset.flag;
            if (!currentSupplierId || !field) return;
            
            // Disable button during request
            this.disabled = true;
            const originalText = this.textContent;
            this.innerHTML = '<div class="spinner spinner-dark" style="width: 12px; height: 12px;"></div>';
            
            fetch(`{% url 'contracts:supplier_toggle_flag' pk=0 %}`.replace('0', currentSupplierId), {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: new URLSearchParams({ field })
            })
            .then(resp => resp.json())
            .then(data => {
                currentSupplierId = data.id;
                setDetail(data);
                document.querySelectorAll('.toggle-btn').forEach(b => {
                    const f = b.dataset.flag;
                    b.classList.toggle('active', data[f] === true);
                });
                const statusText = data[field] ? 'enabled' : 'disabled';
                showToast(`${field.charAt(0).toUpperCase() + field.slice(1)} ${statusText}!`, 'success');
            })
            .catch(() => {
                showToast('Failed to update status.', 'error');
            })
            .finally(() => {
                this.disabled = false;
                this.textContent = originalText;
            });
        });
    });
    } catch (err) {
        console.error('Supplier page init error', err);
        if (window.notify) {
            window.notify('error', `Page error: ${err.message}`, 6000);
        } else {
            alert(`Page error: ${err.message}`);
        }
    }
});
</script>
{% endblock %}
