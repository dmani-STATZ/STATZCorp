<!doctype html>
{% load static tailwind_tags %}
{% load static %}
{% load custom_tags %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    {% if active_company %}
    <meta name="theme-color" content="{{ active_company.get_primary_color }}">
    {% else %}
    <meta name="theme-color" content="#004eb3">
    {% endif %}
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="STATZ">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="{% static 'images/icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'images/icons/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="167x167" href="{% static 'images/icons/icon-152x152.png' %}">
    
    <!-- Microsoft Tile Images -->
    <meta name="msapplication-TileImage" content="{% static 'images/icons/icon-144x144.png' %}">
    <meta name="msapplication-TileColor" content="#004eb3">
    
    <!-- Desktop PWA Support -->
    <meta name="application-name" content="STATZ Corporation">
    <meta name="msapplication-tooltip" content="STATZ Corporation Web Application">
    <meta name="msapplication-starturl" content="/">
    <meta name="msapplication-config" content="none">
    
    <!-- Prevent FOUC (Flash of Unstyled Content) -->
    <style>
        .no-fouc { display: none; }
    </style>
    <script>
        document.documentElement.className = 'no-fouc';
        window.onload = function() {
            document.documentElement.className = '';
        }
    </script>
    
    {% tailwind_css %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'favicon/favicon.ico' %}">

    <!-- CSS Files with environment-aware caching -->
    {% is_development as dev_mode %}
    {% if dev_mode %}
        <!-- Development: Force reload CSS -->
        <link rel="stylesheet" href="{% static 'css/base.css' %}?v={{ cache_version }}-{{ request.id }}">
        <link rel="stylesheet" href="{% static 'css/light-mode.css' %}?v={{ cache_version }}-{{ request.id }}">
        <link rel="stylesheet" href="{% static 'css/dark-mode.css' %}?v={{ cache_version }}-{{ request.id }}">
    {% else %}
        <!-- Production: Normal caching -->
        <link rel="stylesheet" href="{% static 'css/base.css' %}?v={{ cache_version }}">
        <link rel="stylesheet" href="{% static 'css/light-mode.css' %}?v={{ cache_version }}">
        <link rel="stylesheet" href="{% static 'css/dark-mode.css' %}?v={{ cache_version }}">
    {% endif %}

    {% if active_company %}
    <style>
        :root {
            --company-primary: {{ active_company.get_primary_color }};
            --company-secondary: {{ active_company.get_secondary_color }};
        }
    </style>
    {% endif %}

    {% block extra_head %}{% endblock extra_head %}
    {% if title %}
        <title>STATZ Corporation - {{ title }}{% if active_company %} - {{ active_company.name }}{% endif %}</title>
    {% else %}
        <title>STATZ Corporation{% if active_company %} - {{ active_company.name }}{% endif %}</title>
    {% endif %}
</head>
<body class="{% if user_preferences.theme == 'dark' %}dark{% endif %}" {% if active_company %}style="--company-primary: {{ active_company.get_primary_color }}; --company-secondary: {{ active_company.get_secondary_color }};"{% endif %}>
    <header id="header">
        <div class="flex items-center space-x-4">
        <a href="{% url 'landing' %}">
            {% if active_company and active_company.logo_url %}
                <img src="{{ active_company.logo_url }}" alt="{{ active_company.name }} Logo" style="height: 30px;">
            {% else %}
                <img src="{% static 'images/StatzCorpColorFINAL.png' %}" alt="Logo" style="height: 30px;">
            {% endif %}
        </a>
        <!-- Menu Toggle Button -->
        <button onclick="toggleSidebar()" class="text-white p-2 hover:bg-gray-700 rounded-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        {% if user.is_authenticated %}
        <a href="{% url 'users:messages' %}" class="relative">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 hover:text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="unreadMessageCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center {% if not unread_messages_count %}hidden{% endif %}">
                {{ unread_messages_count }}
            </span>
        </a>
        {% endif %}
        <!-- Company Selector -->
        {% if active_company %}
            {% with section=request.resolver_match.app_name %}
            <div class="ml-3 flex items-center bg-white/10 backdrop-blur-sm rounded-full px-3 py-1 text-white text-sm">
                {% if user.is_authenticated and available_companies|length > 1 %}
                <form method="post" action="{% url 'users:switch_company' %}" class="relative flex items-center">
                    {% csrf_token %}
                    <label for="header-company-switcher" class="sr-only">Switch company</label>
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <select name="company_id" id="header-company-switcher" class="appearance-none bg-transparent text-white font-semibold cursor-pointer px-2 pr-6 focus:outline-none focus:ring-2 focus:ring-white/70" onchange="this.form.submit()">
                        {% for c in available_companies %}
                            <option class="bg-white text-blue-800" value="{{ c.id }}" {% if c.id == active_company.id %}selected{% endif %}>{{ c.name }}</option>
                        {% endfor %}
                    </select>
                    <svg class="pointer-events-none absolute right-1 w-4 h-4 text-white/80" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M10 12a1 1 0 01-.707-.293l-3-3a1 1 0 011.414-1.414L10 9.586l2.293-2.293a1 1 0 111.414 1.414l-3 3A1 1 0 0110 12z" clip-rule="evenodd" />
                    </svg>
                </form>
                {% else %}
                <span class="px-2 font-semibold">{{ active_company.name }}</span>
                {% endif %}
            </div>
            {% endwith %}
        {% endif %}

    </div>
        <div class="flex items-center space-x-4">
            <button id="theme-toggle" class="ml-4 p-2 rounded-lg bg-white border border-gray-300 shadow-sm hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:hover:bg-gray-600" title="Toggle dark mode">
                <svg id="theme-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    {% if user_preferences.theme == 'dark' %}
                    <!-- Moon icon for dark mode -->
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    {% else %}
                    <!-- Sun icon for light mode -->
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    {% endif %}
                </svg>
            </button>

            {# company switcher moved near badge #}
            
            {% is_development as dev_mode %}
            {% if dev_mode %}
                &nbsp;&nbsp;<p class="text-yellow-300 mr-4 font-medium">Development Environment</p>
            {% endif %}
            
            <!-- Version Information -->
            <div class="text-xs text-gray-400 mr-4">
                <span title="Full version info: {{ detailed_version }}">{{ display_version }}</span>
                {% if version_info.build_number %}
                <br><span class="text-xs text-gray-500 cursor-pointer" id="build-number">Build: {{ version_info.build_number }}</span>
                {% endif %}
            </div>
            
            {% get_require_login as require_login %}
            {% if require_login %}
                {% if user.is_authenticated %}
                    <div class="flex flex-col md:flex-row md:ml-auto items-center gap-2">
                        {% if user.is_superuser %}
                        <a href="{% url 'admin:index' %}" class="nav-item nav-link text-white px-3 py-2">Welcome, {{ user.first_name }}</a>
                        {% else %}
                        <a href="{% url 'users:profile' %}" class="nav-item nav-link text-white px-3 py-2">Welcome, {{ user.first_name }}</a>
                        {% endif %}
                        <button id="settings-trigger" type="button" aria-haspopup="dialog" aria-expanded="false" aria-controls="user-settings-panel" class="flex items-center justify-center w-10 h-10 rounded-full border border-white/30 bg-white/10 text-white shadow-sm hover:bg-white/20 focus:outline-none focus:ring-2 focus:ring-white/70 transition-all duration-200">
                            <span class="sr-only">Open settings</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M9.594 3.094c.55-1.902 3.262-1.902 3.812 0a1.724 1.724 0 002.573 1.02c1.643-.947 3.434.844 2.487 2.487a1.724 1.724 0 001.02 2.573c1.902.55 1.902 3.262 0 3.812a1.724 1.724 0 00-1.02 2.573c.947 1.643-.844 3.434-2.487 2.487a1.724 1.724 0 00-2.573 1.02c-.55 1.902-3.262 1.902-3.812 0a1.724 1.724 0 00-2.573-1.02c-1.643.947-3.434-.844-2.487-2.487a1.724 1.724 0 00-1.02-2.573c-1.902-.55-1.902-3.262 0-3.812a1.724 1.724 0 001.02-2.573C3.553 4.958 5.344 3.167 6.987 4.114a1.724 1.724 0 002.573-1.02z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                        </button>
                    </div>
                {% else %}
                    <div class="flex flex-col md:flex-row md:ml-auto">
                        <a class="nav-link text-white hover:text-gray-200 px-3 py-2 rounded-md" href="{% url 'users:login' %}">Sign In</a>
                        <a class="nav-link text-white hover:text-gray-200 px-3 py-2 rounded-md" href="{% url 'users:register' %}">Sign Up</a>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </header>

    <!-- Sidebar Menu -->
    <div class="sidebar inactive" id="sidebar">
        <img src="{% static 'images/StatzCorpColorFINAL.png' %}" alt="STATZ Corp" class="h-12 w-18 m-8">
        <div class="px-4 pb-8">
            <ul class="mt-10 space-y-1">
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'index' %}" class="px-3 py-2 rounded-md text-sm font-medium">Home</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'about' %}" class="px-3 py-2 rounded-md text-sm font-medium">About</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'training:dashboard' %}" class="px-3 py-2 rounded-md text-sm font-medium">Training</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'inventory:dashboard' %}" class="px-3 py-2 rounded-md text-sm font-medium">Inventory</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'contracts:contracts_dashboard' %}" class="px-3 py-2 rounded-md text-sm font-medium">Contracts</a>
                </li>
                {% if user.is_authenticated and user.is_superuser %}
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'contracts:company_list' %}" class="px-3 py-2 rounded-md text-sm font-medium">Companies</a>
                </li>
                {% endif %}
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'reports:my_requests' %}" class="px-3 py-2 rounded-md text-sm font-medium">Reports</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'contracts:folder_tracking' %}" class="px-3 py-2 rounded-md text-sm font-medium">Folder Tracking</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="https://www.salespatriot.com/" class="px-3 py-2 rounded-md text-sm font-medium">Sales Patriot</a>
                </li>
            </ul>
        </div>
    </div>

    <div class="content flex-1 inactive" id="content">
        {% if messages %}
        <div class="container mx-auto px-4 py-2">
            {% for message in messages %}
                {% if 'error' in message.tags %}
                    <div class="mb-2 px-3 py-2 rounded bg-red-600 text-white">{{ message }}</div>
                {% elif 'warning' in message.tags %}
                    <div class="mb-2 px-3 py-2 rounded bg-yellow-500 text-black">{{ message }}</div>
                {% elif 'success' in message.tags %}
                    <div class="mb-2 px-3 py-2 rounded bg-green-600 text-white">{{ message }}</div>
                {% else %}
                    <div class="mb-2 px-3 py-2 rounded bg-blue-600 text-white">{{ message }}</div>
                {% endif %}
            {% endfor %}
        </div>
        {% endif %}
        {% block body %}{% endblock body %}
        {% block extra_scripts %}{% endblock extra_scripts %}
    </div>
    {% if user.is_authenticated %}
    <div id="user-settings-overlay" class="settings-overlay" aria-hidden="true">
        <div id="user-settings-panel" class="settings-panel" role="dialog" aria-modal="true" aria-labelledby="settings-title" tabindex="-1">
            <div class="settings-header">
                <div>
                    <p class="settings-kicker">Workspace</p>
                    <h2 id="settings-title" class="settings-title">Settings</h2>
                </div>
                <div class="settings-actions">
                    <form id="settings-logout-form" method="post" action="{% url 'users:logout' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="settings-chip settings-chip-ghost">Sign Out</button>
                    </form>
                    <button type="button" class="settings-icon-btn" data-close-settings aria-label="Close settings panel">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="settings-grid">
                <div class="settings-row">
                    <div>
                        <p class="settings-label">Dashboard</p>
                        <p class="settings-help">Pick the layout you want to see first.</p>
                    </div>
                    <div class="settings-toggle" data-setting="dashboard_view">
                        <button type="button" class="settings-chip" data-value="table" aria-pressed="false">Table</button>
                        <button type="button" class="settings-chip" data-value="card" aria-pressed="false">Card</button>
                    </div>
                </div>
                <div class="settings-row">
                    <div>
                        <p class="settings-label">Dark Mode</p>
                        <p class="settings-help">Switch the theme across STATZ.</p>
                    </div>
                    <div class="settings-toggle" data-setting="theme">
                        <button type="button" class="settings-chip" data-value="light" aria-pressed="false">Off</button>
                        <button type="button" class="settings-chip" data-value="dark" aria-pressed="false">On</button>
                    </div>
                </div>
                {% if available_companies %}
                <div class="settings-row">
                    <div>
                        <p class="settings-label">Default Company</p>
                        <p class="settings-help">Set the context we load by default.</p>
                    </div>
                    <form id="settings-company-form" method="post" action="{% url 'users:switch_company' %}" class="settings-select-wrapper">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <label for="settings-company-select" class="sr-only">Choose company</label>
                        <select name="company_id" id="settings-company-select" class="settings-select" {% if available_companies|length <= 1 %}disabled{% endif %}>
                            {% for c in available_companies %}
                                <option value="{{ c.id }}" {% if active_company and c.id == active_company.id %}selected{% endif %}>{{ c.name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
                {% endif %}
                {% if user.is_superuser %}
                <div class="settings-divider"></div>
                <div class="settings-row">
                    <div>
                        <p class="settings-label">Admin</p>
                        <p class="settings-help">Launch the console in a new view.</p>
                    </div>
                    <a href="{% url 'admin:index' %}" class="settings-chip settings-chip-outline">Admin Console</a>
                </div>
                <div class="settings-row">
                    <div>
                        <p class="settings-label">OpenRouter Model</p>
                        <p class="settings-help">Set the default model used by the Reports AI panel.</p>
                    </div>
                    <div class="flex flex-col gap-2 w-full">
                        <input id="settings-ai-model" type="text" class="settings-select" value="{{ user_preferences.reports_ai_model|default:ai_model_default }}">
                        <small class="settings-help">Any OpenRouter model id (e.g. gpt-4o-mini, qwen/qwen-2.5-32b-instruct).</small>
                        <input id="settings-ai-fallbacks" type="text" class="settings-select" placeholder="Fallback models, comma separated" value="{{ user_preferences.reports_ai_fallbacks|default:ai_fallback_default }}">
                        <form id="settings-ai-form" method="post" action="{% url 'reports:admin_save_ai_settings' %}">
                            {% csrf_token %}
                            <input type="hidden" name="model" id="settings-ai-model-field">
                            <input type="hidden" name="fallbacks" id="settings-ai-fallbacks-field">
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" id="settings-ai-save" class="settings-chip settings-chip-outline">Save Model Defaults</button>
                            <span id="settings-ai-status" class="settings-help ml-2"></span>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar').classList.toggle('inactive');
            document.getElementById('content').classList.toggle('active');
            document.getElementById('content').classList.toggle('inactive');
        }
    </script>

    <!-- PWA Service Worker Registration - Development Mode Aware -->
    <script>
        {% is_development as dev_mode %}
        if ({{ dev_mode|yesno:"true,false" }}) {
            // Development mode - aggressively unregister any existing service workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                        console.log('Development mode: Unregistered service worker:', registration.scope);
                    }
                });
                console.log('PWA Service Worker disabled in development mode');
            }
        } else {
            // Production mode - register service worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js', {
                        scope: '/',
                        updateViaCache: 'none'
                    })
                    .then(reg => {
                        console.log('Service worker registered successfully. Scope:', reg.scope);
                    })
                    .catch(err => {
                        console.error('Service worker registration failed:', err);
                        console.error('Error details:', {
                            message: err.message,
                            fileName: err.fileName,
                            lineNumber: err.lineNumber
                        });
                    });
                });
            }
        }
    </script>
    <script src="{% static 'js/theme_toggle.js' %}"></script>
    <script>
        // Secret entry: click the build number 5 times to open TD Now
        (function(){
            const el = document.getElementById('build-number');
            if (!el) return;
            let clicks = 0;
            let timer = null;
            el.addEventListener('click', function(){
                clicks += 1;
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => { clicks = 0; }, 4000);
                if (clicks >= 5) {
                    window.location.href = '/td-now/';
                }
            });
        })();
    </script>
    {% if user.is_authenticated %}
    <script>
        window.CURRENT_USER_ID = "{{ user.id }}";
    </script>
    <script>
        (function(){
            const trigger = document.getElementById('settings-trigger');
            const overlay = document.getElementById('user-settings-overlay');
            const panel = document.getElementById('user-settings-panel');
            const dashboardGroup = document.querySelector('[data-setting="dashboard_view"]');
            const themeGroup = document.querySelector('[data-setting="theme"]');
            const themeToggleButton = document.getElementById('theme-toggle');
            const companySelect = document.getElementById('settings-company-select');
            const closeButtons = overlay ? overlay.querySelectorAll('[data-close-settings]') : [];
            const csrfToken = (typeof getCookie === 'function') ? getCookie('csrftoken') : null;
            const normalizeSetting = (value, fallback) => {
                const clean = (value || '').toString().trim().toLowerCase();
                if (!clean || clean === 'none') return fallback;
                return clean;
            };
            const state = {
                dashboard_view: normalizeSetting("{{ user_preferences.dashboard_view|default:'table' }}", 'table'),
                theme: document.body.classList.contains('dark') ? 'dark' : 'light'
            };

            function setActive(group, value) {
                if (!group) return;
                group.querySelectorAll('[data-value]').forEach(btn => {
                    const isActive = btn.dataset.value === value;
                    btn.classList.toggle('is-active', isActive);
                    btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                });
            }

            setActive(dashboardGroup, state.dashboard_view);
            setActive(themeGroup, state.theme === 'dark' ? 'dark' : 'light');

            function openSettings() {
                if (!overlay) return;
                overlay.classList.add('active');
                overlay.setAttribute('aria-hidden', 'false');
                trigger?.setAttribute('aria-expanded', 'true');
                setActive(dashboardGroup, state.dashboard_view);
                setActive(themeGroup, state.theme === 'dark' ? 'dark' : 'light');
                panel?.focus({ preventScroll: true });
            }

            function closeSettings() {
                if (!overlay) return;
                overlay.classList.remove('active');
                overlay.setAttribute('aria-hidden', 'true');
                trigger?.setAttribute('aria-expanded', 'false');
                trigger?.focus({ preventScroll: true });
            }

            const saveSetting = (name, value, type = 'string') => {
                if (!csrfToken) return Promise.resolve();
                return fetch("{% url 'users:settings-save' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        user_id: "{{ user.id }}",
                        setting_name: name,
                        setting_value: value,
                        setting_type: type
                    })
                }).catch(() => ({}));
            };

            trigger?.addEventListener('click', openSettings);
            closeButtons.forEach(btn => btn.addEventListener('click', closeSettings));
            overlay?.addEventListener('click', (event) => {
                if (event.target === overlay) {
                    closeSettings();
                }
            });
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && overlay?.classList.contains('active')) {
                    closeSettings();
                }
            });

            dashboardGroup?.addEventListener('click', (event) => {
                const btn = event.target.closest('[data-value]');
                if (!btn) return;
                const value = btn.dataset.value;
                state.dashboard_view = value;
                setActive(dashboardGroup, value);
                saveSetting('dashboard_view', value);
            });

            themeGroup?.addEventListener('click', (event) => {
                const btn = event.target.closest('[data-value]');
                if (!btn) return;
                const value = btn.dataset.value;
                state.theme = value;
                setActive(themeGroup, value);
                const wantsDark = value === 'dark';
                const isDark = document.body.classList.contains('dark');
                if (wantsDark !== isDark) {
                    themeToggleButton?.click();
                }
            });

            companySelect?.addEventListener('change', () => {
                companySelect.classList.add('pending');
                companySelect.form?.submit();
            });

            const aiModelInput = document.getElementById('settings-ai-model');
            const aiFallbackInput = document.getElementById('settings-ai-fallbacks');
            const aiForm = document.getElementById('settings-ai-form');
            const aiStatus = document.getElementById('settings-ai-status');
            const aiModelField = document.getElementById('settings-ai-model-field');
            const aiFallbackField = document.getElementById('settings-ai-fallbacks-field');
            if (aiForm && aiModelInput && aiFallbackInput && aiModelField && aiFallbackField) {
                aiForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const modelVal = (aiModelInput.value || '').trim();
                    const fallbackVal = (aiFallbackInput.value || '').trim();
                    aiModelField.value = modelVal;
                    aiFallbackField.value = fallbackVal;
                    if (!csrfToken) { aiForm.submit(); return; }
                    aiStatus.textContent = 'Saving...';
                    try {
                        const resp = await fetch(aiForm.action, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken,
                                'X-Requested-With': 'XMLHttpRequest',
                            },
                            body: JSON.stringify({ model: modelVal, fallbacks: fallbackVal })
                        });
                        if (resp.ok) {
                            aiStatus.textContent = 'Saved';
                            setTimeout(() => { aiStatus.textContent = ''; }, 2000);
                        } else {
                            aiStatus.textContent = 'Error saving';
                            setTimeout(() => { aiStatus.textContent = ''; }, 3000);
                        }
                    } catch (e) {
                        aiStatus.textContent = 'Error saving';
                        setTimeout(() => { aiStatus.textContent = ''; }, 3000);
                    }
                });
            }
        })();
    </script>
    {% endif %}
    <div id="toast-root" class="toast" aria-live="polite" aria-atomic="true"></div>
    <script>
    (function() {
        const DEFAULT_DURATION = 3500;

        function ensureToastRoot() {
            let root = document.getElementById('toast-root');
            if (!root) {
                root = document.createElement('div');
                root.id = 'toast-root';
                root.className = 'toast';
                document.body.appendChild(root);
            }
            return root;
        }

        function normalizeType(type) {
            const t = (type || '').toLowerCase();
            if (['success', 'error', 'warning', 'info'].includes(t)) {
                return t;
            }
            return 'info';
        }

        function notify(type, message, duration) {
            const root = ensureToastRoot();
            const item = document.createElement('div');
            const resolvedType = normalizeType(type);
            item.className = 'toast-item';
            item.classList.add(resolvedType);
            item.textContent = message;
            root.appendChild(item);
            requestAnimationFrame(() => item.classList.add('show'));

            const timeout = Number.isFinite(duration) ? duration : DEFAULT_DURATION;
            setTimeout(() => {
                item.classList.remove('show');
                setTimeout(() => item.remove(), 300);
            }, timeout);
        }

        window.notify = notify;
        window.showToast = notify;
        window.Toastify = function(opts) {
            return {
                showToast: function() {
                    const text = (opts && (opts.text || opts.message)) || '';
                    const cls = (opts && opts.className) || '';
                    const bg = (opts && opts.backgroundColor) || '';
                    const duration = (opts && (opts.duration || opts.timeOut)) || DEFAULT_DURATION;
                    const type = cls.includes('error') || bg.includes('f44336') ? 'error'
                        : cls.includes('success') || bg.includes('4CAF50') ? 'success'
                        : cls.includes('warning') ? 'warning'
                        : 'info';
                    notify(type, text, duration);
                }
            };
        };
    })();
    </script>
    {% block extra_js %}
    <script>
    function updateUnreadMessageCount() {
        fetch('/users/messages/unread-count/')
        .then(response => response.json())
        .then(data => {
            const countElement = document.querySelector('#unreadMessageCount');
            if (countElement) {
                countElement.textContent = data.count;
                if (data.count > 0) {
                    countElement.classList.remove('hidden');
                } else {
                    countElement.classList.add('hidden');
                }
            }
        });
    }

    // Update count every minute
    setInterval(updateUnreadMessageCount, 60000);

    // Initial update
    updateUnreadMessageCount();
    </script>
    {% endblock %}
</body>
</html> 








