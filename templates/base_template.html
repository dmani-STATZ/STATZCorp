<!doctype html>
{% load static tailwind_tags %}
{% load static %}
{% load custom_tags %}

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#004eb3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="STATZ">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="{% static 'images/icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'images/icons/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'images/icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="167x167" href="{% static 'images/icons/icon-152x152.png' %}">
    
    <!-- Microsoft Tile Images -->
    <meta name="msapplication-TileImage" content="{% static 'images/icons/icon-144x144.png' %}">
    <meta name="msapplication-TileColor" content="#004eb3">
    
    <!-- Desktop PWA Support -->
    <meta name="application-name" content="STATZ Corporation">
    <meta name="msapplication-tooltip" content="STATZ Corporation Web Application">
    <meta name="msapplication-starturl" content="/">
    <meta name="msapplication-config" content="none">
    
    <!-- Prevent FOUC (Flash of Unstyled Content) -->
    <style>
        .no-fouc { display: none; }
    </style>
    <script>
        document.documentElement.className = 'no-fouc';
        window.onload = function() {
            document.documentElement.className = '';
        }
    </script>
    
    {% tailwind_css %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="shortcut icon" type="image/x-icon" href="{% static 'favicon/favicon.ico' %}">
    
    <!-- CSS Files with environment-aware caching -->
    {% is_development as dev_mode %}
    {% if dev_mode %}
        <!-- Development: Force reload CSS -->
        <link rel="stylesheet" href="{% static 'css/base.css' %}?v={{ cache_version }}-{{ request.id }}">
        <link rel="stylesheet" href="{% static 'css/light-mode.css' %}?v={{ cache_version }}-{{ request.id }}">
        <link rel="stylesheet" href="{% static 'css/dark-mode.css' %}?v={{ cache_version }}-{{ request.id }}">
    {% else %}
        <!-- Production: Normal caching -->
        <link rel="stylesheet" href="{% static 'css/base.css' %}?v={{ cache_version }}">
        <link rel="stylesheet" href="{% static 'css/light-mode.css' %}?v={{ cache_version }}">
        <link rel="stylesheet" href="{% static 'css/dark-mode.css' %}?v={{ cache_version }}">
    {% endif %}
    
    {% block extra_head %}{% endblock extra_head %}
    {% if title %}
        <title>STATZ Corporation - {{ title }}</title>
    {% else %}
        <title>STATZ Corporation</title>
    {% endif %}
</head>
<body class="{% if user_preferences.theme == 'dark' %}dark{% endif %}">
    <header id="header">
        <div class="flex items-center space-x-4">
        <a href="{% url 'landing' %}"><img src="{% static 'images/StatzCorpColorFINAL.png' %}" alt="Logo" style="height: 30px;"></a>
        <!-- Menu Toggle Button -->
        <button onclick="toggleSidebar()" class="text-white p-2 hover:bg-gray-700 rounded-md">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        </button>
        {% if user.is_authenticated %}
        <a href="{% url 'users:messages' %}" class="relative">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 hover:text-gray-800" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
            </svg>
            <span id="unreadMessageCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center {% if not unread_messages_count %}hidden{% endif %}">
                {{ unread_messages_count }}
            </span>
        </a>
        {% endif %}
    </div>
        <div class="flex items-center space-x-4">
            <button id="theme-toggle" class="ml-4 p-2 rounded-lg bg-white border border-gray-300 shadow-sm hover:bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:hover:bg-gray-600" title="Toggle dark mode">
                <svg id="theme-toggle-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-800 dark:text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    {% if user_preferences.theme == 'dark' %}
                    <!-- Moon icon for dark mode -->
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    {% else %}
                    <!-- Sun icon for light mode -->
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    {% endif %}
                </svg>
            </button>
            
            {% is_development as dev_mode %}
            {% if dev_mode %}
                &nbsp;&nbsp;<p class="text-yellow-300 mr-4 font-medium">Development Environment</p>
            {% endif %}
            
            {% get_require_login as require_login %}
            {% if require_login %}
                {% if user.is_authenticated %}
                    <div class="flex flex-col md:flex-row md:ml-auto">
                        {% if user.is_superuser %}
                        <a href="{% url 'admin:index' %}" class="nav-item nav-link text-white px-3 py-2">Welcome, {{ user.first_name }}</a>
                    {% else %}
                        <a href="#" class="nav-item nav-link text-white px-3 py-2">Welcome, {{ user.first_name }}</a>
                    {% endif %}
                    
                    <form id="logout-form" method="post" action="{% url 'users:logout' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="nav-link text-white hover:text-gray-200 px-3 py-2 rounded-md">Sign Out</button>
                    </form>
                    </div>
                {% else %}
                    <div class="flex flex-col md:flex-row md:ml-auto">
                        <a class="nav-link text-white hover:text-gray-200 px-3 py-2 rounded-md" href="{% url 'users:login' %}">Sign In</a>
                        <a class="nav-link text-white hover:text-gray-200 px-3 py-2 rounded-md" href="{% url 'users:register' %}">Sign Up</a>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </header>

    <!-- Sidebar Menu -->
    <div class="sidebar inactive" id="sidebar">
        <img src="{% static 'images/StatzCorpColorFINAL.png' %}" alt="STATZ Corp" class="h-12 w-18 m-8">
        <div class="px-4 pb-8">
            <ul class="mt-10 space-y-1">
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'index' %}" class="px-3 py-2 rounded-md text-sm font-medium">Home</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'about' %}" class="px-3 py-2 rounded-md text-sm font-medium">About</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'training:dashboard' %}" class="px-3 py-2 rounded-md text-sm font-medium">Training</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'inventory:dashboard' %}" class="px-3 py-2 rounded-md text-sm font-medium">Inventory</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'contracts:contracts_dashboard' %}" class="px-3 py-2 rounded-md text-sm font-medium">Contracts</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'reports:user-reports' %}" class="px-3 py-2 rounded-md text-sm font-medium">Reports</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="{% url 'contracts:folder_tracking' %}" class="px-3 py-2 rounded-md text-sm font-medium">Folder Tracking</a>
                </li>
                <li class="py-3 px-6 hover:text-green-700 cursor-pointer overflow-hidden">
                    <a href="https://www.salespatriot.com/" class="px-3 py-2 rounded-md text-sm font-medium">Sales Patriot</a>
                </li>
            </ul>
        </div>
    </div>

    <div class="content flex-1 inactive" id="content">
        {% block body %}{% endblock body %}
        {% block extra_scripts %}{% endblock extra_scripts %}
    </div>

    <script>
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar').classList.toggle('inactive');
            document.getElementById('content').classList.toggle('active');
            document.getElementById('content').classList.toggle('inactive');
        }
    </script>

    <!-- PWA Service Worker Registration - Development Mode Aware -->
    <script>
        {% is_development as dev_mode %}
        if ({{ dev_mode|yesno:"true,false" }}) {
            // Development mode - aggressively unregister any existing service workers
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                        console.log('Development mode: Unregistered service worker:', registration.scope);
                    }
                });
                console.log('PWA Service Worker disabled in development mode');
            }
        } else {
            // Production mode - register service worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js', {
                        scope: '/',
                        updateViaCache: 'none'
                    })
                    .then(reg => {
                        console.log('Service worker registered successfully. Scope:', reg.scope);
                    })
                    .catch(err => {
                        console.error('Service worker registration failed:', err);
                        console.error('Error details:', {
                            message: err.message,
                            fileName: err.fileName,
                            lineNumber: err.lineNumber
                        });
                    });
                });
            }
        }
    </script>
    <script src="{% static 'js/theme_toggle.js' %}"></script>
    {% if user.is_authenticated %}
    <script>
        window.CURRENT_USER_ID = "{{ user.id }}";
    </script>
    {% endif %}
    {% block extra_js %}
    <script>
    function updateUnreadMessageCount() {
        fetch('/users/messages/unread-count/')
        .then(response => response.json())
        .then(data => {
            const countElement = document.querySelector('#unreadMessageCount');
            if (countElement) {
                countElement.textContent = data.count;
                if (data.count > 0) {
                    countElement.classList.remove('hidden');
                } else {
                    countElement.classList.add('hidden');
                }
            }
        });
    }

    // Update count every minute
    setInterval(updateUnreadMessageCount, 60000);

    // Initial update
    updateUnreadMessageCount();
    </script>
    {% endblock %}
</body>
</html> 