{% extends 'base_template.html' %}

{% block body %}
<div class="bg-white rounded-lg p-6 dark:bg-gray-800 dark:text-gray-100">
    <h1 class="text-2xl font-semibold mb-6">Welcome to STATZ Corporation Portal</h1>
    
    <div class="mb-4 flex justify-between items-center">
        <h2 class="text-xl font-medium text-gray-800">Resources</h2>
        {% if user.is_superuser %}
        <button onclick="toggleNewSection()" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
            New Section
        </button>
        {% endif %}
    </div>

    {% if user.is_superuser %}
    <div id="newSectionForm" class="hidden mb-6 p-4 border rounded-lg bg-gray-50">
        <form onsubmit="return addSection(event)">
            {% csrf_token %}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm text-gray-600">Title</label>
                    <input name="title" class="w-full border rounded p-2" required />
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm text-gray-600">Description</label>
                    <input name="description" class="w-full border rounded p-2" />
                </div>
            </div>
            <div class="mt-3 flex gap-2">
                <button type="submit" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700">Create</button>
                <button type="button" onclick="toggleNewSection(false)" class="px-3 py-1 text-sm bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
            </div>
        </form>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="portalSections">
        {% for section in portal_context.sections %}
        <div class="p-4 border rounded-lg hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800">{{ section.title }}</h3>
                    {% if section.description %}
                    <p class="text-sm text-gray-600 mt-1">{{ section.description }}</p>
                    {% endif %}
                </div>
                <div class="flex gap-2">
                    {% if user.is_superuser %}
                    <button title="Delete Section" onclick="deleteSection({{ section.id }})" class="text-red-600 hover:text-red-800">
                        &#128465;
                    </button>
                    {% endif %}
                </div>
            </div>

            <ul class="space-y-2 mt-4">
                {% if section.resources %}
                    {% for res in section.resources %}
                    <li class="flex items-center justify-between">
                        <a href="{{ res.url }}" target="_blank" class="text-blue-600 hover:text-blue-800 flex-1">
                            {{ res.title }}
                        </a>
                        {% if section.can_edit and user.is_superuser %}
                        <button title="Remove" onclick="deleteResource({{ res.id }})" class="ml-2 text-xs text-red-600 hover:text-red-800">Remove</button>
                        {% endif %}
                    </li>
                    {% endfor %}
                {% else %}
                    <li class="text-sm text-gray-500">No resources yet.</li>
                {% endif %}
            </ul>

            {% if section.can_edit %}
            {% if user.is_superuser %}
            <div class="mt-4 border-t pt-3">
                <details>
                    <summary class="cursor-pointer text-sm text-gray-700 hover:text-gray-900">Add Link here</summary>
                    <form class="mt-2" onsubmit="return addLink(event, {{ section.id }})">
                        {% csrf_token %}
                        <input type="hidden" name="section" value="{{ section.id }}" />
                        <input type="hidden" name="resource_type" value="link" />
                        <div class="grid grid-cols-1 gap-2">
                            <input name="title" placeholder="Link title" class="border rounded p-2" required />
                            <input name="external_url" placeholder="https://example.com or mailto:support@example.com?subject=Hello" class="border rounded p-2" type="text" required />
                        </div>
                        <div class="mt-2">
                            <button type="submit" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">Add Link this</button>
                        </div>
                    </form>
                </details>
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Announcements Section -->
    <div class="mt-8 p-4 border rounded-lg">
        <h2 class="text-xl font-medium mb-4 text-gray-800">Recent Announcements</h2>
        <div class="space-y-4">
            {% for announcement in announcements %}
            <div class="p-3 bg-blue-50 rounded">
                <p class="text-blue-800">{{ announcement.content }}</p>
                <span class="text-sm text-blue-600">
                    Posted by: {{ announcement.posted_by.username }} on {{ announcement.posted_at|date:"F j, Y, g:i a" }}
                </span>
                {% if perms.users.delete_announcement %}
                <form method="post" action="{% url 'delete_announcement' announcement.id %}">
                    {% csrf_token %}
                    <button type="submit" class="text-red-600 hover:text-red-800">Delete</button>
                </form>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% if perms.users.add_announcement %}
        <button onclick="showAddAnnouncementModal()" 
                class="mt-4 text-blue-600 hover:text-blue-800">
            Add Announcement
        </button>
        {% endif %}
    </div>

</div>
{% endblock body %}

{% block extra_scripts %}
<script>

    // Function to show modal
    function showAddAnnouncementModal() {
        const modal = document.getElementById('addAnnouncementModal');
        modal.classList.remove('hidden');
    }

    // Function to hide modal
    function hideAddAnnouncementModal() {
        const modal = document.getElementById('addAnnouncementModal');
        modal.classList.add('hidden');
    }

    // Function to submit announcement
    async function submitAnnouncement(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        try {
            const response = await fetch("{% url 'add_announcement' %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (response.ok) {
                window.location.reload();
            } else {
                let msg = 'Failed to post announcement.';
                try {
                    const data = await response.json();
                    if (data && (data.error || data.errors)) {
                        msg = (data.error || JSON.stringify(data.errors));
                    }
                } catch(_) {}
                alert(msg);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Unexpected error posting announcement.');
        }
    }

    // Toggle New Section form
    function toggleNewSection(forceState) {
        const el = document.getElementById('newSectionForm');
        if (!el) return;
        if (typeof forceState === 'boolean') {
            el.classList.toggle('hidden', !forceState);
        } else {
            el.classList.toggle('hidden');
        }
    }

    // Create a new section (admin only)
    async function addSection(event) {
        event.preventDefault();
        const form = event.target;
        const title = form.querySelector('[name="title"]').value.trim();
        const description = form.querySelector('[name="description"]').value.trim();
        if (!title) return false;
        try {
            const resp = await fetch("{% url 'users:portal_sections_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ title, description })
            });
            if (resp.ok) {
                window.location.reload();
            } else {
                console.error('Failed to create section');
            }
        } catch (e) {
            console.error(e);
        }
        return false;
    }

    // Delete a section (admin only)
    async function deleteSection(sectionId) {
        if (!confirm('Delete this section and all of its resources?')) return;
        try {
            const resp = await fetch(`{% url 'users:portal_section_delete' 0 %}`.replace('/0/', `/${sectionId}/`), {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            if (resp.ok) {
                window.location.reload();
            } else {
                console.error('Failed to delete section');
            }
        } catch (e) {
            console.error(e);
        }
    }

    // Add a link resource to a section
    async function addLink(event, sectionId) {
        event.preventDefault();
        const form = event.target;
        const fd = new FormData(form);
        fd.set('section', sectionId);
        fd.set('resource_type', 'link');
        // Light normalization for mailto: subjects with spaces
        const rawUrl = fd.get('external_url');
        if (rawUrl && typeof rawUrl === 'string' && rawUrl.startsWith('mailto:')) {
            fd.set('external_url', rawUrl.replace(/\s/g, '%20'));
        }
        try {
            const resp = await fetch("{% url 'users:portal_resource_upsert' %}", {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                body: fd
            });
            if (resp.ok) {
                window.location.reload();
            } else {
                let msg = 'Failed to add link.';
                try {
                    const data = await resp.json();
                    if (data && (data.error || data.errors)) {
                        msg = data.error || JSON.stringify(data.errors);
                    }
                } catch(_) {}
                alert(msg);
            }
        } catch (e) {
            console.error(e);
            alert('Unexpected error adding link.');
        }
        return false;
    }

    // Delete a resource
    async function deleteResource(resourceId) {
        if (!confirm('Remove this resource?')) return;
        try {
            const resp = await fetch(`{% url 'users:portal_resource_delete' 0 %}`.replace('/0/', `/${resourceId}/`), {
                method: 'POST',
                headers: { 'X-CSRFToken': '{{ csrf_token }}' }
            });
            if (resp.ok) {
                window.location.reload();
            } else {
                console.error('Failed to delete resource');
            }
        } catch (e) {
            console.error(e);
        }
    }
</script>

<!-- Modal Template -->
<div id="addAnnouncementModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Add New Announcement</h3>
            <form onsubmit="submitAnnouncement(event)" class="mt-4">
                {% csrf_token %}
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="title">
                        Title
                    </label>
                    <input name="title" 
                           class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                           type="text" required />
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="content">
                        Announcement Content
                    </label>
                    <textarea name="content" 
                              class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                              rows="4"
                              required></textarea>
                </div>
                <div class="mt-4 flex justify-end space-x-3">
                    <button type="button" 
                            onclick="hideAddAnnouncementModal()"
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Post Announcement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const unreadCount = {{ unread_messages_count }};
    if (unreadCount > 0) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
                <h2 class="text-2xl font-bold mb-4">Unread System Messages</h2>
                <p class="mb-6">You have ${unreadCount} unread system message${unreadCount > 1 ? 's' : ''}.</p>
                <div class="flex justify-end space-x-4">
                    <button id="cancelBtn" class="px-4 py-2 text-gray-600 hover:text-gray-800 ${unreadCount >= 5 ? 'hidden' : ''}" onclick="closeModal()">
                        Cancel
                    </button>
                    <a href="{% url 'users:messages' %}" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                        Read Messages
                    </a>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
});

function closeModal() {
    const modal = document.querySelector('.fixed');
    if (modal) {
        modal.remove();
    }
}
</script>
{% endblock %}
