{% extends "contracts/contract_base.html" %}
{% load static %}

{% block title %}DD Form 1155 Extraction Test{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-6">DD Form 1155 Extraction Test</h1>
    
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Upload DD Form 1155</h2>
        
        <form id="uploadForm" class="space-y-4">
            <div class="flex flex-col">
                <label for="dd1155_file" class="mb-2 font-medium text-gray-700">Select DD Form 1155 PDF</label>
                <input type="file" id="dd1155_file" name="dd1155_file" accept=".pdf" 
                       class="border border-gray-300 rounded-md p-2">
            </div>
            
            <div>
                <button type="submit" id="extractBtn" 
                        class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition">
                    Extract Data
                </button>
            </div>
        </form>
        
        <div id="statusMessage" class="mt-4 hidden"></div>
    </div>
    
    <div id="resultsContainer" class="bg-white shadow-md rounded-lg p-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Extraction Results</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="space-y-2">
                <div class="font-medium">Contract Number:</div>
                <div id="contract_number" class="bg-gray-100 p-2 rounded"></div>
            </div>
            
            <div class="space-y-2">
                <div class="font-medium">PO Number:</div>
                <div id="po_number" class="bg-gray-100 p-2 rounded"></div>
            </div>
            
            <div class="space-y-2">
                <div class="font-medium">Award Date:</div>
                <div id="award_date" class="bg-gray-100 p-2 rounded"></div>
            </div>
            
            <div class="space-y-2">
                <div class="font-medium">Due Date:</div>
                <div id="due_date" class="bg-gray-100 p-2 rounded"></div>
            </div>
            
            <div class="space-y-2">
                <div class="font-medium">Contract Type:</div>
                <div id="contract_type" class="bg-gray-100 p-2 rounded"></div>
            </div>
            
            <div class="space-y-2">
                <div class="font-medium">Buyer:</div>
                <div id="buyer" class="bg-gray-100 p-2 rounded"></div>
            </div>
            
            <div class="space-y-2">
                <div class="font-medium">Contract Amount:</div>
                <div id="contract_amount" class="bg-gray-100 p-2 rounded"></div>
            </div>
        </div>
        
        <div class="mb-6">
            <h3 class="text-lg font-medium mb-2">Coordinate Results</h3>
            <div id="coordinate_results" class="bg-gray-100 p-4 rounded overflow-auto max-h-60 font-mono text-sm"></div>
        </div>
        
        <div>
            <h3 class="text-lg font-medium mb-2">Raw Text</h3>
            <div id="raw_text" class="bg-gray-100 p-4 rounded overflow-auto max-h-60 font-mono text-sm whitespace-pre-wrap"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadForm = document.getElementById('uploadForm');
    const statusMessage = document.getElementById('statusMessage');
    const resultsContainer = document.getElementById('resultsContainer');
    
    uploadForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('dd1155_file');
        if (!fileInput.files.length) {
            showStatus('Please select a PDF file.', 'error');
            return;
        }
        
        const file = fileInput.files[0];
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            showStatus('Please select a PDF file.', 'error');
            return;
        }
        
        showStatus('Extracting data from DD Form 1155...', 'info');
        
        const formData = new FormData();
        formData.append('dd1155_file', file);
        
        fetch('/contracts/extract-dd1155/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showStatus('Data extracted successfully!', 'success');
                displayResults(data);
            } else {
                showStatus('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showStatus('Error: ' + error.message, 'error');
        });
    });
    
    function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = 'mt-4 p-3 rounded';
        
        if (type === 'error') {
            statusMessage.classList.add('bg-red-100', 'text-red-700');
        } else if (type === 'success') {
            statusMessage.classList.add('bg-green-100', 'text-green-700');
        } else {
            statusMessage.classList.add('bg-blue-100', 'text-blue-700');
        }
        
        statusMessage.classList.remove('hidden');
    }
    
    function displayResults(data) {
        // Display each field
        document.getElementById('contract_number').textContent = data.contract_number || 'Not found';
        document.getElementById('po_number').textContent = data.po_number || 'Not found';
        document.getElementById('award_date').textContent = data.award_date || 'Not found';
        document.getElementById('due_date').textContent = data.due_date || 'Not found';
        document.getElementById('contract_type').textContent = data.contract_type || 'Not found';
        document.getElementById('buyer').textContent = data.buyer || 'Not found';
        document.getElementById('contract_amount').textContent = data.contract_amount || 'Not found';
        
        // Display coordinate results
        if (data.coordinate_results) {
            document.getElementById('coordinate_results').textContent = JSON.stringify(data.coordinate_results, null, 2);
        }
        
        // Display raw text
        document.getElementById('raw_text').textContent = data.raw_text || '';
        
        // Show results container
        resultsContainer.classList.remove('hidden');
    }
    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %} 