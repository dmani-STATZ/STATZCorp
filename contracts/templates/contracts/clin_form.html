{% extends "contracts/contract_base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}Edit CLIN{% else %}New CLIN{% endif %}
{% endblock %}

{% block extra_head %}
{{ block.super }}
<style>
    /* NSN Modal Styles */
    .nsn-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    
    .nsn-modal-content {
        background-color: white;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    .nsn-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .nsn-modal-body {
        padding: 1rem;
    }
    
    .nsn-modal-footer {
        padding: 1rem;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        gap: 0.5rem;
    }
    
    .nsn-search-results {
        margin-top: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }
    
    .nsn-result-item {
        padding: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
    }
    
    .nsn-result-item:hover {
        background-color: #f3f4f6;
    }
    
    .nsn-pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        margin-top: 1rem;
    }
    
    /* Form label styling */
    .form-label {
        text-transform: capitalize;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4b5563;
        margin-bottom: 0.5rem;
        display: block;
        font-family: inherit;
    }
    
    /* For acronyms that should always be uppercase */
    .text-uppercase {
        text-transform: uppercase !important;
    }
    
    /* Section headers */
    .section-header {
        font-size: 1.125rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        font-family: inherit;
    }
</style>
{% endblock extra_head %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-gray-800">
            {% if form.instance.pk %}
                Edit <span class="text-uppercase">CLIN</span>: {{ form.instance.clin_po_num }}
                {% if form.initial.contract %}
                    for Contract #{{ form.initial.contract_number }}
                {% endif %}
            {% else %}
                Create New <span class="text-uppercase">CLIN</span>
                {% if form.initial.contract %}
                    for Contract #{{ form.initial.contract_number }}
                {% endif %}
            {% endif %}
        </h1>
        <div>
            {% if form.instance.pk %} <!-- Edit CLIN -->
                <a href="{% url 'contracts:contract_detail' form.instance.contract.id %}" class="btn-secondary">
                    Cancel
                </a>
            {% elif form.initial.contract %} <!-- New CLIN with pre-selected contract -->
                <a href="{% url 'contracts:contract_detail' form.initial.contract %}" class="btn-secondary">
                    Cancel
                </a>
            {% else %}
                <a href="{% url 'contracts:contracts_dashboard' %}" class="btn-secondary">
                    Cancel
                </a>
            {% endif %}
        </div>
    </div>

    <div class="bg-white rounded-lg shadow-md p-6">
        <form method="post" class="space-y-6" id="clin-form">
            {% csrf_token %}
            
            <!-- CLIN Identification -->
            <div>
                <h2 class="section-header">
                    <span class="text-uppercase">CLIN</span> Identification
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <!-- Row 1 -->
                    <div class="md:col-span-4">
                        <div id="contract-field-container">
                            {% if form.instance.pk or form.initial.contract %}
                            <!-- Display contract as read-only field when editing or when contract is pre-selected -->
                            <div class="form-group">
                                <label class="form-label">Contract</label>
                                <div class="form-control bg-gray-50 py-2">
                                    {% if form.instance.contract %}
                                        {{ form.instance.contract.contract_number }}
                                    {% elif form.initial.contract_number %}
                                        {{ form.initial.contract_number }}
                                    {% endif %}
                                </div>
                                <!-- Hidden input to preserve the contract value -->
                                <input type="hidden" name="contract" id="id_contract" 
                                    value="{% if form.instance.contract %}{{ form.instance.contract.id }}{% elif form.initial.contract %}{{ form.initial.contract }}{% endif %}">
                            </div>
                            {% else %}
                            <!-- Only show dropdown if creating a new CLIN without pre-selected contract -->
                            {{ form.contract|as_crispy_field }}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-4">
                        <div class="form-group">
                            <label for="{{ form.po_number.id_for_label }}" class="form-label">
                                <span class="text-uppercase">PO</span> Number
                            </label>
                            {{ form.po_number }}
                            {% if form.po_number.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.po_number.errors }}</div>
                            {% endif %}
                            {% if form.po_number.help_text %}
                                <div class="text-gray-500 text-sm mt-1">{{ form.po_number.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-4">
                        <!-- Empty cell for alignment -->
                    </div>
                    
                    <!-- Row 2 -->
                    <div class="md:col-span-4">
                        <div id="clin-type-field-container">
                            <div class="form-group">
                                <label for="{{ form.clin_type.id_for_label }}" class="form-label">
                                    <span class="text-uppercase">CLIN</span> Type
                                </label>
                                {{ form.clin_type }}
                                {% if form.clin_type.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.clin_type.errors }}</div>
                                {% endif %}
                                {% if form.clin_type.help_text %}
                                    <div class="text-gray-500 text-sm mt-1">{{ form.clin_type.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="md:col-span-4">
                        <div class="form-group">
                            <label for="{{ form.ia.id_for_label }}" class="form-label">
                                <span class="text-uppercase">IA</span>
                            </label>
                            {{ form.ia }}
                            {% if form.ia.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.ia.errors }}</div>
                            {% endif %}
                            {% if form.ia.help_text %}
                                <div class="text-gray-500 text-sm mt-1">{{ form.ia.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-4">
                        <div class="form-group">
                            <label for="{{ form.fob.id_for_label }}" class="form-label">
                                <span class="text-uppercase">FOB</span>
                            </label>
                            {{ form.fob }}
                            {% if form.fob.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.fob.errors }}</div>
                            {% endif %}
                            {% if form.fob.help_text %}
                                <div class="text-gray-500 text-sm mt-1">{{ form.fob.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Row 3 -->
                    <div class="md:col-span-4">
                        <div class="form-group">
                            <label for="{{ form.tab_num.id_for_label }}" class="form-label">
                                <span class="text-uppercase">TAB</span> Number
                            </label>
                            {{ form.tab_num }}
                            {% if form.tab_num.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.tab_num.errors }}</div>
                            {% endif %}
                            {% if form.tab_num.help_text %}
                                <div class="text-gray-500 text-sm mt-1">{{ form.tab_num.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-4">
                        <div class="form-group">
                            <label for="{{ form.po_num_ext.id_for_label }}" class="form-label">
                                <span class="text-uppercase">PO</span> Number Extension
                            </label>
                            {{ form.po_num_ext }}
                            {% if form.po_num_ext.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.po_num_ext.errors }}</div>
                            {% endif %}
                            {% if form.po_num_ext.help_text %}
                                <div class="text-gray-500 text-sm mt-1">{{ form.po_num_ext.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-4">
                        <!-- Empty cell for alignment -->
                    </div>
                    
                    <!-- Row 4 -->
                    <div class="md:col-span-4">
                        {{ form.sub_contract|as_crispy_field }}
                    </div>
                    
                    <div class="md:col-span-4">
                        <div class="form-group">
                            <label for="{{ form.clin_po_num.id_for_label }}" class="form-label">
                                <span class="text-uppercase">CLIN PO</span> Number
                            </label>
                            {{ form.clin_po_num }}
                            {% if form.clin_po_num.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.clin_po_num.errors }}</div>
                            {% endif %}
                            {% if form.clin_po_num.help_text %}
                                <div class="text-gray-500 text-sm mt-1">{{ form.clin_po_num.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-4">
                        <!-- Empty cell for alignment -->
                    </div>
                </div>
            </div>
            
            <!-- Item Details -->
            <div>
                <h2 class="section-header">
                    Item Details
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                    <!-- Row 1 -->
                    <div class="md:col-span-6">
                        <!-- Simplified NSN Field -->
                        <div class="form-group">
                            <label for="nsn_display" class="form-label requiredField">
                                <span class="text-uppercase">NSN</span><span class="asteriskField">*</span>
                            </label>
                            <div class="flex">
                                <input type="text" id="nsn_display" class="form-control flex-grow" 
                                       value="{% if form.instance.nsn %}{{ form.instance.nsn.nsn_code }} - {{ form.instance.nsn.description }}{% endif %}" 
                                       readonly placeholder="Click to select NSN">
                                <button type="button" id="select_nsn_btn" class="ml-2 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Select
                                </button>
                            </div>
                            <!-- Hidden input to store the actual NSN ID -->
                            <input type="hidden" name="nsn" id="id_nsn" value="{% if form.instance.nsn %}{{ form.instance.nsn.id }}{% endif %}">
                        </div>
                    </div>
                    
                    <div class="md:col-span-6">
                        <!-- Simplified Supplier Field -->
                        <div class="form-group">
                            <label for="supplier_display" class="form-label requiredField">
                                Supplier<span class="asteriskField">*</span>
                            </label>
                            <div class="flex">
                                <input type="text" id="supplier_display" class="form-control flex-grow" 
                                       value="{% if form.instance.supplier %}{{ form.instance.supplier.name }} ({{ form.instance.supplier.cage_code }}){% endif %}" 
                                       readonly placeholder="Click to select Supplier">
                                <button type="button" id="select_supplier_btn" class="ml-2 px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                                    Select
                                </button>
                            </div>
                            <!-- Hidden input to store the actual Supplier ID -->
                            <input type="hidden" name="supplier" id="id_supplier" value="{% if form.instance.supplier %}{{ form.instance.supplier.id }}{% endif %}">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Order Information -->
            <div>
                <h2 class="section-header">
                    Order Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-9 gap-4">
                    <!-- Row 1 -->
                    <div class="md:col-span-2">
                        <div class="form-group">
                            <label for="{{ form.order_qty.id_for_label }}" class="form-label{% if form.order_qty.field.required %} requiredField{% endif %}">
                                Order Qty{% if form.order_qty.field.required %}<span class="asteriskField">*</span>{% endif %}
                            </label>
                            <input type="number" name="{{ form.order_qty.html_name }}" id="{{ form.order_qty.id_for_label }}" 
                                   class="form-control w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                   placeholder="Enter Order Quantity" 
                                   value="{% if form.order_qty.value %}{{ form.order_qty.value|floatformat:'0' }}{% endif %}"
                                   step="any">
                            {% if form.order_qty.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.order_qty.errors }}</div>
                            {% endif %}
                            {% if form.order_qty.help_text %}
                                <div class="text-gray-500 text-sm mt-1">{{ form.order_qty.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-1">
                        <div class="form-group">
                            <label for="{{ form.uom.id_for_label }}" class="form-label{% if form.uom.field.required %} requiredField{% endif %}">
                                <span class="text-uppercase">UOM</span>{% if form.uom.field.required %}<span class="asteriskField">*</span>{% endif %}
                            </label>
                            <input type="text" name="{{ form.uom.html_name }}" id="{{ form.uom.id_for_label }}" 
                                   class="form-control w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                   placeholder="EA" 
                                   value="{{ form.uom.value|default:'EA' }}">
                            {% if form.uom.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.uom.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-3">
                        {{ form.due_date|as_crispy_field }}
                    </div>
                    
                    <div class="md:col-span-3">
                        {{ form.supplier_due_date|as_crispy_field }}
                    </div>
                </div>
            </div>
            
            <!-- Shipping Information -->
            <div>
                <h2 class="section-header">
                    Shipping Information
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-9 gap-4">
                    <!-- Row 1 -->
                    <div class="md:col-span-2">
                        <div class="form-group">
                            <label for="{{ form.ship_qty.id_for_label }}" class="form-label{% if form.ship_qty.field.required %} requiredField{% endif %}">
                                Ship Qty{% if form.ship_qty.field.required %}<span class="asteriskField">*</span>{% endif %}
                            </label>
                            <input type="number" name="{{ form.ship_qty.html_name }}" id="{{ form.ship_qty.id_for_label }}" 
                                   class="form-control w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                   placeholder="Enter Ship Quantity" 
                                   value="{% if form.ship_qty.value %}{{ form.ship_qty.value|floatformat:'0' }}{% endif %}"
                                   step="any">
                            {% if form.ship_qty.errors %}
                                <div class="text-red-500 text-sm mt-1">{{ form.ship_qty.errors }}</div>
                            {% endif %}
                            {% if form.ship_qty.help_text %}
                                <div class="text-gray-500 text-sm mt-1">{{ form.ship_qty.help_text }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="md:col-span-1">
                        <div class="form-group">
                            <label class="form-label">
                                <span class="text-uppercase">UOM</span>
                            </label>
                            <input type="text" class="form-control w-full rounded-md border-gray-300 shadow-sm bg-gray-50" 
                                   value="{{ form.uom.value|default:'EA' }}" readonly>
                        </div>
                    </div>
                    
                    <div class="md:col-span-3">
                        {{ form.ship_date|as_crispy_field }}
                    </div>
                    
                    <div class="md:col-span-3">
                        <!-- Empty cell for alignment -->
                    </div>
                </div>
            </div>

            <!-- Financial Details (Hidden by default) -->
            <div>
                <h2 class="section-header cursor-pointer" id="financial-details-toggle">
                    Financial Details <span class="text-sm text-gray-500">(Click to expand)</span>
                </h2>
                
                <div class="hidden" id="financial-details-section">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-4">
                        <!-- Row 1 -->
                        <div class="md:col-span-4">
                            {{ form.special_payment_terms_paid|as_crispy_field }}
                        </div>
                        
                        <div class="md:col-span-4">
                            <div id="special-payment-terms-container">
                                {{ form.special_payment_terms|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="md:col-span-4">
                            <!-- Empty cell for alignment -->
                        </div>
                        
                        <!-- Row 2 -->
                        <div class="md:col-span-4">
                            <div class="form-group">
                                <label for="{{ form.clin_value.id_for_label }}" class="form-label">
                                    <span class="text-uppercase">PO</span> Amount
                                </label>
                                {{ form.clin_value }}
                                {% if form.clin_value.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.clin_value.errors }}</div>
                                {% endif %}
                                {% if form.clin_value.help_text %}
                                    <div class="text-gray-500 text-sm mt-1">{{ form.clin_value.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="md:col-span-4">
                            {{ form.paid_amount|as_crispy_field }}
                        </div>
                        
                        <div class="md:col-span-4">
                            {{ form.paid_date|as_crispy_field }}
                        </div>
                        
                        <!-- Row 3 -->
                        <div class="md:col-span-4">
                            <div class="form-group">
                                <label for="{{ form.wawf_payment.id_for_label }}" class="form-label">
                                    <span class="text-uppercase">WAWF</span> Payment
                                </label>
                                {{ form.wawf_payment }}
                                {% if form.wawf_payment.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.wawf_payment.errors }}</div>
                                {% endif %}
                                {% if form.wawf_payment.help_text %}
                                    <div class="text-gray-500 text-sm mt-1">{{ form.wawf_payment.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="md:col-span-4">
                            <div class="form-group">
                                <label for="{{ form.wawf_recieved.id_for_label }}" class="form-label">
                                    <span class="text-uppercase">WAWF</span> Received
                                </label>
                                {{ form.wawf_recieved }}
                                {% if form.wawf_recieved.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.wawf_recieved.errors }}</div>
                                {% endif %}
                                {% if form.wawf_recieved.help_text %}
                                    <div class="text-gray-500 text-sm mt-1">{{ form.wawf_recieved.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="md:col-span-4">
                            <div class="form-group">
                                <label for="{{ form.wawf_invoice.id_for_label }}" class="form-label">
                                    <span class="text-uppercase">WAWF</span> Invoice
                                </label>
                                {{ form.wawf_invoice }}
                                {% if form.wawf_invoice.errors %}
                                    <div class="text-red-500 text-sm mt-1">{{ form.wawf_invoice.errors }}</div>
                                {% endif %}
                                {% if form.wawf_invoice.help_text %}
                                    <div class="text-gray-500 text-sm mt-1">{{ form.wawf_invoice.help_text }}</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Row 4 -->
                        <div class="md:col-span-4">
                            {{ form.plan_gross|as_crispy_field }}
                        </div>
                        
                        <div class="md:col-span-4">
                            {{ form.planned_split|as_crispy_field }}
                        </div>
                        
                        <div class="md:col-span-4">
                            {{ form.contract_value|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                {% if form.instance.pk %} <!-- Edit CLIN -->
                    <a href="{% url 'contracts:contract_detail' form.instance.contract.id %}" class="btn-secondary">
                        Cancel
                    </a>
                    <button type="submit" class="btn-primary">
                        Update <span class="text-uppercase">CLIN</span>
                    </button>
                {% elif form.initial.contract %} <!-- New CLIN with pre-selected contract -->
                    <a href="{% url 'contracts:contract_detail' form.initial.contract %}" class="btn-secondary">
                        Cancel
                    </a>
                    <button type="submit" class="btn-primary">
                        Create <span class="text-uppercase">CLIN</span>
                    </button>
                {% else %} <!-- New CLIN without pre-selected contract -->
                    <a href="{% url 'contracts:contracts_dashboard' %}" class="btn-secondary">
                        Cancel
                    </a>
                    <button type="submit" class="btn-primary">
                        Create <span class="text-uppercase">CLIN</span>
                    </button>
                {% endif %}
            </div>
        </form>
    </div>
</div>

<!-- NSN Selection Modal -->
<div id="nsn_modal" class="nsn-modal">
    <div class="nsn-modal-content">
        <div class="nsn-modal-header">
            <h3 class="text-lg font-semibold">Select NSN</h3>
            <button type="button" id="close_nsn_modal" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="nsn-modal-body">
            <div class="mb-4">
                <label for="nsn_search" class="block text-sm font-medium text-gray-700 mb-1">Search NSN</label>
                <div class="flex">
                    <input type="text" id="nsn_search" class="form-control flex-grow" placeholder="Enter NSN code or description">
                    <button type="button" id="search_nsn_btn" class="ml-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Search
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">Enter at least 3 characters to search</p>
            </div>
            
            <div id="nsn_search_results" class="nsn-search-results">
                <!-- Results will be populated here -->
                <div class="text-center text-gray-500 py-4">
                    Search for NSN by code or description
                </div>
            </div>
            
            <div id="nsn_pagination" class="nsn-pagination hidden">
                <button type="button" id="nsn_prev_page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                    Previous
                </button>
                <span id="nsn_page_info">Page 1 of 1</span>
                <button type="button" id="nsn_next_page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                    Next
                </button>
            </div>
        </div>
        <div class="nsn-modal-footer">
            <button type="button" id="cancel_nsn_selection" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Supplier Selection Modal -->
<div id="supplier_modal" class="nsn-modal">
    <div class="nsn-modal-content">
        <div class="nsn-modal-header">
            <h3 class="text-lg font-semibold">Select Supplier</h3>
            <button type="button" id="close_supplier_modal" class="text-gray-500 hover:text-gray-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div class="nsn-modal-body">
            <div class="mb-4">
                <label for="supplier_search" class="block text-sm font-medium text-gray-700 mb-1">Search Supplier</label>
                <div class="flex">
                    <input type="text" id="supplier_search" class="form-control flex-grow" placeholder="Enter supplier name or CAGE code">
                    <button type="button" id="search_supplier_btn" class="ml-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                        Search
                    </button>
                </div>
                <p class="text-sm text-gray-500 mt-1">Enter at least 3 characters to search</p>
            </div>
            
            <div id="supplier_search_results" class="nsn-search-results">
                <!-- Results will be populated here -->
                <div class="text-center text-gray-500 py-4">
                    Search for supplier by name or CAGE code
                </div>
            </div>
            
            <div id="supplier_pagination" class="nsn-pagination hidden">
                <button type="button" id="supplier_prev_page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                    Previous
                </button>
                <span id="supplier_page_info">Page 1 of 1</span>
                <button type="button" id="supplier_next_page" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 disabled:opacity-50" disabled>
                    Next
                </button>
            </div>
        </div>
        <div class="nsn-modal-footer">
            <button type="button" id="cancel_supplier_selection" class="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300">
                Cancel
            </button>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_scripts %}
{{ block.super }}
<script>
    // Execute code when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded");
        
        // Add form submission handler for debugging
        const clinForm = document.getElementById('clin-form');
        if (clinForm) {
            clinForm.addEventListener('submit', function(e) {
                // Don't prevent form submission, just log the data
                console.log("Form submission data:");
                const formData = new FormData(clinForm);
                for (let [key, value] of formData.entries()) {
                    console.log(`${key}: ${value}`);
                }
                
                // Check if clin_type has a value
                const clinTypeValue = formData.get('clin_type');
                if (!clinTypeValue) {
                    console.warn("Warning: clin_type has no value!");
                }
            });
        }
        
        // Initialize modals immediately - don't wait for setTimeout
        // NSN Modal Functionality
        const nsnModal = document.getElementById('nsn_modal');
        const selectNsnBtn = document.getElementById('select_nsn_btn');
        const closeNsnModalBtn = document.getElementById('close_nsn_modal');
        const cancelNsnSelection = document.getElementById('cancel_nsn_selection');
        const nsnSearch = document.getElementById('nsn_search');
        const searchNsnBtn = document.getElementById('search_nsn_btn');
        const nsnSearchResults = document.getElementById('nsn_search_results');
        const nsnPagination = document.getElementById('nsn_pagination');
        const nsnPrevPage = document.getElementById('nsn_prev_page');
        const nsnNextPage = document.getElementById('nsn_next_page');
        const nsnPageInfo = document.getElementById('nsn_page_info');
        const nsnDisplay = document.getElementById('nsn_display');
        const nsnIdInput = document.getElementById('id_nsn');
        
        let currentPage = 1;
        let totalPages = 1;
        let searchTerm = '';
        
        console.log("NSN elements:", {selectNsnBtn, nsnModal, nsnDisplay});
        
        // Open NSN modal
        function openNsnModal() {
            console.log("Opening NSN modal");
            nsnModal.style.display = 'flex';
            nsnSearch.focus();
        }
        
        if (selectNsnBtn) {
            selectNsnBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openNsnModal();
            });
        }
        
        if (nsnDisplay) {
            nsnDisplay.addEventListener('click', function(e) {
                e.preventDefault();
                openNsnModal();
            });
        }
        
        // Close NSN modal
        function closeNsnModal() {
            nsnModal.style.display = 'none';
        }
        
        if (closeNsnModalBtn) {
            closeNsnModalBtn.addEventListener('click', closeNsnModal);
        }
        
        if (cancelNsnSelection) {
            cancelNsnSelection.addEventListener('click', closeNsnModal);
        }
        
        // Close modal when clicking outside
        if (nsnModal) {
            nsnModal.addEventListener('click', function(e) {
                if (e.target === nsnModal) {
                    closeNsnModal();
                }
            });
        }
        
        // Search for NSN
        function searchNsn() {
            searchTerm = nsnSearch.value.trim();
            if (searchTerm.length < 3) {
                nsnSearchResults.innerHTML = '<div class="text-center text-gray-500 py-4">Enter at least 3 characters to search</div>';
                nsnPagination.classList.add('hidden');
                return;
            }
            
            currentPage = 1;
            fetchNsnResults();
        }
        
        if (searchNsnBtn) {
            searchNsnBtn.addEventListener('click', searchNsn);
        }
        
        // Search on enter key
        if (nsnSearch) {
            nsnSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchNsn();
                }
            });
        }
        
        // Pagination
        if (nsnPrevPage) {
            nsnPrevPage.addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    fetchNsnResults();
                }
            });
        }
        
        if (nsnNextPage) {
            nsnNextPage.addEventListener('click', function() {
                if (currentPage < totalPages) {
                    currentPage++;
                    fetchNsnResults();
                }
            });
        }
        
        // Fetch NSN results from API
        function fetchNsnResults() {
            nsnSearchResults.innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading...</p></div>';
            
            fetch(`/contracts/api/options/nsn/?search=${encodeURIComponent(searchTerm)}&page=${currentPage}&page_size=10`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update pagination
                        totalPages = data.pagination.total_pages;
                        updateNsnPagination();
                        
                        // Display results
                        if (data.options.length > 0) {
                            let resultsHtml = '';
                            data.options.forEach(option => {
                                resultsHtml += `
                                    <div class="nsn-result-item" data-nsn-id="${option.value}" data-nsn-text="${option.label}">
                                        <div class="font-medium">${option.label}</div>
                                    </div>
                                `;
                            });
                            nsnSearchResults.innerHTML = resultsHtml;
                            
                            // Add click event to result items
                            document.querySelectorAll('.nsn-result-item[data-nsn-id]').forEach(item => {
                                item.addEventListener('click', function() {
                                    const nsnId = this.getAttribute('data-nsn-id');
                                    const nsnText = this.getAttribute('data-nsn-text');
                                    
                                    // Update the form fields
                                    nsnIdInput.value = nsnId;
                                    nsnDisplay.value = nsnText;
                                    
                                    // Close the modal
                                    closeNsnModal();
                                });
                            });
                        } else {
                            nsnSearchResults.innerHTML = '<div class="text-center text-gray-500 py-4">No results found</div>';
                        }
                    } else {
                        nsnSearchResults.innerHTML = '<div class="text-center text-red-500 py-4">Error loading results</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching NSN data:', error);
                    nsnSearchResults.innerHTML = '<div class="text-center text-red-500 py-4">Error loading results</div>';
                });
        }
        
        function updateNsnPagination() {
            if (totalPages > 1) {
                nsnPagination.classList.remove('hidden');
                nsnPageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
                nsnPrevPage.disabled = currentPage <= 1;
                nsnNextPage.disabled = currentPage >= totalPages;
            } else {
                nsnPagination.classList.add('hidden');
            }
        }
        
        // Supplier Modal Functionality
        const supplierModal = document.getElementById('supplier_modal');
        const selectSupplierBtn = document.getElementById('select_supplier_btn');
        const closeSupplierModalBtn = document.getElementById('close_supplier_modal');
        const cancelSupplierSelection = document.getElementById('cancel_supplier_selection');
        const supplierSearch = document.getElementById('supplier_search');
        const searchSupplierBtn = document.getElementById('search_supplier_btn');
        const supplierSearchResults = document.getElementById('supplier_search_results');
        const supplierPagination = document.getElementById('supplier_pagination');
        const supplierPrevPage = document.getElementById('supplier_prev_page');
        const supplierNextPage = document.getElementById('supplier_next_page');
        const supplierPageInfo = document.getElementById('supplier_page_info');
        const supplierDisplay = document.getElementById('supplier_display');
        const supplierIdInput = document.getElementById('id_supplier');
        
        let supplierCurrentPage = 1;
        let supplierTotalPages = 1;
        let supplierSearchTerm = '';
        
        console.log("Supplier elements:", {selectSupplierBtn, supplierModal, supplierDisplay});
        
        // Open Supplier modal
        function openSupplierModal() {
            console.log("Opening Supplier modal");
            supplierModal.style.display = 'flex';
            supplierSearch.focus();
        }
        
        if (selectSupplierBtn) {
            selectSupplierBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openSupplierModal();
            });
        }
        
        if (supplierDisplay) {
            supplierDisplay.addEventListener('click', function(e) {
                e.preventDefault();
                openSupplierModal();
            });
        }
        
        // Close Supplier modal
        function closeSupplierModal() {
            supplierModal.style.display = 'none';
        }
        
        if (closeSupplierModalBtn) {
            closeSupplierModalBtn.addEventListener('click', closeSupplierModal);
        }
        
        if (cancelSupplierSelection) {
            cancelSupplierSelection.addEventListener('click', closeSupplierModal);
        }
        
        // Close modal when clicking outside
        if (supplierModal) {
            supplierModal.addEventListener('click', function(e) {
                if (e.target === supplierModal) {
                    closeSupplierModal();
                }
            });
        }
        
        // Search for Supplier
        function searchSupplier() {
            supplierSearchTerm = supplierSearch.value.trim();
            if (supplierSearchTerm.length < 3) {
                supplierSearchResults.innerHTML = '<div class="text-center text-gray-500 py-4">Enter at least 3 characters to search</div>';
                supplierPagination.classList.add('hidden');
                return;
            }
            
            supplierCurrentPage = 1;
            fetchSupplierResults();
        }
        
        if (searchSupplierBtn) {
            searchSupplierBtn.addEventListener('click', searchSupplier);
        }
        
        // Search on enter key
        if (supplierSearch) {
            supplierSearch.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    searchSupplier();
                }
            });
        }
        
        // Pagination
        if (supplierPrevPage) {
            supplierPrevPage.addEventListener('click', function() {
                if (supplierCurrentPage > 1) {
                    supplierCurrentPage--;
                    fetchSupplierResults();
                }
            });
        }
        
        if (supplierNextPage) {
            supplierNextPage.addEventListener('click', function() {
                if (supplierCurrentPage < supplierTotalPages) {
                    supplierCurrentPage++;
                    fetchSupplierResults();
                }
            });
        }
        
        // Fetch Supplier results from API
        function fetchSupplierResults() {
            supplierSearchResults.innerHTML = '<div class="text-center py-4"><div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><p class="mt-2 text-gray-600">Loading...</p></div>';
            
            fetch(`/contracts/api/options/supplier/?search=${encodeURIComponent(supplierSearchTerm)}&page=${supplierCurrentPage}&page_size=10`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update pagination
                        supplierTotalPages = data.pagination.total_pages;
                        updateSupplierPagination();
                        
                        // Display results
                        if (data.options.length > 0) {
                            let resultsHtml = '';
                            data.options.forEach(option => {
                                resultsHtml += `
                                    <div class="nsn-result-item" data-supplier-id="${option.value}" data-supplier-text="${option.label}">
                                        <div class="font-medium">${option.label}</div>
                                    </div>
                                `;
                            });
                            supplierSearchResults.innerHTML = resultsHtml;
                            
                            // Add click event to result items
                            document.querySelectorAll('.nsn-result-item[data-supplier-id]').forEach(item => {
                                item.addEventListener('click', function() {
                                    const supplierId = this.getAttribute('data-supplier-id');
                                    const supplierText = this.getAttribute('data-supplier-text');
                                    
                                    // Update the form fields
                                    supplierIdInput.value = supplierId;
                                    supplierDisplay.value = supplierText;
                                    
                                    // Close the modal
                                    closeSupplierModal();
                                });
                            });
                        } else {
                            supplierSearchResults.innerHTML = '<div class="text-center text-gray-500 py-4">No results found</div>';
                        }
                    } else {
                        supplierSearchResults.innerHTML = '<div class="text-center text-red-500 py-4">Error loading results</div>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching supplier data:', error);
                    supplierSearchResults.innerHTML = '<div class="text-center text-red-500 py-4">Error loading results</div>';
                });
        }
        
        function updateSupplierPagination() {
            if (supplierTotalPages > 1) {
                supplierPagination.classList.remove('hidden');
                supplierPageInfo.textContent = `Page ${supplierCurrentPage} of ${supplierTotalPages}`;
                supplierPrevPage.disabled = supplierCurrentPage <= 1;
                supplierNextPage.disabled = supplierCurrentPage >= supplierTotalPages;
            } else {
                supplierPagination.classList.add('hidden');
            }
        }

        // Toggle financial details section
        const financialToggle = document.getElementById('financial-details-toggle');
        const financialSection = document.getElementById('financial-details-section');
        
        if (financialToggle && financialSection) {
            financialToggle.addEventListener('click', function() {
                financialSection.classList.toggle('hidden');
                const isHidden = financialSection.classList.contains('hidden');
                const span = financialToggle.querySelector('span');
                if (span) {
                    span.textContent = isHidden ? '(Click to expand)' : '(Click to collapse)';
                }
            });
        }
    });
</script>
{% endblock extra_scripts %}
