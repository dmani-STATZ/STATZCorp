{% extends "contracts/contract_base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Contract Queue{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-4">
    <!-- Header Section -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-4">
        <div class="flex flex-col lg:flex-row justify-between items-center space-y-3 lg:space-y-0">
            <h1 class="text-2xl font-bold text-gray-800">Contract Queue</h1>
            
            <div class="flex space-x-2">
                <a href="{% url 'contracts:download_csv_template' %}" 
                   class="btn-primary flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download Template
                </a>
                <a href="{% url 'contracts:download_test_data' %}" 
                   class="btn-primary flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Download Test Data
                </a>
            </div>
        </div>

        <!-- Drag and Drop Zone -->
        <div id="dropZone" 
             class="mt-4 border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition-colors duration-200">
            <input type="file" id="csvFile" accept=".csv" class="hidden" />
            <div class="flex flex-col items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-gray-400 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                </svg>
                <p class="text-gray-600 mb-2">Drag and drop your CSV file here, or</p>
                <button id="uploadCsvBtn" class="btn-primary flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Select File
                </button>
            </div>
        </div>
    </div>

    <!-- Contract Queue Grid -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-4 py-2">
            <h2 class="text-lg font-semibold text-white">Queued Contracts</h2>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Contract Number
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Buyer
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Award Date
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Contract Value
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Contract Type
                        </th>
                        <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="contractQueueBody">
                    {% for contract in queued_contracts %}
                    <tr class="{% if contract.is_being_processed %}bg-yellow-50{% endif %} hover:bg-gray-50">
                        <td class="px-4 py-2 whitespace-nowrap">
                            {% if contract.is_being_processed %}
                            <div class="flex items-center">
                                <div class="h-2 w-2 bg-yellow-500 rounded-full mr-2"></div>
                                <span class="text-xs text-yellow-600">Processing by {{ contract.processed_by.username }}</span>
                            </div>
                            {% else %}
                            <div class="flex items-center">
                                <div class="h-2 w-2 bg-green-500 rounded-full mr-2"></div>
                                <span class="text-xs text-green-600">Available</span>
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                            {{ contract.contract_number }}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                            {{ contract.buyer }}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                            {{ contract.award_date|date:"M d, Y" }}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                            ${{ contract.contract_value|floatformat:2|intcomma }}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                            {{ contract.contract_type }}
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                            {% if not contract.is_being_processed %}
                            <button onclick="startProcessing('{{ contract.id }}')" class="text-blue-600 hover:text-blue-900">
                                Process
                            </button>
                            {% else %}
                            <div class="flex space-x-2">
                                <span class="text-gray-400">In Progress</span>
                                <button onclick="confirmCancelProcessing('{{ contract.id }}', '{{ contract.contract_number }}')" 
                                        class="text-red-600 hover:text-red-900">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="px-6 py-10 text-center text-gray-500">
                            <p class="text-base">No queued contracts found.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div id="processingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Process Contract</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Please fill in the required information to process this contract.</p>
            </div>
            <div class="mt-4">
                <form id="processContractForm">
                    <input type="hidden" id="contractQueueId" name="contract_queue_id">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="po_number">
                            PO Number
                        </label>
                        <input type="text" id="po_number" name="po_number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" readonly>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="tab_number">
                            Tab Number
                        </label>
                        <input type="text" id="tab_number" name="tab_number" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" readonly>
                    </div>
                    <div class="flex items-center justify-between">
                        <button type="button" onclick="closeModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Cancel
                        </button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                            Process
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Processing Confirmation Modal -->
<div id="cancelProcessingModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Cancel Processing</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">Are you sure you want to cancel processing for contract <span id="cancelContractNumber" class="font-semibold"></span>?</p>
                <p class="text-sm text-red-500 mt-2">This action cannot be undone.</p>
            </div>
            <div class="mt-4 flex justify-center space-x-4">
                <button onclick="closeCancelModal()" 
                        class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    No, Keep Processing
                </button>
                <button onclick="executeCancelProcessing()" 
                        class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Yes, Cancel Processing
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Function to start processing a contract
function startProcessing(contractId) {
    // Get the next PO and Tab numbers
    fetch('/contracts/api/get-next-numbers/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('contractQueueId').value = contractId;
            document.getElementById('po_number').value = data.po_number;
            document.getElementById('tab_number').value = data.tab_number;
            document.getElementById('processingModal').classList.remove('hidden');
        });
}

// Function to close the modal
function closeModal() {
    document.getElementById('processingModal').classList.add('hidden');
}

// Handle form submission
document.getElementById('processContractForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/contracts/api/process-contract/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error processing contract: ' + data.error);
        }
    });
});

// Close modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('processingModal');
    if (e.target === modal) {
        closeModal();
    }
});

let cancelContractId = null;

function confirmCancelProcessing(contractId, contractNumber) {
    cancelContractId = contractId;
    document.getElementById('cancelContractNumber').textContent = contractNumber;
    document.getElementById('cancelProcessingModal').classList.remove('hidden');
}

function closeCancelModal() {
    document.getElementById('cancelProcessingModal').classList.add('hidden');
    cancelContractId = null;
}

function executeCancelProcessing() {
    if (!cancelContractId) return;
    
    fetch(`/processing/cancel-processing/${cancelContractId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error canceling processing: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error canceling processing. Please try again.');
    })
    .finally(() => {
        closeCancelModal();
    });
}

// Close cancel modal when clicking outside
document.addEventListener('click', function(e) {
    const modal = document.getElementById('cancelProcessingModal');
    if (e.target === modal) {
        closeCancelModal();
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const uploadBtn = document.getElementById('uploadCsvBtn');
    const csvFile = document.getElementById('csvFile');
    
    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });
    
    // Highlight drop zone when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });
    
    // Handle dropped files
    dropZone.addEventListener('drop', handleDrop, false);
    
    // Handle file selection via button
    uploadBtn.addEventListener('click', function() {
        csvFile.click();
    });
    
    csvFile.addEventListener('change', handleFiles);
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    function highlight(e) {
        dropZone.classList.add('border-blue-500', 'bg-blue-50');
    }
    
    function unhighlight(e) {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    }
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles({ target: { files: files } });
    }
    
    function handleFiles(e) {
        const file = e.target.files[0];
        if (file) {
            if (!file.name.endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }
            
            const formData = new FormData();
            formData.append('csv_file', file);
            
            fetch('{% url "contracts:upload_csv" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error uploading CSV: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error uploading CSV. Please try again.');
            });
        }
    }
});
</script>
{% endblock %} 