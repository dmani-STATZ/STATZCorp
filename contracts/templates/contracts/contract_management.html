{% extends "contracts/contract_base.html" %}
{% load static %}

{% block content %}
<form id="csrf-form">
    {% csrf_token %}
</form>
    <div class="container mx-auto px-2 py-2">
    <!-- Top Section Grid Layout -->
    <div class="grid grid-cols-3 gap-4 mb-2">
        <!-- CLIN Acknowledgment Section - Left Column -->
        <div class="col-span-1 card card-padded !p-2">
            <h2 class="text-lg font-bold text-gray-800 mb-1">CLIN Acknowledgment</h2>
            <div class="space-y-1">
                <div class="row-between py-1 border-b">
                    <span class="text-sm text-gray-700 w-1/3">PO Acknowledge Letter</span>
                    <div class="text-center w-1/3">
                        <button
                            onclick="openAcknowledgmentLetter('{{ selected_clin.id }}')"
                            class="w-24 px-3 py-1 text-sm font-medium rounded-md transition-colors duration-150
                                {% if not selected_clin %}bg-gray-300 text-gray-500{% else %}bg-blue-500 text-white hover:bg-blue-600{% endif %}">
                            {% if acknowledgment_letter %}Edit{% else %}Create{% endif %}
                        </button>
                    </div>
                    <span class="text-xs text-gray-500 w-1/3 text-right">
                        {% if acknowledgment_letter %}
                            Last updated: {{ acknowledgment_letter.modified_on|date:"m/d/Y H:i A" }}
                        {% endif %}
                    </span>
                </div>

                <!-- PO Sent to Sup -->
                <div class="grid grid-cols-3 items-center py-1 border-b">
                    <span class="text-sm text-gray-700">PO Sent to Supplier</span>
                    <div class="text-center">
                        <button
                            onclick="toggleAcknowledgment('po_to_supplier_bool')"
                            id="po_to_supplier_bool_btn"
                            class="w-24 px-3 py-1 text-sm font-medium rounded-md transition-colors duration-150
                            {% if acknowledgment.po_to_supplier_bool %}bg-green-500 text-white{% else %}bg-red-500 text-white{% endif %}">
                            {% if acknowledgment.po_to_supplier_bool %}Sent{% else %}Not Sent{% endif %}
                        </button>
                    </div>
                    <div class="text-right text-xs text-gray-600">
                        {% if acknowledgment.po_to_supplier_bool %}
                            <div>{{ acknowledgment.po_to_supplier_user.username }}</div>
                            <div>{{ acknowledgment.po_to_supplier_date|date:"m/d/Y H:i A" }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Acknowledged -->
                <div class="grid grid-cols-3 items-center py-1 border-b">
                    <span class="text-sm text-gray-700">Acknowledged</span>
                    <div class="text-center">
                        <button
                            onclick="toggleAcknowledgment('clin_reply_bool')"
                            id="clin_reply_bool_btn"
                            class="w-24 px-3 py-1 text-sm font-medium rounded-md transition-colors duration-150
                            {% if acknowledgment.clin_reply_bool %}bg-green-500 text-white{% else %}bg-red-500 text-white{% endif %}">
                            {% if acknowledgment.clin_reply_bool %}Yes{% else %}No{% endif %}
                        </button>
                    </div>
                    <div class="text-right text-xs text-gray-600">
                        {% if acknowledgment.clin_reply_bool %}
                            <div>{{ acknowledgment.clin_reply_user.username }}</div>
                            <div>{{ acknowledgment.clin_reply_date|date:"m/d/Y H:i A" }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- PO Sent to QAR -->
                <div class="grid grid-cols-3 items-center py-1 border-b">
                    <span class="text-sm text-gray-700">PO Sent to QAR</span>
                    <div class="text-center">
                        <button
                            onclick="toggleAcknowledgment('po_to_qar_bool')"
                            id="po_to_qar_bool_btn"
                            class="w-24 px-3 py-1 text-sm font-medium rounded-md transition-colors duration-150
                            {% if acknowledgment.po_to_qar_bool %}bg-green-500 text-white{% else %}bg-red-500 text-white{% endif %}">
                            {% if acknowledgment.po_to_qar_bool %}Sent{% else %}Not Sent{% endif %}
                        </button>
                    </div>
                    <div class="text-right text-xs text-gray-600">
                        {% if acknowledgment.po_to_qar_bool %}
                            <div>{{ acknowledgment.po_to_qar_user.username }}</div>
                            <div>{{ acknowledgment.po_to_qar_date|date:"m/d/Y H:i A" }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Contract Header - Right Columns -->
        <div class="col-span-2 card card-padded !p-2">
            {% if contract.status.description == 'Cancelled' %}
                <div class="bg-red-100 text-red-800 flex justify-between items-center mb-2 p-1">
                    <a href="{% url 'contracts:contract_detail' contract.id %}">
                        <h1 class="text-xl font-bold text-gray-800">
                            Contract {{ contract.contract_number }}
                        </h1>
                    </a>
                    <div class="flex items-center space-x-3">
                        <span class="bg-white text-red-800 px-3 py-1 rounded-full text-sm font-semibold">Cancelled</span>
                        <button type="button" onclick="openContractSearchModal()" class="text-gray-800 hover:bg-gray-200 px-4 py-2 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            Contract Search
                        </button>
                        <a href="{% url 'contracts:contracts_dashboard' %}"
                        class="hover:bg-gray-200 text-red px-4 py-2 rounded-lg flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                             <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                         </svg>
                         Back to Dashboard
                        </a>
                    </div>
                </div>
            {% elif not contract.status.description == 'Open' %}
                <div class="bg-gray-100 text-gray-800 flex justify-between items-center mb-2 p-1">
                    <a href="{% url 'contracts:contract_detail' contract.id %}">
                    <h1 class="text-xl font-bold text-gray-800">
                        Contract {{ contract.contract_number }}
                    </h1></a>
                    <div class="flex items-center space-x-3">
                        <span class="bg-white text-gray-800 px-3 py-1 rounded-full text-sm font-semibold">Closed</span>
                        <button type="button" onclick="openContractSearchModal()" class="text-gray-800 hover:bg-gray-200 px-4 py-2 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            Contract Search
                        </button>
                        <a href="{% url 'contracts:contracts_dashboard' %}"
                        class=" hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg flex items-center">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                             <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                         </svg>
                         Back to Dashboard
                        </a>
                    </div>
                </div>
            {% else %}
                <div class="bg-green-100 text-green-800 flex justify-between items-center mb-2 p-1">
                    <a href="{% url 'contracts:contract_detail' contract.id %}">
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center">
                        Contract {{ contract.contract_number }}
                    </h1></a>

                        <!-- Contract Options Dropdown -->
                        <div class="relative inline-block text-left">
                            <button type="button" onclick="toggleOptionsMenu()"
                                    class="inline-flex items-center px-4 py-2 rounded-md bg-white text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                Options
                                <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div id="optionsMenu"
                                 class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 divide-y divide-gray-100 focus:outline-none z-50">
                                <div class="py-1">
                                    <a href="{% url 'contracts:contract_review' contract.id %}"
                                       class="group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                                       <svg class="mr-3" width="20" height="20" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M12 2h40c1.1 0 2 .9 2 2v56c0 1.1-.9 2-2 2H12c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2zm0 4v52h40V6H12zm4 4h32v4H16V10zm0 8h32v4H16v-4zm0 8h32v4H16v-4zm0 8h32v4H16v-4zm0 8h32v4H16v-4z" fill="#000"/>
                                       </svg>
                                        {% if contract.reviewed %}Reviewed{% else %}Review Contract{% endif %}
                                    </a>
                                    <a href="{% url 'contracts:contract_update' contract.id %}"
                                        class="group flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900">
                                        <svg class="mr-3 h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                        </svg>
                                        Edit Contract
                                    </a>
                                    <a href="{% url 'contracts:finance_audit_detail' contract.id %}"
                                        class="group flex items-center px-4 py-2 text-sm text-green-800 hover:bg-gray-100 hover:text-gray-900">
                                        <svg class="mr-3 h-5 w-5 text-green-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                        Finance Audit
                                    </a>
                                    {% if contract.status.description != 'Cancelled' %}
                                    <button onclick="showCancelModal('{{ contract.id }}', '{{ contract.contract_number }}')"
                                            class="group flex w-full items-center px-4 py-2 text-sm btn btn-caution">
                                        <svg class="mr-3 h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                                        </svg>
                                        Cancel Contract
                                    </button>
                                    {% endif %}
                                    {% if contract.status.description == 'Open' %}
                                    <a href="{% url 'contracts:contract_close' contract.id %}"
                                       class="group flex items-center px-4 py-2 text-sm text-yellow-700 hover:bg-gray-100 hover:text-yellow-900">
                                        <svg class="mr-3 h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                        </svg>
                                        Close Contract
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-3">
                        <span class="bg-white {% if contract.status.description == 'Open' %}text-green-800{% else %}text-gray-800{% endif %} px-3 py-1 rounded-full text-sm font-semibold">
                            {% if contract.status.description == 'Open' %}Open{% else %}Closed{% endif %}
                        </span>
                        <button type="button" onclick="openContractSearchModal()" class="text-gray-800 hover:bg-gray-200 px-4 py-2 rounded-lg flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                            Contract Search
                        </button>
                        <a href="{% url 'contracts:contracts_dashboard' %}"
                        class="hover:bg-gray-200 text-gray-800 px-4 py-2 rounded-lg flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                        </svg>
                        Back to Dashboard
                        </a>
                    </div>
                </div>
            {% endif %}

            <!-- Contract Details + Controls -->
            <div class="flex gap-3 items-start flex-wrap">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-3 gap-y-0.5 flex-1 min-w-0">
                    <div class="px-0.5 py-0.5">
                        <p class="text-xs text-gray-600">PO Number</p>
                        <p class="font-medium text-sm">{{ contract.po_number|default:"N/A" }}</p>
                    </div>
                    <div class="px-0.5 py-0.5">
                        <p class="text-xs text-gray-600">Tab Number</p>
                        <p class="font-medium text-sm">{{ contract.tab_num|default:"N/A" }}</p>
                    </div>
                    <div class="px-0.5 py-0.5">
                        <p class="text-xs text-gray-600">Buyer</p>
                        <p class="font-medium text-sm">{{ contract.buyer.description|default:"N/A" }}</p>
                    </div>
                    <div class="px-0.5 py-0.5">
                    {% with sharepoint_url=contract.get_sharepoint_documents_url %}
                    {% if sharepoint_url %}
                    <a href="{{ sharepoint_url }}" target="_blank" rel="noopener noreferrer"
                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-blue-100 text-blue-600 hover:bg-blue-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd" /></svg>
                        Documents
                    </a>
                    {% elif contract.files_url %}
                    <button onclick="copyContractPath('{{ contract.files_url | escapejs }}')"
                        class="flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-gray-100 text-gray-600 hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 mr-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H8a3 3 0 00-3 3v1.5a1.5 1.5 0 01-3 0V6z" clip-rule="evenodd" /><path d="M6 12a2 2 0 012-2h8a2 2 0 012 2v2a2 2 0 01-2 2H2h2a2 2 0 002-2v-2z" /></svg>
                        Copy Path
                    </button>
                    {% endif %}
                    {% endwith %}
                    </div>
                    <div class="px-0.5 py-0.5">
                        <p class="text-xs text-gray-600">Award Date</p>
                        <p class="font-medium text-sm">{{ contract.award_date|date:"M d, Y"|default:"N/A" }}</p>
                    </div>
                    <div class="px-0.5 py-0.5">
                        <p class="text-xs text-gray-600">Due Date</p>
                        <p class="font-medium text-sm {% if contract.due_date_late %}text-red-600{% endif %}">
                            {{ contract.due_date|date:"M d, Y"|default:"N/A" }}
                        </p>
                    </div>
                    <div class="px-0.5 py-0.5">
                        <p class="text-xs text-gray-600">Sales Class</p>
                        <p class="font-medium text-sm">{{ contract.sales_class.sales_team|default:"N/A" }}</p>
                    </div>
                    <div class="px-0.5 py-0.5">
                        <p class="text-xs text-gray-600">Solicitation Type</p>
                        <p class="font-medium text-sm">{{ contract.solicitation_type|default:"N/A" }}</p>
                    </div>
                </div>
                <!-- Contract Controls: Expedite (top) + NIST (below) -->
                <div class="shrink-0 flex flex-col gap-2 border-l border-gray-200 pl-3">
                    <!-- Expedite panel: bordered, title + X top, buttons stacked vertically -->
                    <div id="expedite_container" class="border border-gray-300 rounded-md p-1.5
                        {% if expedite and expedite.used %}bg-fuchsia-200{% elif expedite and expedite.successful %}bg-yellow-200{% else %}bg-gray-50{% endif %}">
                        <div class="flex justify-between items-center mb-1.5">
                            <span class="text-sm font-semibold text-gray-800">Expedite</span>
                            <button type="button" onclick="resetExpedite()"
                                class="bg-red-100 hover:bg-red-200 text-red-600 rounded p-1 flex items-center justify-center transition-colors" title="Reset">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                        <div class="space-y-2">
                            {% if not expedite or not expedite.successful %}
                            <button onclick="toggleExpediteStatus('initiate')" id="expedite_initiate_btn"
                                class="w-full px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                                    {% if expedite and expedite.initiated %}bg-gray-300 text-gray-600 cursor-not-allowed{% else %}bg-red-200 text-red-800 hover:bg-red-300{% endif %}"
                                {% if expedite and expedite.initiated %}disabled{% endif %}>Initiate</button>
                            <button onclick="toggleExpediteStatus('successful')" id="expedite_successful_btn"
                                class="w-full px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                                    {% if not expedite or not expedite.initiated or expedite.successful %}bg-gray-300 text-gray-600 cursor-not-allowed{% else %}bg-red-200 text-red-800 hover:bg-red-300{% endif %}"
                                {% if not expedite or not expedite.initiated or expedite.successful %}disabled{% endif %}>Successful</button>
                            {% endif %}
                            {% if expedite and expedite.successful %}
                            <button onclick="toggleExpediteStatus('use')" id="expedite_use_btn"
                                class="w-full px-3 py-1.5 text-sm font-medium rounded-md transition-colors
                                    {% if expedite.used %}bg-gray-300 text-gray-600 cursor-not-allowed{% else %}bg-red-200 text-red-800 hover:bg-red-300{% endif %}"
                                {% if expedite.used %}disabled{% endif %}>Use Expedite</button>
                            {% endif %}
                        </div>
                        {% if expedite and expedite.initiated %}
                        <div class="mt-1 text-xs text-gray-700">
                            {% if expedite.successful %}<span>✓ Successful</span>{% endif %}
                            {% if expedite.used %}<span>Used</span>{% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <!-- NIST button below Expedite -->
                    <div class="flex justify-center">
                        <button onclick="toggleContractField('nist')" id="nist_btn"
                            data-nist-state="{% if contract.nist %}true{% else %}false{% endif %}"
                            class="flex items-center justify-center p-1.5 border border-gray-300 rounded shadow-sm hover:opacity-90 transition-colors {% if contract.nist %}bg-green-500 text-white{% else %}bg-gray-300 text-gray-700{% endif %}" title="NIST">
                            <img src="{% static 'contracts/images/nist.png' %}" alt="NIST" class="h-7">
                        </button>
                    </div>
                </div>
            </div>
            <!-- Toast message for clipboard copy -->
            <div id="clipboard-toast" class="hidden fixed top-4 right-4 bg-green-100 text-green-800 px-4 py-2 rounded-lg shadow-lg z-50">
                Path copied to clipboard! Paste in File Explorer address bar.
            </div>
            <!-- System message for additional instructions -->
            <div id="system-message" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="card card-padded max-w-lg mx-4">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-lg font-bold text-gray-800" id="system-message-title">Information</h3>
                        <button onclick="closeSystemMessage()" class="text-gray-500 hover:text-gray-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <div id="system-message-content" class="text-gray-600 mb-6">
                        Message content will appear here.
                    </div>
                    <div class="flex justify-end">
                        <button onclick="closeSystemMessage()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                            OK
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CLINs Section: Table + Details (combined) -->
    <div class="card card-padded !p-2 mt-2">
        <div class="flex justify-between items-center mb-1">
            <h2 class="text-lg font-bold text-gray-800">Contract Line Items (CLINs)</h2>
            {% if contract.status.description == 'Open' %}
            <a href="{% url 'contracts:contract_clin_create' contract.id %}"
               class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 text-sm rounded-md">
                Add CLIN
            </a>
            {% endif %}
        </div>
        <div class="grid grid-cols-12 gap-2">
            <!-- CLIN Table - left ~35% -->
            <div class="col-span-4 overflow-x-auto max-h-[220px] overflow-y-auto border border-gray-200 rounded">
            <div class="min-w-full">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-3 py-1 bg-gray-50 text-left text-xs label tracking-wider">
                                Item No
                            </th>
                            <th class="px-3 py-1 bg-gray-50 text-left text-xs label tracking-wider">
                                Item Type
                            </th>
                            <th class="px-3 py-1 bg-gray-50 text-left text-xs label tracking-wider">
                                Supplier
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for clin in clins %}
                        <tr id="clin-row-{{ clin.id }}"
                            data-clin-id="{{ clin.id }}"
                            class="{% if selected_clin and clin.id == selected_clin.id %}selected-row{% endif %} hover:bg-gray-50 transition-colors duration-150 cursor-pointer clin-row">
                            <td class="px-3 py-1 whitespace-nowrap text-sm text-gray-900">
                                {{ clin.item_number|default:"0000" }}
                            </td>
                            <td class="px-3 py-1 whitespace-nowrap text-sm text-gray-900">
                                {{ clin.get_item_type_display|default:"—" }}
                            </td>
                            <td class="px-3 py-1 whitespace-nowrap text-sm text-gray-900">
                                {% if clin.supplier %}{{ clin.supplier.name }}{% else %}N/A{% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-3 py-2 text-center text-gray-500 text-sm">
                                No CLINs found for this contract
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            </div>
            <!-- CLIN Details Panel - right ~65% -->
            <div class="col-span-8 border border-gray-200 rounded bg-gray-50 p-2 min-h-[200px]" id="clin-details-panel">
                <div id="clin-details-content" class="text-sm">
                    {% if selected_clin %}
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                        <div><span class="text-gray-600">Type:</span> <span id="cd-type">{{ selected_clin.get_item_type_display|default:"—" }}</span></div>
                        <div><span class="text-gray-600">Sub PO #:</span> <span id="cd-po">{{ selected_clin.clin_po_num|default:selected_clin.po_number|default:"—" }}</span></div>
                        <div class="col-span-2"><span class="text-gray-600">Supplier:</span>
                            {% if selected_clin.supplier %}
                            <span id="cd-supplier-name">{% if selected_clin.supplier.name %}{{ selected_clin.supplier.name }}{% else %}N/A{% endif %}</span>
                            <button type="button" onclick="openSupplierInfoModal({{ selected_clin.supplier.id }})" class="ml-1 text-xs text-blue-600 hover:text-blue-800 underline">Supplier Info</button>
                            {% else %}<span id="cd-supplier">N/A</span>{% endif %}
                        </div>
                        <div class="col-span-2"><span class="text-gray-600">NSN:</span>
                            {% if selected_clin.nsn %}
                            <a href="{% url 'contracts:nsn_edit' selected_clin.nsn.id %}" target="_blank" class="text-blue-600 hover:text-blue-800" id="cd-nsn-link">{{ selected_clin.nsn.nsn_code }}{% if selected_clin.nsn.description %} ({{ selected_clin.nsn.description }}){% endif %}</a>
                            {% else %}<span id="cd-nsn">N/A</span>{% endif %}
                        </div>
                        <div><span class="text-gray-600">I&A:</span> <span id="cd-ia">{% if selected_clin.ia %}{{ selected_clin.get_ia_display }}{% else %}—{% endif %}</span></div>
                        <div><span class="text-gray-600">FOB:</span> <span id="cd-fob">{% if selected_clin.fob %}{{ selected_clin.get_fob_display }}{% else %}—{% endif %}</span></div>
                        <div class="col-span-2"><span class="text-gray-600">Special Payment Terms:</span> <span id="cd-spt">{% if selected_clin.special_payment_terms %}{{ selected_clin.special_payment_terms }}{% else %}—{% endif %}</span></div>
                        <div><span class="text-gray-600">Sub Due Date:</span> <span id="cd-sub-due" class="{% if selected_clin.supplier_due_date_late %}text-red-600{% endif %}">{% if selected_clin.supplier_due_date %}{{ selected_clin.supplier_due_date|date:"m/d/Y" }}{% else %}N/A{% endif %}</span></div>
                        <div><span class="text-gray-600">Quoted Due Date:</span> <span id="cd-quoted-due" class="{% if selected_clin.supplier_due_date_late %}text-red-600{% endif %}">{% if selected_clin.supplier_due_date %}{{ selected_clin.supplier_due_date|date:"m/d/Y" }}{% elif selected_clin.due_date %}{{ selected_clin.due_date|date:"m/d/Y" }}{% else %}N/A{% endif %}</span></div>
                        <div><span class="text-gray-600">Order Qty:</span> <span id="cd-order-qty">{{ selected_clin.order_qty|floatformat:'0'|default:"—" }} {{ selected_clin.uom|default:"EA" }}</span></div>
                        <div><span class="text-gray-600">Ship Qty:</span> <span id="cd-ship-qty">{{ selected_clin.ship_qty|floatformat:'0'|default:"—" }}</span></div>
                        <div><span class="text-gray-600">Ship Date:</span> <span id="cd-ship-date">{% if selected_clin.ship_date %}{{ selected_clin.ship_date|date:"m/d/Y" }}{% else %}—{% endif %}</span></div>
                        <div><span class="text-gray-600">Item Value:</span> <span id="cd-item-value">{% if selected_clin.item_value %}${% endif %}{{ selected_clin.item_value|floatformat:2|default:"—" }}</span></div>
                        <div class="col-span-2 flex gap-2 items-center">
                            <a href="{% url 'contracts:clin_update' selected_clin.id %}" class="text-indigo-600 hover:text-indigo-900 text-xs font-medium">Edit CLIN</a>
                            <a href="{% url 'contracts:clin_detail' selected_clin.id %}" class="text-blue-600 hover:text-blue-800 text-xs">View Full</a>
                        </div>
                    </div>
                    {% else %}
                    <p id="clin-details-placeholder" class="text-gray-500">Select a CLIN above to view details.</p>
                    <div id="clin-details-fetched" class="hidden"></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Notes & Gov Actions (higher priority) -->
    <div class="grid grid-cols-3 gap-4 mt-2">
        <!-- Notes Section - Contract and CLIN tabs -->
        <div class="col-span-2 card card-padded !p-2">
            <div class="flex justify-between items-center mb-1">
                <h2 class="text-lg font-bold text-gray-800">Notes</h2>
                <div class="flex space-x-3">
                    <button
                        class="notes-add-contract-btn bg-green-500 hover:bg-green-600 text-white px-3 py-1 text-sm rounded-md"
                        data-note-action="add"
                        data-content-type-id="{{ contract_content_type_id|default:'18' }}"
                        data-object-id="{{ contract.id }}"
                        data-entity-type="Contract"
                    >
                        Add Contract Note
                    </button>
                    <button
                        class="notes-add-clin-btn bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 text-sm rounded-md js-add-clin-note"
                        data-note-action="add"
                        data-content-type-id="{{ clin_content_type_id|default:'12' }}"
                        data-object-id="{{ selected_clin.id|default:'' }}"
                        data-entity-type="CLIN"
                        {% if not selected_clin %}disabled{% endif %}
                    >
                        Add CLIN Note
                    </button>
                </div>
            </div>
            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-2">
                <nav class="flex space-x-2" aria-label="Notes tabs">
                    <button type="button" id="notes-tab-contract" onclick="switchNotesTab('contract')"
                        class="notes-tab-btn py-1 px-2 border-b-2 font-medium text-sm
                        border-green-500 text-green-600 bg-green-50">
                        Contract
                    </button>
                    {% for clin in clins %}
                    <button type="button" id="notes-tab-clin-{{ clin.id }}" data-clin-id="{{ clin.id }}" onclick="switchToClinTab({{ clin.id }})"
                        class="notes-tab-btn py-1 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        CLIN ({{ clin.item_number|default:"—" }})
                    </button>
                    {% endfor %}
                </nav>
            </div>
            <!-- Contract tab content -->
            <div id="notes-panel-contract" class="notes-panel space-y-2 max-h-[360px] overflow-y-auto">
                {% include "contracts/partials/notes_list.html" with notes=contract_notes entity_type="contract" show_note_type=False content_type_id=contract_content_type_id object_id=contract.id note_empty_msg="No contract notes" %}
            </div>
            <!-- CLIN tab content (single panel, populated via fetch when a CLIN tab is clicked) -->
            <div id="notes-panel-clin" class="notes-panel hidden space-y-2 max-h-[360px] overflow-y-auto">
                {% if selected_clin %}
                {% include "contracts/partials/notes_list.html" with notes=clin_notes entity_type="clin" show_note_type=False content_type_id=clin_content_type_id object_id=selected_clin.id note_empty_msg="No CLIN notes" %}
                {% else %}
                <p class="text-gray-500 text-center py-2 text-sm">{% if clins %}Click a CLIN tab above to view its notes.{% else %}No CLINs in this contract.{% endif %}</p>
                {% endif %}
            </div>
        </div>

        <!-- Gov Actions & Log Fields - 1/3 width -->
        <div class="col-span-1 card card-padded !p-2">
            <div class="border-b border-gray-200 mb-2">
                <nav class="flex space-x-2" aria-label="Gov Actions and Log Fields tabs">
                    <button type="button" id="gov-tab-govactions" onclick="switchGovLogTab('govactions')"
                        class="gov-log-tab-btn py-1 px-2 border-b-2 font-medium text-sm border-blue-500 text-blue-600 bg-blue-50">
                        Gov Actions
                    </button>
                    <button type="button" id="gov-tab-logfields" onclick="switchGovLogTab('logfields')"
                        class="gov-log-tab-btn py-1 px-2 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        Log Fields
                    </button>
                </nav>
            </div>
            <!-- Gov Actions tab -->
            <div id="gov-panel-govactions" class="gov-log-panel">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium text-gray-700">Contract Gov Actions</span>
                    <button type="button" onclick="openGovActionModal()" class="text-blue-600 hover:text-blue-800 inline-flex items-center" title="Add Gov Action">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        <span class="ml-1 text-sm">New</span>
                    </button>
                </div>
                <div class="overflow-x-auto max-h-[220px] overflow-y-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-2 py-1 text-left text-xs font-medium text-gray-600">Action</th>
                                <th class="px-2 py-1 text-left text-xs font-medium text-gray-600">Number</th>
                                <th class="px-2 py-1 text-left text-xs font-medium text-gray-600">Request</th>
                                <th class="px-2 py-1 text-left text-xs font-medium text-gray-600">Date Sub.</th>
                                <th class="px-2 py-1 text-left text-xs font-medium text-gray-600">Date Closed</th>
                                <th class="px-2 py-1 text-left text-xs font-medium text-gray-600">Initiated</th>
                                <th class="px-2 py-1 w-8"></th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="gov-actions-tbody">
                            {% for ga in gov_actions %}
                            <tr data-gov-action-id="{{ ga.id }}">
                                <td class="px-2 py-1">{{ ga.get_action_display|default:ga.action|default:"—" }}</td>
                                <td class="px-2 py-1">{{ ga.number|default:"—" }}</td>
                                <td class="px-2 py-1">{{ ga.get_request_display|default:ga.request|default:"—" }}</td>
                                <td class="px-2 py-1">{{ ga.date_submitted|date:"m/d/Y"|default:"—" }}</td>
                                <td class="px-2 py-1">{{ ga.date_closed|date:"m/d/Y"|default:"—" }}</td>
                                <td class="px-2 py-1">{{ ga.get_initiated_display|default:ga.initiated|default:"—" }}</td>
                                <td class="px-2 py-1">
                                    <button type="button" onclick="confirmDeleteGovAction({{ ga.id }})" class="text-red-600 hover:text-red-800" title="Delete">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    </button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr data-empty-gov-row><td colspan="7" class="px-2 py-4 text-center text-gray-500">No gov actions. Click New to add.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Log Fields tab (tied to selected CLIN; populated via JS when switching CLINs) -->
            <div id="gov-panel-logfields" class="gov-log-panel hidden">
                <p id="log-fields-clin-label" class="text-xs text-gray-500 mb-1">{% if selected_clin %}For CLIN {{ selected_clin.item_number|default:"—" }}{% else %}Select a CLIN above{% endif %}</p>
                <div class="space-y-2" id="log-fields-form-wrap">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-0.5">Status</label>
                        <textarea id="log-field-status" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" placeholder="Enter status...">{% if selected_clin %}{{ selected_clin.log_status|default:"" }}{% endif %}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-0.5">Notes</label>
                        <textarea id="log-field-notes" rows="3" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" placeholder="Enter notes...">{% if selected_clin %}{{ selected_clin.log_notes|default:"" }}{% endif %}</textarea>
                    </div>
                    <button type="button" onclick="saveLogFields()" id="log-fields-save-btn" class="px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white text-sm rounded-md" {% if not selected_clin %}disabled{% endif %}>Save</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include Note Modal -->
{% include "contracts/partials/note_modal.html" %}
{% include "contracts/includes/cancel_contract_modal.html" %}

<!-- Gov Action Modal -->
<div id="govActionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 99999;" onclick="if(event.target===this)closeGovActionModal()">
    <div class="relative top-16 mx-auto p-6 border shadow-lg rounded-md bg-white" style="width: 480px !important; max-width: 95%;" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Add Gov Action</h3>
            <button type="button" onclick="closeGovActionModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form id="gov-action-form" onsubmit="submitGovAction(event)">
            {% csrf_token %}
            <div class="space-y-3 text-sm">
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Action</label>
                    <select name="action" id="gov-action-action" class="w-full rounded-md border-gray-300 shadow-sm">
                        <option value="">—</option>
                        <option value="PAR">PAR</option>
                        <option value="RFV">RFV</option>
                        <option value="ECP">ECP</option>
                        <option value="QN">QN</option>
                        <option value="NCR">NCR</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Number</label>
                    <input type="text" name="number" id="gov-action-number" class="w-full rounded-md border-gray-300 shadow-sm" placeholder="Number">
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Request</label>
                    <select name="request" id="gov-action-request" class="w-full rounded-md border-gray-300 shadow-sm">
                        <option value="">—</option>
                        <option value="Admin">Admin</option>
                        <option value="Technical">Technical</option>
                        <option value="Extension">Extension</option>
                        <option value="Cancellation">Cancellation</option>
                        <option value="Qty Change">Qty Change</option>
                        <option value="Litigation">Litigation</option>
                        <option value="Price">Price</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Date Submitted</label>
                    <input type="date" name="date_submitted" id="gov-action-date-submitted" class="w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Date Closed</label>
                    <input type="date" name="date_closed" id="gov-action-date-closed" class="w-full rounded-md border-gray-300 shadow-sm">
                </div>
                <div>
                    <label class="block font-medium text-gray-700 mb-1">Initiated</label>
                    <select name="initiated" id="gov-action-initiated" class="w-full rounded-md border-gray-300 shadow-sm">
                        <option value="">—</option>
                        <option value="STATZ">STATZ</option>
                        <option value="Gov">Gov</option>
                        <option value="Supplier">Supplier</option>
                    </select>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-2">
                <button type="button" onclick="closeGovActionModal()" class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">Add</button>
            </div>
        </form>
    </div>
</div>

<!-- Supplier Info Modal -->
<div id="supplierInfoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 99999;" onclick="if(event.target===this)closeSupplierInfoModal()">
    <div class="relative top-10 mx-auto p-6 border shadow-lg rounded-md bg-white max-w-2xl mb-10" onclick="event.stopPropagation()">
        <div id="supplier-info-loading" class="text-center py-8 text-gray-500">Loading...</div>
        <div id="supplier-info-content" class="hidden">
            <div class="flex justify-between items-start mb-4">
                <h3 id="supplier-info-name" class="text-xl font-semibold text-gray-800">Supplier Name</h3>
                <button type="button" onclick="closeSupplierInfoModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-3 text-sm">
                <div><span class="text-gray-600 font-medium">CAGE Code:</span> <span id="supplier-info-cage">—</span></div>
                <div><span class="text-gray-600 font-medium">Supplier Contact:</span> <span id="supplier-info-contact">—</span></div>
                <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-gray-600 font-medium">Email:</span>
                    <span id="supplier-info-email" class="mr-2">—</span>
                    <button type="button" onclick="copyToClipboard(document.getElementById('supplier-info-email').dataset.value || document.getElementById('supplier-info-email').textContent, 'Email')" class="text-xs px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded" title="Copy">Copy</button>
                </div>
                <div class="flex flex-wrap gap-2 items-center">
                    <span class="text-gray-600 font-medium">Phone:</span>
                    <span id="supplier-info-phone" class="mr-2">—</span>
                    <button type="button" onclick="copyToClipboard(document.getElementById('supplier-info-phone').dataset.value || document.getElementById('supplier-info-phone').textContent, 'Phone')" class="text-xs px-2 py-0.5 bg-gray-100 hover:bg-gray-200 rounded" title="Copy">Copy</button>
                </div>
                <!-- Probation & Conditional indicators -->
                <div class="flex gap-4">
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600 font-medium">Probation:</span>
                        <span id="supplier-info-probation" class="inline-block w-4 h-4 rounded border border-gray-300" title="Probation"></span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-gray-600 font-medium">Conditions:</span>
                        <span id="supplier-info-conditional" class="inline-block w-4 h-4 rounded border border-gray-300" title="Conditional"></span>
                    </div>
                </div>
                <!-- Address tabs: Physical, Billing, Shipping -->
                <div>
                    <div class="text-gray-600 font-medium mb-1">Addresses</div>
                    <div class="border border-gray-200 rounded">
                        <div class="flex border-b border-gray-200">
                            <button type="button" data-addr-tab="physical" class="supplier-addr-tab px-3 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600">Physical</button>
                            <button type="button" data-addr-tab="billing" class="supplier-addr-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500">Billing</button>
                            <button type="button" data-addr-tab="shipping" class="supplier-addr-tab px-3 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500">Shipping</button>
                        </div>
                        <div id="supplier-addr-physical" class="supplier-addr-panel p-3 text-gray-700"></div>
                        <div id="supplier-addr-billing" class="supplier-addr-panel hidden p-3 text-gray-700"></div>
                        <div id="supplier-addr-shipping" class="supplier-addr-panel hidden p-3 text-gray-700"></div>
                    </div>
                </div>
                <div>
                    <div class="text-gray-600 font-medium mb-1">Supplier Notes</div>
                    <div id="supplier-info-notes" class="p-2 bg-gray-50 rounded text-gray-700 whitespace-pre-wrap max-h-32 overflow-y-auto">—</div>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <a id="supplier-info-full-link" href="#" target="_blank" class="text-sm text-blue-600 hover:text-blue-800">View Full Supplier Page →</a>
            </div>
        </div>
    </div>
</div>

<!-- Contract Search Modal -->
<div id="contractSearchModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 99999;" onclick="if(event.target===this)closeContractSearchModal()">
    <div class="relative top-20 mx-auto p-6 border shadow-lg rounded-md bg-white" style="width: 520px !important; max-width: 95%;" onclick="event.stopPropagation()">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold text-gray-800">Jump to Contract</h3>
            <button type="button" onclick="closeContractSearchModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div class="space-y-4">
            <div class="flex items-center gap-4 flex-wrap">
                <div class="relative flex-1 min-w-[200px]">
                    <input type="text" id="contract-search-modal-input"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        placeholder="Search by contract number, last 4 digits, or PO number..."
                        autocomplete="off">
                    <div id="contract-search-modal-results"
                        class="absolute z-50 w-full card mt-1 border-gray-200 max-h-64 overflow-y-auto hidden">
                    </div>
                </div>
                <div class="flex items-center gap-3 shrink-0">
                    <span class="text-sm font-medium text-gray-700">Status:</span>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="contract-search-status" value="open" class="rounded-full border-gray-300 text-blue-600 focus:ring-blue-500 mr-1.5">
                        <span class="text-sm text-gray-700">Open</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="contract-search-status" value="closed" class="rounded-full border-gray-300 text-blue-600 focus:ring-blue-500 mr-1.5">
                        <span class="text-sm text-gray-700">Closed</span>
                    </label>
                    <label class="inline-flex items-center cursor-pointer">
                        <input type="radio" name="contract-search-status" value="both" checked class="rounded-full border-gray-300 text-blue-600 focus:ring-blue-500 mr-1.5">
                        <span class="text-sm text-gray-700">Both</span>
                    </label>
                </div>
            </div>
            <p class="text-sm text-gray-500">Type at least 3 characters (e.g. last 4 digits of contract number). Click a contract to jump to it.</p>
        </div>
        <div class="mt-6 flex justify-end gap-2">
            <button type="button" onclick="closeContractSearchModal()" class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Cancel
            </button>
        </div>
    </div>
</div>

<!-- Acknowledgment Letter Modal -->
<div id="acknowledgmentLetterModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden" style="z-index: 99999;">
    <div class="relative top-20 mx-auto p-5 border shadow-lg rounded-md bg-white" style="width: 550px !important; max-width: 550px !important;">
        <div class="flex justify-between items-center pb-3">
            <h3 class="text-xl font-semibold">Purchase Order Acknowledge Letter</h3>
            <button onclick="closeAcknowledgmentLetter()" class="text-gray-400 hover:text-gray-500">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div id="acknowledgmentLetterContent" class="mt-4">
            <!-- Form will be loaded here -->
        </div>
    </div>
</div>

<style>
    .selected-row {
        outline: 3px solid #39ff14;  /* Neon green color */
        outline-offset: -3px;
        position: relative;
        z-index: 1 !important;  /* Force lower z-index */
    }

    /* Custom styling for note containers */
    .note-content {
        max-height: 100px !important;
        overflow-y: auto !important;
        display: block !important;
    }

    /* Notes panels */
    .notes-panel {
        overflow-y: auto !important;
    }

    /* Color coding for notes */
    .contract-note {
        border-left-color: #10B981 !important; /* Green */
    }

    .clin-note {
        border-left-color: #3B82F6 !important; /* Blue */
    }

    /* Ensure modal appears above everything */
    #acknowledgmentLetterModal {
        z-index: 99999 !important;
    }

    /* Ensure form inputs in modal appear above CLIN highlight */
    #acknowledgmentLetterModal input,
    #acknowledgmentLetterModal select,
    #acknowledgmentLetterModal button {
        position: relative;
        z-index: 1;
    }

    /* Modal content styling */
    #acknowledgmentLetterContent input,
    #acknowledgmentLetterContent select {
        width: 100%;
        padding: 0.375rem 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}
{% block extra_js %}
<script src="{% static 'contracts/js/note_modal.js' %}"></script>
<script>
// Contract Search Modal
function openContractSearchModal() {
    const modal = document.getElementById('contractSearchModal');
    if (modal) {
        modal.classList.remove('hidden');
        document.getElementById('contract-search-modal-input').value = '';
        document.getElementById('contract-search-modal-results').innerHTML = '';
        document.getElementById('contract-search-modal-results').classList.add('hidden');
        setTimeout(() => document.getElementById('contract-search-modal-input').focus(), 100);
    }
}
function closeContractSearchModal() {
    const modal = document.getElementById('contractSearchModal');
    if (modal) modal.classList.add('hidden');
}
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('contract-search-modal-input');
    const searchResults = document.getElementById('contract-search-modal-results');
    if (!searchInput || !searchResults) return;
    let debounceTimer;
    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value;
        if (query.length < 3) {
            searchResults.classList.add('hidden');
            return;
        }
        debounceTimer = setTimeout(() => {
            const status = document.querySelector('input[name="contract-search-status"]:checked')?.value || 'both';
            fetch(`/contracts/search/?q=${encodeURIComponent(query)}&status=${encodeURIComponent(status)}`)
                .then(response => response.json())
                .then(data => {
                    searchResults.innerHTML = '';
                    const results = data.results || data;
                    if (results.length > 0) {
                        results.forEach(contract => {
                            const div = document.createElement('div');
                            div.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                            let html = `<div class="text-sm text-blue-600">${contract.contract_number}</div>`;
                            if (contract.po_numbers && contract.po_numbers.length > 0) {
                                html += `<div class="text-xs text-gray-500 mt-1">PO: ${contract.po_numbers.join(', ')}</div>`;
                            }
                            div.innerHTML = html;
                            div.addEventListener('click', function() { window.location.href = "{% url 'contracts:contract_management' 0 %}".replace('/0/', '/' + contract.id + '/'); });
                            searchResults.appendChild(div);
                        });
                        searchResults.classList.remove('hidden');
                    } else {
                        searchResults.classList.add('hidden');
                    }
                });
        }, 300);
    });
    document.querySelectorAll('input[name="contract-search-status"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (searchInput.value.length >= 3) searchInput.dispatchEvent(new Event('input', { bubbles: true }));
        });
    });
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !searchResults.contains(e.target) && !e.target.closest('#contractSearchModal button')) {
            searchResults.classList.add('hidden');
        }
    });
});
</script>
<script>
// Debug ContentType IDs
document.addEventListener('DOMContentLoaded', function() {
    // Fetch content types for debugging
    fetch('/contracts/api/content-types/')
        .then(response => response.json())
        .then(data => {
            // console.log('Available ContentTypes:');
            // data.content_types.forEach(ct => {
            //      console.log(`ID: ${ct.id}, App: ${ct.app_label}, Model: ${ct.model}`);
            // });

            // Check if our content type IDs are valid
            const contractBtn = document.querySelector('[data-entity-type="Contract"]');
            const clinBtn = document.querySelector('[data-entity-type="CLIN"]');

            if (contractBtn) {
                const contractTypeId = contractBtn.dataset.contentTypeId;
                // console.log(`Contract button content type ID: ${contractTypeId}`);
                const matchingType = data.content_types.find(ct => ct.id == contractTypeId);
                if (matchingType) {
                    console.log(`Found matching type: ${matchingType.app_label}.${matchingType.model}`);
                } else {
                    console.error(`No matching content type found for ID: ${contractTypeId}`);
                }
            }

            if (clinBtn) {
                const clinTypeId = clinBtn.dataset.contentTypeId;
                // console.log(`CLIN button content type ID: ${clinTypeId}`);
                const matchingType = data.content_types.find(ct => ct.id == clinTypeId);
                if (matchingType) {
                    console.log(`Found matching type: ${matchingType.app_label}.${matchingType.model}`);
                } else {
                    console.error(`No matching content type found for ID: ${clinTypeId}`);
                }
            }
        })
        .catch(error => {
            console.error('Error fetching content types:', error);
        });
});
</script>

<script>
// Function to copy contract path to clipboard
function copyContractPath(path) {
    // Create temporary textarea to copy from
    const tempTextArea = document.createElement('textarea');
    tempTextArea.value = path;
    document.body.appendChild(tempTextArea);
    tempTextArea.select();

    try {
        // Execute copy command
        document.execCommand('copy');

        // Show toast notification
        const toast = document.getElementById('clipboard-toast');
        toast.classList.remove('hidden');

        // Hide toast after 3 seconds
        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);

        // Display a system message with instructions
        showSystemMessage(
            "Contract Files Location",
            `<p>The file path has been copied to your clipboard:</p>
            <p class="bg-gray-100 p-2 my-2 rounded font-mono text-sm overflow-x-auto">${path}</p>
            <p class="mt-3 font-semibold">Quick Access:</p>
            <p class="mt-1">
                <button onclick="tryDirectOpen('${path.replace(/\\/g, '\\\\')}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                    Try One-Click Open
                </button>
            </p>
            <p class="mt-3 font-semibold">Manual Steps (Keyboard Shortcuts):</p>
            <ol class="list-decimal ml-5 space-y-2 mt-2">
                <li><kbd class="bg-gray-200 px-2 py-1 rounded">Windows+E</kbd> to open Windows Explorer</li>
                <li><kbd class="bg-gray-200 px-2 py-1 rounded">Alt+D</kbd> to select the address bar</li>
                <li><kbd class="bg-gray-200 px-2 py-1 rounded">Ctrl+V</kbd> to paste the path</li>
                <li><kbd class="bg-gray-200 px-2 py-1 rounded">Enter</kbd> to navigate to the folder</li>
            </ol>`
        );
    } catch (err) {
        // Show error message to user
        showSystemMessage(
            "Error Copying Path",
            `<p>Unable to copy the path to your clipboard.</p>
            <p>Please manually copy this path and paste it into File Explorer:</p>
            <p class="bg-gray-100 p-2 my-2 rounded font-mono text-sm overflow-x-auto">${path}</p>`
        );
    } finally {
        // Clean up
        document.body.removeChild(tempTextArea);
    }
}

// Try various methods to open the folder directly
function tryDirectOpen(path) {
    // Handle UNC paths specifically
    if (path.startsWith('\\\\')) {
        // Format UNC path for file protocol
        // Remove any leading or trailing spaces
        path = path.trim();

        // Replace backslashes with forward slashes
        let formattedPath = path.replace(/\\/g, '/');

        // Ensure proper encoding of special characters
        formattedPath = encodeURI(formattedPath);

        // Create the file URL with the correct number of slashes for UNC
        let fileUrl = 'file:' + formattedPath;

        // Try to open the URL
        try {
            window.open(fileUrl, '_blank');
        } catch (e) {
            console.error('Failed to open UNC path:', e);
            // Show manual instructions after a short delay
            setTimeout(() => {
                document.getElementById('try-manual').classList.remove('hidden');
            }, 1500);
        }
    } else {
        // Handle local paths
        try {
            // Convert backslashes to forward slashes and encode
            let formattedPath = path.trim().replace(/\\/g, '/');
            formattedPath = encodeURI(formattedPath);

            // Add file:/// prefix for local paths
            let fileUrl = 'file:///' + formattedPath;
            window.open(fileUrl, '_blank');
        } catch (e) {
            console.error('Failed to open local path:', e);
            setTimeout(() => {
                document.getElementById('try-manual').classList.remove('hidden');
            }, 1500);
        }
    }
}

// Show system message modal
function showSystemMessage(title, content) {
    const modal = document.getElementById('system-message');
    const titleElement = document.getElementById('system-message-title');
    const contentElement = document.getElementById('system-message-content');

    titleElement.textContent = title;
    contentElement.innerHTML = content +
        `<div id="try-manual" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <p class="text-yellow-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                One-click opening may be blocked by your browser. Please use the keyboard shortcuts instead.
            </p>
        </div>`;

    modal.classList.remove('hidden');
}

// Close system message modal
function closeSystemMessage() {
    const modal = document.getElementById('system-message');
    modal.classList.add('hidden');
}

// Define generateLetter function globally
function generateLetter() {
    // Collect form data to send to the server
    const letterId = document.getElementById('acknowledgmentLetterForm').dataset.letterId;
    const formData = new FormData(document.getElementById('acknowledgmentLetterForm'));

    // Add indicator that this is a document generation request, not just a save
    formData.append('action', 'generate');

    // Show loading state
    const generateButton = document.querySelector('button[onclick="generateLetter()"]');
    const originalText = generateButton.innerHTML;
    generateButton.innerHTML = '<span class="inline-flex items-center"><svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Generating...</span>';
    generateButton.disabled = true;

    // Send request to generate letter
    fetch(`/contracts/acknowledgment-letter/${letterId}/generate/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        // Reset button state
        generateButton.innerHTML = originalText;
        generateButton.disabled = false;

        if (data.success) {
            // Open the document in a new window
            window.open(data.file_url, '_blank');

            // Show success message
            const messageDiv = document.createElement('div');
            messageDiv.className = 'mt-3 p-2 bg-green-100 text-green-800 rounded-md';
            messageDiv.textContent = 'Letter generated successfully!';
            document.getElementById('acknowledgmentLetterForm').appendChild(messageDiv);

            // Remove message after 3 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 3000);
        } else {
            // Show error
            alert(data.error || 'Error generating letter');
            console.error('Error details:', data.details);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        generateButton.innerHTML = originalText;
        generateButton.disabled = false;
        alert('Error generating letter. Please try again.');
    });
}

// Legacy function kept for reference
function openContractFiles(path) {
    // Format the path correctly for Windows file explorer
    // Replace backslashes with forward slashes for URI compatibility
    // For network paths (UNC), use the proper file:// protocol format
    if (path.startsWith('\\\\')) {
        // For UNC paths like \\server\share\path, use file://// format
        const formattedPath = 'file:////' + path.replace(/\\/g, '/');
        // Display a system message with the path information
        showSystemMessage(
            "UNC Path Detected",
            `<p>Attempting to open UNC path:</p>
            <p class="bg-gray-100 p-2 my-2 rounded font-mono text-sm">${path}</p>
            <p>If the folder doesn't open automatically, please copy and paste this path into File Explorer.</p>`
        );
        window.open(formattedPath, '_blank');
    } else {
        // For local paths, use regular file:// format
        showSystemMessage(
            "Local Path Detected",
            `<p>Attempting to open local path:</p>
            <p class="bg-gray-100 p-2 my-2 rounded font-mono text-sm">${path}</p>
            <p>If the folder doesn't open automatically, please copy and paste this path into File Explorer.</p>`
        );
        window.open('file://' + path.replace(/\\/g, '/'), '_blank');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers to all CLIN rows
    document.querySelectorAll('.clin-row').forEach(row => {
        row.addEventListener('click', function() {
            const clinId = this.dataset.clinId;
            const clinElement = this;
            selectClin(clinId, clinElement);
        });
    });

    // Select default CLIN if it exists
    const defaultClinId = '{{ selected_clin.id|default:"" }}';
    if (defaultClinId) {
        const defaultClinElement = document.getElementById(`clin-row-${defaultClinId}`);
        if (defaultClinElement) {
            selectClin(defaultClinId, defaultClinElement);
        }
    }

    // Initialize NIST button state
    const nistBtn = document.getElementById('nist_btn');
    if (nistBtn) {
        const isNistCertified = nistBtn.dataset.nistState === 'true';
        // The button classes are already set in the template, no need to adjust them here
    }
});

// Function to open edit note modal - directly called by button onclick
function openEditNoteModal(button) {
    // Prevent default button behavior
    event.preventDefault();
    event.stopPropagation();

    const noteId = button.dataset.noteId;
    const noteText = button.dataset.noteText;
    const contentTypeId = button.dataset.contentTypeId;
    const objectId = button.dataset.objectId;
    const entityType = button.dataset.entityType;

    console.log("Opening edit modal for note:", noteId);

    // Set modal for edit mode
    const noteModal = document.getElementById('noteModal');
    const noteModalTitle = document.getElementById('noteModalTitle');
    const noteForm = document.getElementById('noteForm');
    const noteTextArea = document.getElementById('id_note');
    const noteContentTypeIdInput = document.getElementById('noteContentTypeId');
    const noteObjectIdInput = document.getElementById('noteObjectId');

    // Update modal title and form action
    noteModalTitle.textContent = `Edit ${entityType} Note`;

    // Match the URL pattern and parameter name expected by Django
    noteForm.action = `/contracts/note/update/${noteId}/`;
    noteForm.method = 'POST';  // Ensure form method is POST

    // Set form values - decode Unicode escape sequences like \u000D\u000A back to newlines
    noteTextArea.value = decodeUnicodeEscapes(noteText);
    noteContentTypeIdInput.value = contentTypeId;
    noteObjectIdInput.value = objectId;

    // Show modal
    noteModal.classList.remove('hidden');
    return false;
}

// Helper function to decode Unicode escape sequences like \u000D\u000A back to actual newlines
function decodeUnicodeEscapes(str) {
    return str.replace(/\\u([0-9a-f]{4})/gi, function(match, grp) {
        return String.fromCharCode(parseInt(grp, 16));
    });
}

function selectClin(clinId, clinElement) {
    // Remove highlight from all rows and add it to the selected row
    document.querySelectorAll('.clin-row').forEach(row => {
        row.classList.remove('selected-row');
    });
    clinElement.classList.add('selected-row');

    // Update all CLIN Add Note buttons with the selected CLIN ID and enable them
    document.querySelectorAll('.notes-add-clin-btn, [data-entity-type="CLIN"]').forEach(btn => {
        btn.dataset.objectId = clinId;
        btn.removeAttribute('disabled');
    });

    // Fetch CLIN details, notes, and log fields
    fetchClinDetails(clinId);
    fetchClinNotes(clinId);
    fetchLogFields(clinId);
}

function switchToClinTab(clinId) {
    // Sync row selection
    document.querySelectorAll('.clin-row').forEach(row => {
        row.classList.remove('selected-row');
        if (row.dataset.clinId === String(clinId)) row.classList.add('selected-row');
    });
    document.querySelectorAll('.notes-add-clin-btn, [data-entity-type="CLIN"]').forEach(btn => {
        btn.dataset.objectId = clinId;
        btn.removeAttribute('disabled');
    });
    fetchClinDetails(clinId);
    fetchClinNotes(clinId);
    fetchLogFields(clinId);
}

// Gov Actions & Log Fields
let currentClinIdForLogFields = '{{ selected_clin.id|default:"" }}';

function switchGovLogTab(tab) {
    document.querySelectorAll('.gov-log-panel').forEach(panel => panel.classList.add('hidden'));
    document.querySelectorAll('.gov-log-tab-btn').forEach(btn => {
        btn.classList.remove('border-blue-500', 'text-blue-600', 'bg-blue-50');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    const panel = document.getElementById(`gov-panel-${tab}`);
    const tabBtn = document.getElementById(`gov-tab-${tab}`);
    if (panel) panel.classList.remove('hidden');
    if (tabBtn) {
        tabBtn.classList.remove('border-transparent', 'text-gray-500');
        tabBtn.classList.add('border-blue-500', 'text-blue-600', 'bg-blue-50');
    }
}

function openGovActionModal() {
    document.getElementById('govActionModal').classList.remove('hidden');
    document.getElementById('gov-action-form').reset();
}

function closeGovActionModal() {
    document.getElementById('govActionModal').classList.add('hidden');
}

let currentSupplierInfoData = null;

function openSupplierInfoModal(supplierId) {
    const modal = document.getElementById('supplierInfoModal');
    const loading = document.getElementById('supplier-info-loading');
    const content = document.getElementById('supplier-info-content');
    if (!modal || !supplierId) return;
    modal.classList.remove('hidden');
    loading.textContent = 'Loading...';
    loading.classList.remove('hidden');
    content.classList.add('hidden');
    const url = "{{ supplier_info_url_base|default:'/contracts/supplier/' }}" + supplierId + "/info/";
    fetch(url, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.json())
        .then(data => {
            loading.classList.add('hidden');
            if (!data.success) {
                content.classList.remove('hidden');
                content.innerHTML = '<p class="text-red-600">Failed to load supplier info.</p>';
                return;
            }
            currentSupplierInfoData = data;
            document.getElementById('supplier-info-name').textContent = data.name;
            document.getElementById('supplier-info-cage').textContent = data.cage_code;
            document.getElementById('supplier-info-contact').textContent = data.contact_name;
            document.getElementById('supplier-info-email').textContent = data.contact_email;
            document.getElementById('supplier-info-email').dataset.value = data.contact_email;
            document.getElementById('supplier-info-phone').textContent = data.contact_phone;
            document.getElementById('supplier-info-phone').dataset.value = data.contact_phone;
            document.getElementById('supplier-info-notes').textContent = data.notes;
            document.getElementById('supplier-info-probation').className = 'inline-block w-4 h-4 rounded border ' + (data.probation ? 'bg-red-500 border-red-600' : 'bg-green-500 border-green-600');
            document.getElementById('supplier-info-probation').title = data.probation ? 'On Probation' : 'Not on Probation';
            document.getElementById('supplier-info-conditional').className = 'inline-block w-4 h-4 rounded border ' + (data.conditional ? 'bg-red-500 border-red-600' : 'bg-green-500 border-green-600');
            document.getElementById('supplier-info-conditional').title = data.conditional ? 'Conditional' : 'Not Conditional';
            const fmtAddr = (a) => a && a.display ? a.display : '—';
            document.getElementById('supplier-addr-physical').textContent = fmtAddr(data.physical_address);
            document.getElementById('supplier-addr-billing').textContent = fmtAddr(data.billing_address);
            document.getElementById('supplier-addr-shipping').textContent = fmtAddr(data.shipping_address);
            const fullUrl = "{% url 'suppliers:supplier_detail' 0 %}".replace('/0/', `/${supplierId}/`);
            const fullLink = document.getElementById('supplier-info-full-link');
            fullLink.href = fullUrl;
            fullLink.classList.remove('hidden');
            content.classList.remove('hidden');
            document.querySelectorAll('.supplier-addr-tab').forEach(btn => btn.classList.remove('border-blue-500', 'text-blue-600', 'border-transparent', 'text-gray-500'));
            document.querySelector('[data-addr-tab="physical"]').classList.add('border-blue-500', 'text-blue-600');
            document.querySelectorAll('.supplier-addr-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById('supplier-addr-physical').classList.remove('hidden');
        })
        .catch(() => {
            loading.innerHTML = '<p class="text-red-600 py-4">Failed to load supplier info.</p>';
        });
}

function closeSupplierInfoModal() {
    document.getElementById('supplierInfoModal').classList.add('hidden');
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.supplier-addr-tab').forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.dataset.addrTab;
            document.querySelectorAll('.supplier-addr-tab').forEach(b => { b.classList.remove('border-blue-500', 'text-blue-600'); b.classList.add('border-transparent', 'text-gray-500'); });
            this.classList.remove('border-transparent', 'text-gray-500');
            this.classList.add('border-blue-500', 'text-blue-600');
            document.querySelectorAll('.supplier-addr-panel').forEach(p => p.classList.add('hidden'));
            const panel = document.getElementById('supplier-addr-' + tab);
            if (panel) panel.classList.remove('hidden');
        });
    });
});

function copyToClipboard(text, label) {
    const val = (typeof text === 'string' ? text : '').trim();
    if (!val || val === '—') return;
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(val).then(() => {
            const toast = document.getElementById('clipboard-toast');
            if (toast) { toast.textContent = (label || 'Value') + ' copied!'; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 2000); }
        });
    } else {
        const ta = document.createElement('textarea');
        ta.value = val;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        const toast = document.getElementById('clipboard-toast');
        if (toast) { toast.textContent = (label || 'Value') + ' copied!'; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 2000); }
    }
}

function submitGovAction(e) {
    e.preventDefault();
    const form = document.getElementById('gov-action-form');
    const formData = new FormData(form);
    formData.append('csrfmiddlewaretoken', document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value);
    fetch("{% url 'contracts:gov_action_create' contract.id %}", {
        method: 'POST',
        body: formData,
        credentials: 'same-origin',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            closeGovActionModal();
            const tbody = document.getElementById('gov-actions-tbody');
            const emptyRow = tbody.querySelector('tr[data-empty-gov-row]');
            if (emptyRow) emptyRow.remove();
            const tr = document.createElement('tr');
            tr.dataset.govActionId = data.id;
            tr.innerHTML = `<td class="px-2 py-1">${data.action || '—'}</td><td class="px-2 py-1">${data.number || '—'}</td><td class="px-2 py-1">${data.request || '—'}</td><td class="px-2 py-1">${data.date_submitted ? new Date(data.date_submitted).toLocaleDateString() : '—'}</td><td class="px-2 py-1">${data.date_closed ? new Date(data.date_closed).toLocaleDateString() : '—'}</td><td class="px-2 py-1">${data.initiated || '—'}</td><td class="px-2 py-1"><button type="button" onclick="confirmDeleteGovAction(${data.id})" class="text-red-600 hover:text-red-800" title="Delete"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td>`;
            tbody.appendChild(tr);
        } else {
            alert(data.error || data.errors || 'Failed to add Gov Action.');
        }
    })
    .catch(err => { console.error(err); alert('Error adding Gov Action.'); });
}

function confirmDeleteGovAction(id) {
    if (confirm('Are you sure you want to delete this Gov Action?')) {
        deleteGovAction(id);
    }
}

function deleteGovAction(id) {
    fetch(`/contracts/gov-action/${id}/delete/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`tr[data-gov-action-id="${id}"]`);
            if (row) row.remove();
            const tbody = document.getElementById('gov-actions-tbody');
            if (tbody && tbody.querySelectorAll('tr').length === 0) {
                const tr = document.createElement('tr');
                tr.setAttribute('data-empty-gov-row', '');
                tr.innerHTML = '<td colspan="7" class="px-2 py-4 text-center text-gray-500">No gov actions. Click New to add.</td>';
                tbody.appendChild(tr);
            }
        }
    });
}

function fetchClinDetails(clinId) {
    const panel = document.getElementById('clin-details-content');
    if (!panel) return;
    if (!clinId) {
        panel.innerHTML = '<p id="clin-details-placeholder" class="text-gray-500">Select a CLIN above to view details.</p>';
        return;
    }
    const url = "{% url 'contracts:get_clin_details' 0 %}".replace('/0/', `/${clinId}/`);
    fetch(url, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                panel.innerHTML = '<p class="text-red-600">Failed to load CLIN details.</p>';
                return;
            }
            const d = data;
            const fmt = (v) => (v === null || v === undefined || v === '') ? '—' : String(v);
            const qty = d.order_qty !== '—' ? (Number(d.order_qty) === d.order_qty ? d.order_qty.toFixed(0) : d.order_qty) : '—';
            const shipQty = d.ship_qty !== '—' ? (Number(d.ship_qty) === d.ship_qty ? d.ship_qty.toFixed(0) : d.ship_qty) : '—';
            const itemVal = d.item_value !== '—' ? '$' + (Number(d.item_value) ? parseFloat(d.item_value).toFixed(2) : d.item_value) : '—';
            const supplierHtml = d.supplier_id
                ? `<span>${fmt(d.supplier_name)}</span> <button type="button" onclick="event.stopPropagation(); openSupplierInfoModal(${d.supplier_id})" class="ml-1 text-xs text-blue-600 hover:text-blue-800 underline">Supplier Info</button>`
                : 'N/A';
            const nsnUrl = d.nsn_id ? "{% url 'contracts:nsn_edit' 0 %}".replace('/0/', `/${d.nsn_id}/`) : null;
            const nsnHtml = nsnUrl
                ? `<a href="${nsnUrl}" target="_blank" class="text-blue-600 hover:text-blue-800">${fmt(d.nsn)}</a>`
                : fmt(d.nsn);
            const lateClass = d.supplier_due_date_late ? 'text-red-600' : '';
            const editUrl = "{% url 'contracts:clin_update' 0 %}".replace('/0/', `/${d.id}/`);
            const viewUrl = "{% url 'contracts:clin_detail' 0 %}".replace('/0/', `/${d.id}/`);
            panel.innerHTML = `
                <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs">
                    <div><span class="text-gray-600">Type:</span> <span>${fmt(d.item_type)}</span></div>
                    <div><span class="text-gray-600">Sub PO #:</span> <span>${fmt(d.clin_po_num)}</span></div>
                    <div class="col-span-2"><span class="text-gray-600">Supplier:</span> ${supplierHtml}</div>
                    <div class="col-span-2"><span class="text-gray-600">NSN:</span> ${nsnHtml}</div>
                    <div><span class="text-gray-600">I&A:</span> <span>${fmt(d.ia)}</span></div>
                    <div><span class="text-gray-600">FOB:</span> <span>${fmt(d.fob)}</span></div>
                    <div class="col-span-2"><span class="text-gray-600">Special Payment Terms:</span> <span>${fmt(d.special_payment_terms)}</span></div>
                    <div><span class="text-gray-600">Sub Due Date:</span> <span class="${lateClass}">${fmt(d.supplier_due_date)}</span></div>
                    <div><span class="text-gray-600">Quoted Due Date:</span> <span class="${lateClass}">${fmt(d.quoted_due_date)}</span></div>
                    <div><span class="text-gray-600">Order Qty:</span> <span>${qty} ${d.uom || 'EA'}</span></div>
                    <div><span class="text-gray-600">Ship Qty:</span> <span>${shipQty}</span></div>
                    <div><span class="text-gray-600">Ship Date:</span> <span>${fmt(d.ship_date)}</span></div>
                    <div><span class="text-gray-600">Item Value:</span> <span>${itemVal}</span></div>
                    <div class="col-span-2 flex gap-2 items-center">
                        <a href="${editUrl}" class="text-indigo-600 hover:text-indigo-900 text-xs font-medium">Edit CLIN</a>
                        <a href="${viewUrl}" class="text-blue-600 hover:text-blue-800 text-xs">View Full</a>
                    </div>
                </div>`;
        })
        .catch(() => {
            panel.innerHTML = '<p class="text-red-600">Failed to load CLIN details.</p>';
        });
}

function fetchLogFields(clinId) {
    currentClinIdForLogFields = clinId;
    const label = document.getElementById('log-fields-clin-label');
    const statusEl = document.getElementById('log-field-status');
    const notesEl = document.getElementById('log-field-notes');
    const saveBtn = document.getElementById('log-fields-save-btn');
    if (!clinId) {
        if (label) label.textContent = 'Select a CLIN above';
        if (statusEl) statusEl.value = '';
        if (notesEl) notesEl.value = '';
        if (saveBtn) saveBtn.disabled = true;
        return;
    }
    const itemNum = document.querySelector(`.clin-row[data-clin-id="${clinId}"] td:first-child a`)?.textContent?.trim() || clinId;
    if (label) label.textContent = `For CLIN ${itemNum}`;
    if (saveBtn) saveBtn.disabled = false;
    const url = "{% url 'contracts:get_clin_log_fields' 0 %}".replace('/0/', `/${clinId}/`);
    fetch(url, { credentials: 'same-origin' })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            if (statusEl) statusEl.value = data.log_status || '';
            if (notesEl) notesEl.value = data.log_notes || '';
        }
    });
}

function saveLogFields() {
    const clinId = currentClinIdForLogFields;
    if (!clinId) return;
    const status = document.getElementById('log-field-status')?.value || '';
    const notes = document.getElementById('log-field-notes')?.value || '';
    const url = "{% url 'contracts:save_clin_log_fields' 0 %}".replace('/0/', `/${clinId}/`);
    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin',
        body: JSON.stringify({ log_status: status, log_notes: notes })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            // Could add a brief toast - for now silent
        } else {
            alert(data.error || 'Failed to save.');
        }
    });
}

function switchNotesTab(tab, clinId) {
    document.querySelectorAll('.notes-panel').forEach(panel => panel.classList.add('hidden'));
    document.querySelectorAll('.notes-tab-btn').forEach(btn => {
        btn.classList.remove('border-green-500', 'text-green-600', 'bg-green-50', 'border-blue-500', 'text-blue-600', 'bg-blue-50');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    const panel = document.getElementById(tab === 'contract' ? 'notes-panel-contract' : 'notes-panel-clin');
    let tabBtn = document.getElementById('notes-tab-contract');
    if (tab === 'clin' && clinId) {
        tabBtn = document.getElementById(`notes-tab-clin-${clinId}`);
    }
    if (panel) panel.classList.remove('hidden');
    if (tabBtn) {
        tabBtn.classList.remove('border-transparent', 'text-gray-500');
        const activeClasses = tab === 'contract' ? ['border-green-500', 'text-green-600', 'bg-green-50'] : ['border-blue-500', 'text-blue-600', 'bg-blue-50'];
        tabBtn.classList.add(...activeClasses);
    }
}

function fetchClinNotes(clinId) {
    const container = document.getElementById('notes-panel-clin');
    if (!container) return;
    if (!clinId) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Select a CLIN to view its notes.</p>';
        return;
    }
    const url = "{% url 'contracts:get_clin_notes' 0 %}".replace('/0/', `/${clinId}/`);
    fetch(url, { credentials: 'same-origin', headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => {
            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                if (contentType.includes('application/json')) {
                    return response.json().then(data => { throw new Error(data.error || `Request failed (${response.status})`); });
                }
                throw new Error(`Request failed (${response.status}). Please try again.`);
            }
            if (!contentType.includes('application/json')) {
                throw new Error('Invalid response from server.');
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.notes_html) {
                container.innerHTML = data.notes_html;
                setupEditButtons(container);
            } else {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No notes for this CLIN.</p>';
            }
            switchNotesTab('clin', clinId);
        })
        .catch(error => {
            console.error('Error fetching CLIN notes:', error);
            container.innerHTML = '<div class="text-red-600 text-center py-4">' + (error.message || 'Error loading notes. Please try again.') + '</div>';
        });
}

function setupEditButtons(container) {
    // Setup edit buttons functionality
    container.querySelectorAll('[data-note-action="edit"]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            openEditNoteModal(this);
            return false;
        });
    });
}

function toggleAcknowledgment(field) {
    const clinId = '{{ selected_clin.id }}';
    if (!clinId) return;

    // Get the current state before the toggle
    const btn = document.getElementById(`${field}_btn`);
    const initialState = btn.classList.contains('bg-green-500');

    fetch(`/contracts/clin/${clinId}/toggle-acknowledgment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            field: field,
            initial_state: initialState
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success === false) {
            alert(data.error || 'An error occurred while processing your request.');
            return;
        }

        const btn = document.getElementById(`${field}_btn`);
        if (data.status === true) {
            btn.classList.remove('bg-red-500');
            btn.classList.add('bg-green-500');

            // Update button text based on field
            if (field.includes('po_to_supplier')) {
                btn.textContent = 'Sent';
            } else if (field.includes('clin_reply')) {
                btn.textContent = 'Yes';
            } else if (field.includes('po_to_qar')) {
                btn.textContent = 'Sent';
            }

            // Update user info if provided
            if (data.user_info) {
                const userInfoContainer = btn.closest('.grid').querySelector('.text-right');
                if (userInfoContainer) {
                    userInfoContainer.innerHTML = `
                        <div>${data.user_info.username}</div>
                        <div>${data.user_info.date}</div>
                    `;
                }
            }

            // If a note was created, refresh the CLIN notes tab
            if (data.note_created) {
                fetchClinNotes(clinId);
            }

            // Show message if a reminder was created
            if (data.reminder_created) {
                const message = `Reminder "${data.reminder_title}" created for ${data.reminder_date}`;
                // Display notification (can be enhanced with a proper notification system)
                alert(message);
            }
        } else {
            btn.classList.remove('bg-green-500');
            btn.classList.add('bg-red-500');
            btn.textContent = field.includes('po_sent') ? 'Not Sent' : 'Not Acknowledged';

            // Clear user info
            const userInfoContainer = btn.closest('.grid').querySelector('.text-right');
            if (userInfoContainer) {
                userInfoContainer.innerHTML = '';
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request. Please try again.');
    });
}

// Functions for Expedite functionality
function toggleExpediteStatus(action) {
    const contractId = "{{ contract.id }}";
    if (!contractId) return;

    fetch(`/contracts/contract/${contractId}/toggle-expedite/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success === false) {
            alert(data.error || 'An error occurred while processing your request.');
            return;
        }

        // Update UI based on current state
        const container = document.getElementById('expedite_container');
        const buttonContainer = container.querySelector('.space-y-2');

        // Reset all background classes first
        container.classList.remove('bg-gray-50', 'bg-yellow-200', 'bg-fuchsia-200');

        if (action === 'reset') {
            // Handle reset action specifically
            if (data.initiated === false) {
                // Complete reset to initial state
                location.reload(); // Simplest way to reset UI completely
                return;
            } else if (data.initiated && !data.successful) {
                // Reset from successful to initiated state
                container.classList.add('bg-gray-50');

                // Recreate buttons in the right state
                buttonContainer.innerHTML = `
                    <!-- Initiate button -->
                    <button
                        onclick="toggleExpediteStatus('initiate')"
                        id="expedite_initiate_btn"
                        class="w-full px-3 py-1 text-sm font-medium rounded-md transition-colors duration-150
                            bg-gray-300 text-gray-600 cursor-not-allowed"
                        disabled>
                        Initiate
                    </button>

                    <!-- Successful button -->
                    <button
                        onclick="toggleExpediteStatus('successful')"
                        id="expedite_successful_btn"
                        class="w-full px-3 py-1 text-sm font-medium rounded-md transition-colors duration-150
                            bg-red-200 text-red-800 hover:bg-red-300">
                        Successful
                    </button>
                `;

                // Update status info
                let statusHtml = '';
                if (data.initiatedby) {
                    statusHtml += `<p>Initiated: ${data.initiateddate} by ${data.initiatedby}</p>`;
                }

                // Update or add status div
                let statusDiv = container.querySelector('.mt-2.text-xs');
                if (!statusDiv) {
                    statusDiv = document.createElement('div');
                    statusDiv.className = 'mt-2 text-xs text-gray-700';
                    container.appendChild(statusDiv);
                }
                statusDiv.innerHTML = statusHtml;

                return;
            } else if (data.initiated && data.successful && !data.used) {
                // Reset from used to successful state
                container.classList.add('bg-yellow-200');

                // Recreate just the Use Expedite button (active)
                buttonContainer.innerHTML = `
                    <button
                        onclick="toggleExpediteStatus('use')"
                        id="expedite_use_btn"
                        class="w-full px-3 py-1 text-sm font-medium rounded-md transition-colors duration-150
                            bg-red-200 text-red-800 hover:bg-red-300">
                        Use Expedite
                    </button>
                `;

                // Update status info
                let statusHtml = '';
                if (data.initiatedby) {
                    statusHtml += `<p>Initiated: ${data.initiateddate} by ${data.initiatedby}</p>`;
                }
                if (data.successfulby) {
                    statusHtml += `<p>Successful: ${data.successfuldate} by ${data.successfulby}</p>`;
                }

                // Update status div
                let statusDiv = container.querySelector('.mt-2.text-xs');
                if (!statusDiv) {
                    statusDiv = document.createElement('div');
                    statusDiv.className = 'mt-2 text-xs text-gray-700';
                    container.appendChild(statusDiv);
                }
                statusDiv.innerHTML = statusHtml;

                return;
            }
        }

        // Handle normal (non-reset) actions
        if (data.initiated) {
            const initiateBtn = document.getElementById('expedite_initiate_btn');
            const successfulBtn = document.getElementById('expedite_successful_btn');
            const useBtn = document.getElementById('expedite_use_btn');

            // Handle initiate state
            if (initiateBtn) {
                initiateBtn.classList.remove('bg-red-200', 'text-red-800', 'hover:bg-red-300');
                initiateBtn.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                initiateBtn.disabled = true;
            }

            if (data.successful) {
                // Wild color 1 - Yellow background for successful
                container.classList.add('bg-yellow-200');

                // Hide initiate and successful buttons
                if (initiateBtn) initiateBtn.parentElement.removeChild(initiateBtn);
                if (successfulBtn) successfulBtn.parentElement.removeChild(successfulBtn);

                // Add/update Use Expedite button if it doesn't exist
                if (!useBtn) {
                    const useBtnHtml = `
                    <button
                        onclick="toggleExpediteStatus('use')"
                        id="expedite_use_btn"
                        class="w-full px-3 py-1 text-sm font-medium rounded-md transition-colors duration-150
                        ${data.used ? 'bg-gray-300 text-gray-600 cursor-not-allowed' : 'bg-red-200 text-red-800 hover:bg-red-300'}"
                        ${data.used ? 'disabled' : ''}>
                        Use Expedite
                    </button>`;
                    buttonContainer.innerHTML = useBtnHtml;
                } else if (data.used) {
                    // If already has use button and it's used, disable it
                    useBtn.classList.remove('bg-red-200', 'text-red-800', 'hover:bg-red-300');
                    useBtn.classList.add('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                    useBtn.disabled = true;

                    // Wild color 2 - Fuchsia background for used
                    container.classList.remove('bg-yellow-200');
                    container.classList.add('bg-fuchsia-200');
                }
            } else if (successfulBtn) {
                // Enable successful button if not already successful
                successfulBtn.classList.remove('bg-gray-300', 'text-gray-600', 'cursor-not-allowed');
                successfulBtn.classList.add('bg-red-200', 'text-red-800', 'hover:bg-red-300');
                successfulBtn.disabled = false;
            }

            // Update status info
            let statusHtml = '';
            if (data.initiatedby) {
                statusHtml += `<p>Initiated: ${data.initiateddate} by ${data.initiatedby}</p>`;
            }
            if (data.successfulby) {
                statusHtml += `<p>Successful: ${data.successfuldate} by ${data.successfulby}</p>`;
            }
            if (data.usedby) {
                statusHtml += `<p>Used: ${data.useddate} by ${data.usedby}</p>`;
            }

            // Add or update status div
            let statusDiv = container.querySelector('.mt-2.text-xs');
            if (!statusDiv) {
                statusDiv = document.createElement('div');
                statusDiv.className = 'mt-2 text-xs text-gray-700';
                container.appendChild(statusDiv);
            }
            statusDiv.innerHTML = statusHtml;
        } else {
            // Reset to initial state - just reload the page
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request. Please try again.');
    });
}

function resetExpedite() {
    if (confirm('Are you sure you want to reset the Expedite process? This will clear all current expedite data.')) {
        toggleExpediteStatus('reset');
    }
}

// Function to toggle contract fields like NIST
function toggleContractField(field) {
    const contractId = "{{ contract.id }}";
    if (!contractId) return;

    // Get the current state before the toggle
    const btn = document.getElementById(`${field}_btn`);
    const initialState = btn.classList.contains('bg-green-500');

    fetch(`/contracts/contract/${contractId}/toggle-field/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('#csrf-form [name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            field: field,
            initial_state: initialState
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success === false) {
            alert(data.error || 'An error occurred while processing your request.');
            return;
        }

        if (field === 'nist') {
            // Toggle the button appearance
            if (data.status) {
                btn.classList.remove('bg-gray-300');
                btn.classList.add('bg-green-500');
                btn.classList.remove('text-gray-700');
                btn.classList.add('text-white');
            } else {
                btn.classList.remove('bg-green-500');
                btn.classList.add('bg-gray-300');
                btn.classList.remove('text-white');
                btn.classList.add('text-gray-700');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request. Please try again.');
    });
}

function toggleOptionsMenu() {
    const menu = document.getElementById('optionsMenu');
    menu.classList.toggle('hidden');
}

// Close the menu when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('optionsMenu');
    const button = event.target.closest('button');

    if (!button || !button.hasAttribute('onclick') || button.getAttribute('onclick') !== 'toggleOptionsMenu()') {
        menu.classList.add('hidden');
    }
});

function openAcknowledgmentLetter(clinId) {
    console.log('Opening acknowledgment letter for CLIN:', clinId);

    // Get the modal and content elements
    const modal = document.getElementById('acknowledgmentLetterModal');
    const modalContent = document.getElementById('acknowledgmentLetterContent');

    // Show loading state
    modalContent.innerHTML = '<div class="flex justify-center items-center h-64"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div></div>';

    // Show the modal
    modal.classList.remove('hidden');

    // Fetch the form
    const url = `/contracts/acknowledgment-letter/${clinId}/`;
    console.log('Fetching from URL:', url);

    fetch(url)
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (data.success) {
                modalContent.innerHTML = data.html;

                // Initialize form after content is loaded
                const form = modalContent.querySelector('form');
                if (form) {
                    // Style all form inputs
                    form.querySelectorAll('input, select').forEach(input => {
                        input.classList.add('w-full', 'rounded-md', 'border-gray-300', 'shadow-sm', 'focus:border-blue-500', 'focus:ring-blue-500', 'text-sm');
                    });

                    // Set up form submission
                    form.addEventListener('submit', function(e) {
                        e.preventDefault();

                        const formData = new FormData(form);
                        const letterId = form.dataset.letterId;

                        fetch(`/contracts/acknowledgment-letter/${letterId}/update/`, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        })
                        .then(response => response.json())
                        .then(result => {
                            if (result.success) {
                                // Close modal and refresh page
                                closeAcknowledgmentLetter();
                                location.reload();
                            } else {
                                // Show errors
                                const errors = result.errors;
                                Object.keys(errors).forEach(field => {
                                    const input = form.querySelector(`[name="${field}"]`);
                                    if (input) {
                                        input.classList.add('border-red-500');
                                        const errorDiv = document.createElement('div');
                                        errorDiv.className = 'text-red-500 text-sm mt-1';
                                        errorDiv.textContent = errors[field].join(' ');
                                        input.parentNode.appendChild(errorDiv);
                                    }
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('An error occurred while saving the form');
                        });
                    });
                }
            } else {
                modalContent.innerHTML = '<div class="p-4 text-red-500">Error loading form</div>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modalContent.innerHTML = '<div class="p-4 text-red-500">Error loading form</div>';
        });
}

function closeAcknowledgmentLetter() {
    const modal = document.getElementById('acknowledgmentLetterModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Contract cancellation functions
function showCancelModal(contractId, contractNumber) {
    event.preventDefault();
    event.stopPropagation();
    document.getElementById('contractId').value = contractId;
    document.getElementById('cancelContractNumber').textContent = contractNumber;
    document.getElementById('cancelContractModal').classList.remove('hidden');
    return false;
}

function closeCancelModal() {
    document.getElementById('cancelContractModal').classList.add('hidden');
    document.getElementById('cancelContractForm').reset();
}

document.addEventListener('DOMContentLoaded', function() {
    // Add form submission handler for cancel contract
    document.getElementById('cancelContractForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const contractId = formData.get('contractId');

        fetch(`/contracts/${contractId}/cancel/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Error cancelling contract: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while cancelling the contract.');
        });
    });
});
</script>
{% endblock %}
