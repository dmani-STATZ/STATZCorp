{% extends "base_template.html" %}
{% load static %}

{% block extra_head %}
<style>
    /* Stack background colors - dynamically generated from model */
    {% for stack_key, colors in stack_colors.items %}
    select.stack-{{ stack_key }} {
        background-color: {{ colors.bg }} !important;
        color: {{ colors.text }} !important;
    }
    {% endfor %}
    
    /* Make highlight more vibrant */
    tr.highlight-row {
        background-color: #ffff00 !important;
    }
    tr.highlight-row td:not(:first-child) {
        background-color: #ffff00 !important;
    }
    tr.highlight-row input:not([type="checkbox"]) {
        background-color: #ffff00 !important;
    }
    .compact-table th, .compact-table td {
        padding: 0.5rem;
        font-size: 0.875rem;
    }
    .checkbox-cell {
        text-align: center !important;
        padding: 0.5rem !important;
        vertical-align: middle !important;
    }
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
    }
    .editable-cell {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .editable-cell:hover {
        background-color: #f3f4f6;
    }
    .editable-input {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        outline: none;
    }
    .editable-input:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    .editable-select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        outline: none;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='currentColor' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right 0.5rem center !important;
        background-size: 1em !important;
        padding-right: 2.5rem !important;
    }
    .editable-select option {
        background-color: white !important;
        color: black !important;
        padding: 0.5rem !important;
    }
    .editable-select, .editable-select option {
        font-weight: 500;
    }
    .checkbox-input {
        width: 1rem !important;
        height: 1rem !important;
        border: 1px solid #e5e7eb !important;  /* Blue border */
        border-radius: 0.25rem !important;
        appearance: none !important;
        -webkit-appearance: none !important;
        background-color: white !important;
        margin: 0 !important;
        cursor: pointer !important;
        position: relative !important;
    }
    
    .checkbox-input:checked {
        background-color: #3b82f6 !important;  /* Blue background when checked */
        border-color: #e5e7eb !important;
    }

    .checkbox-input:checked::after {
        content: '' !important;
        position: absolute !important;
        left: 4px !important;
        top: 1px !important;
        width: 4px !important;
        height: 8px !important;
        border: solid white !important;
        border-width: 0 2px 2px 0 !important;
        transform: rotate(45deg) !important;
        display: block !important;
    }

    .checkbox-input:focus {
        outline: 2px solid #93c5fd !important;  /* Light blue focus ring */
        outline-offset: 2px !important;
    }
    
    /* Table styles */
    .table-compact td, 
    .table-compact th {
        padding-top: 0.25rem !important;    /* 4px */
        padding-bottom: 0.25rem !important; /* 4px */
        padding-left: 0.5rem !important;    /* 8px */
        padding-right: 0.5rem !important;   /* 8px */
        font-size: 0.75rem !important;      /* Reduced from 0.875rem */
    }
    
    /* Header specific styles */
    .table-compact th {
        padding: 1rem 0.5rem 0.5rem 0.5rem !important;  /* More top padding, standard sides/bottom */
        height: auto !important;                        /* Allow natural height */
        min-height: 3.5rem !important;                 /* Ensure minimum height for headers */
        white-space: normal !important;                /* Allow text wrapping */
        line-height: 1.2 !important;                   /* Tighter line height for wrapped text */
        vertical-align: bottom !important;             /* Align text to bottom */
    }

    /* Remove the span wrapper and flexbox styling */
    .table-compact th {
        text-align: left !important;
        font-size: 0.75rem !important;
        font-weight: 500 !important;
        text-transform: uppercase !important;
        color: #252525 !important;
        letter-spacing: 0.05em !important;
    }
    
    .table-compact .editable-input,
    .table-compact .editable-select {
        padding: 0.125rem 0.125rem !important;
        height: 1.50rem !important;
        min-height: 1.50rem !important;
        font-size: 0.75rem !important;      /* Reduced from 0.875rem */
    }
    
    .table-compact .checkbox-input {
        width: 1rem !important;
        height: 1rem !important;
    }

    .container-fluid {
        font-size: 0.5rem !important;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid">
    <div class="flex justify-between items-center mb-2">
        <h1 class="text-xl font-bold text-gray-900">Folder Tracking</h1>
        <div class="flex items-center space-x-4 flex-1 mx-4">
            <input type="text" 
                   name="search" 
                   placeholder="Search folders by Contract Number, PO Number, Partial, or Tracking Number..." 
                   value="{{ search_query }}"
                   onkeyup="handleSearch(event)"
                   class="w-full px-3 py-1.5 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
        </div>
        <div class="flex space-x-2">
            <button type="button" id="addNewBtn" class="bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-700 text-sm flex items-center">
                <svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Document Shape -->
                    <rect x="10" y="6" width="24" height="36" rx="3" ry="3" fill="white" stroke="black" stroke-width="2"/>
                    <path d="M34 14H16" stroke="black" stroke-width="2"/>
                    <path d="M30 20H16" stroke="black" stroke-width="2"/>
                    <path d="M26 26H16" stroke="black" stroke-width="2"/>
                  
                    <!-- Plus Icon -->
                    <circle cx="36" cy="34" r="9" fill="white"/>
                    <path d="M36 30V38" stroke="blue" stroke-width="2"/>
                    <path d="M32 34H40" stroke="blue" stroke-width="2"/>
                  </svg>
                Add Contract
            </button>
            <a href="{% url 'contracts:export_folder_tracking' %}" class="flex items-center gap-2 bg-green-600 text-white px-3 py-1.5 rounded hover:bg-green-700 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="30" height="30" viewBox="0 0 100 100">
                    <path d="M 30.306641 17.574219 C 23.138641 17.574219 17.306641 23.406219 17.306641 30.574219 L 17.306641 69.574219 C 17.306641 76.742219 23.138641 82.574219 30.306641 82.574219 L 69.306641 82.574219 C 76.474641 82.574219 82.306641 76.742219 82.306641 69.574219 L 82.306641 30.574219 C 82.306641 23.406219 76.475641 17.574219 69.306641 17.574219 L 30.306641 17.574219 z M 30.306641 19.574219 L 69.306641 19.574219 C 75.371641 19.574219 80.306641 24.509219 80.306641 30.574219 L 80.306641 69.574219 C 80.306641 75.639219 75.371641 80.574219 69.306641 80.574219 L 30.306641 80.574219 C 24.241641 80.574219 19.306641 75.639219 19.306641 69.574219 L 19.306641 30.574219 C 19.306641 24.509219 24.241641 19.574219 30.306641 19.574219 z M 33.144531 22.574219 C 27.168531 22.574219 22.306641 27.436109 22.306641 33.412109 L 22.306641 66.738281 C 22.306641 72.714281 27.168531 77.574219 33.144531 77.574219 L 66.470703 77.574219 C 72.446703 77.574219 77.306641 72.714281 77.306641 66.738281 L 77.306641 48.074219 C 77.306641 47.797219 77.082641 47.574219 76.806641 47.574219 C 76.530641 47.574219 76.306641 47.798219 76.306641 48.074219 L 76.306641 66.738281 C 76.306641 72.162281 71.894703 76.574219 66.470703 76.574219 L 33.144531 76.574219 C 27.720531 76.574219 23.306641 72.162281 23.306641 66.738281 L 23.306641 33.412109 C 23.306641 27.988109 27.720531 23.574219 33.144531 23.574219 L 66.806641 23.574219 C 67.082641 23.574219 67.306641 23.350219 67.306641 23.074219 C 67.306641 22.798219 67.082641 22.574219 66.806641 22.574219 L 33.144531 22.574219 z M 76.806641 36.574219 C 76.530641 36.574219 76.306641 36.797219 76.306641 37.074219 L 76.306641 39.074219 C 76.306641 39.350219 76.530641 39.574219 76.806641 39.574219 C 77.082641 39.574219 77.306641 39.350219 77.306641 39.074219 L 77.306641 37.074219 C 77.306641 36.798219 77.082641 36.574219 76.806641 36.574219 z M 38.699219 38.576172 C 38.510219 38.576172 38.338906 38.682563 38.253906 38.851562 C 38.168906 39.020562 38.185828 39.224 38.298828 39.375 L 45.712891 49.326172 L 36.486328 60.763672 C 36.367328 60.911672 36.344734 61.117016 36.427734 61.291016 C 36.510734 61.465016 36.686906 61.574219 36.878906 61.574219 L 44.509766 61.574219 C 44.666766 61.574219 44.814203 61.502953 44.908203 61.376953 L 49.945312 54.693359 L 54.732422 61.365234 C 54.826422 61.496234 54.977672 61.574219 55.138672 61.574219 L 62.736328 61.574219 C 62.927328 61.574219 63.101547 61.466922 63.185547 61.294922 C 63.269547 61.123922 63.247859 60.920531 63.130859 60.769531 L 54.267578 49.339844 L 62.042969 39.382812 C 62.160969 39.232813 62.181656 39.027469 62.097656 38.855469 C 62.014656 38.684469 61.839438 38.576172 61.648438 38.576172 L 53.804688 38.576172 C 53.639688 38.576172 53.486578 38.657922 53.392578 38.794922 L 50.001953 43.751953 L 46.828125 38.806641 C 46.736125 38.663641 46.579203 38.576172 46.408203 38.576172 L 38.699219 38.576172 z M 39.697266 39.574219 L 46.136719 39.574219 L 49.570312 44.925781 C 49.661313 45.067781 49.816375 45.15425 49.984375 45.15625 C 50.159375 45.15125 50.309297 45.0765 50.404297 44.9375 L 54.070312 39.574219 L 60.626953 39.574219 L 53.242188 49.03125 C 53.101188 49.21225 53.100234 49.464531 53.240234 49.644531 L 61.71875 60.574219 L 55.396484 60.574219 L 50.363281 53.558594 C 50.270281 53.428594 50.121891 53.351609 49.962891 53.349609 C 49.809891 53.375609 49.653594 53.421828 49.558594 53.548828 L 44.263672 60.574219 L 37.927734 60.574219 L 46.734375 49.652344 C 46.877375 49.475344 46.882094 49.222062 46.746094 49.039062 L 39.697266 39.574219 z M 76.806641 40.574219 C 76.530641 40.574219 76.306641 40.798219 76.306641 41.074219 L 76.306641 45.074219 C 76.306641 45.350219 76.530641 45.574219 76.806641 45.574219 C 77.082641 45.574219 77.306641 45.350219 77.306641 45.074219 L 77.306641 41.074219 C 77.306641 40.797219 77.082641 40.574219 76.806641 40.574219 z"></path>
                </svg>
                Export to Excel
            </a>
            <button type="button" id="togglePaginationBtn" 
                class="{% if pagination_disabled %}bg-red-600 hover:bg-red-700{% else %}bg-blue-600 hover:bg-blue-700{% endif %} text-white px-3 py-1.5 rounded text-sm flex items-center">
                {% if pagination_disabled %}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="4" cy="12" r="2" fill="black"/>
                    <circle cx="12" cy="12" r="2" fill="black"/>
                    <circle cx="20" cy="12" r="2" fill="black"/>
                </svg>
                Enable Paging
                {% else %}
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="4" cy="12" r="2" fill="gray"/>
                    <circle cx="12" cy="12" r="2" fill="gray"/>
                    <circle cx="20" cy="12" r="2" fill="gray"/>
                    <line x1="2" y1="2" x2="22" y2="22" stroke="red" stroke-width="2"/>
                </svg>
                Disable Paging
                {% endif %}
            </button>
        </div>
    </div>

    <!-- Folder Table -->
    <div class="overflow-x-auto bg-white rounded-lg shadow">
        <table class="w-full divide-y divide-gray-200 table-compact">
            <thead class="bg-gray-50">
                <tr>
                    <th class="w-30">Stack</th>
                    <th class="w-32">Contract</th>
                    <th class="w-16">PO</th>
                    <th class="w-36">Partial</th>
                    <th class="w-12">RTS Email</th>
                    <th class="w-32">QB Invoice</th>
                    <th class="w-12">WAWF Submit</th>
                    <th class="w-12">WAWF QAR</th>
                    <th class="w-32">VSM SCN</th>
                    <th class="w-32">SIR SCN</th>
                    <th class="w-38">Tracking</th>
                    <th class="w-38">Tracking #</th>
                    <th class="w-16">Sort Data</th>
                    <th class="w-80">Notes</th>
                    <th class="w-32">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for folder in folders %}
                <tr class="{% if folder.highlight %}highlight-row{% endif %}" data-id="{{ folder.id }}">
                    <td class="whitespace-nowrap">
                        <select class="editable-select stack-{{ folder.stack|slice:'4:'|lower|cut:' ' }}" 
                                data-id="{{ folder.id }}" 
                                data-field="stack" 
                                onchange="updateField(this)">
                            {% for choice in folder.STACK_CHOICES %}
                            <option value="{{ choice.0 }}" 
                                    {% if folder.stack == choice.0 %}selected{% endif %}>
                                {{ choice.1 }}
                            </option>
                            {% endfor %}
                        </select>
                    </td>
                    <td class="whitespace-nowrap">{{ folder.contract.contract_number }}</td>
                    <td class="whitespace-nowrap">{{ folder.contract.po_number }}</td>
                    <td class="whitespace-nowrap editable-cell">
                        <input type="text" class="editable-input" value="{{ folder.partial|default:'' }}"
                               data-id="{{ folder.id }}" data-field="partial" onchange="updateField(this)"
                               placeholder="Enter partial...">
                    </td>
                    <td class="whitespace-nowrap checkbox-cell">
                        <input type="checkbox" class="checkbox-input" 
                               {% if folder.rts_email %}checked{% endif %}
                               data-id="{{ folder.id }}" data-field="rts_email" onchange="updateField(this)">
                    </td>
                    <td class="whitespace-nowrap editable-cell">
                        <input type="text" class="editable-input" value="{{ folder.qb_inv|default:'' }}"
                               data-id="{{ folder.id }}" data-field="qb_inv" onchange="updateField(this)"
                               placeholder="Enter QB INV...">
                    </td>
                    <td class="whitespace-nowrap checkbox-cell">
                        <input type="checkbox" class="checkbox-input"
                               {% if folder.wawf %}checked{% endif %}
                               data-id="{{ folder.id }}" data-field="wawf" onchange="updateField(this)">
                    </td>
                    <td class="whitespace-nowrap checkbox-cell">
                        <input type="checkbox" class="checkbox-input"
                               {% if folder.wawf_qar %}checked{% endif %}
                               data-id="{{ folder.id }}" data-field="wawf_qar" onchange="updateField(this)">
                    </td>
                    <td class="whitespace-nowrap editable-cell">
                        <input type="text" class="editable-input" value="{{ folder.vsm_scn|default:'' }}"
                               data-id="{{ folder.id }}" data-field="vsm_scn" onchange="updateField(this)"
                               placeholder="Enter VSM SCN...">
                    </td>
                    <td class="whitespace-nowrap editable-cell">
                        <input type="text" class="editable-input" value="{{ folder.sir_scn|default:'' }}"
                               data-id="{{ folder.id }}" data-field="sir_scn" onchange="updateField(this)"
                               placeholder="Enter SIR SCN...">
                    </td>
                    <td class="whitespace-nowrap editable-cell">
                        <input type="text" class="editable-input" value="{{ folder.tracking|default:'' }}"
                               data-id="{{ folder.id }}" data-field="tracking" onchange="updateField(this)"
                               placeholder="Enter tracking...">
                    </td>
                    <td class="whitespace-nowrap editable-cell">
                        <input type="text" class="editable-input" value="{{ folder.tracking_number|default:'' }}"
                               data-id="{{ folder.id }}" data-field="tracking_number" onchange="updateField(this)"
                               placeholder="Enter tracking number...">
                    </td>
                    <td class="whitespace-nowrap">{{ folder.sort_data|default:'' }}</td>
                    <td class="whitespace-nowrap editable-cell">
                        <input type="text" class="editable-input" value="{{ folder.note|default:'' }}"
                               data-id="{{ folder.id }}" data-field="note" onchange="updateField(this)"
                               placeholder="Enter note...">
                    </td>
                    <td class="whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-indigo-600 hover:text-indigo-900 mr-2"
                                data-id="{{ folder.id }}" onclick="toggleHighlightBtn(this)">
                            {% if folder.highlight %}Unhighlight{% else %}Highlight{% endif %}
                        </button>
                        <button class="text-red-600 hover:text-red-900"
                                data-id="{{ folder.id }}" onclick="closeFolderBtn(this)">
                            Close
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="15" class="text-center text-gray-500">
                        No folders found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if not pagination_disabled and folders.has_other_pages %}
    <div class="flex justify-center mt-2">
        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
            {% if folders.has_previous %}
            <a href="?page={{ folders.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                Previous
            </a>
            {% endif %}
            
            {% for i in folders.paginator.page_range %}
                {% if folders.number == i %}
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-blue-50 text-sm font-medium text-blue-600">
                    {{ i }}
                </span>
                {% else %}
                <a href="?page={{ i }}{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                    {{ i }}
                </a>
                {% endif %}
            {% endfor %}

            {% if folders.has_next %}
            <a href="?page={{ folders.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                Next
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>

<!-- Search Modal -->
<div id="searchModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 hidden z-50">
    <div class="fixed inset-0 overflow-y-auto">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-base font-semibold leading-6 text-gray-900 mb-4">
                                Search Contract
                            </h3>
                            <div class="mt-2">
                                <input type="text" 
                                       id="contractSearch"
                                       class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                       placeholder="Search by Contract Number or PO Number..."
                                       hx-get="{% url 'contracts:search_contracts' %}"
                                       hx-trigger="keyup changed delay:500ms"
                                       hx-target="#search-results"
                                       hx-indicator="#search-indicator"
                                       name="q">
                                <div id="search-indicator" class="htmx-indicator mt-2 text-gray-500 text-sm">
                                    <svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    Searching...
                                </div>
                                <div id="search-results" class="mt-4 max-h-96 overflow-y-auto divide-y divide-gray-200">
                                    <!-- Search results will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                    <button type="button" id="cancelBtn" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
console.log('Script starting to load...');
</script>
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded');
    const modal = document.getElementById('searchModal');
    const addNewBtn = document.getElementById('addNewBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const contractSearch = document.getElementById('contractSearch');
    const searchResults = document.getElementById('search-results');

    console.log('Modal element:', modal);
    console.log('Add New button:', addNewBtn);

    function openSearchModal() {
        console.log('Opening modal');
        modal.classList.remove('hidden');
        setTimeout(() => {
            contractSearch.focus();
            contractSearch.select();
        }, 100);
    }

    function closeSearchModal() {
        console.log('Closing modal');
        modal.classList.add('hidden');
        contractSearch.value = '';
        searchResults.innerHTML = '';
    }

    // Event Listeners
    if (addNewBtn) {
        addNewBtn.addEventListener('click', function(e) {
            console.log('Add New button clicked');
            e.preventDefault();
            openSearchModal();
        });
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', closeSearchModal);
    }

    // Close modal when clicking outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            closeSearchModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
            closeSearchModal();
        }
    });

    // Initialize HTMX
    if (typeof htmx !== 'undefined') {
        console.log('HTMX initialized');
        htmx.logAll(); // Enable HTMX logging
    }
});

function handleSearch(event) {
    if (event.key === 'Enter') {
        const searchQuery = event.target.value;
        window.location.href = `?search=${encodeURIComponent(searchQuery)}`;
    }
}

function selectContract(contractId, contractNumber) {
    fetch("{% url 'contracts:add_folder_tracking' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `contract=${contractId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        } else {
            alert(data.message || 'Error adding folder');
        }
    });
}

function toggleHighlight(folderId) {
    fetch(`/contracts/folder-tracking/${folderId}/toggle-highlight/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            location.reload();
        }
    });
}

function closeFolder(folderId) {
    if (confirm('Are you sure you want to close this folder?')) {
        fetch(`/contracts/folder-tracking/${folderId}/close/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            }
        });
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateField(element) {
    const folderId = element.dataset.id;
    const field = element.dataset.field;
    const value = element.type === 'checkbox' ? element.checked : element.value;

    const formData = new FormData();
    formData.append('field', field);
    formData.append('value', value);

    fetch(`/contracts/folder-tracking/${folderId}/update-field/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (field === 'stack') {
                // Update the select element's class
                const stackName = value.split(' - ')[1].toLowerCase(); // Get the part after the dash
                element.className = `editable-select stack-${stackName}`;
            }
        } else {
            alert('Error updating field: ' + (data.message || 'Unknown error'));
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating field. Please try again.');
        location.reload();
    });
}

function toggleHighlightBtn(element) {
    const folderId = element.dataset.id;
    toggleHighlight(folderId);
}

function closeFolderBtn(element) {
    const folderId = element.dataset.id;
    closeFolder(folderId);
}

// Replace the pagination toggle JavaScript with this updated version
document.addEventListener('DOMContentLoaded', function() {
    const togglePaginationBtn = document.getElementById('togglePaginationBtn');
    if (togglePaginationBtn) {
        togglePaginationBtn.addEventListener('click', function() {
            const formData = new FormData();
            formData.append('toggle_pagination', 'true');
            
            fetch(window.location.pathname, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    console.log('Pagination toggled successfully:', data);
                    
                    // Preserve search query if it exists
                    const currentUrl = new URL(window.location.href);
                    const searchQuery = currentUrl.searchParams.get('search');
                    const newUrl = new URL(window.location.pathname, window.location.origin);
                    
                    if (searchQuery) {
                        newUrl.searchParams.set('search', searchQuery);
                    }
                    
                    // Preserve page parameter if pagination is enabled and we have a page
                    if (!data.pagination_disabled && currentUrl.searchParams.has('page')) {
                        newUrl.searchParams.set('page', currentUrl.searchParams.get('page'));
                    }
                    
                    // Reload the page with the new state
                    window.location.href = newUrl.toString();
                } else {
                    console.error('Error toggling pagination:', data);
                    alert('Error toggling pagination');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error toggling pagination');
            });
        });
    }
});
</script>
{% endblock %} 