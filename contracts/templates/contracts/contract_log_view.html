{% extends "contracts/contract_base.html" %}
{% load static %}

{% block title %}Contract Log View{% endblock %}

{% block content %}
<div class="container-fluid px-2 py-2" style="max-width: 1920px;">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
            <h3 class="text-lg font-semibold mb-4">Exporting Contract Log</h3>
            <div class="mb-4">
                <div class="h-2 bg-gray-200 rounded-full">
                    <div id="progressBar" class="h-2 bg-blue-600 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <p id="exportStatus" class="text-sm text-gray-600 mb-2">Preparing export...</p>
            <p id="exportTime" class="text-sm text-gray-600"></p>
            <div id="exportStats" class="mt-4 text-xs text-gray-500 hidden">
                <p>Recent Export Times:</p>
                <ul id="recentExports" class="list-disc pl-5 space-y-1"></ul>
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <div class="bg-white shadow-md rounded-lg p-3 mb-3">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-bold">Contract Log View</h1>
            
            <div class="flex items-center space-x-2">
                <!-- Filter Toggle Button -->
                <button id="toggleFilters" class="btn-secondary flex items-center text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                    </svg>
                    Show Filters
                </button>

                <!-- Clear Filters Button -->
                <button id="clearFilters" class="btn-secondary flex items-center text-sm ">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    Clear Filters
                </button>
                
                <!-- Export Button -->
                <button id="exportBtn" class="btn-primary flex items-center text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export to Excel
                </button>
            </div>
        </div>
        
        <!-- Filter Controls - Hidden by default -->
        <div id="filterControls" class="mt-3 grid grid-cols-1 md:grid-cols-4 gap-2 hidden">
            <div>
                <label for="filterStatus" class="block text-xs font-medium text-gray-700 mb-1">Filter by Status</label>
                <select id="filterStatus" class="w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm">
                    <option value="">All Statuses</option>
                    <option value="open">Open</option>
                    <option value="closed">Closed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            
            <div>
                <label for="filterSupplier" class="block text-xs font-medium text-gray-700 mb-1">Filter by Supplier</label>
                <select id="filterSupplier" class="w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm">
                    <option value="">All Suppliers</option>
                    {% for supplier in suppliers %}
                        <option value="{{ supplier.id }}" {% if supplier.id|stringformat:"s" == request.GET.supplier %}selected{% endif %}>
                            {{ supplier.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="searchContract" class="block text-xs font-medium text-gray-700 mb-1">Search Contracts</label>
                <input type="text" id="searchContract" placeholder="Search by contract number, PO, etc." 
                       class="w-full border border-gray-300 rounded-md shadow-sm p-1 text-sm">
            </div>
            
            <div class="flex items-end">
                <button id="applyFilters" class="btn-secondary text-sm py-1">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
    
    <!-- Contract Table -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full whitespace-nowrap">
                    <thead class="bg-gray-50 sticky top-0 z-10">
                    <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider text-left">
                        <th class="px-1.5 py-1">Status</th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                            Tab #
                        </th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                            PO #
                        </th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                            IDIQ Contract #
                        </th>
                        <th class="px-2 py-1 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                            Contract #
                        </th>
                        <th class="px-1.5 py-1">Buyer</th>
                        <th class="px-1.5 py-1">Type</th>
                        <th class="px-1.5 py-1">CLIN #</th>
                        <th class="px-1.5 py-1">Supplier</th>
                        <th class="px-1.5 py-1">Cage Code</th>
                        <th class="px-1.5 py-1">Award Date</th>
                        <th class="px-1.5 py-1">Contract Status</th>
                        <th class="px-1.5 py-1">NSN</th>
                        <th class="px-1.5 py-1">NSN Description</th>
                        <th class="px-1.5 py-1">IA</th>
                        <th class="px-1.5 py-1">PO to Sub</th>
                        <th class="px-1.5 py-1">Sub Reply</th>
                        <th class="px-1.5 py-1">PO to QAR</th>
                        <th class="px-1.5 py-1">FOB</th>
                        <th class="px-1.5 py-1">QDD</th>
                        <th class="px-1.5 py-1">CDD</th>
                        <th class="px-1.5 py-1">Order Qty</th>
                        <th class="px-1.5 py-1">Ship Date</th>
                        <th class="px-1.5 py-1">Ship Qty</th>
                        <th class="px-1.5 py-1">Sub PO $</th>
                        <th class="px-1.5 py-1">Sub Paid $</th>
                        <th class="px-1.5 py-1">X</th>
                        <th class="px-1.5 py-1">Contract $</th>
                        <th class="px-1.5 py-1">WAWF Payment $</th>
                        <th class="px-1.5 py-1">Date Pay Recv</th>
                        <th class="px-1.5 py-1">Plan Gross $</th>
                        <th class="px-1.5 py-1">Actual Paid PPI $</th>
                        <th class="px-1.5 py-1">Actual STATZ $</th>
                        <th class="px-1.5 py-1">Plan Split per PPI bid</th>
                        <th class="px-1.5 py-1">PPI Split $</th>
                        <th class="px-1.5 py-1">STATZ Split $</th>
                        <th class="px-1.5 py-1">Notes</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    {% for clin in clins %}
                    <tr class="hover:bg-gray-50 text-xs">
                        <td class="px-1.5 py-1">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                              {% if clin.contract.status.description == 'Cancelled' %}bg-red-100 text-red-800
                                              {% elif clin.contract.date_closed %}bg-yellow-100 text-yellow-800
                                              {% else %}bg-green-100 text-green-800{% endif %}">
                                            {% if clin.contract.status.description == 'Cancelled' %}Cancelled
                                            {% elif clin.contract.date_closed %}Closed
                                            {% else %}Open{% endif %}
                                </span>
                            </td>   
                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-900">
                            {{ clin.contract.tab_num }}
                        </td>
                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-900">
                            {{ clin.contract.po_number }}
                        </td>
                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-900">
                            {{ clin.contract.idiq_contract.contract_number|default:'' }}
                        </td>
                        <td class="px-2 py-1 whitespace-nowrap text-sm text-gray-900">
                            <a href="{% url 'contracts:contract_management' clin.contract.id %}" 
                               class="text-blue-600 hover:text-blue-800">
                                {{ clin.contract.contract_number }}
                            </a>
                        </td>
                        <td class="px-1.5 py-1">{{ clin.contract.buyer.description }}</td>
                        <td class="px-1.5 py-1">{{ clin.contract.contract_type.description }}</td>
                        <td class="px-1.5 py-1">{{ clin.item_number }}</td>
                        <td class="px-1.5 py-1">
                            <a href="{% url 'suppliers:supplier_detail' clin.supplier.id %}" 
                               class="text-blue-600 hover:text-blue-800">
                                {{ clin.supplier.name }}
                            </a>
                        </td>
                        <td class="px-1.5 py-1">{{ clin.supplier.cage_code|default:"" }}</td>
                        <td class="px-1.5 py-1">{{ clin.contract.award_date|date:"m/d/Y"|default:"-" }}</td>
                        <td class="px-1.5 py-1">{{ clin.contract_status_text|default:"" }}</td>
                        <td class="px-1.5 py-1">
                            <a href="{% url 'contracts:nsn_edit' clin.nsn.id %}" 
                               class="text-blue-600 hover:text-blue-800">
                               {{ clin.nsn.nsn_code|default:"" }}
                            </a>
                        </td>
                        <td class="px-1.5 py-1">{{ clin.nsn.description|default:"" }}</td>
                        <td class="px-1.5 py-1">{{ clin.ia|default:"" }}</td>
                        <td class="px-1.5 py-1">{% if clin.clinacknowledgment_set.first.po_to_supplier_bool %}Yes{% else %}No{% endif %}</td>
                        <td class="px-1.5 py-1">{% if clin.clinacknowledgment_set.first.clin_reply_bool %}Yes{% else %}No{% endif %}</td>
                        <td class="px-1.5 py-1">{% if clin.clinacknowledgment_set.first.po_to_qar_bool %}Yes{% else %}No{% endif %}</td>
                        <td class="px-1.5 py-1">{{ clin.fob|default:"" }}</td>
                        <td class="px-1.5 py-1">{{ clin.supplier_due_date|date:"m/d/Y" }}</td>
                        <td class="px-1.5 py-1">{{ clin.due_date|date:"m/d/Y"|default:"-" }}</td>
                        <td class="px-1.5 py-1">{{ clin.order_qty|default:"0" }} {{ clin.uom|default:"ea" }}</td>
                        <td class="px-1.5 py-1">{{ clin.ship_date|date:"m/d/Y"|default:"-" }}</td>
                        <td class="px-1.5 py-1">{{ clin.ship_qty|default:"-" }}</td>
                        <td class="px-1.5 py-1">${{ clin.quote_value|floatformat:2|default:"0.00" }}</td>
                        <td class="px-1.5 py-1">${{ clin.paid_amount|floatformat:2|default:"0.00" }}</td>
                        <td class="px-1.5 py-1"></td>
                        <td class="px-1.5 py-1">${{ clin.contract.contract_value|floatformat:2|default:"0.00" }}</td>
                        <td class="px-1.5 py-1">${{ clin.wawf_payment|floatformat:2|default:"0.00" }}</td>
                        <td class="px-1.5 py-1">{{ clin.wawf_recieved|date:"m/d/Y"|default:"-" }}</td>
                        <td class="px-1.5 py-1">
                            {% if clin.is_first_for_contract %}
                                ${{ clin.contract.plan_gross|floatformat:2|default:"0.00" }}
                            {% else %}
                                $0.00
                            {% endif %}
                        </td>
                        <td class="px-1.5 py-1">
                            {% if clin.is_first_for_contract %}
                                ${{ clin.ppi_split_paid|floatformat:2|default:"0.00" }}
                            {% else %}
                                $0.00
                            {% endif %}
                        </td>
                        <td class="px-1.5 py-1">
                            {% if clin.is_first_for_contract %}
                                ${{ clin.statz_split_paid|floatformat:2|default:"0.00" }}
                            {% else %}
                                $0.00
                            {% endif %}
                        </td>
                        <td class="px-1.5 py-1">
                            {% if clin.is_first_for_contract %}
                                {{ clin.contract.planned_split|default:"-" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-1.5 py-1">
                            {% if clin.is_first_for_contract %}
                                ${{ clin.ppi_split_value|floatformat:2|default:"0.00" }}
                            {% else %}
                                $0.00
                            {% endif %}
                        </td>
                        <td class="px-1.5 py-1">
                            {% if clin.is_first_for_contract %}
                                ${{ clin.statz_split_value|floatformat:2|default:"0.00" }}
                            {% else %}
                                $0.00
                            {% endif %}
                        </td>
                        <td class="px-1.5 py-1"></td>
                        </tr>
                        {% empty %}
                        <tr>
                        <td colspan="35" class="px-1.5 py-1 text-center text-gray-500">
                            No records found
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    <!-- Pagination -->
        {% if is_paginated %}
        <div class="bg-white shadow-md rounded-lg mt-2 px-4 py-1">
            <div class="flex flex-col items-center justify-center space-y-1">
                <div class="bg-blue-700 text-white rounded-md p-1 pr-4 pl-4">
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm items-center space-x-2">
                        <!-- First Page -->
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                               class="btn-pagination underline">First</a>
                        {% else %}
                            <span class="btn-pagination opacity-50 cursor-not-allowed">First</span>
                        {% endif %}

                        <!-- Previous Page -->
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                               class="btn-pagination underline">Prev</a>
                        {% else %}
                            <span class="btn-pagination opacity-50 cursor-not-allowed">Prev</span>
                        {% endif %}

                        <!-- Page Range -->
                        {% with ''|center:5 as range %}
                            {% for i in paginator.page_range %}
                                {% if i >= page_obj.number|add:"-3" and i <= page_obj.number|add:"3" %}
                                    {% if page_obj.number == i %}
                                        <span class="btn-pagination-active mx-1">{{ i }}</span>
                                    {% else %}
                                        <a href="?page={{ i }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                                           class="btn-pagination mx-1 underline">{{ i }}</a>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endwith %}

                        <!-- Next Page -->
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                               class="btn-pagination underline">Next</a>
                        {% else %}
                            <span class="btn-pagination opacity-50 cursor-not-allowed">Next</span>
                        {% endif %}

                        <!-- Last Page -->
                        {% if page_obj.has_next %}
                            <a href="?page={{ paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}" 
                               class="btn-pagination underline">Last</a>
                        {% else %}
                            <span class="btn-pagination opacity-50 cursor-not-allowed">Last</span>
                        {% endif %}
                    </nav>
                </div>
                <div class="bg-blue-300 rounded-md p-1">
                    <p class="text-sm text-black">
                    Showing <span class="font-medium">{{ page_obj.start_index }}</span> to 
                    <span class="font-medium">{{ page_obj.end_index }}</span> of 
                    <span class="font-medium">{{ paginator.count }}</span> results
                    </p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter toggle functionality
        const toggleFilters = document.getElementById('toggleFilters');
        const filterControls = document.getElementById('filterControls');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const progressBar = document.getElementById('progressBar');
        
        toggleFilters.addEventListener('click', function() {
            filterControls.classList.toggle('hidden');
        });
        
        // Apply filters
        const applyFilters = document.getElementById('applyFilters');
        const clearFilters = document.getElementById('clearFilters');
        const filterStatus = document.getElementById('filterStatus');
        const filterSupplier = document.getElementById('filterSupplier');
        const searchContract = document.getElementById('searchContract');
        
        // Set initial values from URL if they exist
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('status')) {
            filterStatus.value = urlParams.get('status');
        }
        if (urlParams.has('supplier')) {
            filterSupplier.value = urlParams.get('supplier');
        }
        if (urlParams.has('search')) {
            searchContract.value = urlParams.get('search');
        }
        
        applyFilters.addEventListener('click', function() {
            const status = filterStatus.value;
            const supplier = filterSupplier.value;
            const search = searchContract.value;
            
            let queryParams = [];
            if (status) queryParams.push(`status=${status}`);
            if (supplier) queryParams.push(`supplier=${supplier}`);
            if (search) queryParams.push(`search=${search}`);
            
            window.location.href = `${window.location.pathname}${queryParams.length ? '?' + queryParams.join('&') : ''}`;
        });
        
        // Clear filters functionality
        clearFilters.addEventListener('click', function() {
            filterStatus.value = '';
            filterSupplier.value = '';
            searchContract.value = '';
            window.location.href = window.location.pathname;
        });
        
        // Export functionality
        const exportBtn = document.getElementById('exportBtn');
        
        function updateExportProgress(progress, message) {
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('exportStatus');
            progressBar.style.width = `${progress}%`;
            if (message) {
                statusText.textContent = message;
            }
        }

        async function getExportEstimate(rowCount) {
            try {
                const response = await fetch(`{% url "contracts:get_export_estimate" %}?rows=${rowCount}`);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error getting export estimate:', error);
                return null;
            }
        }

        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        async function exportContractLog() {
            const startTime = performance.now();
            const loadingOverlay = document.getElementById('loadingOverlay');
            const exportStats = document.getElementById('exportStats');
            const recentExports = document.getElementById('recentExports');
            const exportTime = document.getElementById('exportTime');
            
            loadingOverlay.classList.remove('hidden');
            exportTime.textContent = '';
            
            try {
                // Get row count from the table
                const rowCount = document.querySelector('.text-sm.text-black')?.textContent.match(/of\s+(\d+)\s+results/)?.[1] || '0';
                const numRows = parseInt(rowCount);
                
                // Get export estimate and recent timings
                const estimateData = await getExportEstimate(numRows);
                if (estimateData) {
                    const { estimated_seconds, recent_timings } = estimateData;
                    
                    // Display recent export times
                    recentExports.innerHTML = recent_timings.map(timing => `
                        <li>${timing.row_count} rows in ${timing.export_time.toFixed(1)}s (${formatDateTime(timing.timestamp)})</li>
                    `).join('');
                    exportStats.classList.remove('hidden');
                    
                    // Start progress updates
                    let progress = 0;
                    const updateInterval = estimated_seconds * 10; // Update 10 times during estimated duration
                    const progressIncrement = 100 / (estimated_seconds * 1000 / updateInterval);
                    
                    const progressTimer = setInterval(() => {
                        progress = Math.min(progress + progressIncrement, 95);
                        updateExportProgress(progress, `Exporting ${numRows} rows...`);
                    }, updateInterval);
                    
                    // Perform the actual export
                    const response = await fetch('{% url "contracts:export_contract_log_xlsx" %}?' + new URLSearchParams(window.location.search));
                    clearInterval(progressTimer);
                    
                    if (!response.ok) throw new Error('Export failed');
                    
                    const blob = await response.blob();
                    const endTime = performance.now();
                    const duration = ((endTime - startTime) / 1000).toFixed(1);
                    
                    // Update final progress and timing
                    updateExportProgress(100, 'Export completed successfully');
                    exportTime.textContent = `Export completed in ${duration} seconds`;
                    
                    // Download the file
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'contract_log.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    // Keep overlay visible for 2 more seconds to show completion
                    setTimeout(() => {
                        loadingOverlay.classList.add('hidden');
                        exportStats.classList.add('hidden');
                    }, 2000);
                    
                } else {
                    throw new Error('Could not get export estimate');
                }
            } catch (error) {
                console.error('Export failed:', error);
                updateExportProgress(100, 'Export failed');
                exportTime.textContent = 'An error occurred during export';
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    exportStats.classList.add('hidden');
                }, 2000);
            }
        }
        
        exportBtn.addEventListener('click', exportContractLog);
    });
</script>
{% endblock %} 
